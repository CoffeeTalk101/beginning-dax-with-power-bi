<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link href="style.css" rel="stylesheet" type="text/css" /><title>Beginning DAX with Power BI (for pre sume): The SQL Pro’s Guide to Better Business Intelligence</title></head><body><div class="calibre1" id="calibre_link-56">
<div id="calibre_link-379" class="calibre2">
<div id="calibre_link-380" class="calibre3"><div class="bookfrontmatter"><div class="bookfrontmatter" type="titlepage"><div class="bookauthors"><span><span>Philip&nbsp;Seamark</span></span></div><div class="maintitlesection" type="fulltitle"><span class="booktitle" type="title" lang="en">Beginning DAX with Power BI</span><span class="booksubtitle" type="subtitle" lang="en">The SQL Pro’s Guide to Better Business Intelligence</span></div><div class="bookfrontmatter"><figure class="figure" id="calibre_link-381"><div class="mediaobject" id="calibre_link-382"><img alt="../images/456681_1_En_BookFrontmatter_Figa_HTML.png" src="images/000022.png" class="calibre4" /></div></figure></div></div><div class="copyrightpage" type="copyright-page"><div class="bookfrontmatter"><div class="bookfrontmatter"><div class="bookfrontmatter"><span>Philip&nbsp;Seamark</span><div class="bookfrontmatter" id="calibre_link-383"><div class="bookfrontmatter">UPPER HUTT, New Zealand</div></div></div></div></div><aside class="articlenote"><p class="simplepara">
            Any source code or other supplementary material referenced by the author in this book is available to readers on GitHub via the book’s product page, located at
            <span><a href="http://www.apress.com/9781484234761" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>www.​apress.​com/​9781484234761</span></a></span>
            . For more detailed information, please visit
            <span><a href="http://www.apress.com/source-code" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>http://​www.​apress.​com/​source-code</span></a></span>
            .
          </p></aside><div class="bookfrontmatter"><span>
				ISBN 978-1-4842-3476-1</span><span class="copyrightpageelectronicisbn">e-ISBN 978-1-4842-3477-8</span></div><div class="bookfrontmatter"><a href="https://doi.org/10.1007/978-1-4842-3477-8" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">https://doi.org/10.1007/978-1-4842-3477-8</a></div><div class="bookfrontmatter">Library of Congress Control Number: 2018937896</div><div class="bookfrontmatter">© Philip Seamark 2018</div><div class="bookfrontmatter" lang="en">This work is subject to copyright. All rights are reserved by the Publisher, whether the whole or part of the material is concerned, specifically the rights of translation, reprinting, reuse of illustrations, recitation, broadcasting, reproduction on microfilms or in any other physical way, and transmission or information storage and retrieval, electronic adaptation, computer software, or by similar or dissimilar methodology now known or hereafter developed.</div><div class="bookfrontmatter" lang="en">Trademarked names, logos, and images may appear in this book. Rather than use a trademark symbol with every occurrence of a trademarked name, logo, or image we use the names, logos, and images only in an editorial fashion and to the benefit of the trademark owner, with no intention of infringement of the trademark. The use in this publication of trade names, trademarks, service marks, and similar terms, even if they are not identified as such, is not to be taken as an expression of opinion as to whether or not they are subject to proprietary rights.</div><div class="bookfrontmatter" lang="en">While the advice and information in this book are believed to be true and accurate at the date of publication, neither the authors nor the editors nor the publisher can accept any legal responsibility for any errors or omissions that may be made. The publisher makes no warranty, express or implied, with respect to the material contained herein.</div><div class="bookfrontmatter" lang="en">Printed on acid-free paper</div><div class="bookfrontmatter" lang="en">Distributed to the book trade worldwide by Springer Science+Business Media New York, 233 Spring Street, 6th Floor, New York, NY 10013. Phone 1-800-SPRINGER, fax (201) 348-4505, e-mail orders-ny@springer-sbm.com, or visit www.springeronline.com. Apress Media, LLC is a California LLC and the sole member (owner) is Springer Science + Business Media Finance Inc (SSBM Finance Inc). SSBM Finance Inc is a Delaware corporation.</div></div><div class="copyrightpage" type="dedication"><p class="simplepara">
            <em class="emphasistypeitalic">To Grace, Hazel, Emily</em>
          </p><p class="simplepara">
            <em class="emphasistypeitalic">. . . and of course Rebecca.</em>
          </p></div><div class="copyrightpage" type="foreword"><div class="forewordtitle" lang="en">Foreword</div><div class="bookfrontmatter"><p class="simplepara" id="calibre_link-384">Power BI has changed the definition of business intelligence (BI) tools. Taking tools that were historically reserved for data scientists and making them easy to use and economically available to business analysts has enabled an entire culture of self-service BI. This book is doing the same for data access programming. It breaks complex concepts into simple, easy-to-understand steps and frames them in a business context that makes it easy for you to start learning the DAX language and helps you solve real-world business challenges on a daily basis.</p><p class="simplepara">&mdash;Charles “Chuck” Sterling (of Microsoft).</p></div></div><div class="copyrightpage" type="acknowledgments"><div class="forewordtitle" lang="en">Acknowledgments</div><div class="bookfrontmatter"><p class="simplepara" id="calibre_link-385">Thanks to Marco Russo, Alberto Ferrari, and Chris Webb for providing many years of high-quality material in the world of business intelligence.</p></div></div><div class="copyrightpage" type="toc" id="calibre_link-386"><div class="bookfrontmatter"><h3 class="heading">Table of Contents</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
              <span><a href="#calibre_link-57" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Chapter 1 :​ Introduction to DAX</span></a></span>
            </span><span class="tocpagenumber">1</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-58" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>What Is DAX?​</span></a></span>
              </span><span class="tocpagenumber">2</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-59" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>What Is a Data Model?​</span></a></span>
              </span><span class="tocpagenumber">3</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-60" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Components of a&nbsp;DAX Data Model</span></a></span>
              </span><span class="tocpagenumber">4</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-61" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Data</span></a></span>
                </span><span class="tocpagenumber">4</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-62" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Tables</span></a></span>
                </span><span class="tocpagenumber">4</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-63" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Columns</span></a></span>
                </span><span class="tocpagenumber">4</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-64" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Relationships</span></a></span>
                </span><span class="tocpagenumber">4</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-65" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Measures</span></a></span>
                </span><span class="tocpagenumber">4</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-66" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Hierarchies</span></a></span>
                </span><span class="tocpagenumber">5</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-67" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Your First DAX Calculation</span></a></span>
              </span><span class="tocpagenumber">5</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-68" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Your First Calculation</span></a></span>
                </span><span class="tocpagenumber">6</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-69" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>IntelliSense</span></a></span>
                </span><span class="tocpagenumber">8</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-70" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Formatting</span></a></span>
              </span><span class="tocpagenumber">9</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-71" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Comments</span></a></span>
                </span><span class="tocpagenumber">9</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-72" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Your Second DAX Calculation</span></a></span>
              </span><span class="tocpagenumber">11</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-73" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Your Third DAX Calculation</span></a></span>
              </span><span class="tocpagenumber">12</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-74" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The CALENDARAUTO Function</span></a></span>
                </span><span class="tocpagenumber">13</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-75" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Datatypes</span></a></span>
              </span><span class="tocpagenumber">14</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-76" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The Whole Number Datatype</span></a></span>
                </span><span class="tocpagenumber">15</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-77" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The Decimal and Fixed Decimal Number Datatype</span></a></span>
                </span><span class="tocpagenumber">16</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-78" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Date and DateTime</span></a></span>
                </span><span class="tocpagenumber">17</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-79" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Time</span></a></span>
                </span><span class="tocpagenumber">18</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-80" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Operators</span></a></span>
              </span><span class="tocpagenumber">18</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-81" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Arithmetic Operators</span></a></span>
                </span><span class="tocpagenumber">19</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-82" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Comparison Operators</span></a></span>
                </span><span class="tocpagenumber">19</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-83" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Concatenation Operator</span></a></span>
                </span><span class="tocpagenumber">20</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-84" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Logical Operators</span></a></span>
                </span><span class="tocpagenumber">20</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-85" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Operator Precedence</span></a></span>
                </span><span class="tocpagenumber">20</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-86" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Relationships</span></a></span>
              </span><span class="tocpagenumber">22</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-87" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Types of Relationships</span></a></span>
                </span><span class="tocpagenumber">22</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-88" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Hierarchies</span></a></span>
              </span><span class="tocpagenumber">24</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
              <span><a href="#calibre_link-89" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Chapter 2 :​ Variables</span></a></span>
            </span><span class="tocpagenumber">27</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-90" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Variable Structure</span></a></span>
              </span><span class="tocpagenumber">28</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-91" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Using Variables with Text</span></a></span>
                </span><span class="tocpagenumber">29</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-92" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Using Variables in Calculated Columns</span></a></span>
                </span><span class="tocpagenumber">31</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-93" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Using Variables in Calculated Measures</span></a></span>
                </span><span class="tocpagenumber">32</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-94" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Using Variables in Calculated Tables</span></a></span>
                </span><span class="tocpagenumber">33</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-95" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Debugging Using Variables</span></a></span>
                </span><span class="tocpagenumber">36</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-96" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Nesting Variables</span></a></span>
              </span><span class="tocpagenumber">37</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-97" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Nested Variables (Complex)</span></a></span>
                </span><span class="tocpagenumber">38</span></div></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
              <span><a href="#calibre_link-28" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Chapter 3 :​ Context</span></a></span>
            </span><span class="tocpagenumber">41</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-98" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Filter Context</span></a></span>
              </span><span class="tocpagenumber">41</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-99" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Implicit Filter Context</span></a></span>
                </span><span class="tocpagenumber">43</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-100" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Explicit Filter Context</span></a></span>
                </span><span class="tocpagenumber">50</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-101" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Calculated Column</span></a></span>
                </span><span class="tocpagenumber">53</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-102" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Calculated Measure</span></a></span>
                </span><span class="tocpagenumber">54</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-103" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Hardcoded Example</span></a></span>
                </span><span class="tocpagenumber">56</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-104" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Row Context</span></a></span>
              </span><span class="tocpagenumber">57</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-105" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Iterators</span></a></span>
                </span><span class="tocpagenumber">60</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-106" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>How Data Is Stored in DAX</span></a></span>
              </span><span class="tocpagenumber">62</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-107" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Column Indexes</span></a></span>
                </span><span class="tocpagenumber">63</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-108" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Context Transition</span></a></span>
              </span><span class="tocpagenumber">65</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
              <span><a href="#calibre_link-109" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Chapter 4 :​ Summarizing and Aggregating</span></a></span>
            </span><span class="tocpagenumber">67</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-110" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The SUMMARIZE Function</span></a></span>
              </span><span class="tocpagenumber">69</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-111" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Relationships</span></a></span>
                </span><span class="tocpagenumber">72</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-112" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>SUMMARIZE with a&nbsp;Filter</span></a></span>
                </span><span class="tocpagenumber">74</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-113" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The SUMMARIZECOLUMNS​ Function</span></a></span>
              </span><span class="tocpagenumber">76</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-114" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>SUMMARIZECOLUMNS​ with a&nbsp;Filter</span></a></span>
                </span><span class="tocpagenumber">77</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-115" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The GROUP BY Function</span></a></span>
              </span><span class="tocpagenumber">78</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-116" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The CURRENTGROUP() Function</span></a></span>
                </span><span class="tocpagenumber">79</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-117" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>GROUPBY Iterators</span></a></span>
                </span><span class="tocpagenumber">80</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-118" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The GROUPBY Double Aggregation</span></a></span>
                </span><span class="tocpagenumber">81</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-119" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>GROUPBY with a&nbsp;Filter</span></a></span>
                </span><span class="tocpagenumber">84</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-120" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Subtotal and Total Lines</span></a></span>
              </span><span class="tocpagenumber">85</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-121" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The ISSUBTOTAL Function</span></a></span>
                </span><span class="tocpagenumber">88</span></div></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
              <span><a href="#calibre_link-122" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Chapter 5 :​ Joins</span></a></span>
            </span><span class="tocpagenumber">93</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-123" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Joins in DAX</span></a></span>
              </span><span class="tocpagenumber">93</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-124" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Standard Relationship</span></a></span>
                </span><span class="tocpagenumber">93</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-125" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>How to Join Tables Without a Relationship</span></a></span>
                </span><span class="tocpagenumber">96</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-126" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The CROSSJOIN and GENERATE Functions</span></a></span>
              </span><span class="tocpagenumber">96</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-127" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>CROSSJOIN</span></a></span>
                </span><span class="tocpagenumber">97</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-128" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>GENERATE</span></a></span>
                </span><span class="tocpagenumber">97</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-129" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>NATURALINNERJOIN​ and NATURALLEFTOUTER​JOIN</span></a></span>
              </span><span class="tocpagenumber">118</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-130" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Lineage</span></a></span>
                </span><span class="tocpagenumber">119</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-131" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>UNION</span></a></span>
              </span><span class="tocpagenumber">121</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-132" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>LOOKUPVALUE</span></a></span>
              </span><span class="tocpagenumber">123</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
              <span><a href="#calibre_link-42" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Chapter 6 :​ Filtering</span></a></span>
            </span><span class="tocpagenumber">125</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-133" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Implicit Filtering</span></a></span>
              </span><span class="tocpagenumber">125</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-134" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Explicit Filtering</span></a></span>
              </span><span class="tocpagenumber">133</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-135" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The FILTER Function</span></a></span>
                </span><span class="tocpagenumber">133</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-136" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Filters and Calculated Tables</span></a></span>
                </span><span class="tocpagenumber">162</span></div></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
              <span><a href="#calibre_link-0" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Chapter 7 :​ Dates</span></a></span>
            </span><span class="tocpagenumber">165</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-137" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Date</span></a></span>
              </span><span class="tocpagenumber">166</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-138" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Time</span></a></span>
              </span><span class="tocpagenumber">166</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-139" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Date/​Calendar Tables</span></a></span>
              </span><span class="tocpagenumber">167</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-140" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Automatic Date Tables</span></a></span>
                </span><span class="tocpagenumber">171</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-141" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Quick Measures</span></a></span>
              </span><span class="tocpagenumber">172</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-142" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Sorting by Columns</span></a></span>
              </span><span class="tocpagenumber">172</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-143" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Including the Year When Using Month</span></a></span>
              </span><span class="tocpagenumber">174</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-144" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Time Intelligence</span></a></span>
              </span><span class="tocpagenumber">174</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-145" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Year to Date</span></a></span>
              </span><span class="tocpagenumber">175</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-146" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Period Comparisons</span></a></span>
                </span><span class="tocpagenumber">178</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-147" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>The Rolling Average</span></a></span>
              </span><span class="tocpagenumber">181</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-148" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Rolling Your Own Table</span></a></span>
              </span><span class="tocpagenumber">184</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-149" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>CALENDAR</span></a></span>
                </span><span class="tocpagenumber">185</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-150" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>CALENDARAUTO</span></a></span>
                </span><span class="tocpagenumber">185</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-151" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Expanding the Date Table</span></a></span>
                </span><span class="tocpagenumber">186</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-152" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Adding the Year</span></a></span>
                </span><span class="tocpagenumber">188</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-153" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Fiscal Year</span></a></span>
                </span><span class="tocpagenumber">189</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-154" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Days from Today</span></a></span>
                </span><span class="tocpagenumber">190</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-155" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Weekly Buckets</span></a></span>
                </span><span class="tocpagenumber">190</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-156" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Is Working Day</span></a></span>
                </span><span class="tocpagenumber">192</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-157" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Weekday Name</span></a></span>
                </span><span class="tocpagenumber">194</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-158" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Rolling Your Own&mdash;Summary</span></a></span>
                </span><span class="tocpagenumber">194</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-159" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Optimizing Dates</span></a></span>
              </span><span class="tocpagenumber">194</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
              <span><a href="#calibre_link-160" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Chapter 8 :​ Debugging and Optimizing</span></a></span>
            </span><span class="tocpagenumber">197</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-161" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Debugging in DAX</span></a></span>
              </span><span class="tocpagenumber">197</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-162" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Debugging Using Columns</span></a></span>
                </span><span class="tocpagenumber">199</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-163" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Debugging Using Variables</span></a></span>
                </span><span class="tocpagenumber">201</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-164" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Debugging Calculated Measures</span></a></span>
                </span><span class="tocpagenumber">202</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-165" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>External Tools</span></a></span>
                </span><span class="tocpagenumber">206</span></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-166" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Optimizing</span></a></span>
              </span><span class="tocpagenumber">217</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-167" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Optimizing Data Models</span></a></span>
                </span><span class="tocpagenumber">217</span></div></div></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
              <span><a href="#calibre_link-168" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Chapter 9 :​ Practical DAX</span></a></span>
            </span><span class="tocpagenumber">231</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-169" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Creating a Numbers Table</span></a></span>
              </span><span class="tocpagenumber">231</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-170" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Adding a Date Table</span></a></span>
              </span><span class="tocpagenumber">233</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-171" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Creating the Sales Table</span></a></span>
              </span><span class="tocpagenumber">234</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-172" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Optimizing Sales</span></a></span>
              </span><span class="tocpagenumber">242</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                <span><a href="#calibre_link-173" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Calculated Columns vs.​ Calculated Measures</span></a></span>
              </span><span class="tocpagenumber">243</span></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-174" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Calculated Columns</span></a></span>
                </span><span class="tocpagenumber">243</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-175" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Calculated Measures</span></a></span>
                </span><span class="tocpagenumber">243</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-176" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Show All Sales for the&nbsp;Top Ten Products</span></a></span>
                </span><span class="tocpagenumber">248</span></div></div><div class="bookfrontmatter"><div class="bookauthors"><span class="tocitem">
                  <span><a href="#calibre_link-177" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>Double Grouping</span></a></span>
                </span><span class="tocpagenumber">252</span></div></div></div></div><div class="bookauthors"><span class="tocitem">Index</span><span class="tocpagenumber">259</span></div></div></div><div class="copyrightpage" type="contributors"><div class="bookfrontmatter"><h3 class="heading">About the Author and About the Technical Reviewer</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">About the Author</h3></div><div class="bookfrontmatter"><span class="tocitem"><span>Philip&nbsp;Seamark</span></span><div class="biography"><div class="biographyfigure"><figure class="figure1" id="calibre_link-387"><div class="mediaobject" id="calibre_link-388"><img alt="../images/456681_1_En_BookFrontmatter_Figb_HTML.jpg" src="images/000016.jpg" class="calibre4" /></div></figure></div><p class="simplepara" id="calibre_link-389">is an experienced Data Warehouse and Business Intelligence consultant with a deep understanding of the Microsoft stack and extensive knowledge of Data Warehouse methodologies and enterprise data modeling. He is recognized for his analytical, conceptual, and problem-solving abilities and has more than 25 years of commercial experience delivering business applications across a broad range of technologies. His expertise runs the gamut from project management, dimensional modeling, performance tuning, ETL design, development and optimization, and report and dashboard design to installation and administration.</p><p class="simplepara" id="calibre_link-390">In 2017 he received a Microsoft Data Platform MVP award for his contributions to the Microsoft Power BI community site, as well as for speaking at many data, analytic, and reporting events around the world. Philip is also the founder and organizer of the Wellington Power BI User Group.</p></div><div class="clearboth">&nbsp;</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">About the Technical Reviewer</h3></div><div class="bookfrontmatter"><span class="tocitem"><span>Jeffrey&nbsp;Wang</span></span><div class="biography"><p class="simplepara" id="calibre_link-391">stumbled upon Power BI technologies by accident in 2002 in the suburbs of Philadelphia, fell in love with the field, and has stayed in the BI industry ever since. In 2004, he moved his family across the continent to join the Microsoft Analysis Services engine team as a software engineer just in time to catch the tail end of SQL Server 2005 Analysis Services RTM development. Jeffrey started off with performance improvements in the storage engine. After he found that users desperately needed faster MDX (Multidimensional) calculations, he switched to the formula engine and participated in all the improvements to MDX afterward. He was one of the inventors of the DAX programming language in 2009 and has been driving the progress of the DAX language since then. Currently, Jeffrey is a principal engineering manager in charge of the DAX development team and is leading the next phase of BI programming and its modeling evolution.</p></div><div class="clearboth">&nbsp;</div></div></div></div></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-57">
<div id="calibre_link-392" class="calibre2">
<div id="calibre_link-393" class="calibre3"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-394"><div class="bookfrontmatter">©&nbsp;Philip Seamark&nbsp;2018</div><span class="pcalibre5"><span><span>Philip&nbsp;Seamark</span></span></span><span><span class="booktitle1" type="title" lang="en">Beginning DAX with Power BI</span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-3477-8_1" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">https://doi.org/10.1007/978-1-4842-3477-8_1</a></span></div></div><div class="maintitlesection"><h1 class="chaptertitle" lang="en">1.&nbsp;Introduction to DAX</h1></div><div class="bookfrontmatter"><div class="bookfrontmatter"><span><span>Philip&nbsp;Seamark</span><sup class="calibre6"><a href="#calibre_link-178" class="pcalibre3 pcalibre4 pcalibre1 pcalibre2 pcalibre calibre7">1</a>&nbsp;<span class="contacticon"></span></sup></span></div><div class="bookfrontmatter"><div class="bookfrontmatter" id="calibre_link-178"><span class="affiliationnumber">(1)</span><div class="bookfrontmatter">UPPER HUTT, New Zealand</div></div><div class="clearboth">&nbsp;</div></div></div><div class="bookfrontmatter"><p class="para" id="calibre_link-395">The aim of this book is to help you learn how you can use the DAX language to improve your data modelling capability using tools such as Microsoft Power BI, Excel Power Pivot, and SSAS Tabular. This book will be particularly useful if you already have a good knowledge of T-SQL, although this is not essential.</p><p class="simplepara" id="calibre_link-396">Throughout the book, I present and solve a variety of scenarios using DAX and provide equivalent T-SQL statements primarily as a comparative reference to help clarify each solution. My personal background is as someone who has spent many years building solutions using T-SQL, and I would like to share the tips and tricks I have acquired on my journey learning DAX with those who have a similar background. It’s not crucial for you to be familiar with T-SQL to get the best out of this book because the examples will still be useful to someone who isn’t. I find it can be helpful to sometimes describe an answer multiple ways to help provide a better understanding of the solution.</p><p class="simplepara" id="calibre_link-397">In this book, I use Power BI Desktop as my primary DAX engine and most samples use data from the WideWorldImportersDW database, which is freely available for download from Microsoft’s website. This database can be restored to an instance of Microsoft SQL Server 2016 or later. I am using the Developer edition of SQL Server 2016.</p><p class="simplepara" id="calibre_link-398">I recommend you download and install the latest version of Power BI Desktop to your local Windows PC. The download is available from <span class="emphasisfontcategorynonproportional">powerbi.microsoft.com/desktop</span>, or you can find it via a quick internet search. The software is free to install and allows you to load data and start building DAX-based data models in a matter of minutes.</p><p class="simplepara" id="calibre_link-399">The WideWorldImportersDW database is clean, well-organized, and an ideal starting point from which to learn to data model using DAX.</p><p class="simplepara" id="calibre_link-400">The aim of this first chapter is to cover high-level fundamentals of DAX without drilling into too much detail. Later chapters explore the same fundamentals in much more depth.</p><section class="section" id="calibre_link-58"><h2 class="heading">What Is DAX?</h2><p class="simplepara" id="calibre_link-401">Data Analysis Expressions (DAX) is both a query and functional language. It made its first appearance back in 2009 as part of an add-in to Microsoft Excel 2010. The primary objective of DAX is to help organize, analyze, understand, and enhance data for analytics and reporting.</p><p class="simplepara" id="calibre_link-402">DAX is not a full-blown programing language and does not provide some of the flow-control or state-persistence mechanisms you might expect from other programming languages. It has been designed to enhance data modeling, reporting, and analytics. DAX is constantly evolving with new functions being added on a regular basis.</p><div class="para1" id="calibre_link-403">
<span id="calibre_link-404">DAX

</span> is described as a functional language, which means calculations primarily use functions to generate results. A wide variety of functions are provided to help with arithmetic, string manipulation, date and time handling, and more. Functions can be nested but <em class="emphasistypeitalic">you cannot create your own</em>. <span id="calibre_link-405">Functions

</span> are classified into the following categories:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-406">DateTime</p></li><li class="calibre8"><p class="para2" id="calibre_link-407">Filter</p></li><li class="calibre8"><p class="para2" id="calibre_link-408">Info</p></li><li class="calibre8"><p class="para2" id="calibre_link-409">Logical</p></li><li class="calibre8"><p class="para2" id="calibre_link-410">Mathtrig</p></li><li class="calibre8"><p class="para2" id="calibre_link-411">ParentChild</p></li><li class="calibre8"><p class="para2" id="calibre_link-412">Statistical</p></li><li class="calibre8"><p class="para2" id="calibre_link-413">Text</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-414">There are over 200 functions in DAX. Every calculation you write will use one or more of these. Each function produces an output with some returning a single value and others returning a table. Functions use parameters as input. Functions can be nested so the output of one function can be used as input to another function.</p><p class="simplepara" id="calibre_link-415">Unlike T-SQL, there is no concept of INSERT, UPDATE, or DELETE for manipulating data in a data model. Once a physical table exists in a Power BI, SSAS Tabular, or Excel PowerPivot data model, DAX cannot add, change, or remove data from that table. Data can only be filtered or queried using DAX functions.</p></section><section class="section" id="calibre_link-59"><h2 class="heading">What Is a Data Model?</h2><p class="simplepara" id="calibre_link-416">A <em class="emphasistypeitalic">data</em> <span id="calibre_link-417">
              <em class="emphasistypeitalic">model</em>
              
              
            </span> is a collection of data, calculations, and formatting rules that combine to create an object that can be used to explore, query, and better understand an existing dataset. This can include data from many sources.</p><p class="simplepara" id="calibre_link-418">Power BI Desktop, SSAS Tabular, and PowerPivot for Excel can import data from a wide variety of data sources including databases and flat files or directly from many source systems. Once imported, calculations can be added to the model to help explore and make sense of the data.</p><p class="simplepara" id="calibre_link-419">Data is organized and stored into tables. Tables are two dimensional and share many characteristics with databases tables. Tables have columns and rows, and relationships can be defined between tables to assist calculations that use data from multiple tables. Calculations can be as simple as providing a row count over a table or providing a sum of values in a column. Well-considered calculations should enhance your data model and support the process of building reports and performing analytical tasks known as <span id="calibre_link-420">
              <em class="emphasistypeitalic">measures</em>
              
              
            </span>.</p><p class="simplepara" id="calibre_link-421">It’s the combination of data and measures that become your data model.</p><p class="simplepara" id="calibre_link-422">The Power BI Desktop user interface consists of three core components. First, the <span id="calibre_link-423">
              <em class="emphasistypeitalic">Report View</em>
              
              
            </span> provides a canvas that lets you create a visual layer of your data model using charts and other visuals. Report View also lets you control the layout by dragging, dropping, and resizing elements on the report canvas. It’s the canvas that is presented to the end user when they access the report.</p><p class="simplepara" id="calibre_link-424">The second component is the <em class="emphasistypeitalic">Data View</em>, which provides the ability to see raw data for each table in the model. <span id="calibre_link-425">Data View

</span> can show data for one table at a time and is controlled by clicking the name of a table from the list of tables in the right-hand panel. Columns can be sorted in this view, but sorting here has no impact on any sorting by visuals on the report canvas. Columns can be renamed, formatted, deleted, hidden, or have their datatype defined using the Report View. A hidden column will always appear in the Report View but not in any field list in the report.</p><p class="simplepara" id="calibre_link-426">It’s possible to add or change calculations from both Report and Data View.</p><p class="simplepara" id="calibre_link-427">The last component of the Power BI Desktop user interface is the <span id="calibre_link-428">
              <em class="emphasistypeitalic">Relationship View</em>
              
              
            </span>. This section shows every table in the data model and allows you to add, change, or remove relationships between tables.</p></section><section class="section" id="calibre_link-60"><h2 class="heading">Components of a&nbsp;DAX Data Model</h2><p class="simplepara" id="calibre_link-429">The DAX data modeling engine is made up of six key components.</p><section class="section" id="calibre_link-61"><h3 class="heading">
              <span id="calibre_link-430">Data


</span>
            </h3><p class="simplepara" id="calibre_link-431">The first step of building a data model is importing data. A wide variety of data sources are available, and once they are imported, they will be stored in two-dimensional tables. Sources that are not two dimensional can be used, but these will need to be converted to a two-dimensional format before or during import. The query editor provides a rich array of functions that help with this type of transformation.</p></section><section class="section" id="calibre_link-62"><h3 class="heading">
              <span id="calibre_link-432">Tables


</span>
            </h3><p class="simplepara" id="calibre_link-433">Tables are objects used to store and organize data. Tables consist of columns that are made up of source data or results of DAX calculations.</p></section><section class="section" id="calibre_link-63"><h3 class="heading">
              <span id="calibre_link-434">Columns


</span>
            </h3><p class="simplepara" id="calibre_link-435">Each table can have one or more columns. The underlying data engine stores data from the same column in its own separate index. Unlike T-SQL, DAX stores data in columns rather than in rows. Once data has been loaded to a column, it is considered static and cannot be changed. Columns can also be known as <em class="emphasistypeitalic">fields</em>.</p></section><section class="section" id="calibre_link-64"><h3 class="heading">
              <span id="calibre_link-436">Relationships


</span>
            </h3><p class="simplepara" id="calibre_link-437">Two tables can be connected via a relationship defined in the model. A single column from each table is used to define the relationship. Only <em class="emphasistypeitalic">one-to-many</em> and <em class="emphasistypeitalic">one-to-one</em> relationships are supported. Many-to-many relationships cannot be created. In DAX, the most common use of relationships is to provide filtering rather than to mimic normalization of data optimized for OLTP <span id="calibre_link-438">operations


</span>.</p></section><section class="section" id="calibre_link-65"><h3 class="heading">
              <span id="calibre_link-439">Measures


</span>
            </h3><p class="simplepara" id="calibre_link-440">A <em class="emphasistypeitalic">measure</em> is a DAX calculation that returns a single value that can be used in visuals in reports or as part of calculations in other measures. A measure can be as simple as a row count of a table or sum over a column. Measures react and respond to user interaction and recalculate as a report is being used. Measures can return new values based on updates to the selection of filters and slicers.</p></section><section class="section" id="calibre_link-66"><h3 class="heading">
              <span id="calibre_link-441">Hierarchies


</span>
            </h3><p class="simplepara" id="calibre_link-442"><em class="emphasistypeitalic">Hierarchies</em> are groupings of two or more columns into levels that can be drilled up/down through by interactive visuals and charts. A common hierarchy might be over date data that creates a three-level hierarchy over year, month, and day. Other common hierarchies might use geographical data (country, city, suburb), or structures that reflect organizational groupings in HR or Product data.</p></section></section><section class="section" id="calibre_link-67"><h2 class="heading">Your First DAX Calculation</h2><p class="simplepara" id="calibre_link-443">It’s possible to import data and have no need to write in DAX. If data is clean and simple and report requirements are basic, you can create a model that needs no user-created calculations. Numeric fields dragged to the report canvas will produce a number.</p><p class="simplepara" id="calibre_link-444">If you then drag a non-numeric field to the same visual, it automatically assumes you would like to group your numeric field by the distinct values found in your nonnumeric field. The default aggregation over your numeric field will be SUM. This can be changed to another aggregation type using the properties of your visual. Other aggregation types include AVERAGE, COUNT, MAX, MIN and so on.</p><p class="simplepara" id="calibre_link-445">In this approach, the report creates a DAX-calculated measure on your behalf. These are known as <span id="calibre_link-446">
              <em class="emphasistypeitalic">implicit measures</em>
              
              
            </span>. Dragging the ‘Fact Sale’[Quantity] field to the canvas automatically generates the following DAX statement for you:</p><div class="para1" id="calibre_link-447">
            <div class="programcode" id="calibre_link-448"><div class="fixedline">CALCULATE(SUM('Fact Sale'[Quantity]))</div></div>
          </div><p class="simplepara" id="calibre_link-449">This calculation recomputes every time a slicer or filter is changed and should show values relevant for any filter settings in your report.</p><p class="simplepara" id="calibre_link-450">Most real-world scenarios require at least some basic enhancements to raw data, and this is where adding DAX calculations can improve your model. When you specifically create calculated measures, these are known as <span id="calibre_link-451">
              <em class="emphasistypeitalic">explicit measures</em>
              
              
            </span>.</p><p class="simplepara" id="calibre_link-452">Some of the most common enhancements are to provide the ability to show a count of the number of records in a table or to sum values in a column.</p><p class="simplepara" id="calibre_link-453">Other enhancements might be to create a new column using values from other columns in the same row, or from elsewhere in the model. A simple example is a column that multiplies values from columns such as Price and Qty together to produce a total. A more complicated example might use data from other tables in a calculation to provide a value that has meaning to that row and table.</p><p class="simplepara" id="calibre_link-454">Once basic count or sum calculations have been added, more sophisticated calculations that provide cumulative totals, period comparisons, or ranking can be added.</p><div class="para1" id="calibre_link-455">These are the three types of calculations in DAX:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-456">Calculated columns</p></li><li class="calibre8"><p class="para2" id="calibre_link-457">Calculated measures</p></li><li class="calibre8"><p class="para2" id="calibre_link-458">Calculated tables</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-459">We explore each of these calculations in more detail later in this book and I include hints on how and when you might choose one type over another.</p><div class="formalpara" id="calibre_link-460"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-461"><em class="emphasistypeitalic">Calculated tables</em> (tables that are the result of a DAX calculation) can only be created in the DAX engine used by Power BI Desktop and SSAS Tabular.</p></div><section class="section" id="calibre_link-68"><h3 class="heading">Your First Calculation</h3><div class="bookfrontmatter" id="calibre_link-462">The first example I cover creates a simple <span id="calibre_link-463">calculated measure

</span> using data from the WideWorldImportersDW database (Figure <span><a href="#calibre_link-179" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-1</a></span>). The dataset has a table called ‘Fact Sale’ that has a column called [Total Including Tax]. The <span id="calibre_link-464">calculation

</span> produces a value that represents a sum using values stored in this column.<figure class="figure1" id="calibre_link-179"><div class="mediaobject" id="calibre_link-465"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig1_HTML.jpg" src="images/000055.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-1</span><p class="simplepara1">A sample of data from the ‘Fact Sale’ <span id="calibre_link-466" class="calibre9">table

</span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-467">When viewing this table in Data View, we see the unsummarized value for each row in the [Total Including Tax] column. A calculated measure is required to show a single value that represents a sum of every row in this column.</p><p class="simplepara" id="calibre_link-468">In Power BI, you can create a calculated measure using the ribbon, or by right-clicking the table name in the Report View or Data View. This presents an area below the ribbon where you can type the DAX <span id="calibre_link-469">code

</span> for your calculation. The text for this calculated measure should be</p><div class="para1" id="calibre_link-470">
              <div class="programcode" id="calibre_link-471"><div class="fixedline">Sum of Total including Tax = SUM('Fact Sales'[Total Including Tax])</div></div>
            </div><div class="para1" id="calibre_link-472">This should look as it does in Figure <span><a href="#calibre_link-180" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-2</a></span>.<figure class="figure1" id="calibre_link-180"><div class="mediaobject" id="calibre_link-473"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig2_HTML.jpg" src="images/000040.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-2</span><p class="simplepara1">DAX for the first calculated measure. This calculation uses the SUM function to return a single value anywhere the calculated measure is used in the report. When dragged and dropped to the report canvas using a visual with no other fields or filters, the value should show as $198,043,493.45.</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-474">The structure of the formula can be broken down as follows: starting from the left, the first part of the text sets the name of the calculated measure. In this case, the name is determined by all text to the left of the = operator. The name of this calculated measure is [Sum of Total including Tax]. Names of calculated measures should be unique across the model including column names<span id="calibre_link-475">
                
                
              </span>.</p><p class="simplepara" id="calibre_link-476">This name is how you will see the measure appear in the field list as well as how it may show in some visuals and charts.</p><div class="formalpara" id="calibre_link-477"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-478">Spaces between words are recommended when creating names for calculated measures and columns. Avoid naming conventions that use the underscore character or remove spaces altogether. Use natural language as much as possible. Use names that are brief and descriptive. This will be especially helpful for Power BI features such as Q&amp;A.</p></div><p class="simplepara" id="calibre_link-479">The = sign separates the calculation name from the calculation itself. A calculated measure can only return a single value and never a list or table of values. In more advanced scenarios, steps involving groups of values can be used, but the result must be a single value.</p><p class="simplepara" id="calibre_link-480">All text after the = sign is the DAX code for the calculated measure. This calculation uses the <span id="calibre_link-481">SUM function

</span> and a single parameter, which is a reference to a column. The single number value that is returned by the SUM function represents values from every row from the [Total Including Tax] column added together. The datatype for the column passed to the SUM function needs to be numeric and cannot be either the Text or DateTime datatypes.</p><p class="simplepara" id="calibre_link-482">The notation for the column reference is <span id="calibre_link-483">
                <em class="emphasistypeitalic">fully qualified</em>
                
                
              </span>, meaning it contains both the name of the table and name of the column. The table name is encapsulated inside single quotations (‘ ’). This is optional when your table name doesn’t contain spaces. The column name is encapsulated inside square brackets ([ ]).</p><p class="simplepara" id="calibre_link-484">Calculated measures belong to a single table but you can move them to a new home table using the Home Table option on the Modeling tab. Calculated measures produce the same result regardless of which home table they reside on.</p><div class="formalpara" id="calibre_link-485"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-486">When making references to other calculated measures in calculations, never prefix them with the table name. However, you should always include the name of a table when referencing a column.</p></div></section><section class="section" id="calibre_link-69"><h3 class="heading">
              <span id="calibre_link-487">IntelliSense
</span>
            </h3><p class="simplepara" id="calibre_link-488"><em class="emphasistypeitalic">IntelliSense</em> is a form of predictive text for programmers. Most modern programming development environments offer some form of IntelliSense to help guide you as you write your code. If you haven’t encountered this before, it is an incredibly useful way to help avoid syntax errors and keep calculations well-formed.</p><p class="simplepara" id="calibre_link-489">DAX is no different, and as you start typing your calculation, you should notice suggestions appearing as to what you might type next. Tooltips provide short descriptions about functions along with details on what parameters might be required.</p><p class="simplepara" id="calibre_link-490">IntelliSense also helps you ensure you have symmetry with your brackets, although this can sometimes be confusing if you are not aware it is happening.</p><p class="simplepara" id="calibre_link-491">IntelliSense suggestions can take the form of relevant functions, or tables or columns that can be used by the current function. IntelliSense is smart enough to only offer suggestions valid for the current parameter. It does not offer tables to a parameter that only accepts columns.</p><p class="simplepara" id="calibre_link-492">In the case of our formula, when we type in the first bracket of the SUM function, IntelliSense offers suggestions of columns that can be used. It does not offer tables or calculated measures as options because the SUM function is only designed to work with columns.</p></section></section><section class="section" id="calibre_link-70"><h2 class="heading">Formatting</h2><p class="simplepara" id="calibre_link-493">As with T-SQL and pretty much any programming language, making practical use of line spacing, carriage returns, and tabs greatly improves readability and, more importantly, understanding of the code used in the calculation. Although it’s possible to construct a working calculation using complex code on just a single line, it is difficult to maintain. Single-line calculations also lead to issues playing the <span id="calibre_link-494">
              <em class="emphasistypeitalic">bracket game</em>
              
            </span>.</p><div class="formalpara" id="calibre_link-495"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-496">The <em class="emphasistypeitalic">bracket game</em> is where you try to correctly pair open/close brackets in your formula to produce the correct result. Failure to pair properly means you lose the game and your formula doesn’t work.</p></div><p class="simplepara" id="calibre_link-497">A good tip is to extend the viewable area where you edit your calculation before you start by repeating the Shift-Enter key combination multiple times or by clicking the down arrow on the right-hand side.</p><section class="section" id="calibre_link-71"><h3 class="heading">Comments</h3><div class="bookfrontmatter" id="calibre_link-498">
<span id="calibre_link-499">Comments

</span> can also be added to any DAX calculation using any of the techniques in Table <span><a href="#calibre_link-181" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-1</a></span>.<div class="table" id="calibre_link-181"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 1-1</span><p class="para3">How to Add Comments</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Comment Characters</p></th><th class="calibre14"><p class="simplepara2">Effect</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">//</p></td><td class="calibre16"><p class="simplepara2">Text to the right is ignored by DAX until the next carriage return.</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">--</p></td><td class="calibre16"><p class="simplepara2">Text to the right is ignored by DAX until the next carriage return.</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">/* */</p></td><td class="calibre16"><p class="simplepara2">Text between the two stars is ignored by DAX and comments can span multiple lines.</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-500">Examples of ways you can add comments are shown in Figure <span><a href="#calibre_link-182" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-3</a></span> as is an example of how spacing DAX over multiple lines helps increase readability.</p><div class="para1" id="calibre_link-501">By formatting code and adding comments you help to make the logic and intent of the function easier to understand and interpret for anyone looking at the calculation later.<figure class="figure1" id="calibre_link-182"><div class="mediaobject" id="calibre_link-502"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig3_HTML.jpg" src="images/000083.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-3</span><p class="simplepara1">Commented text styles and usage of line breaks</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-503">A nice alternative to the formula bar in Power BI <span id="calibre_link-504">Desktop

</span> and SSAS Tabular, is DAX Studio, which is a free product full of features designed to help you develop and debug your calculations. I provide a more detailed look at DAX Studio in Chapter <span><a href="#calibre_link-160" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>8</span></a></span>.</p></section></section><section class="section" id="calibre_link-72"><h2 class="heading">Your Second DAX Calculation</h2><p class="simplepara" id="calibre_link-505">In this second example, I create a <span id="calibre_link-506">calculated column
</span>
<span id="calibre_link-507">
              
              
            </span> as opposed to a calculated measure. A Chapter <span><a href="#calibre_link-168" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>9</span></a></span> provides more detailed advice on when you should consider using a calculated column instead of a calculated measure, but in short, a calculated column adds a column in an existing table in which the values are generated using a DAX formula.</p><p class="simplepara" id="calibre_link-508">A simple calculation might use values from other columns in the same row. This example uses two columns from the ‘Fact Sale’ table to perform a simple division to return a value that represents an average unit price.</p><div class="para1" id="calibre_link-509">To add this calculation to your data model, select the ‘Fact Sale’ table in the Fields menu so it is highlighted. Then use the New Column button on the Modeling tab and enter the text shown in Figure <span><a href="#calibre_link-183" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-4</a></span>.<figure class="figure1" id="calibre_link-183"><div class="mediaobject" id="calibre_link-510"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig4_HTML.jpg" src="images/000058.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-4</span><p class="simplepara1">A calculated column for [Average Item Price]</p></div></figcaption></figure>
</div><div class="formalpara" id="calibre_link-511"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-512">This formula works without the table name preceding each column name; however, it is highly recommended that whenever you reference a column, you always include the table name. This makes it much easier to differentiate between columns and measures when you are debugging longer DAX queries.</p></div><div class="bookfrontmatter" id="calibre_link-513">The code in Figure <span><a href="#calibre_link-183" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-4</a></span> adds a new column to the ‘Fact Sale’ table called [Average Item Price]. The value in each cell of the new column (see Figure <span><a href="#calibre_link-184" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-5</a></span>) is the output of this calculation when it is executed once for every row in the table.<figure class="figure1" id="calibre_link-184"><div class="mediaobject" id="calibre_link-514"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig5_HTML.jpg" src="images/000047.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-5</span><p class="simplepara1">Sample of data for new <span id="calibre_link-515" class="calibre9">calculated column

</span>
<span id="calibre_link-516" class="calibre9">
                      
                    </span>
</p></div></figcaption></figure>
</div></section><section class="section" id="calibre_link-73"><h2 class="heading">Your Third DAX Calculation</h2><p class="simplepara" id="calibre_link-517">This last example creates a <span id="calibre_link-518">calculated table
</span>
<span id="calibre_link-519">
              
              
            </span>. This option is only available in Power BI Desktop and SSAS Tabular, not in PowerPivot for Excel 2016 (or earlier).</p><div class="para1" id="calibre_link-520">You can create calculated tables using any DAX function that returns a table or by simply referencing another table in the model. The simplest syntax allows you to create a clone of another DAX table. The example shown in Figure <span><a href="#calibre_link-185" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-6</a></span> creates a new calculated table called ‘Dates2’, which is a full copy of the ‘Dates’ table. Modifications made to the ‘Dates’ table, such as adding or modifying columns, automatically flow through to the ‘Dates2’ table.<figure class="figure1" id="calibre_link-185"><div class="mediaobject" id="calibre_link-521"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig6_HTML.jpg" src="images/000063.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-6</span><p class="simplepara1">Creating a calculated table</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-522">Filters, measures, columns, and relationships can be added to the ‘Dates2’ table without effecting ‘Dates’ table. The beauty of this is that because the base table (‘Dates’) is reading from a physical data source, any changes to data in the ‘Dates’ table are reflected in the ‘Dates2’ <span id="calibre_link-523">table

</span>
<span id="calibre_link-524">
              
            </span>.</p><div class="para1" id="calibre_link-525">To extend the example so the new table only shows some rows from the original table, you can use the <span id="calibre_link-526">FILTER function
</span> as shown in Figure <span><a href="#calibre_link-186" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-7</a></span>.<figure class="figure1" id="calibre_link-186"><div class="mediaobject" id="calibre_link-527"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig7_HTML.jpg" src="images/000009.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-7</span><p class="simplepara1">Calculated table created using FILTER</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-528">The ‘Dates2’ calculated table still has the same number of columns as ‘Dates’, but it only has rows that match the filter expression. This results in the ‘Dates2’calculated table having 365 rows that represent a row per day for the calendar year of 2016.</p><p class="simplepara" id="calibre_link-529">It is common to use calculated tables to create summary tables that can be used as faster alternatives for calculated measures. Using calculated tables to produce an aggregated version of a sales table can provide considerable performance gains for any calculation using the aggregated version.</p><section class="section" id="calibre_link-74"><h3 class="heading">The CALENDARAUTO Function</h3><p class="simplepara" id="calibre_link-530">A handy DAX function that generates a calculated table without using an existing table is the CALENDARAUTO <span id="calibre_link-531">function
</span>. This function returns a table with a single column called [Date]. When called, the CALENDARAUTO function inspects every table in the model looking for columns that use either the Date or DateTime datatype.</p><p class="simplepara" id="calibre_link-532">The oldest and newest date values that appear in any column using these datatypes are used to generate a row for every day between the oldest and newest values. The dates are rounded to the start and end of the calendar year.</p><div class="para1" id="calibre_link-533">
<span id="calibre_link-534">Date tables
</span> are invaluable for data models, particularly when you add measures designed to show period comparison and running totals accurately. There are several DAX functions that allow you to add time-intelligence logic to your model. These often rely on a date table that has contiguous dates to work properly. In the WideWorldImportersDW <span id="calibre_link-535">dataset
</span>, no rows exist in the ‘Fact Sale’ table with an [Invoice Date Key] that falls on a Sunday. This might cause problems for some functions when they are processing period comparison logic. Date/Calendar tables help make calculations behave more reliably when there are gaps in dates in non-date table data.<figure class="figure1" id="calibre_link-187"><div class="mediaobject" id="calibre_link-536"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig8_HTML.jpg" src="images/000026.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-8</span><p class="simplepara1">A sample output of the CALENDARAUTO function</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-537">Once you create a calculated table using the CALENDARAUTO function as shown in Figure <span><a href="#calibre_link-187" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-8</a></span>, you can start adding calculated columns and measures to it. You can also start creating one-to-many relationships to other tables in your model.</p></section></section><section class="section" id="calibre_link-75"><h2 class="heading">Datatypes</h2><div class="bookfrontmatter" id="calibre_link-538">In DAX, it is possible to define datatypes for individual columns. The different datatypes are listed momentarily in Table <span><a href="#calibre_link-188" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-2</a></span> and fall into three main <span id="calibre_link-539">categories

</span>, with the exception of True/False (Boolean).<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-540">Text</p></li><li class="calibre8"><p class="para2" id="calibre_link-541">Numeric</p></li><li class="calibre8"><p class="para2" id="calibre_link-542">DateTime</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-543">By select the best datatype, you help reduce the size of your model as well as improve performance when refreshing data and using your report.</p><p class="simplepara" id="calibre_link-544">When importing new data, the data modeling engine guesses at what the datatype for each column should be. This is something worth checking on as there may be opportunities to adjust to make sure that appropriate data types are used for each column.</p><div class="para1" id="calibre_link-545">Another factor to be aware of is that although your data source may produce numeric data at the time you author your model, at some point in the future, it may start to include nonnumeric data that will cause errors during a data refresh. This is more likely to happen when a data source provides few suggestions as to the best datatype (for example, CSV format).<div class="table" id="calibre_link-188"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 1-2</span><p class="para3">
                    <em class="emphasistypeitalic">Datatypes</em>
                    <span id="calibre_link-546">
                      <em class="emphasistypeitalic">in DAX</em>
                      
                      
                    </span>
                  </p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Datatype</p></th><th class="calibre14"><p class="simplepara2">Stored As</p></th><th class="calibre14"><p class="simplepara2">Valid Values</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Whole Number</p></td><td class="calibre16"><p class="simplepara2">64-bit integer</p></td><td class="calibre16"><p class="simplepara2">Signed integer between &ndash;9,223,372,036,854,755,808 and + 9,223,372,036,854,755,808.</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Decimal Number</p></td><td class="calibre16"><p class="simplepara2">64-bit real number</p></td><td class="calibre16"><p class="simplepara2">A mixture of real and decimal numbers ranging between &ndash;1.79E + 308 and &ndash;2.23E &ndash;308. Only 15 significant digits return a precise result. Values outside these calculate and return approximate results.</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Fixed Decimal/Currency</p></td><td class="calibre16"><p class="simplepara2">64-bit real number</p></td><td class="calibre16"><p class="simplepara2">The same as for Decimal Number but fixed to four decimal places.</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Date/Time</p></td><td class="calibre16"><p class="simplepara2">64-bit double-floating</p></td><td class="calibre16"><p class="simplepara2">1<sup class="calibre18">st</sup> January 100AD to 31<sup class="calibre18">st</sup> December 9999AD.</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">True/False</p></td><td class="calibre16">&nbsp;</td><td class="calibre16">&nbsp;</td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Text</p></td><td class="calibre16"><p class="simplepara2">Unicode (two bytes per character)</p></td><td class="calibre16"><p class="simplepara2">The maximum string length is 268,435,456 Unicode characters.</p></td></tr></tbody></table></div>
</div><section class="section" id="calibre_link-76"><h3 class="heading">The Whole Number Datatype</h3><p class="simplepara" id="calibre_link-547">The <span id="calibre_link-548">Whole Number datatype
</span>
<span id="calibre_link-549">
                
                
              </span>, as the name suggests, allows you to store and manipulate data in the form of positive or negative integers. Any decimal component is removed and arithmetic using whole number values returns a whole number and not a value of another datatype.</p><div class="para1" id="calibre_link-550">
              <div class="programcode" id="calibre_link-551"><div class="bookfrontmatter"><div class="fixedline1">VAR WholeNumberA = 3</div><div class="fixedline1">VAR WholeNumberB = 2</div><div class="fixedline1">RETURN DIVIDE( WholeNumberA, WholeNumberB ) // will be stored as 1.5</div></div></div>
            </div><div class="formalpara" id="calibre_link-552"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-553">When performing a division calculation, use the DIVIDE function rather than the / operator. Use DIVIDE (3, 2) instead of 3 / 2. This handles cases with a divide-by-zero error more elegantly.</p></div></section><section class="section" id="calibre_link-77"><h3 class="heading">The <span id="calibre_link-554">Decimal and Fixed Decimal Number Datatype

</span>
</h3><p class="simplepara" id="calibre_link-555">Decimal <span id="calibre_link-556">numbers
</span> use 64 bits of storage per value and can represent a wide range of values that either represent a large integer component with a small decimal component or vice versa.</p><p class="simplepara" id="calibre_link-557">You can store extremely large or small numbers using this datatype and then perform calculations. However, when using this datatype, be aware that with extremely large values, results can be imprecise (not exact).</p><p class="simplepara" id="calibre_link-558">The following exercise shows values that are stored but not displayed, except for the 15 most significant digits.</p><section class="section" id="calibre_link-559"><h4 class="heading2">Calculations on <span id="calibre_link-560">REAL Numbers
</span>
<span id="calibre_link-561">
                  
                  
                </span>
</h4><p class="simplepara" id="calibre_link-562">The first example creates a calculated measure using the following code:</p><div class="para1" id="calibre_link-563">
                <div class="programcode" id="calibre_link-564"><div class="fixedline">Measure1 = 100000000000000000 + 50</div></div>
              </div><p class="simplepara" id="calibre_link-565">In this code, 17 zeros following the 1 and the calculation returns the value of 100000000000000000. Note that nothing has changed despite the addition of the value of 50. I understand that the considerable number of zeros might make you go cross-eyed, but let me assure that there are 17 zeros.</p><p class="simplepara" id="calibre_link-566">Now create a second calculated <span id="calibre_link-567">measure
</span>
<span id="calibre_link-568">
                  
                  
                </span> that makes a reference to the first as follows:</p><div class="para1" id="calibre_link-569">
                <div class="programcode" id="calibre_link-570"><div class="fixedline">Measure2 = [Measure1] + 50</div></div>
              </div><p class="simplepara" id="calibre_link-571">This returns 100000000000000100&mdash;a 1, 14 zeros, a 1, and then two more zeros.</p><p class="simplepara" id="calibre_link-572">If your number has a large integer component, such as the top rows shown in Figure <span><a href="#calibre_link-189" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-9</a></span>, DAX allows less precision on the fractional side. The maximum number of digits total on either side of the decimal point is 15.</p><div class="para1" id="calibre_link-573">The integer side takes priority, so if you have a value with 12 integer places and 12 decimal places, DAX will automatically round the decimal to 3 places.<figure class="figure1" id="calibre_link-189"><div class="mediaobject" id="calibre_link-574"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig9_HTML.jpg" src="images/000074.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-9</span><p class="simplepara1">Data formatting</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-575">Fixed Decimal (or Currency) uses the Decimal datatype, however the fractional component is locked to 4 places. You should show preference for this datatype when you are working with money or currency data. Arithmetic performed using this datatype should yield results that are acceptable for financial reports, particularly regarding rounding and truncation.</p></section></section><section class="section" id="calibre_link-78"><h3 class="heading">Date and <span id="calibre_link-576">DateTime

</span>
</h3><p class="simplepara" id="calibre_link-577">There are two <span id="calibre_link-578">date-based datatypes
</span> available to choose from when you are working with date-based data. The difference between Date and DateTime is, as the names suggest, that DateTime can represent values that include hour, minute, second, and millisecond, whereas Date does not.</p><p class="simplepara" id="calibre_link-579">It is possible to compare and match values that are both Date and DateTime, however, only values of DateTime that are midnight can match a value of Date from the same day. This can sometimes trip up inexperienced users when they are creating relationships between tables in which one side of the relationship uses a Date datatype while the other uses DateTime. If the table using DateTime has a value such as ‘2018-01-01 10:30:00’, it never finds a matching record in the table using the Date datatype. No error is thrown.</p><p class="simplepara" id="calibre_link-580">If you need to generate a specific date in DAX, you can use the DATE function, which takes three parameters (year, month, day). <span class="emphasisfontcategorynonproportional">DATE( 2018, 5, 1)</span> returns a date that represents May 1, 2018.</p></section><section class="section" id="calibre_link-79"><h3 class="heading">Time</h3><p class="simplepara" id="calibre_link-581">You can use the <span id="calibre_link-582">Time datatype
</span>
<span id="calibre_link-583">
                
                
              </span> to represent specific points in time in a day. These values can be “2:37 pm” or “10:30 am” and can be added or combined to make time-based calculations.</p><div class="para1" id="calibre_link-584">
              <div class="programcode" id="calibre_link-585"><div class="fixedline">TIME(1,0,0) + "03:00:00"</div></div>
            </div><p class="simplepara" id="calibre_link-586">The preceding calculation shows two different notations of a Time value being added. It is adding 1 hour to a value that represents 3 am. The result is4 am.</p><p class="simplepara" id="calibre_link-587">Values that use the Time datatype are still stored as a full DateTime and use December 30, 1899, for the year, month, and day components. Functions that use Time typically ignore the year, month, and day.</p></section></section><section class="section" id="calibre_link-80"><h2 class="heading">Operators</h2><div class="bookfrontmatter" id="calibre_link-588">These are the four sets of operators in DAX:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-589">Arithmetic</p></li><li class="calibre8"><p class="para2" id="calibre_link-590">Comparison</p></li><li class="calibre8"><p class="para2" id="calibre_link-591">Concatenation</p></li><li class="calibre8"><p class="para2" id="calibre_link-592">Logical</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-593">There are no bitwise operators in DAX. Bitwise calculations can be performed using functions rather than operators.</p><section class="section" id="calibre_link-81"><h3 class="heading">
              <span id="calibre_link-594">Arithmetic Operators
</span>
              <span id="calibre_link-595">
                
                
              </span>
            </h3><div class="bookfrontmatter" id="calibre_link-596">Table&nbsp;<span><a href="#calibre_link-190" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-3</a></span> shows the arithmetic operators available in DAX.<div class="table" id="calibre_link-190"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 1-3</span><p class="para3">DAX Atrithmetic Operators</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Operator</p></th><th class="calibre14"><p class="simplepara2">Effect</p></th><th class="calibre14"><p class="simplepara2">Example</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">+</p></td><td class="calibre16"><p class="simplepara2">Addition</p></td><td class="calibre16"><p class="simplepara2">2 + 2 = 4</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">&ndash;</p></td><td class="calibre16"><p class="simplepara2">Subtraction</p></td><td class="calibre16"><p class="simplepara2">10&nbsp;&ndash; 4 = 6</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">*</p></td><td class="calibre16"><p class="simplepara2">Multiplication</p></td><td class="calibre16"><p class="simplepara2">4 * 5 = 20</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">/</p></td><td class="calibre16"><p class="simplepara2">Division</p></td><td class="calibre16"><p class="simplepara2">8 / 2 = 4</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">^</p></td><td class="calibre16"><p class="simplepara2">Exponents</p></td><td class="calibre16"><p class="simplepara2">2 ^ 4 = 16</p></td></tr></tbody></table></div>
</div></section><section class="section" id="calibre_link-82"><h3 class="heading">
              <span id="calibre_link-597">Comparison Operators
</span>
              <span id="calibre_link-598">
                
                
              </span>
            </h3><div class="bookfrontmatter" id="calibre_link-599">The operators in Table <span><a href="#calibre_link-191" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-4</a></span> return true or false when used to compare two values. Values on either side of the operator can be Text, Numeric, or DateTime.<div class="table" id="calibre_link-191"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 1-4</span><p class="para3">DAX Comparison Operators</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Operator</p></th><th class="calibre14"><p class="simplepara2">Effect</p></th><th class="calibre14"><p class="simplepara2">Example</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">=</p></td><td class="calibre16"><p class="simplepara2">Equal to</p></td><td class="calibre16"><p class="simplepara2">Sales[Qty] = 10</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">&lt;</p></td><td class="calibre16"><p class="simplepara2">Less than</p></td><td class="calibre16"><p class="simplepara2">Sales[Qty] &lt; 10</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">&gt;</p></td><td class="calibre16"><p class="simplepara2">Greater than</p></td><td class="calibre16"><p class="simplepara2">Sales[Price] &gt; 20</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">&lt;=</p></td><td class="calibre16"><p class="simplepara2">Less than or equal to</p></td><td class="calibre16"><p class="simplepara2">Dates[Date] &lt;= TODAY ()</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">&gt;=</p></td><td class="calibre16"><p class="simplepara2">Greater than or equal to</p></td><td class="calibre16"><p class="simplepara2">[Total] &gt;= 200</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">&lt;&gt;</p></td><td class="calibre16"><p class="simplepara2">Not equal to</p></td><td class="calibre16"><p class="simplepara2">[Animal] &lt;&gt; “Cat”</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-600">If you compare a number to a text <span id="calibre_link-601">value
</span>
<span id="calibre_link-602">
                
                
              </span>, for example, 1 = “1”, you receive an error. In this case, you can convert the numeric 1 to a string using the FORMAT function, or you can convert the “1” value to a number using the VALUE function.</p></section><section class="section" id="calibre_link-83"><h3 class="heading">
              <span id="calibre_link-603">Concatenation Operator
</span>
              <span id="calibre_link-604">
                
                
              </span>
            </h3><div class="bookfrontmatter" id="calibre_link-605">The operator used for concatenating text values is shown (Table <span><a href="#calibre_link-192" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-5</a></span>).<div class="table" id="calibre_link-192"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 1-5</span><p class="para3">DAX Concatenation Operator</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Operator</p></th><th class="calibre14"><p class="simplepara2">Effect</p></th><th class="calibre14"><p class="simplepara2">Examples</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">&amp;</p></td><td class="calibre16"><p class="simplepara2">Concatenates values</p></td><td class="calibre16"><p class="simplepara2">“ABC” &amp; “DEF” = “ABCDEF”</p></td></tr><tr class="calibre17"><td class="calibre16">&nbsp;</td><td class="calibre16">&nbsp;</td><td class="calibre16"><p class="simplepara2">1 &amp; 2 = “12”</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-606">In the “1 &amp; 2” example, both values are implicitly converted to text with the output being a text value.</p></section><section class="section" id="calibre_link-84"><h3 class="heading">
              <span id="calibre_link-607">Logical Operators
</span>
              <span id="calibre_link-608">
                
                
              </span>
            </h3><div class="bookfrontmatter" id="calibre_link-609">Table&nbsp;<span><a href="#calibre_link-193" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-6</a></span> show logical operators in DAX.<div class="table" id="calibre_link-193"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 1-6</span><p class="para3">DAX Logical Operators</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Operator</p></th><th class="calibre14"><p class="simplepara2">Effect</p></th><th class="calibre14"><p class="simplepara2">Example</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">&amp;&amp;</p></td><td class="calibre16"><p class="simplepara2">Logical AND</p></td><td class="calibre16"><p class="simplepara2">(1=1) &amp;&amp; (2=2) = true</p><p class="simplepara2">((1=1) &amp;&amp; (2=3) = false</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">||</p></td><td class="calibre16"><p class="simplepara2">Logical OR</p></td><td class="calibre16"><p class="simplepara2">(1=1) || (2=2) = true</p><p class="simplepara2">(1=1) || (2=3) = true</p><p class="simplepara2">(1=2) || (2=3) = false</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">IN</p></td><td class="calibre16"><p class="simplepara2">Logical OR</p></td><td class="calibre16"><p class="simplepara2">Location[Country] IN (“UK”,“USA”,“Canada”)</p></td></tr></tbody></table></div>
</div></section><section class="section" id="calibre_link-85"><h3 class="heading">Operator <span id="calibre_link-610">Precedence

</span>
</h3><div class="bookfrontmatter" id="calibre_link-611">Once you have the correct operator, you also need to consider the order in which to apply operators. Table <span><a href="#calibre_link-194" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-7</a></span> shows the order of operator precedence in DAX.<div class="table" id="calibre_link-194"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 1-7</span><p class="para3">Operator Precedence</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Operator</p></th><th class="calibre14"><p class="simplepara2">Effect</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">^</p></td><td class="calibre16"><p class="simplepara2">Exponent</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">&ndash;</p></td><td class="calibre16"><p class="simplepara2">Sign (positive or negative)</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">* /</p></td><td class="calibre16"><p class="simplepara2">Multiplication and division</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">!</p></td><td class="calibre16"><p class="simplepara2">NOT</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">+ &ndash;</p></td><td class="calibre16"><p class="simplepara2">Addition and subtraction</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">&amp;</p></td><td class="calibre16"><p class="simplepara2">Concatenation</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">= &lt; &gt; &lt;= &gt;= &lt;&gt;</p></td><td class="calibre16"><p class="simplepara2">Comparison</p></td></tr></tbody></table></div>
</div><div class="para1" id="calibre_link-612">You can use parentheses to override the operator precedence if you need to as shown in the examples in Table <span><a href="#calibre_link-195" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-8</a></span>. In the example on the second row, the addition takes place before the <span id="calibre_link-613">multiplication

</span>, producing a different result than the first row. In the example on the bottom row, the parentheses make the sign operator take precedence over the exponent operator.<div class="table" id="calibre_link-195"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 1-8</span><p class="para3">Examples of Operator Precedence</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Calculation</p></th><th class="calibre14"><p class="simplepara2">Result</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">2 * 3 + 4</p></td><td class="calibre16"><p class="simplepara2">10</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2 * (3 + 4)</p></td><td class="calibre16"><p class="simplepara2">14</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">&ndash;2 ^ 2</p></td><td class="calibre16"><p class="simplepara2">&ndash;4</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">(&ndash;2) ^ 2</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-614">DAX attempts to implicitly convert two sides of an operator to the same datatype where possible. This cannot be guaranteed in all cases. So, for instance, 1 + “2” results in an error whereas 1 &amp; “2” results in the text value of “12”.</p></section></section><section class="section" id="calibre_link-86"><h2 class="heading">Relationships</h2><p class="simplepara" id="calibre_link-615"><em class="emphasistypeitalic">Relationships</em> are rules in DAX that define how two tables can be associated. There are two main reasons to create <span id="calibre_link-616">relationships

</span>. The first is to allow filter selections made on one table to automatically filter rows on another table via the <span id="calibre_link-617">relationship

</span>. The other is to allow calculations to use values from rows in different tables and to understand how rows should be connected.</p><section class="section" id="calibre_link-87"><h3 class="heading">Types of <span id="calibre_link-618">Relationships

</span>
</h3><p class="simplepara" id="calibre_link-619">
<span id="calibre_link-620">Relationships


</span> can be defined as <em class="emphasistypeitalic">one-to-many</em> or <em class="emphasistypeitalic">one-to-one</em> but always use a single column from each table in the relationship. When you add a relationship between two tables, the column involved on one side of the relationship must have unique values. If duplicate data is detected during a data load or refresh, an error occurs telling you that you can’t create a relationship between the two columns because the columns must have unique values.</p><section class="section" id="calibre_link-621"><h4 class="heading2">Relationships <span id="calibre_link-622">for Filtering

</span>
</h4><p class="simplepara" id="calibre_link-623">The <span id="calibre_link-624">WideWorldImportersDW dataset
</span> contains several fact tables that each have one or more date-based columns. The dataset also contains a table called Dimension.Date, which has one row per day between January 1, 2013, and December 31, 2016. The date table contains 14 columns useful for grouping and filtering.</p><p class="simplepara" id="calibre_link-625">Once you import these tables to the model, you can add relationships between pairs of tables that allow report-based filters to make any selection on the table on the one side flow through and filter rows on the related table.</p><p class="simplepara" id="calibre_link-626">
<span id="calibre_link-627">Filters
</span> only flow across relationships in one direction. A filter selection made to a column in a table on the many side of a relationship will not filter rows in the table on the one side. Filters can flow down through multiple sets of relationships, but always in the direction of one to many.</p><p class="simplepara" id="calibre_link-628">This means that if you add any field from the date table to a report visual or filter, any selection you make using these visuals or filters propagates to related tables and triggers measures to recalculate using the new filter settings.</p><p class="simplepara" id="calibre_link-629">Figure&nbsp;<span><a href="#calibre_link-196" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-10</a></span> shows a relationship between the ‘Dimension Date’ table and the ‘Fact Sale’ <span id="calibre_link-630">table

</span>. The column used on the ‘Dimension Date’ (one) side is [Date], whereas the column used on the ‘Fact Sale’ (many) side is [Invoice Date Key]. Both columns use the Date datatype.</p><div class="para1" id="calibre_link-631">With this relationship in effect, drag the [Calendar Year] column from ‘Dimension Date’ to the report canvas and turn it into a slicer visual. The slicer shows distinct values from the <span id="calibre_link-632">column

</span>, which are 2013, 2014, 2015, and 2016. Any selection of one or more of these values flows down and is applied to any related table. If 2014 is selected in the slicer, calculations used by visuals based on columns in related tables automatically recompute and produce new values that consider the updated filtering on the ‘Dimension Date’ <span id="calibre_link-633">table

</span>.<figure class="figure1" id="calibre_link-196"><div class="mediaobject" id="calibre_link-634"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig10_HTML.jpg" src="images/000073.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-10</span><p class="simplepara1">The relationship between ‘Dimension Date’ and ‘Fact Sale’</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-635">
<span id="calibre_link-636">Power BI Desktop

</span> has a feature that can automatically detect relationships when you add new tables to your model. If a new table contains a column that shares the same name and datatype to a column in another table, a relationship may be added for you. This can be helpful, but it is always good to double check what relationships have been added for you and if these are indeed useful.</p><p class="simplepara" id="calibre_link-637">A good tip I picked up from my good friend Matt Allington is to organize tables in the Relationship View so tables on the one side are positioned higher than tables on the many side. This helps visually reinforce the trickle-down nature of filtering through relationships. It becomes harder when you have many tables in your data model, but it’s a tip well worth applying for smaller models.</p></section><section class="section" id="calibre_link-638"><h4 class="heading2">Relationships in Calculations</h4><p class="simplepara" id="calibre_link-639">The other way you can take advantage of relationships is through the DAX functions RELATED and RELATEDTABLE. These functions allow calculations to use data from rows from different, but related tables. This means you can add a calculated column to a table that shows a value using data from a parent or child table. The RELATED function allows calculations to tunnel up to data in a table on the one side from the many side, whereas RELATEDTABLE provides access to data from a table on the many side to a calculation on the one side.</p><p class="simplepara" id="calibre_link-640">A pair of tables can have more than one relationship <span id="calibre_link-641">defined

</span>, but only one can be marked as the active relationship at any one time. Active <span id="calibre_link-642">relationships

</span> are used by default by filters and calculations. Relationships that are not active can be used in calculations, but they need to be specifically referenced using the USERELATIONSHIP filter function.</p><p class="simplepara" id="calibre_link-643">Although it is possible to make your table/relationship mirror that of an OLTP, it is far better to study and learn some BI methodology, such as using a star schema to organize your data. This is especially useful once the row counts in your tables grow to large values.</p><p class="simplepara" id="calibre_link-644">It’s also possible to define multiple relationships between two tables and control the cross-filter direction. These concepts are covered in more detail in the chapter on DAX relationships (Chapter <span><a href="#calibre_link-122" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>5</span></a></span>).</p></section></section></section><section class="section" id="calibre_link-88"><h2 class="heading">Hierarchies</h2><p class="simplepara" id="calibre_link-645">
<span id="calibre_link-646">Hierarchies
</span> combine two or more columns from a table together as a level-based grouping. These can be added to your model by dragging a field and dropping it on another field from the same table. This creates a new entry in the field list with a special icon to show it is a hierarchy. The fields that represent the levels in the hierarchy appear slightly indented and can be reordered by dragging and dropping.</p><p class="simplepara" id="calibre_link-647">You can rename a hierarchy as well as individual levels. Renaming these has no impact on the columns used as source columns for the hierarchy.</p><div class="para1" id="calibre_link-648">In the example in Figure <span><a href="#calibre_link-197" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">1-11</a></span>, the [Calendar Month Label] field has been dragged and dropped onto the [Calendar Year] field, which creates a new hierarchy. The two levels and the hierarchy are then renamed, making each name shorter. Finally, a third level is added to the hierarchy by the [Day] field being dragged and dropped onto the hierarchy name. This adds the field as a new third level. It’s possible to reorder by dragging individual levels up or down the list.<figure class="figure1" id="calibre_link-197"><div class="mediaobject" id="calibre_link-649"><img alt="../images/456681_1_En_1_Chapter/456681_1_En_1_Fig11_HTML.jpg" src="images/000024.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-11</span><p class="simplepara1">A hierarchy in the ‘Dimension Date’ table</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-650">Not all Power <span id="calibre_link-651">BI
</span>
<span id="calibre_link-652">
              
              
            </span> visuals understand hierarchies, but most of the native visuals allow hierarchies to be used on an X or Y axis to provide drill-down functionality. You can obtain the same experience by dropping multiple individual fields to the same axis fields, but you have less ability to rename and customize the levels.</p></section></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-89">
<div id="calibre_link-653" class="calibre2">
<div id="calibre_link-654" class="calibre3"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-655"><div class="bookfrontmatter">©&nbsp;Philip Seamark&nbsp;2018</div><span class="pcalibre5"><span><span>Philip&nbsp;Seamark</span></span></span><span><span class="booktitle1" type="title" lang="en">Beginning DAX with Power BI</span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-3477-8_2" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">https://doi.org/10.1007/978-1-4842-3477-8_2</a></span></div></div><div class="maintitlesection"><h1 class="chaptertitle" lang="en">2.&nbsp;Variables</h1></div><div class="bookfrontmatter"><div class="bookfrontmatter"><span><span>Philip&nbsp;Seamark</span><sup class="calibre6"><a href="#calibre_link-198" class="pcalibre3 pcalibre4 pcalibre1 pcalibre2 pcalibre calibre7">1</a>&nbsp;<span class="contacticon"></span></sup></span></div><div class="bookfrontmatter"><div class="bookfrontmatter" id="calibre_link-198"><span class="affiliationnumber">(1)</span><div class="bookfrontmatter">UPPER HUTT, New Zealand</div></div><div class="clearboth">&nbsp;</div></div></div><div class="bookfrontmatter"><p class="para" id="calibre_link-656">This chapter looks at how you can use DAX variables to make calculations easier to understand and, in some cases, perform faster. Variables are used to store results from DAX expressions. These variables can be as simple as assigning a hardcoded value or the result of a complex DAX equation.</p><p class="simplepara" id="calibre_link-657">You can use variables in any type of DAX calculation including calculated columns, measures, and tables. <span id="calibre_link-658">Variables

</span> are not strictly typed and can represent any type of object in DAX. Variables automatically assume the type of the object being assigned. You must use a RETURN statement to close a layer of variable scope. You can declare multiple variables within the same layer of scope and you can use them with a single RETURN statement. <span id="calibre_link-659">Nested variables


</span>
<span id="calibre_link-660">
            
            
          </span> can initialize a new layer of scope when you use them anywhere within an expression, but all layers of scope are ended when you use a RETURN statement.</p><p class="simplepara" id="calibre_link-661">This is the basic structure of creating and using a <span id="calibre_link-662">variable

</span> in your DAX expression:</p><div class="para4" id="calibre_link-663">
          <div class="programcode" id="calibre_link-664"><div class="fixedline">VAR varname = <em class="emphasistypeitalic">expression</em>
</div><div class="fixedline">RETURN <em class="emphasistypeitalic">expression</em>
</div></div>
        </div><p class="simplepara" id="calibre_link-665">You can only assign variables once and cannot reassign them. The following code produces an <span id="calibre_link-666">error

</span>:</p><div class="para1" id="calibre_link-667">
          <div class="programcode" id="calibre_link-668"><div class="fixedline">VAR myVar = 1</div><div class="fixedline">myVar = myVar + 1</div></div>
        </div><p class="simplepara" id="calibre_link-669">The following example shows the basic structure of a formula using <span id="calibre_link-670">multiple DAX variables

</span>:</p><div class="para1" id="calibre_link-671">
          <div class="programcode" id="calibre_link-672"><div class="fixedline">VAR myVar1 = 1</div><div class="fixedline">VAR myVar2 = myVar1 + 2</div><div class="fixedline">RETURN myVar2 * 2</div></div>
        </div><section class="section" id="calibre_link-90"><h2 class="heading">Variable <span id="calibre_link-673">Structure

</span>
</h2><p class="simplepara" id="calibre_link-674">The keyword <span id="calibre_link-675">VAR

</span> denotes a new variable being declared. This is followed by the name of the variable. You cannot use spaces or encapsulate the variable name with square brackets or apostrophes to allow spaces like you can elsewhere in DAX. Another limitation on variable names is that you cannot use the names of tables or DAX keywords.</p><p class="simplepara" id="calibre_link-676">Finally, a DAX expression follows the = operator.</p><div class="para1" id="calibre_link-677">
            <div class="programcode" id="calibre_link-678"><div class="fixedline">VAR myVar1 = 1</div><div class="fixedline">VAR myVar2 = myVar1 + 2</div></div>
          </div><p class="simplepara" id="calibre_link-679">The first line of this example assigns the numeric value of 1 to a variable called myVar. The myVar variable is used in an expression on the following line to assign a value to the variable called myVar2. At this point, the variable myVar2 carries the number 3 because of the expression (1 + 2).</p><div class="para1" id="calibre_link-680">
            <div class="programcode" id="calibre_link-681"><div class="fixedline">RETURN myVar2 * 2</div></div>
          </div><p class="simplepara" id="calibre_link-682">The <span id="calibre_link-683">RETURN keyword
</span>
<span id="calibre_link-684">
              
              
            </span> must be used to output the result and can also use an expression. In this case, the result is the whole number 6. The RETURN keyword can only be used once per variable scope.</p><div class="formalpara" id="calibre_link-685"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-686">The RETURN keyword is used to return the value of any variable in the current scope. This can be useful when you’re debugging calculations with multiple variables. It does not have to return the last variable in the series.</p></div><p class="simplepara" id="calibre_link-687">A major benefit of using variables in DAX is code readability. In plenty of cases, you can simplify complex DAX formulas by adding variables. The following example shows an unformatted DAX expression that doesn’t use variables.</p><div class="para1" id="calibre_link-688">
            <div class="programcode" id="calibre_link-689"><div class="fixedline">Table =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;NATURALINNERJOIN(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;'Sales',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;TOPN(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZECOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales'[Product],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Revenue", SUM('Sales'[Total])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Revenue],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DESC))</div></div>
          </div><p class="simplepara" id="calibre_link-690">In the following code, the DAX expression is now formatted and rewritten to make use of variables. It produces the same result as the preceding code.</p><div class="para1" id="calibre_link-691">
            <div class="programcode" id="calibre_link-692"><div class="bookfrontmatter"><div class="fixedline1">Table =</div><div class="fixedline1">VAR InnerGroup =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZECOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Group BY --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales'[Product],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation Column --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Revenue", SUM('Sales'[Total])</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR Top10PRoducts =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;TOPN(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InnerGroup,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Revenue],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DESC</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">RETURN</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;NATURALINNERJOIN(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales',</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Top10PRoducts</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div></div>
          </div><p class="simplepara" id="calibre_link-693">Although this example is longer, breaking the code into smaller steps and formatting it makes it much easier to read and understand its logic.</p><section class="section" id="calibre_link-91"><h3 class="heading">Using Variables <span id="calibre_link-694">with Text

</span>
</h3><p class="simplepara" id="calibre_link-695">Variables can store text as well as numeric data. The variable inherits the type of the expression being assigned. This example joins the text from textVar1 and textVar2 to produce a new value that returns “Hello World”.</p><div class="para1" id="calibre_link-696">
              <div class="programcode" id="calibre_link-697"><div class="fixedline">My Measure =</div><div class="fixedline">VAR textVar1 = "Hello "</div><div class="fixedline">VAR textVar2 = "World"</div><div class="fixedline">RETURN CONCATENATE(textVar1,textVar2)</div></div>
            </div><p class="simplepara" id="calibre_link-698">You can use this technique with other DAX functions to create dynamic text-based measures that may change depending on the current filter context. Consider the following <span id="calibre_link-699">calculated measure

</span>
<span id="calibre_link-700">
                
                
              </span>:</p><div class="para1" id="calibre_link-701">
              <div class="programcode" id="calibre_link-702"><div class="fixedline">Sales Text =</div><div class="fixedline">VAR SalesQty = SUM('Fact Sale'[Quantity])</div><div class="fixedline">VAR Text1 = "This month we sold "</div><div class="fixedline">VAR Text2 = " Items"</div><div class="fixedline">VAR Result = IF(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SalesQty &gt; 0,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- THEN --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Text1 &amp; SalesQty &amp; Text2,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- ELSE --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"No sales this month"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">RETURN Result</div></div>
            </div><p class="simplepara" id="calibre_link-703">Here you assign the DAX SUM expression to the SalesQty variable. This is used later in the IF function to test for the existence of sales to determine the output message. Note the use of comments in the IF function to help clarify which code is being used to update the Result variable.</p><p class="simplepara" id="calibre_link-704">This also shows how you can use variables to improve performance. The SalesQty variable is potentially used twice in the IF function. If this formula was written without using variables, the IF function would make two calls to the underlying column and therefore take longer to arrive at the same result.</p><p class="simplepara" id="calibre_link-705">A similar function using text-based variables is one that generates a greeting calculated measure. Creating a calculated measure using the code in Listing <span><a href="#calibre_link-199" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">2-1</a></span> tests the current time of day and stores the hour of the day in the CurrentHour variable. This is then used in a SWITCH function to generate appropriate text to be stored in the GreetingText variable. This is then combined with other text to produce a measure that you can use as a dynamic greeting on your report.</p><div class="para1" id="calibre_link-199">
              <div class="programcode" id="calibre_link-706"><div class="fixedline">Greeting =</div><div class="fixedline">VAR CurrentHour = HOUR(NOW())</div><div class="fixedline">VAR GreetingText =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SWITCH(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TRUE(),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CurrentHour&lt;12,"Morning",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CurrentHour&lt;17,"Afternoon",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Evening"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Good " &amp; GreetingText &amp; ", " &amp; USERNAME()</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 2-1</span><p class="para3">Generating a Greeting Calculated Measure</p></div></div></div>
            </div></section><section class="section" id="calibre_link-92"><h3 class="heading">Using Variables in <span id="calibre_link-707">Calculated Columns

</span>
</h3><p class="simplepara" id="calibre_link-708">When you are using variables inside calculated <span id="calibre_link-709">columns

</span>
<span id="calibre_link-710">
                
                
              </span>, variables automatically have access to values in any column from the same row. When you use the ‘tablename’[columnname] notation during the assignment, the assumption is that the value used is from the same row.</p><p class="simplepara" id="calibre_link-711">This example uses variables to help create a new column that combines separate location values into a single piece of text in the new column. This type of column can be useful for some visuals that try to plot using text-based address data.</p><p class="simplepara" id="calibre_link-712">In this case, the DAX expression for the calculated column might look like this:</p><div class="para1" id="calibre_link-713">
              <div class="programcode" id="calibre_link-714"><div class="fixedline">City and Country =</div><div class="fixedline">VAR city = 'Dimension City'[City]</div><div class="fixedline">VAR country = 'Dimension City'[Country]</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;city &amp; ", " &amp; country</div></div>
            </div><div class="para1" id="calibre_link-715">In this block of code, you have declared two variables, city and country. The datatype inherited for these variables is Text and uses the &amp; operator to concatenate the variables together in the RETURN statement. A sample of the output once the calculated column has been added is shown in Figure <span><a href="#calibre_link-200" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">2-1</a></span>.<figure class="figure1" id="calibre_link-200"><div class="mediaobject" id="calibre_link-716"><img alt="../images/456681_1_En_2_Chapter/456681_1_En_2_Fig1_HTML.jpg" src="images/000031.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 2-1</span><p class="simplepara1">Sample output of new calculated column using variables</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-717">The result of the preceding code is a new column added to the table called [City and Country]. The values for each row are the result of concatenating text using other values from the same row. This is similar to what you’d expect when you are creating new columns in a table in Excel, or when you are creating a new column in a SELECT statement in <span id="calibre_link-718">SQL

</span> based on other values from the same row.</p><p class="simplepara" id="calibre_link-719">When you use variables in calculated columns, the final RETURN statement must return a single value. It cannot return a column or a table.</p></section><section class="section" id="calibre_link-93"><h3 class="heading">Using Variables in <span id="calibre_link-720">Calculated Measures

</span>
</h3><p class="simplepara" id="calibre_link-721">You can use variables to make calculations in calculated measures more readable and, in some cases, perform faster.</p><p class="simplepara" id="calibre_link-722">A difference between variables used in calculated measures compared with calculated columns is that variables in calculated measures do not have a connection with individual rows like they do with calculated columns. This means variables used in calculated measure cannot be assigned a column-based value.</p><p class="simplepara" id="calibre_link-723">Using the same DAX code as in the previous section, a new calculated measure called [City and Country] would encounter errors similar to this:</p><div class="para1" id="calibre_link-724">
              <div class="programcode" id="calibre_link-725"><div class="fixedline">A single value for column 'City' in table 'Dimension City' cannot be determined</div></div>
            </div><p class="simplepara" id="calibre_link-726">This is more the nature of the difference between calculated measures and calculated columns, which are covered in Chapter <span><a href="#calibre_link-168" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>9</span></a></span>. So, for now, let’s create a calculated measure using <span id="calibre_link-727">variables that work

</span>.</p><p class="simplepara" id="calibre_link-728">Say you have a report requirement to understand how many sales have a [Total Including Tax] value that is greater than or equal to $100.</p><p class="simplepara" id="calibre_link-729">One way to write this as a calculated measure using variables shown in Listing <span><a href="#calibre_link-201" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">2-2</a></span>.</p><div class="para1" id="calibre_link-201">
              <div class="programcode" id="calibre_link-730"><div class="fixedline">Total Sales &gt; $100 =</div><div class="fixedline">VAR SalesAbove100 =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Filter Table --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Filter Condition --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Total Including Tax]&gt;=100</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">RETURN COUNTROWS(SalesAbove100)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 2-2</span><p class="para3">Writing Code as a Calculated Measure Using Variables</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-731">In this calculated measure, a variable called SalesAbove100 is used to assign the output of the FILTER function. The <span id="calibre_link-732">FILTER function
</span> returns a table that cannot be used as the final output for the RETURN function because you are defining a calculated measure and calculated measures must return a single value.</p><p class="simplepara" id="calibre_link-733">The RETURN statement uses the <span id="calibre_link-734">COUNTROWS function
</span> to return a single value based on the table passed to it as the argument. This calculated measure shows how you can use the COUNTROWS function over a table expression stored in a variable and that is not limited to physical tables in the model.</p></section><section class="section" id="calibre_link-94"><h3 class="heading">Using Variables in <span id="calibre_link-735">Calculated Tables

</span>
</h3><p class="simplepara" id="calibre_link-736">You can also use variables in DAX calculations to create new calculated tables. You may find this useful when you are creating new tables as summary or aggregated versions of existing tables that require additional processing or manipulation.</p><p class="simplepara" id="calibre_link-737">This technique can improve the performance of some report pages, although it will have an impact on the time it takes to load data as well as the overall memory footprint of your data model.</p><p class="simplepara" id="calibre_link-738">The example in Listing <span><a href="#calibre_link-202" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">2-3</a></span> uses variables to help create a table showing who the top ten customers from ‘Fact Sale’ are based on amounts in the [Total Including Tax] <span id="calibre_link-739">column

</span>.</p><div class="para1" id="calibre_link-202">
              <div class="programcode" id="calibre_link-740"><div class="bookfrontmatter"><div class="fixedline1">Sales Summary =</div><div class="fixedline1">VAR SalesTableWithCustKey =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Filter Table --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Fitler Condition --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Customer Key]&gt;0</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline1">VAR SalesTableGrouped =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Table to Summarize --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SalesTableWithCustKey,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group By --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Customer Key],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggretated Column Name &amp; Expression --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Total Spend",SUM('Fact Sale'[Total Including Tax])</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR SummaryTableFiltered =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TOPN(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Number of rows to return</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Table to filter --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SalesTableGrouped,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Order by Expression</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Total Spend]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;</div><div class="fixedline1">RETURN SummaryTableFiltered</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 2-3</span><p class="para3">Using Variables to Create a Table</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-741">The first variable in the DAX calculation is SalesTableWithCustKey, which is assigned the output of the FILTER function used to remove rows of data that have a [Customer Key] of zero.</p><p class="simplepara" id="calibre_link-742">The SalesTableGrouped variable is assigned a table that is the output of the SUMMARIZE function. The <span id="calibre_link-743">SUMMARIZE function
</span>
<span id="calibre_link-744">
                
                
              </span> takes the SalesTableWithCustKey variable and groups by the [Customer Key] column. A new column called [Total Spend] is added, which calculates the SUM values for all rows belonging to each [Customer Key] to one value.</p><div class="para1" id="calibre_link-745">Finally, the SummaryTableFiltered variable is assigned the output of the TOPN filter function that filters a table with all customers down to a table showing just the top ten. This variable is eventually returned to the calculated table (Figure <span><a href="#calibre_link-203" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">2-2</a></span>).<figure class="figure1" id="calibre_link-203"><div class="mediaobject" id="calibre_link-746"><img alt="../images/456681_1_En_2_Chapter/456681_1_En_2_Fig2_HTML.jpg" src="images/000007.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 2-2</span><p class="simplepara1">Sample output of the ‘Sales Summary’ calculated table</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-747">Unlike with the calculated column and calculated measure examples, you can return a calculated table to the data model when you’re using calculated tables.</p><p class="simplepara" id="calibre_link-748">The equivalent T-SQL using #tablenames that match the variables for the earlier DAX at Listing <span><a href="#calibre_link-202" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">2-3</a></span> would look like Listing <span><a href="#calibre_link-204" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">2-4</a></span>.</p><div class="para1" id="calibre_link-204">
              <div class="programcode" id="calibre_link-749"><div class="bookfrontmatter"><div class="fixedline1">SELECT</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</div><div class="fixedline1">INTO #SalesTableWithCustKey</div><div class="fixedline1">FROM Fact.Sale</div><div class="fixedline1">WHERE</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;[Customer Key] &gt; 0</div></div><div class="bookfrontmatter"><div class="fixedline1">SELECT</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;[Customer Key],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;SUM([Total Including Tax]) AS [Total Spend]</div><div class="fixedline1">INTO #SalesTableGrouped</div><div class="fixedline1">FROM #SalesTableWithCustKey</div><div class="fixedline1">GROUP BY</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Customer Key]</div></div><div class="bookfrontmatter"><div class="fixedline1">SELECT TOP 10</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</div><div class="fixedline1">INTO #SummaryTableFiltered</div><div class="fixedline1">FROM #SalesTableGrouped</div><div class="fixedline1">ORDER BY</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Total Spend] DESC</div></div><div class="bookfrontmatter"><div class="fixedline1">SELECT * FROM #SummaryTableFiltered</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 2-4</span><p class="para3">Equivalent T-SQL to Match the DAX <span id="calibre_link-750">Variables

</span>
</p></div></div></div>
            </div></section><section class="section" id="calibre_link-95"><h3 class="heading">Debugging Using Variables</h3><p class="simplepara" id="calibre_link-751">A common <span id="calibre_link-752">technique

</span>
<span id="calibre_link-753">
                
                
              </span> used in SQL Stored Procedures is to create a series of temporary tables that are refined versions of a previous table. You can use variables in DAX in an equivalent way that can make it easier to follow and debug the processing of your data.</p><p class="simplepara" id="calibre_link-754">The final RETURN statement does not always have to return the most recent variable. It can be useful to output any variable so you can visually inspect the values contained by that variable. This is a form of manual <span id="calibre_link-755">debugging

</span>.</p></section></section><section class="section" id="calibre_link-96"><h2 class="heading">Nesting Variables</h2><p class="simplepara" id="calibre_link-756">Variables can be nested and multiple layers of variable scope can exist within the same calculation.</p><p class="simplepara" id="calibre_link-757">Each layer of variable scope begins with a VAR statement and ends with a matching RETURN statement and can only reference other variables declared in the same level or higher.</p><p class="simplepara" id="calibre_link-758">Listing <span><a href="#calibre_link-205" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">2-5</a></span> is a simple example of a <span id="calibre_link-759">calculated measure


</span>
<span id="calibre_link-760">
              
              
              
            </span> that returns the value of 30. Two layers of variable scope are being used in this calculation.</p><div class="para1" id="calibre_link-205">
            <div class="programcode" id="calibre_link-761"><div class="fixedline">Nested Measure =</div><div class="fixedline">VAR Level1a = 10</div><div class="fixedline">VAR Level1b =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">VAR level2a = Level1a</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">VAR Leval2b = level2a * 3</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">RETURN Leval2b</strong>
</div><div class="fixedline">RETURN Level1b</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 2-5</span><p class="para3">An Example of a Calculated Measure</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-762">The first VAR statement begins the outermost layer of variable scope. The highlighted code shows the start and finish of the inner layer of variable scope and ends by returning a single value to be assigned to the Level1b variable.</p><p class="simplepara" id="calibre_link-763">The code in the inner <span id="calibre_link-764">layer


</span>
<span id="calibre_link-765">
              
              
              
            </span> of scope can access variables that have been created in the outer layer. This is shown by the Level2a variable being assigned the same value as Level1a. This cannot happen the other way around. Level2a should have a value of 10. Level2b should have a value of 30.</p><p class="simplepara" id="calibre_link-766">Listing <span><a href="#calibre_link-206" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">2-6</a></span> shows a slightly more complex version with multiple levels of <span id="calibre_link-767">nesting


</span>
<span id="calibre_link-768">
              
              
              
            </span>.</p><div class="para1" id="calibre_link-206">
            <div class="programcode" id="calibre_link-769"><div class="bookfrontmatter"><div class="fixedline1">Nested Measure 2 =</div><div class="fixedline1">VAR Level1a = 10</div><div class="fixedline1">VAR Level1b =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR level2a = 20</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR level2b =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR Leve3a = Level2a + Level1a</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN Level1a</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN level2b</div><div class="fixedline1">VAR Level1c =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR Level4a =&nbsp;&nbsp;Level1b * 5</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN Level4a</div></div><div class="bookfrontmatter"><div class="fixedline1">RETURN Level1c</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 2-6</span><p class="para3">Complex Version with Multiple Nested Levels</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-770">This calculated measure returns a value of 50. There are three layers of nesting below the Level1b variable. The innermost layer can access variables declared at all higher levels. The innermost level doesn’t return a variable declared in the same level.</p><p class="simplepara" id="calibre_link-771">The layer of scope opened beneath the Level1c variable cannot access any variables declared by the <span id="calibre_link-772">layers


</span>
<span id="calibre_link-773">
              
              
              
            </span> that were opened (and closed) during the expression to assign a value to Level1b.</p><section class="section" id="calibre_link-97"><h3 class="heading">
<span id="calibre_link-774">Nested Variables

</span>
<span id="calibre_link-775">
                
                
                
              </span> (Complex)</h3><p class="simplepara" id="calibre_link-776">Rather than using hardcoded values to demonstrate variable nesting, Listing <span><a href="#calibre_link-207" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">2-7</a></span> shows how you can use variables in other types of calculations.</p><div class="para1" id="calibre_link-207">
              <div class="programcode" id="calibre_link-777"><div class="bookfrontmatter"><div class="fixedline1">Demo Table =</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR Level1 =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Quantity] &gt;</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR Level2 = DAY(TODAY())</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN IF(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Level2 &gt; 10,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Then --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Else --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;30</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Group by Columns --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[City],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregations Columns --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Quantity",sum('Fact Sale'[Quantity]))</div><div class="fixedline1">RETURN</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;TOPN(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR Level2 = 5</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN Level2,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Level1,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[City]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 2-7</span><p class="para3">Example with Variables <span id="calibre_link-778">in Other Types of Calculations

</span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-779">This calculated table uses nested variables to help control the parameters used in the filter expression of the FILTER <span id="calibre_link-780">function

</span>
<span id="calibre_link-781">
                
                
                
              </span>
<span id="calibre_link-782">
                
                
              </span>. The Level2 variable can be assigned different values depending on the day of the month. If the current day of the month is between 1 and 10, this layer of scope returns a value of 30, otherwise it returns a value of 20 to be used in the filter expression.</p><p class="simplepara" id="calibre_link-783">Another nested level of scope that safely uses the same name previously is assigned a hardcoded value of 5 to be returned as a parameter to the TOPN function that also uses the Level1 variable as a parameter.</p><p class="simplepara" id="calibre_link-784">This is not the most useful calculation, but it does demonstrate how you can use variables throughout longer calculations.</p></section></section></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-28">
<div id="calibre_link-785" class="calibre2">
<div id="calibre_link-786" class="calibre3"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-787"><div class="bookfrontmatter">©&nbsp;Philip Seamark&nbsp;2018</div><span class="pcalibre5"><span><span>Philip&nbsp;Seamark</span></span></span><span><span class="booktitle1" type="title" lang="en">Beginning DAX with Power BI</span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-3477-8_3" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">https://doi.org/10.1007/978-1-4842-3477-8_3</a></span></div></div><div class="maintitlesection"><h1 class="chaptertitle" lang="en">3.&nbsp;Context</h1></div><div class="bookfrontmatter"><div class="bookfrontmatter"><span><span>Philip&nbsp;Seamark</span><sup class="calibre6"><a href="#calibre_link-29" class="pcalibre3 pcalibre4 pcalibre1 pcalibre2 pcalibre calibre7">1</a>&nbsp;<span class="contacticon"></span></sup></span></div><div class="bookfrontmatter"><div class="bookfrontmatter" id="calibre_link-29"><span class="affiliationnumber">(1)</span><div class="bookfrontmatter">UPPER HUTT, New Zealand</div></div><div class="clearboth">&nbsp;</div></div></div><div class="bookfrontmatter"><p class="para" id="calibre_link-788">Some say that once you have mastered the concept of context in DAX, you have mastered DAX. This is mostly true, and if you have indeed mastered context, you are a long way up the learning curve.</p><p class="simplepara" id="calibre_link-789">Context can seem a little daunting at first, but once you understand the effect that types of context have on calculations, hopefully DAX starts to make more sense. <em class="emphasistypeitalic">Context</em> is how DAX applies layers of filtering to tables used in your calculations so that they return results that are relevant for every value.</p><p class="simplepara" id="calibre_link-790">Most context is automatic, but some context allows you to control the underlying data passed to your DAX calculations. This chapter mostly uses pivot tables to describe the order and effect of the different types of context. Other visuals and charts apply the context logic the same way pivot tables do, but I think pivot tables do a good job of showing the effect.</p><p class="simplepara" id="calibre_link-791">There are two types of context in DAX: filter context and row context. Depending on your calculation, one or both can apply at the same time to affect the result of your DAX calculation.</p><p class="simplepara" id="calibre_link-792">
<span id="calibre_link-793">Context

</span> is the layer of filtering that is applied to calculations, often dynamically to produce a result specific to every value in a pivot table or visual, including row and column totals.</p><section class="section" id="calibre_link-98"><h2 class="heading">Filter Context</h2><p class="simplepara" id="calibre_link-794">
<span id="calibre_link-795">
              <em class="emphasistypeitalic">Filter context</em>
              
              
            </span> is a set of column-based <span id="calibre_link-796">filters


</span> applied on the fly to the underlying data for every DAX calculation. It is helpful to think of every value cell in a pivot table as its own separate computation. Each value cell treats its measure as a function and passes relevant filters to the function to be applied to the calculation.</p><p class="simplepara" id="calibre_link-797">It might also be helpful to think of filter context as a container. The <span id="calibre_link-798">container
</span>
<span id="calibre_link-799">
              
              
            </span> can be empty or have one or more column filter rules. A column filter rule simply specifies which rows in a given column in a table return true to a Boolean test.</p><p class="simplepara" id="calibre_link-800">Although examples in this chapter are mostly single-column filters, you should not assume that all filters in a filter context are single-column filters. In general, each filter in the filter context is a table that can have more than one column. This is important because a two-column filter establishes a correlation between the two columns. For example, a filter of two rows { (2016, US), (2017, UK) } is different from two independent column filters { 2016, 2017 } and { US, UK }.</p><p class="simplepara" id="calibre_link-801">Each execution of a calculation starts by having access to every row of every table in the data model, but before the core calculation is executed, a filter context is established to determine the most relevant set of column filters for that specific execution. Once the filter context is finalized, the column <span id="calibre_link-802">filter

</span> rules contained inside the context are applied across the data and calculations such as SUM execute using remaining data in the columns they have been coded to use. Once the calculation is complete, the filter context is destroyed and is not used by any other process.</p><p class="simplepara" id="calibre_link-803">Column-based filters can be added to the filter context implicitly, in that they are added automatically to the filter context because of another field in the same visual, such as a row or column header. They can also be added to the filter context using filters external to the visual, such as slicer selections or other report, page, or visual filters.</p><p class="simplepara" id="calibre_link-804">Column-based filters can also be added to, or removed from, the filter context explicitly. This is where filter-based rules are added into DAX calculations.</p><p class="simplepara" id="calibre_link-805">Unlike T-SQL, in which you must write specific code to filter and aggregate using JOIN, WHERE, GROUP BY, and HAVING clauses in SELECT statements, DAX can dynamically construct predicate conditions per computation for you.</p><p class="simplepara" id="calibre_link-806">Let’s start with a very basic DAX measure that uses the SUM function to return a value that represents all the values added together for an individual column.</p><div class="para1" id="calibre_link-807">
            <div class="programcode" id="calibre_link-808"><div class="fixedline">Sales Qty = SUM('Fact Sale'[Quantity])</div></div>
          </div><p class="simplepara" id="calibre_link-809">This <span id="calibre_link-810">calculated measure

</span> returns a number that represents the sum of every value in the [Quantity] column in the ‘Fact Sale’ table. Dropping this calculated measure onto a suitable visual on a report with no additional fields or filters applied should display a value of 8,950,628 using the WideWorldImportersDW dataset.</p><p class="simplepara" id="calibre_link-811">In this example, the single value displayed on the report represents a single execution of the calculated measure. The [Sales Qty] calculated measure uses the SUM <span id="calibre_link-812">function

</span> that is passed to the column reference of ‘Fact Sale’[Quantity], meaning it adds every value from every row in the [Quantity] column to produce a value. It has access to every value in the [Quantity] column because there are no column-based filters in the filter context.</p><p class="simplepara" id="calibre_link-813">The following would be the equivalent T-SQL statement to this DAX:</p><div class="para1" id="calibre_link-814">
            <div class="programcode" id="calibre_link-815"><div class="fixedline">SELECT</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM(Quantity) AS [Sales Qty]</div><div class="fixedline">FROM Fact.Sale;</div></div>
          </div><section class="section" id="calibre_link-99"><h3 class="heading">Implicit Filter Context</h3><p class="simplepara" id="calibre_link-816">When a calculated measure is added to a pivot table using other fields from ‘Fact Sale’ (or from tables related to ‘Fact Sale’) in the rows and columns, we don’t see the value 8,950,628 repeated over and over in every cell; instead we see other values that represent the calculation filtered according to the intersecting points of our column and row headers (Figure <span><a href="#calibre_link-30" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span>).</p><div class="para1" id="calibre_link-817">This is the effect of <span id="calibre_link-818">filter context

</span> on the calculated measure. DAX is implicitly adding a set of column-based filters to the filter context for every one of the 20 cells in the pivot table, and a different result is showing in every value cell. This pivot table is using the simple [Sales Qty] calculation that contains no DAX code to say how to group or aggregate the [Quantity] column to produce each value.<figure class="figure1" id="calibre_link-30"><div class="mediaobject" id="calibre_link-819"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig1_HTML.jpg" src="images/000085.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-1</span><p class="simplepara1">The [Sales Qty] calculated measure in a pivot table</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-820">Consider Figure <span><a href="#calibre_link-30" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span>, which uses the [Sales Qty] calculated measure. The pivot table has five rows and four columns. There are four calendar years in the dataset, which is why you are seeing five rows (including a row at the bottom for the total). The Sales Territory has been filtered to show just three of the ten actual Sales Territories in the data for this example. The right-most column is a grand total for each row.</p><p class="simplepara" id="calibre_link-821">The values in each cell are different and none are the same as the grand total value of 8,950,628. Every execution of the calculated measure in this pivot table uses a unique filter context.</p><p class="simplepara" id="calibre_link-822">The DAX expression is a simple SUM calculation and makes no mention of any filtering by Calendar Year, or Sales Territory region, or any other grouping instruction for that matter. So why do we have the value of 277,812 in the top-left cell, and 298,948 in the cell immediately below that?</p><p class="simplepara" id="calibre_link-823">This is the effect of <span id="calibre_link-824">filter context

</span> in DAX. The pivot table has 20 value cells to be calculated, so the DAX engine performs 20 separate logical calculations, one logical computation for every cell in the pivot table. This includes the calculations required to determine the values for each of the row and column totals.</p><p class="simplepara" id="calibre_link-825">To produce a value of 277,812 for the top-left cell, the calculated measure begins by having access to every value in the ‘Fact Sale’[Quantity] column. The filter context for this calculation starts empty but has two sets of column filters implicitly added to it. One of the column filters is that rows in the [Calendar Year] field must have a value of 2013; the other column filter is that rows in the [Sales Territory] column must have a value of “Far West”.</p><p class="simplepara" id="calibre_link-826">All filters in a filter context are based on a logical AND, so only rows in the ‘Fact Sale’[Quantity] column that can meet both criteria are passed to the SUM function.</p><p class="simplepara" id="calibre_link-827">The T-SQL equivalent to generate the value for this cell is like adding the INNER JOIN and WHERE clauses in Listing <span><a href="#calibre_link-31" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span> to the T-SQL statement.</p><div class="para1" id="calibre_link-31">
              <div class="programcode" id="calibre_link-828"><div class="bookfrontmatter"><div class="fixedline1">SELECT</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM([Quantity]) AS [Sales Qty]</div></div><div class="bookfrontmatter"><div class="fixedline1">FROM FACT.Sale AS S</div></div><div class="bookfrontmatter"><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Dimension.City AS C</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON C.[City Key] = S.[City Key]</div></div><div class="bookfrontmatter"><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Dimension.Date AS D</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON D.Date = S.[Invoice Date Key]</div><div class="fixedline1">WHERE</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">C.[Sales Territory] = 'Far West'</strong>
</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">AND D.[Calendar Year] = 2013</strong>
</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 3-1</span><p class="para3">T-SQL of the [Sales Qty] <span id="calibre_link-829">Calculated Measure


</span> with Filters to Produce Value for Top-Left Cell in Figure <span><a href="#calibre_link-30" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-830">The WHERE clause in T-SQL is like the filter context. The two statements inside the WHERE <span id="calibre_link-831">clause


</span> represent each of the column filters that were implicitly added to the filter context.</p><p class="simplepara" id="calibre_link-832">Let’s now look at what the DAX engine is doing to produce the value for the second row of the first column (298,948). The filter context for this computation again starts empty but has two sets of column filters implicitly added to it. One column filter is that rows in the [Calendar Year] field must now have a value of 2014; the other column filter is that rows in the [Sales Territory] column must have a value of “Far West”. Listing <span><a href="#calibre_link-32" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-2</a></span> shows the equivalent T-SQL for the computation used for this cell.</p><div class="para1" id="calibre_link-32">
              <div class="programcode" id="calibre_link-833"><div class="bookfrontmatter"><div class="fixedline1">SELECT</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM([Quantity]) AS [Sales Qty]</div><div class="fixedline1">FROM FACT.Sale AS S</div></div><div class="bookfrontmatter"><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Dimension.City AS C</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON C.[City Key] = S.[City Key]</div></div><div class="bookfrontmatter"><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Dimension.Date AS D</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON D.Date = S.[Invoice Date Key]</div><div class="fixedline1">WHERE</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C.[Sales Territory] = 'Far West'</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">AND D.[Calendar Year] = 2014</strong>
</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 3-2</span><p class="para3">T-SQL of the [Sales Qty] Calculated Measure with Different Filter Context</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-834">The only difference between the T-SQL statements in Listing <span><a href="#calibre_link-31" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span> and Listing <span><a href="#calibre_link-32" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-2</a></span> is the final predicate that specifies that the value for D.[Calendar Year] is now 2014 rather than 2013. Each cell has its own filter context and each filter context has its own set of column filters.</p><p class="simplepara" id="calibre_link-835">This is repeated over and over in any order because no cell in a pivot table relies on the output of another cell.</p><p class="simplepara" id="calibre_link-836">Let’s jump to the bottom row of the first column and look at what the DAX engine is doing to produce a value of 1,028,670 for the grand total of the first column. DAX does not keep a running total of the previous calculations in the same column. Logically the engine starts from scratch and arrives at a value for the total independent of the other 19 cell calculations in the pivot table.</p><p class="simplepara" id="calibre_link-837">DAX once again starts with an empty filter context but in this case, just one column filter is implicitly added to the filter context. This time the column filter is that the [Sales Territory] column must have a value of “Far West”. This filter context restricts the rows in the ‘Fact Sales’[Quantity] column that are passed to the SUM function. More rows are passed in this case than from the previous two examples.</p><p class="simplepara" id="calibre_link-838">Listing <span><a href="#calibre_link-33" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-3</a></span> shows the T-SQL code for this cell.</p><div class="para1" id="calibre_link-33">
              <div class="programcode" id="calibre_link-839"><div class="bookfrontmatter"><div class="fixedline1">SELECT</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM([Quantity]) AS [Sales Qty]</div><div class="fixedline1">FROM FACT.Sale AS S</div></div><div class="bookfrontmatter"><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Dimension.City AS C</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON C.[City Key] = S.[City Key]</div><div class="fixedline1">WHERE</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C.[Sales Territory] = 'Far West'</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 3-3</span><p class="para3">T-SQL Equivalent <span id="calibre_link-840">for Basic DAX Query


</span> to Produce the Total Value for the First Column of Figure <span><a href="#calibre_link-30" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-841">The difference between this and the earlier examples is you no longer need an inner join to the Dimension.Date table and you have one less predicate in your WHERE clause, so no filtering is taking place on the date table.</p><p class="simplepara" id="calibre_link-842">You can use this to your advantage in more complex scenarios where it’s possible to specify an altogether different calculation for the grand total cell than the calculation used in the cells filtered by a calendar year. In fact, it’s possible to use functions to instruct DAX to return completely different calculations altogether for any cell you want to produce the SCOPE-like behavior available in multidimensional data models.</p><p class="simplepara" id="calibre_link-843">The calculated measure in Listing <span><a href="#calibre_link-34" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-4</a></span> applies a test to see if any column filter rules are inside the filter context that ‘Dimension Date’[Calendar Year] must match 2014. If there are, the SUM function is bypassed and the text value of “overridden” is returned.</p><div class="para1" id="calibre_link-34">
              <div class="programcode" id="calibre_link-844"><div class="fixedline">Sum of Quantity =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;IF(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">SELECTEDVALUE('Dimension Date'[Calendar Year])=2014,</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- THEN --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"overridden",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- ELSE --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FORMAT(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),"#,000"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 3-4</span><p class="para3">Using SELECTEDVALUE to Help Override <span id="calibre_link-845">output

</span>
</p></div></div></div>
            </div><div class="para1" id="calibre_link-846">Any <span id="calibre_link-847">cell

</span> that uses the [Sum of Quantity] calculated measure that has a column filter for [Calendar Year] = 2014 inside its filter context now returns the “overridden” text instead of running the SUM function (Figure <span><a href="#calibre_link-35" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-2</a></span>).<figure class="figure1" id="calibre_link-35"><div class="mediaobject" id="calibre_link-848"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig2_HTML.jpg" src="images/000076.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-2</span><p class="simplepara1">Output of the [Sum of Quantity] calculated measure</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-849">Notice the row totals still produce the same totals as before and have not been reduced by the missing values in the 2014 row. This is because the calculations for the row totals have independent filter context and can still use the data belonging to [Calendar Year] = 2014.</p><p class="simplepara" id="calibre_link-850">Column filters can be implicitly added to the filter context from sources other than row and column headers of a visual. They can be driven from external sources, such as selections on slicers or other visuals, or they can be specific report, page, or visual filter rules.</p><p class="simplepara" id="calibre_link-851">If a report-level filter specifies that the ‘Dimension City’[Country] field must be “United States”, this column filter rule is added implicitly to the filter context for every execution of a calculated measure used in the report.</p><section class="section" id="calibre_link-852"><h4 class="heading2">Another Example</h4><div class="bookfrontmatter" id="calibre_link-853">Let’s look at filter context that uses a simpler <span id="calibre_link-854">dataset

</span>. Consider the dataset in Table <span><a href="#calibre_link-36" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span>.<div class="table" id="calibre_link-36"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 3-1</span><p class="para3">Dataset to Demonstrate Filter Context</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Person</p></th><th class="calibre14"><p class="simplepara2">Pet</p></th><th class="calibre14"><p class="simplepara2">Value</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Andrew</p></td><td class="calibre16"><p class="simplepara2">Cat</p></td><td class="calibre16"><p class="simplepara2">10</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Andrew</p></td><td class="calibre16"><p class="simplepara2">Dog</p></td><td class="calibre16"><p class="simplepara2">20</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Andrew</p></td><td class="calibre16"><p class="simplepara2">Dog</p></td><td class="calibre16"><p class="simplepara2">30</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Bradley</p></td><td class="calibre16"><p class="simplepara2">Cat</p></td><td class="calibre16"><p class="simplepara2">40</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Bradley</p></td><td class="calibre16"><p class="simplepara2">Cat</p></td><td class="calibre16"><p class="simplepara2">50</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Bradley</p></td><td class="calibre16"><p class="simplepara2">Dog</p></td><td class="calibre16"><p class="simplepara2">60</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Charles</p></td><td class="calibre16"><p class="simplepara2">Cat</p></td><td class="calibre16"><p class="simplepara2">70</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Charles</p></td><td class="calibre16"><p class="simplepara2">Bird</p></td><td class="calibre16"><p class="simplepara2">80</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Charles</p></td><td class="calibre16"><p class="simplepara2">Dog</p></td><td class="calibre16"><p class="simplepara2">90</p></td></tr></tbody></table></div>
</div><div class="para1" id="calibre_link-855">Using <span id="calibre_link-856">data

</span> from Table <span><a href="#calibre_link-36" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span> in a pivot table would produce the results shown in Figure <span><a href="#calibre_link-37" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-3</a></span>.<figure class="figure1" id="calibre_link-37"><div class="mediaobject" id="calibre_link-857"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig3_HTML.jpg" src="images/000004.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-3</span><p class="simplepara1">Dataset from Table <span class="calibre9"><a href="#calibre_link-36" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span> used in a pivot table</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-858">Here is the calculated measure used in the pivot table to generate these values:</p><div class="para1" id="calibre_link-859">
                <div class="programcode" id="calibre_link-860"><div class="fixedline">Sum of Value = SUM( Table1[Value] )</div></div>
              </div><p class="simplepara" id="calibre_link-861">Let’s walk through an example of filter context. Let’s start by using the highlighted cell (Figure <span><a href="#calibre_link-37" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-3</a></span>) in the top row of the data that shows a value of 50. This is the value that is the intersection of Andrew and Dog.</p><p class="simplepara" id="calibre_link-862">The calculation starts with an empty filter context that contains no column-based filters. If the <span id="calibre_link-863">filter

</span> context remains like this, the SUM function has access to every row in the [Value] column of Table <span><a href="#calibre_link-36" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span> and an output 450.</p><div class="para1" id="calibre_link-864">The calculated measure is on a pivot table that has one field on the row header [Person] and one on the column header [Pet], so two column-based filters are added to the filter context before the calculation executes the SUM function. The first column-based filter is that the Table1[Person] must be “Andrew” (see Figure <span><a href="#calibre_link-38" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-4</a></span>). This means the filter context now has a column-based filter rule.<figure class="figure1" id="calibre_link-38"><div class="mediaobject" id="calibre_link-865"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig4_HTML.jpg" src="images/000052.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-4</span><p class="simplepara1">Showing implict column filter rule of “Andrew”</p></div></figcaption></figure>
<div class="table" id="calibre_link-39"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 3-2</span><p class="para3">Dataset from Table <span><a href="#calibre_link-36" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span> with Filter Applied to [Person] Column</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Person</p></th><th class="calibre14"><p class="simplepara2">Pet</p></th><th class="calibre14"><p class="simplepara2">Value</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Andrew</p></td><td class="calibre16"><p class="simplepara2">Cat</p></td><td class="calibre16"><p class="simplepara2">10</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Andrew</p></td><td class="calibre16"><p class="simplepara2">Dog</p></td><td class="calibre16"><p class="simplepara2">20</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Andrew</p></td><td class="calibre16"><p class="simplepara2">Dog</p></td><td class="calibre16"><p class="simplepara2">30</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-866">The effect of the filter context on the data is that the [Value] column has now been reduced to just three rows of data as shown in Table <span><a href="#calibre_link-39" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-2</a></span>, and if left like this, the SUM function will return 60.</p><div class="para1" id="calibre_link-867">The second column-based filter to be added to the filter context is that the Table1[Pet] must be “Dog”. This now means the filter context has two column-based filter rules (see Figure <span><a href="#calibre_link-40" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-5</a></span>). This reduces the rows in the Value column to just two rows (Table <span><a href="#calibre_link-41" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-3</a></span>).<figure class="figure1" id="calibre_link-40"><div class="mediaobject" id="calibre_link-868"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig5_HTML.jpg" src="images/000057.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-5</span><p class="simplepara1">Showing implict column filter rule of “Andrew” and “Dog”</p></div></figcaption></figure>
<div class="table" id="calibre_link-41"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 3-3</span><p class="para3">Dataset from Table <span><a href="#calibre_link-36" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-1</a></span> with Filter Applied to [Person] and [Pet] Columns</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Person</p></th><th class="calibre14"><p class="simplepara2">Pet</p></th><th class="calibre14"><p class="simplepara2">Value</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Andrew</p></td><td class="calibre16"><p class="simplepara2">Dog</p></td><td class="calibre16"><p class="simplepara2">20</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Andrew</p></td><td class="calibre16"><p class="simplepara2">Dog</p></td><td class="calibre16"><p class="simplepara2">30</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-869">The <span id="calibre_link-870">filter context

</span> is complete, and the SUM function can now add all the values in the [Value] column. This results in a value of 50, which is the number that was highlighted back in Figure <span><a href="#calibre_link-37" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-3</a></span>.</p><p class="simplepara" id="calibre_link-871">Column-based filters can also be added or removed from the filter context by code in a DAX calculation. These are known as <em class="emphasistypeitalic">explicit filter context</em> and we look at them next.</p></section></section><section class="section" id="calibre_link-100"><h3 class="heading">Explicit <span id="calibre_link-872">Filter Context

</span>
</h3><p class="simplepara" id="calibre_link-873"><em class="emphasistypeitalic">Explicit filter context</em> refers to code in calculations that specifically adds or removes column filter rules to and from the filter context. Explicit filter context is applied after implicit and row context and allows you to customize and sometimes completely override the default behavior of your measures in a way the row and query context can’t. You can apply filter context using DAX functions such as FILTER.</p><p class="simplepara" id="calibre_link-874">Several functions allow you to control the data that is ultimately exposed to your calculations and therefore impact the result. These functions, such as ALL, ALLEXCEPT, and ALLSELECTED are covered in Chapter <span><a href="#calibre_link-42" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>6</span></a></span>, which is dedicated to filter functions. You can use these to apply or ignore any combination of outside filters already in place to provide fine-grained control over what data is used by your DAX expressions.</p><p class="simplepara" id="calibre_link-875">Let’s start with a simple example that uses WorldWideImportersDW data. Let’s create a <span id="calibre_link-876">calculation

</span> that shows the SUM of [Quantity] but only for stock items that are the color red.</p><p class="simplepara" id="calibre_link-877">You can approach this in two ways. You can create a calculated column or a calculated measure. Both exhibit different behaviors, which you see here.</p><p class="simplepara" id="calibre_link-878">The DAX for the <em class="emphasistypeitalic">calculated column</em> might look like this:</p><div class="para1" id="calibre_link-879">
              <div class="programcode" id="calibre_link-880"><div class="fixedline">Filter on Red as Column = CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Stock Item'[Color]="Red"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
            </div><p class="simplepara" id="calibre_link-881">Whereas the DAX for the <em class="emphasistypeitalic">calculated measure</em> might look like this:</p><div class="para1" id="calibre_link-882">
              <div class="programcode" id="calibre_link-883"><div class="fixedline">Filter on Red as Measure = CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Stock Item'[Color] = "Red"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
            </div><p class="simplepara" id="calibre_link-884">Apart from the name and type of calculation, the expression used for both is identical. However, the calculations do not behave the same and that is due to different context.</p><p class="simplepara" id="calibre_link-885">Both calculations are created on the ‘Fact Sale’ table and specify a filter condition on a column in a different table. This works because you have defined a relationship between the ‘Fact Sale’ table and ‘Dimension Stock Item’ table in the data model.</p><p class="simplepara" id="calibre_link-886">Both calculations use the CALCULATE function to invoke the filter function as one of the easiest ways to apply a filter.</p><div class="para1" id="calibre_link-887">Both calculations are added to a pivot table (Figure <span><a href="#calibre_link-43" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-6</a></span>) along with a nonfiltered implicit measure showing the sum of the quantity column.<figure class="figure1" id="calibre_link-43"><div class="mediaobject" id="calibre_link-888"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig6_HTML.jpg" src="images/000044.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-6</span><p class="simplepara1">Pivot table showing output using [Filter on Red as Column] and [Filter on Red as Measure]</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-889">The first column called Quantity<span id="calibre_link-890">
                
                
              </span> is the [Quantity] field from the ‘Fact Sale’. This is not one of our calculations; instead it’s the field added to the pivot table to provide a baseline value as a reference for the two calculations.</p><p class="simplepara" id="calibre_link-891">Because this column uses a numeric datatype, a default summarization behavior of SUM is implicitly applied to these results, and the only context being applied to these results is query context from the row and column headers of the pivot table.</p><p class="simplepara" id="calibre_link-892">No DAX is required to generate this behavior. A column property of the data model allows you to define a default summarization for numeric columns. If no default is defined, the data model assumes that SUM should be the default behavior.</p><p class="simplepara" id="calibre_link-893">The next column in the pivot table is an implicit measure using the calculated column called [Filter on Red as Column], which only shows a value on the line where the row header is Red. The last column is the [Filter on Red as Measure] column, which shows the value of 29,033 repeated over and over, including on the last line, which is a Total row that is not filtered by a color.</p></section><section class="section" id="calibre_link-101"><h3 class="heading">
              <span id="calibre_link-894">Calculated Column

</span>
            </h3><p class="simplepara" id="calibre_link-895">Let’s look at what is happening with the [Filter on Red as Column] calculated column. In this case, we use the CALCULATE function. Let’s use an explicit filter expression with this function to specify a rule that the ‘Dimension Stock Item’[Color] must be “Red”.</p><p class="simplepara" id="calibre_link-896">The SUM <span id="calibre_link-897">function

</span> doesn’t understand row context, so the <span id="calibre_link-898">CALCULATE function
</span> automatically converts the row context into a filter context that allows the SUM function to access the data it needs to complete. See “Context Transition” at the end of this chapter, which explains this in more detail.</p><p class="simplepara" id="calibre_link-899">The calculation is evaluated at the point data is read into the data model, and for every row in the ‘Fact Sales’ table, the calculation is computed and the result is returned as the value for the new column. The explicit rule that ‘Dimension Stock Item’[Color] must be “Red” is added to the filter context for each execution of the calculation.</p><p class="simplepara" id="calibre_link-900">The ‘Fact Sales’ table has 228,265 rows, so logically, this calculation is computed 228,265 times with each computation only having access to information from its current, or related, row.</p><p class="simplepara" id="calibre_link-901">Nothing else is added to, or removed from, the filter context, so if a row in the ‘Fact Sales’ table happens to be a red stock item, the calculation returns the SUM of the [Quantity] column, otherwise the calculation returns a blank.</p><p class="simplepara" id="calibre_link-902">The SUM function requires a column to be passed to it to produce a value. For each computation of all 228,265 rows, the SUM function uses a ‘Fact Sale’[Quantity] column that is filtered by the filter context.</p><p class="simplepara" id="calibre_link-903">Once the calculated column has been added to the model, the data is visible in the Data View. This shows that only some rows have a value in the [Filter on Red as Column] column. These are rows that belong to stock items that are “Red”. Most rows in this dataset will have blank values.</p><div class="para1" id="calibre_link-904">In Figure <span><a href="#calibre_link-44" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-7</a></span>, two highlighted rows show values in the final column, whereas other rows show a blank cell. This is the only time the calculated column is computed and it explains why, when the column is added to the pivot table, the result shown in the table is only for data where the row header is “Red”.<figure class="figure1" id="calibre_link-44"><div class="mediaobject" id="calibre_link-905"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig7_HTML.jpg" src="images/000065.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-7</span><p class="simplepara1">Sample of ‘Fact Sale’ table with new [Filter on Red as Column] calculated column</p></div></figcaption></figure>
</div><div class="formalpara" id="calibre_link-906"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-907">Setting a default summarization on a calculated column that uses the CALCULATE function has no effect. The expression used in the CALCULATE function determines the result for each cell, including totals.</p></div><p class="simplepara" id="calibre_link-908">The [Filter on Red as Column] calculated column only applies a very basic filter. An array of filter functions in <span id="calibre_link-909">DAX

</span> allows you to set more sophisticated filter behavior, which I cover in later chapters.</p><p class="simplepara" id="calibre_link-910">When you drag the calculated column to the pivot table, an implicit calculated measure is generated and used by the pivot table.</p></section><section class="section" id="calibre_link-102"><h3 class="heading">
              <span id="calibre_link-911">Calculated Measure

</span>
            </h3><p class="simplepara" id="calibre_link-912">Let’s look at the final column of the pivot table in Figure <span><a href="#calibre_link-45" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-8</a></span>, which uses the [Filter on Red as Measure] calculated measure. This now returns values on rows with row headers for values other than “Red”, and the very bottom row returns the same value as those higher in the column. You might expect the value shown in the final column to at least be the total of the values for that column.</p><div class="para1" id="calibre_link-913">Even though the formulas used for the <span id="calibre_link-914">calculated measure

</span> and calculated columns are identical, the difference is context. When the calculated column is computed, each individual calculation has row context and is logically computed 228,625 times.<figure class="figure1" id="calibre_link-45"><div class="mediaobject" id="calibre_link-915"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig8_HTML.jpg" src="images/000011.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-8</span><p class="simplepara1">Pivot table showing output using [Filter on Red as Column] and [Filter on Red as Measure]</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-916">The calculated measure is computed only ten times for this visual: once for each cell in the pivot table that has a row header (the nine different colors), and once for the total row at the bottom. When the calculated measures are evaluated, there is no row context. Each calculation starts with an empty filter context.</p><p class="simplepara" id="calibre_link-917">How does DAX arrive at the value of 29,033 for each execution of this calculated measure?</p><p class="simplepara" id="calibre_link-918">For the top nine rows, an <em class="emphasistypeitalic">implicit</em> column filter-based rule is added to the empty filter context for each execution. This implicit filter rule comes from the first column in the table and states that the value in the ‘Dimension Stock Item’[Color] column must match the value in the relevant row header.</p><p class="simplepara" id="calibre_link-919">However, an <em class="emphasistypeitalic">explicit</em> column filter rule is also coded into the calculated measure using the same column. This replaces the implicit filter rule, meaning the filter context still has a single-column filter rule on this column but now uses the rule defined explicitly.</p><p class="simplepara" id="calibre_link-920">The calculation on the bottom row does not have an implicit column-based rule added to its filter context, but it still adds the explicit column filter to its filter context before it runs its SUM function. Therefore, it returns the same value as those above it.</p><p class="simplepara" id="calibre_link-921">Once the filter context is finalized, it contains a single-column filter rule over the ‘Dimension Stock Item’[Color] column. The SUM function now returns 29,033 using the surviving values in the [Quantity] column. When this is repeated for every cell in the pivot table column, you get the same result, even for the grand total line.</p><p class="simplepara" id="calibre_link-922">This may seem odd, but hopefully it helps you understand how filter context is affecting the core <span id="calibre_link-923">calculation

</span>.</p><p class="simplepara" id="calibre_link-924">In case you are interested, Listing <span><a href="#calibre_link-46" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-5</a></span> shows the T-SQL equivalent of our calculated measure.</p><div class="para1" id="calibre_link-46">
              <div class="programcode" id="calibre_link-925"><div class="fixedline">SELECT</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM ( F.[Quantity] ) AS [Filter on Red as Measure]</div><div class="fixedline">FROM FACT.Sale AS F</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEFT OUTER JOIN Dimension.[Stock Item] AS D</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON F.[Stock Item Key]=D.[Stock Item Key]</div><div class="fixedline">WHERE</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D.[Color] = 'Red';</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 3-5</span><p class="para3">T-SQL Version of DAX Calculated Measure</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-926">If you run this T-SQL query ten times (once for every cell), you get the same 29,033 result every time.</p><p class="simplepara" id="calibre_link-927">The T-SQL in Listing <span><a href="#calibre_link-46" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-5</a></span> uses a LEFT OUTER JOIN. This is also the join type that DAX would use in this particular case. Be aware that depending on the filters and DAX, sometimes this might be INNER JOIN.</p></section><section class="section" id="calibre_link-103"><h3 class="heading">Hardcoded Example</h3><p class="simplepara" id="calibre_link-928">Another example of filter context is to <span id="calibre_link-929">hardcode

</span> both a calculated column and a calculated measure to return a value of 1.</p><p class="simplepara" id="calibre_link-930">Consider the following two calculations. The first is a <em class="emphasistypeitalic">calculated column</em> while the second is a <em class="emphasistypeitalic">calculated measure</em>:</p><div class="para1" id="calibre_link-931">
              <div class="programcode" id="calibre_link-932"><div class="bookfrontmatter"><div class="fixedline1">Hardcoded Calculated Column = 1</div></div><div class="bookfrontmatter"><div class="fixedline1">Hardcoded Calculated Measure = 1</div></div></div>
            </div><div class="para1" id="calibre_link-933">When we add these two calculations to the same pivot table we get the result shown in Figure <span><a href="#calibre_link-47" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-9</a></span>.<figure class="figure1" id="calibre_link-47"><div class="mediaobject" id="calibre_link-934"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig9_HTML.jpg" src="images/000035.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-9</span><p class="simplepara1">Pivot table showing calculations using hardcoded values</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-935">As expected, the calculated column executes 228,265 times and returns the value of 1 to every <span id="calibre_link-936">row

</span>. When added to the pivot table, an implicit calculated measure is generated using the default summarization behavior of SUM. The filter context for this implicit measure receives a column filter rule from the first column of the pivot table. This is a roundabout way of producing a ROWCOUNT measure.</p><p class="simplepara" id="calibre_link-937">The hardcoded calculated measure has ten cells to produce a value for, so logically, it computes the simple calculation ten times. The result as shown is the hardcoded value for 1 appearing in each cell&mdash;including the Total.</p></section></section><section class="section" id="calibre_link-104"><h2 class="heading">
            <span id="calibre_link-938">Row Context
</span>
            <span id="calibre_link-939">
              
              
            </span>
          </h2><p class="simplepara" id="calibre_link-940">Row context is effective when you create calculated columns or execute code inside an iterator function. Just as calculated measures perform a logical computation for each cell in a pivot table or report visual, calculated columns perform a logical computation to generate a value for every row in your calculated column. If you add a calculated column to a table with 250 rows, the calculation is executed 250 times. Each execution has a slightly different row context.</p><p class="simplepara" id="calibre_link-941">A key difference between calculated columns and calculated measures is the point in time the calculation takes place. Calculated columns are computed at the point they are created or modified and after data has been physically loaded or refreshed into the data model, whereas calculated measures recompute any time a filter is changed that might affect the value.</p><p class="simplepara" id="calibre_link-942">Row context allows the calculation to quickly access value from the same row in the current table or from values that might exist in rows in related tables via relationships.</p><div class="para1" id="calibre_link-943">A simple example of row context using the WideWorldImportersDW dataset (Figure <span><a href="#calibre_link-48" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-10</a></span>) is to create a calculated <span id="calibre_link-944">column
</span>
<span id="calibre_link-945">
              
              
            </span> that returns a value based on multiplying the [Unit Price] and [Quantity] columns together.<figure class="figure1" id="calibre_link-48"><div class="mediaobject" id="calibre_link-946"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig10_HTML.jpg" src="images/000043.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-10</span><p class="simplepara1">Sample of ‘Fact Sale’ with new calculated column</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-947">Figure&nbsp;<span><a href="#calibre_link-48" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-10</a></span> shows a new calculated column called [Total Price] that uses the [Unit Price] and [Quantity] columns from the same row in its calculation to produce each result.</p><p class="simplepara" id="calibre_link-948">The top row of in Figure <span><a href="#calibre_link-48" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-10</a></span> generates a value of 256 in the [Total Price] column, which is the result of 8 * 32.</p><p class="simplepara" id="calibre_link-949">Once the data has been loaded or refreshed, the value cannot be changed. If you have lots of calculated columns and many rows, your data load/refreshing takes longer. Another impact of adding calculated columns to the model is that additional memory is needed to store the computed results. Any additional calculation created that uses data from a calculated column treats the values as if they have been provided by the external data source.</p><p class="simplepara" id="calibre_link-950">If you have relationships defined in your data model, you can use the RELATED function to access columns from other tables to use in formulas in your calculated column.</p><p class="simplepara" id="calibre_link-951">An example of this is adding a calculated column to the ‘Fact Sale’ table that estimates the weight of each row based on the quantity information from the ‘Fact Sale’ table and combines this with the [Typical Weight Per Unit] column from the ‘Dimension Stock Item’ <span id="calibre_link-952">table
</span>
<span id="calibre_link-953">
              
              
            </span>. The formula for the calculated column uses data from two tables to produce the result.</p><div class="para1" id="calibre_link-954">Figure&nbsp;<span><a href="#calibre_link-49" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-11</a></span> highlights the relationship between the [Stock Item Key] columns from each table.<figure class="figure1" id="calibre_link-49"><div class="mediaobject" id="calibre_link-955"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig11_HTML.jpg" src="images/000068.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-11</span><p class="simplepara1">Relationship View between ‘Dimension Stock Item’ and ‘Fact Sale’</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-956">When the following calculated column is added to the ‘Fact Sale’ table, it demonstrates row context:</p><div class="para1" id="calibre_link-957">
            <div class="programcode" id="calibre_link-958"><div class="fixedline">Estimated Weight =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Quantity] *</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELATED(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Stock Item'[Typical Weight Per Unit]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><div class="para1" id="calibre_link-959">You can see the new calculated column in the Data View in Figure <span><a href="#calibre_link-50" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-12</a></span>.<figure class="figure1" id="calibre_link-50"><div class="mediaobject" id="calibre_link-960"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig12_HTML.jpg" src="images/000037.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-12</span><p class="simplepara1">Sample output of 'Fact Sale' with the new calculated column</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-961">IntelliSense only suggests columns in the ‘Dimension Stock Item’ table once you use the RELATED <span id="calibre_link-962">function
</span>
<span id="calibre_link-963">
              
              
            </span>. Relationships in the data model help control objects offered by IntelliSense.</p><p class="simplepara" id="calibre_link-964">The T-SQL equivalent of this calculation is issuing the following command for each row, although the S.[Stock Item Key] would be hardcoded to the value from the column defined in the relationship:</p><div class="para1" id="calibre_link-965">
            <div class="programcode" id="calibre_link-966"><div class="fixedline">SELECT <strong class="emphasistypebold">TOP 1</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;S.[Quantity] * D.[Typical Weight Per Unit] AS [Estimated Weight]</div><div class="fixedline">FROM FACT.Sale AS S</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEFT OUTER JOIN Dimension.[Stock Item] AS D</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON D.[Stock Item Key] = S.[Stock Item Key]</div></div>
          </div><div class="formalpara" id="calibre_link-967"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-968">Calculated columns cannot access data from the row above or below the current row using a current row +/-1 instruction.</p></div><p class="simplepara" id="calibre_link-969">Although this note is not entirely true, it’s not as straightforward as what you might encounter in other languages. You can access data from other rows in your table in calculations that use explicit DAX functions, such as FILTER, which I cover in Chapter <span><a href="#calibre_link-42" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>6</span></a></span> as a more advanced scenario.</p><p class="simplepara" id="calibre_link-970">Assume there is no concept of ordering when loading tables, so the previous/next row cannot be guaranteed. As soon as a row has been read and broken apart to populate the various column indexes during the data load process, it is discarded.</p><p class="simplepara" id="calibre_link-971">It is possible to logically reconstruct <span id="calibre_link-972">rows
</span>
<span id="calibre_link-973">
              
              
            </span> when you are required to, but this can be computationally expensive, especially if the table has many columns.</p><section class="section" id="calibre_link-105"><h3 class="heading">
              <span id="calibre_link-974">Iterators
</span>
              <span id="calibre_link-975">
                
                
              </span>
            </h3><div class="bookfrontmatter" id="calibre_link-976">Several DAX functions rebuild rows based on information stored in the column indexes. These are known as <em class="emphasistypeitalic">iterators,</em> or <span id="calibre_link-977">
                <em class="emphasistypeitalic">X functions</em>
                
                
              </span>, because these functions typically have an X as the last character of the function name. Here are some of the iterator functions:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-978">AVERAGEX: Calculates the average (arithmetic mean) of a set of expressions evaluated over a table.</p></li><li class="calibre8"><p class="para2" id="calibre_link-979">COUNTAX: Counts the number of values that result from evaluating an expression for each row of a table.</p></li><li class="calibre8"><p class="para2" id="calibre_link-980">COUNTX: Counts the number of values that result from evaluating an expression for each row of a table.</p></li><li class="calibre8"><p class="para2" id="calibre_link-981">GEOMEANX: Returns the geometric mean of an expression value in a table.</p></li><li class="calibre8"><p class="para2" id="calibre_link-982">MAXX: Returns the largest numeric value that results from evaluating an expression for each row of a table.</p></li><li class="calibre8"><p class="para2" id="calibre_link-983">MEDIANX: Returns the 50th percentile of an expression value in a table.</p></li><li class="calibre8"><p class="para2" id="calibre_link-984">MINX: Returns the smallest numeric value that results from evaluating an expression for each row of a table.</p></li><li class="calibre8"><p class="para2" id="calibre_link-985">PRODUCTX: Returns the product of an expression value in a table.</p></li><li class="calibre8"><p class="para2" id="calibre_link-986">RANKX: Returns the rank of an expression that is evaluated in the current context in the list of values for each row in the specified table.</p></li><li class="calibre8"><p class="para2" id="calibre_link-987">SUMX: Returns the sum of an expression evaluated for each row in a table.</p></li><li class="calibre8"><p class="para2" id="calibre_link-988">FILTER: Returns a table that has been filtered.</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-989">Iterators are functions that process once for every row over any table passed to the function. A process can be a calculation, or in the case of <span id="calibre_link-990">FILTER
</span>
<span id="calibre_link-991">
                
                
              </span>, it applies a set of Boolean rules to filter the table it uses to return a filtered table.</p><p class="simplepara" id="calibre_link-992">Iterators can be nested many times. Each instance of an iterator keeps its own set of row context. Expressions in a nested iterator can access values from a row context from an outer iterator. These are often described as being the equivalent of the inner and outer loops you might see in other languages:</p><div class="para1" id="calibre_link-993">
              <div class="programcode" id="calibre_link-994"><div class="fixedline">foreach (row <em class="emphasistypeitalic">outer</em> in TableA)</div><div class="fixedline">{</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach (row <em class="emphasistypeitalic">inner</em> in TableB)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return <em class="emphasistypeitalic">expression;</em>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div class="fixedline">}</div></div>
            </div><p class="simplepara" id="calibre_link-995">Iterators allow you to solve sophisticated data problems that can’t easily be solved using functions like SUM, COUNT, or AVERAGE, but they can cause an extra load on CPU processing.</p><div class="formalpara" id="calibre_link-996"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-997">SUM/COUNT/AVERAGE are just syntax sugar for SUMX/COUNTX/AVERAGEX. In the case of a single column, there is no performance advantage to using SUM(‘Table’[Column]) instead of SUMX(‘Table’, [Column]).</p></div></section></section><section class="section" id="calibre_link-106"><h2 class="heading">How Data Is Stored in <span id="calibre_link-998">DAX

</span>
</h2><p class="simplepara" id="calibre_link-999">Another way to think about context in DAX is to consider how the underlying engine stores data once it has imported it. Looking at context in this way may help you appreciate the order and effect different types of context have on your calculations.</p><p class="simplepara" id="calibre_link-1000">Your source data is typically stored in rows or batches of rows. Each row may have many columns, fields, or properties. When you import data to a DAX model, the data source is read into the data model row by row.</p><div class="para1" id="calibre_link-1001">Table&nbsp;<span><a href="#calibre_link-51" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-4</a></span> is an example dataset based on US population estimates from the US Census <span id="calibre_link-1002">Bureau

</span>
<span id="calibre_link-1003">
              
              
            </span>. The raw dataset used here is only nine rows and has not been aggregated.<div class="table" id="calibre_link-51"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 3-4</span><p class="para3">US Population Estimates</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">US State</p></th><th class="calibre14"><p class="simplepara2">Age Band</p></th><th class="calibre14"><p class="simplepara2">2015 Population</p></th><th class="calibre14"><p class="simplepara2">2016 Population</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">California</p></td><td class="calibre16"><p class="simplepara2">Less than 25</p></td><td class="calibre16"><p class="simplepara2">25,947,866</p></td><td class="calibre16"><p class="simplepara2">25,748,276</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">California</p></td><td class="calibre16"><p class="simplepara2">Less than 50</p></td><td class="calibre16"><p class="simplepara2">26,922,326</p></td><td class="calibre16"><p class="simplepara2">27,188,676</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">California</p></td><td class="calibre16"><p class="simplepara2">50 or Over</p></td><td class="calibre16"><p class="simplepara2">24,805,956</p></td><td class="calibre16"><p class="simplepara2">25,245,954</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Florida</p></td><td class="calibre16"><p class="simplepara2">Less than 25</p></td><td class="calibre16"><p class="simplepara2">11,676,422</p></td><td class="calibre16"><p class="simplepara2">11,729,046</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Florida</p></td><td class="calibre16"><p class="simplepara2">Less than 50</p></td><td class="calibre16"><p class="simplepara2">12,627,122</p></td><td class="calibre16"><p class="simplepara2">12,853,344</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Florida</p></td><td class="calibre16"><p class="simplepara2">50 or Over</p></td><td class="calibre16"><p class="simplepara2">16,049,448</p></td><td class="calibre16"><p class="simplepara2">16,501,676</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Texas</p></td><td class="calibre16"><p class="simplepara2">Less than 25</p></td><td class="calibre16"><p class="simplepara2">19,885,656</p></td><td class="calibre16"><p class="simplepara2">20,033,802</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Texas</p></td><td class="calibre16"><p class="simplepara2">Less than 50</p></td><td class="calibre16"><p class="simplepara2">18,700,892</p></td><td class="calibre16"><p class="simplepara2">19,046,066</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Texas</p></td><td class="calibre16"><p class="simplepara2">50 or Over</p></td><td class="calibre16"><p class="simplepara2">16,036,504</p></td><td class="calibre16"><p class="simplepara2">16,412,550</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1004">When this dataset is imported into DAX, the import engine reads and processes the data row by row. A calculated column added to this dataset determines what the differences between the 2015 and 2016 population might look like:</p><div class="para1" id="calibre_link-1005">
            <div class="programcode" id="calibre_link-1006"><div class="fixedline">Population Difference ='Population by Age'[2016 Population] - 'Population by Age'[2015 Population]</div></div>
          </div><p class="simplepara" id="calibre_link-1007">When the first row is imported, the calculation can be computed easily because the engine has access to every value in the row, including the [2016 Population] and [2015 Population] columns used in the formula. The single-value result of the calculation is then stored in a new column on this row.</p><p class="simplepara" id="calibre_link-1008">The calculation does not use any filter statements, so the filter context is empty. Each row is read in <span id="calibre_link-1009">isolation

</span>
<span id="calibre_link-1010">
              
              
            </span>, so you have no access to any information in any other rows (except through data model relationships with other tables).</p><section class="section" id="calibre_link-107"><h3 class="heading">Column Indexes</h3><p class="simplepara" id="calibre_link-1011">The next step of the import process is to break apart each of the columns into its own data structure. DAX keeps and maintains a separate storage structure for every value in the [US State] column, maintains a separate data structure for the [Age Band] column, and so on. I call these data structures column indexes. The data model applies several types of compression algorithms to each of the column indexes, which I will not detail here, but the key point is that each column index retains enough information to allow it to understand the original row number each value belonged to.</p><p class="simplepara" id="calibre_link-1012">As I mentioned, the <span id="calibre_link-1013">column indexes

</span> contain a reference to original row numbers, so although it is possible for the engine to stitch rows back together at runtime, it becomes an expensive operation in terms of performance. The DAX engine can compute most calculations very quickly using just a few column indexes without needing to reconstruct large numbers of complete rows.</p><div class="para1" id="calibre_link-1014">Let’s look at an example of how DAX uses the column indexes to generate a result. Say you would like to create a pivot table that uses the nine rows of population estimates and focus on the [2015 Population] broken down by [Age Band]. A pivot table would look like Figure <span><a href="#calibre_link-52" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-13</a></span>. The top value of 57,509,944 has been highlighted; it is the combined total of three underlying rows that originally belonged to California, Florida, and Texas.<figure class="figure1" id="calibre_link-52"><div class="mediaobject" id="calibre_link-1015"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig13_HTML.jpg" src="images/000049.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-13</span><p class="simplepara1">Pivot table using the [2015 Population] calculated measure</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1016">The formula for the calculated measure is simple enough. This is the DAX to create this as an explicit measure:</p><div class="para1" id="calibre_link-1017">
              <div class="programcode" id="calibre_link-1018"><div class="fixedline">2015 Population = SUM('Population by Age'[2015 Population])</div></div>
            </div><p class="simplepara" id="calibre_link-1019">The SUM function is passed a reference to the [2015 Population] column. The filter context in effect is that SUM should only consider rows where the [Age Band] has a value of “Less than 25”.</p><div class="para1" id="calibre_link-1020">Before the SUM <span id="calibre_link-1021">function

</span>
<span id="calibre_link-1022">
                
                
              </span> can begin, the <span id="calibre_link-1023">engine

</span> first needs to scan the [Age Band] column index to obtain the original row numbers for all values it has for “Less than 25”. These are likely to be sorted and grouped together, so the scan will quickly return a list of row numbers, which in this case are rows 1, 4, and 7 (Table <span><a href="#calibre_link-53" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-5</a></span>). The next step is to allow the SUM function to proceed, but only for values that have these three numbers as row numbers.<div class="table" id="calibre_link-53"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 3-5</span><p class="para3">Rows Used by SUM Function Filtered by [Age Band]</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Row Number</p></th><th class="calibre14"><p class="simplepara2">Age Band</p></th><th class="calibre14"><p class="simplepara2">Row Number</p></th><th class="calibre14"><p class="simplepara2">2015 Population</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">Less than 25</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">25,947,866</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">4</p></td><td class="calibre16"><p class="simplepara2">Less than 25</p></td><td class="calibre16"><p class="simplepara2">4</p></td><td class="calibre16"><p class="simplepara2">11,676,422</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">7</p></td><td class="calibre16"><p class="simplepara2">Less than 25</p></td><td class="calibre16"><p class="simplepara2">7</p></td><td class="calibre16"><p class="simplepara2">19,885,656</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1024">Once you have the [2015 Population] for rows 1, 4, and 7, the engine can return a value of 57,509,944 to the appropriate cell (Figure <span><a href="#calibre_link-54" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-14</a></span>).</p><p class="simplepara" id="calibre_link-1025">This is repeated for the second row, but in this case the row numbers retrieved from the [Age Band] column index for “Less than 50” are rows 2, 5, and 8.</p><p class="simplepara" id="calibre_link-1026">The calculation then identifies that rows 3, 6, and 9 are required for the “50 or Over” values.</p><div class="para1" id="calibre_link-1027">For the final row, there is no need to scan the [Age Band] column index, so all values from the [2015 Population] column are passed to the SUM function for the output of 172,652,192.<figure class="figure1" id="calibre_link-54"><div class="mediaobject" id="calibre_link-1028"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig14_HTML.jpg" src="images/000028.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-14</span><p class="simplepara1">Pivot table using the [2015 Population] calculated measure</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1029">In summary, to compute the numbers for all but the total row, the engine needed to access two column indexes and no more. It did not need to scan or read the column indexes for [US State] or [2016 Population]. The value returned for the final row could be determined by reading just the [2015 Population]. The only context that was in effect was query <span id="calibre_link-1030">context

</span>
<span id="calibre_link-1031">
                
                
              </span>.</p><p class="simplepara" id="calibre_link-1032">The underlying query <span id="calibre_link-1033">engine

</span> may approach these steps in a way that is more efficient, but if you think about what is logically required by the engine to produce the final value for each cell, it may help to understand the effect of the three types of context.</p></section></section><section class="section" id="calibre_link-108"><h2 class="heading">Context <span id="calibre_link-1034">Transition

</span>
</h2><p class="simplepara" id="calibre_link-1035">On occasion, you need to convert a row context to a filter context. This is because some DAX functions do not understand row context.</p><p class="simplepara" id="calibre_link-1036">The row context example from earlier in the chapter used the following formula:</p><div class="para1" id="calibre_link-1037">
            <div class="programcode" id="calibre_link-1038"><div class="fixedline">Estimated Weight =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Quantity] *</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELATED(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Stock Item'[Typical Weight Per Unit]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><p class="simplepara" id="calibre_link-1039">This calculation doesn’t use DAX functions such as SUM or AVERAGE, so it can compute a result that is meaningful and expected.</p><p class="simplepara" id="calibre_link-1040">Let’s look at what happens when you use a DAX function that does not understand row context by adding the following two calculated columns to the ‘Fact Sale’ table.</p><div class="para1" id="calibre_link-1041">
            <div class="programcode" id="calibre_link-1042"><div class="bookfrontmatter"><div class="fixedline1">New Quantity Column 1 = SUM ( 'Fact Sale'[Quantity] )</div></div><div class="bookfrontmatter"><div class="fixedline1">New Quantity Column 2 = CALCULATE( SUM( 'Fact Sale'[Quantity] ) )</div></div></div>
          </div><div class="para1" id="calibre_link-1043">Both calculated columns use the SUM <span id="calibre_link-1044">function

</span> and the same column reference is used for both. The only difference is the second calculated column is using the CALCULATE function around the SUM function. The results are shown in the two right-hand columns in Figure <span><a href="#calibre_link-55" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">3-15</a></span>.<figure class="figure1" id="calibre_link-55"><div class="mediaobject" id="calibre_link-1045"><img alt="../images/456681_1_En_3_Chapter/456681_1_En_3_Fig15_HTML.jpg" src="images/000019.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-15</span><p class="simplepara1">Sample of ‘Fact Sale’ showing new calculated columns</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1046">For the [New Quantity Column 1] column, you can see the value 8,950,628 repeated in every row of the table for this column. The filter context is empty for each execution of this version of the calculation, so the SUM function has access to every row in the ‘Fact Sale’[Quantity] column.</p><p class="simplepara" id="calibre_link-1047">The [New Quantity Column 2] column produces a different result that highlights the effect of context transition. The <span id="calibre_link-1048">CALCULATE function
</span> knows it is being used in a calculated column, so it converts the existing row context for each line into a column-based filter rule that is then added to the filter context. This time around, each execution of the SUM function runs using a heavily filtered version of the ‘Fact Sale’[Quantity] column.</p><p class="simplepara" id="calibre_link-1049">Context transition can only convert row context to filter context. Context is never converted the other way.</p></section></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-109">
<div id="calibre_link-1050" class="calibre2">
<div id="calibre_link-1051" class="calibre3"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1052"><div class="bookfrontmatter">©&nbsp;Philip Seamark&nbsp;2018</div><span class="pcalibre5"><span><span>Philip&nbsp;Seamark</span></span></span><span><span class="booktitle1" type="title" lang="en">Beginning DAX with Power BI</span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-3477-8_4" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">https://doi.org/10.1007/978-1-4842-3477-8_4</a></span></div></div><div class="maintitlesection"><h1 class="chaptertitle" lang="en">4.&nbsp;Summarizing and Aggregating</h1></div><div class="bookfrontmatter"><div class="bookfrontmatter"><span><span>Philip&nbsp;Seamark</span><sup class="calibre6"><a href="#calibre_link-245" class="pcalibre3 pcalibre4 pcalibre1 pcalibre2 pcalibre calibre7">1</a>&nbsp;<span class="contacticon"></span></sup></span></div><div class="bookfrontmatter"><div class="bookfrontmatter" id="calibre_link-245"><span class="affiliationnumber">(1)</span><div class="bookfrontmatter">UPPER HUTT, New Zealand</div></div><div class="clearboth">&nbsp;</div></div></div><div class="bookfrontmatter"><p class="para" id="calibre_link-1053">When it comes to data modeling, a common requirement is to generate summary versions of existing tables. This chapter explores some of the options available to you in DAX.</p><p class="simplepara" id="calibre_link-1054">There are plenty of reasons why you might consider adding a summary table to your data model. Used well, summary tables can greatly improve performance. A large table made up of millions of transactions with thousands of rows per day can be a great candidate for a summary table that may only have one row per day. Metrics can be calculated while aggregating and stored as columns to provide most of the same reporting that might otherwise take place over the raw data. Visuals that use such a summary table are much faster as long as you only need to plot by day, month, or year.</p><p class="simplepara" id="calibre_link-1055">It’s important to be aware that when you create a <span id="calibre_link-1056">summary table

</span> like this, you lose the ability to cross filter on any level of aggregation not included in the summary table. But with some thought and planning, you can optimize a Power BI report to provide a much better experience for your end users.</p><p class="simplepara" id="calibre_link-1057">Other uses of a <span id="calibre_link-1058">summary table

</span> may revolve around helping you understand some behavioral features in your dataset; for instance, when was the first and/or last time a customer made a purchase using the MIN and MAX functions over a purchase date column? You can join the resultant summary table back to the original table as a smart way of filtering records dynamically based on the first/last purchase date, which may be different for each customer. You can also use a summary table to find the top ten products based on sales using grouping and ranking together.</p><div class="para4" id="calibre_link-1059">These are the main DAX functions that provide the ability to create summary tables:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-1060">SUMMARIZE</p></li><li class="calibre8"><p class="para2" id="calibre_link-1061">SUMMARIZECOLUMNS</p></li><li class="calibre8"><p class="para2" id="calibre_link-1062">
                <span id="calibre_link-1063">GROUPBY

</span>
              </p></li></ul></div>
</div><p class="simplepara" id="calibre_link-1064">This chapter looks at these functions in more detail and covers the differences between each with suggestions as to when you might choose one over the other. For simple examples over small sets of data, they are practically interchangeable. However, for more complex scenarios using larger datasets, choosing the right function can make a significant difference.</p><p class="simplepara" id="calibre_link-1065">The <span id="calibre_link-1066">summarization functions

</span> all return a new table as their output. They are often used as the main function in part of a calculate table expression as well as part of complex working logic inside a calculated measure.</p><p class="simplepara" id="calibre_link-1067">The functions are similar in that you can specify columns to be used to group by. If no columns are specified, the function only returns a single-row table. If one column is used to group by, the number of rows reflect the total number of unique values in that column. The number of rows may grow as additional columns are added, but not always. Adding a calendar month column to a summarization function that is already grouping by calendar day does not add any rows to the final output.</p><p class="simplepara" id="calibre_link-1068">The columns used to group can exist across multiple tables, as long as you have defined relationships appropriately. These are typically “upstream” tables that can also be referred to as tables on the “one side” of a DAX relationship.</p><p class="simplepara" id="calibre_link-1069">I use the same example to demonstrate each of the summarization functions. These all use the WideWorldImportersDW dataset and create a summary over the 228,265-row ‘Fact Sale’ table and group by the [State Province] and [Calendar Month] columns. An aggregation column that carries a sum over the ‘Fact Sale’[Quantity] column is added to each summary table.</p><p class="simplepara" id="calibre_link-1070">Listing <span><a href="#calibre_link-246" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-1</a></span> shows what the <span id="calibre_link-1071">T-SQL-equivalent statement

</span> for this looks like:</p><div class="para1" id="calibre_link-246">
          <div class="programcode" id="calibre_link-1072"><div class="bookfrontmatter"><div class="fixedline1">SELECT</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Date].[Calendar Month Label],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[City].[State Province],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(Sale.Quantity) AS [Sum of Qty]</div><div class="fixedline1">FROM [Fact].[Sale] AS [Sale]</div></div><div class="bookfrontmatter"><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN [Dimension].[Date] AS [Date]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON [Date].[Date] = Sale.[Delivery Date Key]</div></div><div class="bookfrontmatter"><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN [Dimension].[City] AS [City]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON [City].[City Key] = Sale.[City Key]</div></div><div class="bookfrontmatter"><div class="fixedline1">GROUP BY</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Date].[Calendar Month Label],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[City].[State Province]</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-1</span><p class="para3">T-SQL Baseline Example</p></div></div></div>
        </div><p class="simplepara" id="calibre_link-1073">The resulting table contains 2,008 rows, down from nearly quarter of a million rows, which is a ratio of 111:1, or is a new table that is less than 1% the size of the original.</p><p class="simplepara" id="calibre_link-1074">Any <span id="calibre_link-1075">visual

</span> using this summary table has less work to do to generate values when used in a report. If the report only ever filters by the [Calendar Month Label] or [State Province] fields, then this is a good thing. However, if you need to represent other levels of filtering, then consider modifying the summary table or creating additional summary tables.</p><section class="section" id="calibre_link-110"><h2 class="heading">The SUMMARIZE Function</h2><p class="simplepara" id="calibre_link-1076">The first function we look at is the SUMMARIZE function. The syntax for calling this <span id="calibre_link-1077">function


</span> is as follows:</p><div class="para1" id="calibre_link-1078">
            <div class="programcode" id="calibre_link-1079"><div class="fixedline">SUMMARIZE (&lt;table&gt;, &lt;groupBy_columnName1&gt;..., &lt;name1&gt;, &lt;expression1&gt; ...)</div></div>
          </div><p class="simplepara" id="calibre_link-1080">The first parameter required is a value for &lt;table&gt;. This can be the name of any table that exists in your model, which can include other calculated tables. It can also be a function that returns a table, or a table expression stored in a variable. You can only provide one table.</p><div class="formalpara" id="calibre_link-1081"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-1082">You cannot use aggregation functions in a SUMMARIZE function over the output of another SUMMARIZE function in the same statement. If you need to perform a multilayer aggregation, you need to use the GROUPBY function, otherwise create two table statements.</p></div><p class="simplepara" id="calibre_link-1083">The second parameter can be the name of any column from the table specified as the first parameter or a column from any table with a relationship defined in your data model. You can continue to pass column references as the third, fourth, and fifth parameters (and so on). The DAX engine is smart enough to be able to figure out what to do based on the type of value you are passing to the function. As long as you continue to pass table columns, the <span id="calibre_link-1084">function


</span> knows that these are the columns you wish to group by.</p><p class="simplepara" id="calibre_link-1085">You are not required to pass any column references to the function if you don’t want to. If your intention is to simply group your base table to a single line, you can start to provide &lt;name&gt; and &lt;expression&gt; pairs immediately after the first argument.</p><p class="simplepara" id="calibre_link-1086">Once you stop passing table columns, you can start adding pairs of parameters to the function. These pairs exist in the form of a text value and a DAX expression. The &lt;name&gt; value is text that you use to set the name of the column. You need to encapsulate the text in double quotes. The other parameter in the pair is the &lt;expression&gt; value, which is a valid DAX calculation. This is the aggregation component of the summary table. This example uses a single pair of &lt;name&gt;/&lt;expression&gt; parameters, but like the &lt;groupBy_columnName&gt; arguments, it’s possible to pass additional parameters as long as they match the &lt;name&gt;/&lt;expression&gt; signature.</p><p class="simplepara" id="calibre_link-1087">The example in Listing <span><a href="#calibre_link-247" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-2</a></span> has been formatted in a way that makes it easier to follow.</p><div class="para1" id="calibre_link-247">
            <div class="programcode" id="calibre_link-1088"><div class="fixedline">Summary Table using SUMMARIZE =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Table to Summarize --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group by --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation Columns --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Qty",SUM('Fact Sale'[Quantity])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-2</span><p class="para3">DAX Example Using the SUMMARIZE Function</p></div></div></div>
          </div><div class="para1" id="calibre_link-1089">Let’s map the parameters in this example back to the syntax specification so you can see how the function works (Table <span><a href="#calibre_link-248" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-1</a></span>).<div class="table" id="calibre_link-248"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 4-1</span><p class="para3">Syntax Mapping of the SUMMARIZE Function</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Syntax</p></th><th class="calibre14"><p class="simplepara2">Example</p></th><th class="calibre14">&nbsp;</th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">&lt;table&gt;</p></td><td class="calibre16"><p class="simplepara2">‘Fact Sale’</p></td><td class="calibre16">&nbsp;</td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">&lt;groupBy_columnName1&gt;</p></td><td class="calibre16"><p class="simplepara2">‘Dimension Date’[Calendar Month Label]</p></td><td class="calibre16">&nbsp;</td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">&lt;groupBy_columnName2&gt;</p></td><td class="calibre16"><p class="simplepara2">‘Dimension City’[State Province]</p></td><td class="calibre16">&nbsp;</td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">&lt;name1&gt;, &lt;expression1&gt;</p></td><td class="calibre16"><p class="simplepara2">“Sum of Qty”</p></td><td class="calibre16"><p class="simplepara2">SUM(‘Fact Sale’[Quantity])</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1090">The SUMMARIZE function returns a new table that otherwise has the appearance of any other table in your data model. You can use this table for visuals and filters and can relate it to other tables. You can add calculated columns and calculated measures. You can also now create calculated tables using the table created by the output of a SUMMARIZE function as your base table if you want to create a second layer of aggregation over your additional <span id="calibre_link-1091">data


</span>.</p><div class="para1" id="calibre_link-1092">Figure 4-1 has a blank value in the top-left row of the results. This means that there are records in the ‘Fact Sale’ table that have no value in the [Delivery Date Key] column or there are values in this column that don’t exist in the ‘Date Dimension’[Date] column. These are kept in the result set, and in this figure you can see the SUM of the original Quantity column add to 790.<figure class="figure1" id="calibre_link-1093"><div class="mediaobject" id="calibre_link-1094"><img alt="../images/456681_1_En_4_Chapter/456681_1_En_4_Fig1_HTML.jpg" src="images/000042.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-1</span><p class="simplepara1">Sample output using the SUMMARIZE function</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1095">One way to better understand the rows involved that have no date is by adding an additional aggregation <span id="calibre_link-1096">column


</span> to the summary table using the &lt;name&gt;/&lt;expression&gt; pair like this:</p><div class="para1" id="calibre_link-1097">
            <div class="programcode" id="calibre_link-1098"><div class="fixedline">"Count of Rows", COUNTROWS('Fact Sale')</div></div>
          </div><p class="simplepara" id="calibre_link-1099">This adds a fourth column to the calculated table that carries a value that shows the number of rows for each grouping, potentially providing extra insight as to many records may be affected by the mismatch.</p><p class="simplepara" id="calibre_link-1100">Alternately, you can use the FILTER function to generate a calculated table showing every value in the ‘Fact Sale’[Invoice Date Key] column that doesn’t have a corresponding value in the ‘Dimension Date’[Date] column. The code for this might look like</p><div class="para1" id="calibre_link-1101">
            <div class="programcode" id="calibre_link-1102"><div class="fixedline">Table of Missing Data =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ISBLANK(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELATED('Dimension Date'[Date])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><p class="simplepara" id="calibre_link-1103">This generates a new <span id="calibre_link-1104">calculated table


</span> in the model that is a filtered copy of ‘Fact Sale’ and only has rows where there are no matching rows in the ‘Dimension Date’ table.</p><p class="simplepara" id="calibre_link-1105">The results of this useful debugging technique are 284 records in ‘Fact Sale’ that have a blank value in the [Delivery Date Key] column. These probably represent recent sales that have yet to be delivered.</p><p class="simplepara" id="calibre_link-1106">The provides a DAX equivalent to a T-SQL LEFT JOIN query that is used to identify the values/rows from the left table that have no matching values/rows from the right query.</p><p class="simplepara" id="calibre_link-1107">This calculated table that has been created can be removed once the data issue investigation work is complete.</p><section class="section" id="calibre_link-111"><h3 class="heading">Relationships</h3><p class="simplepara" id="calibre_link-1108">This example does not provide the SUMMARIZE function with any information on how to join the ‘Fact Sale’ table to the ‘Dimension Date’ and ‘Dimension City’ tables, yet the function is still able to group the data accurately the way we want using columns spanning three tables. In T-SQL statements, we provide hints on how to join tables using the ON and WHERE clauses, whereas the DAX engine uses the Relationship mechanism to determine how to connect the tables at query time.</p><p class="simplepara" id="calibre_link-1109">In this case, the data model has an existing <span id="calibre_link-1110">relationship


</span> defined between the ‘Fact Sales’ table and the ‘Dimension Date’ table. This relationship specifies that the [Delivery Date Key] column from the ‘Fact Sale’ table relates to the [Date] column from the ‘Dimension Date’ table.</p><p class="simplepara" id="calibre_link-1111">The other <span id="calibre_link-1112">relationship


</span> in play for this calculation is between the ‘Fact Sale’ table and the ‘Dimension City’ table using the [City Key] column on both sides. The SUMMARIZE function automatically uses the active relationships to construct the query required.</p><p class="simplepara" id="calibre_link-1113">In DAX, it’s possible to define multiple relationships between the same two tables. Only one can be active at any time, and the decision as to which relationship is active needs to be manually set by the author of the data model. It is the active relationship that is used by default that, in this case, joins the ‘Fact Sale’ table to the ‘Dimension Date’ table using the [Invoice Date Key] column.</p><section class="section" id="calibre_link-1114"><h4 class="heading2">
                <span id="calibre_link-1115">Alternative Relationships


</span>
              </h4><p class="simplepara" id="calibre_link-1116">If you want to create a summary table using the same columns but you want to aggregate ‘Fact Sale’ data using a using a different date column, such as [Invoice Date Key], you can either manually edit the existing relationships between ‘Fact Sales’ and ‘Dimension Date’ to specify the appropriate relationship to be the active relationship or you can write your calculated table formula a different way to take advantage of an alternative relationship. Remember that in DAX, the relationship that is marked as ‘Active’ is the one used by default when you are writing formulas that involve multiple tables.</p><p class="simplepara" id="calibre_link-1117">Listing <span><a href="#calibre_link-249" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-3</a></span> shows what the calculated table looks like if you want to use one of the inactive relationships. Your data model has an inactive relationship between ‘Fact Sale’[Invoice Date Key] and ‘Dimension Date’[Date].</p><div class="para1" id="calibre_link-249">
                <div class="programcode" id="calibre_link-1118"><div class="fixedline">Summary Table using SUMMARIZE =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Table to Summarize</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group by</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation Columns</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Qty",SUM('Fact Sale'[Quantity])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<strong class="emphasistypebold">,</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">USERELATIONSHIP(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Fact Sale'[Invoice Date Key],</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Dimension Date'[Date])</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-3</span><p class="para3">SUMMARIZE Using the USERELATIONSHIP Function</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-1119">Here you have encapsulated your original DAX expression inside a CALCULATETABLE function. This allows a filter function to be used. The first parameter is the same as in the calculation you used earlier. The second parameter of the CALCULATETABLE function is the USERELATIONSHIP filter function that instructs the DAX engine to connect ‘Fact Sale’ to ‘Dimension Date’ using the [Invoice Date Key] <span id="calibre_link-1120">column


</span>.</p><p class="simplepara" id="calibre_link-1121">The result of this query shows the same three columns, but this time the [Sum of Qty] column has results that represent the date of the invoice rather than the date of delivery. This approach does rely on a relationship to exist, even if it is inactive. If there is no relationship between ‘Fact Sale’ and ‘Dimension Date’ via [Invoice Date Key], the calculated table is not loaded to the table.</p><p class="simplepara" id="calibre_link-1122">It might be useful to incorporate this into the name of the new calculated table in some way to make it easier for end users to understand how the data has been aggregated.</p></section></section><section class="section" id="calibre_link-112"><h3 class="heading">SUMMARIZE with a&nbsp;<span id="calibre_link-1123">Filter


</span>
</h3><p class="simplepara" id="calibre_link-1124">In Listing <span><a href="#calibre_link-250" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-4</a></span>, let’s extend this example by incorporating a filter into the logic of the calculated table.</p><p class="simplepara" id="calibre_link-1125">The addition of a filter restricts the underlying data used for the summary table to a specific sales territory. Another enhancement adds a column to the output that performs a basic calculation to represent an average quantity.</p><div class="para1" id="calibre_link-250">
              <div class="programcode" id="calibre_link-1126"><div class="fixedline">Summary Table using SUMMARIZE (Southwest) =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Table to Summarize</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">FILTER('Fact Sale',RELATED('Dimension City'[Sales Territory]) = "Southwest"),</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group by</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation Columns</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Qty",SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"Average Qty", DIVIDE(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">SUM('Fact Sale'[Quantity]),</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">COUNTROWS('Fact Sale')</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-4</span><p class="para3">SUMMARIZE Function Using a Filter</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1127">To incorporate a filter into the calculation, the ‘Fact Sale’ table used in the first parameter is wrapped in a FILTER <span id="calibre_link-1128">function
</span>
<span id="calibre_link-1129">
                
                
                
              </span>. The FILTER function uses the RELATED function to apply a hardcoded filter to the ‘Dimension City’[Sales Territory] column. The other enhancement is the additional &lt;name&gt;/&lt;expression&gt; to the aggregation columns that shows how you can use multiple aggregation functions (SUM and COUNTROWS) within the expression to achieve a slightly more complex result.</p><p class="simplepara" id="calibre_link-1130">Another way to incorporate an explicit filter predicate is to use the CALCULATETABLE function as shown in Listing <span><a href="#calibre_link-251" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-5</a></span>.</p><div class="para1" id="calibre_link-251">
              <div class="programcode" id="calibre_link-1131"><div class="fixedline">Summary Table using SUMMARIZE (Southwest) =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Table to Summarize</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group by --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation Columns --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Qty",SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Average Qty", DIVIDE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS('Fact Sale')</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Dimension City'[Sales Territory] = "Southwest"</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-5</span><p class="para3">SUMMARIZE Using CALCULATETABLE to Filter</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1132">To incorporate a filter into this calculation, the CALCULATETABLE function is used. The first argument is the SUMMARIZE function we used in Listing <span><a href="#calibre_link-250" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-4</a></span>. The second argument passed to the CALCULATETABLE <span id="calibre_link-1133">function


</span> is a basic filter statement. This filter means the calculation only uses data that matches this predicate; this is much like including a similar statement in the WHERE clause of a T-SQL query.</p></section></section><section class="section" id="calibre_link-113"><h2 class="heading">The <span id="calibre_link-1134">SUMMARIZECOLUMNS Function

</span>
</h2><p class="simplepara" id="calibre_link-1135">Another function you can use to aggregate tables in DAX is the SUMMARIZECOLUMNS function. This newer function has a slightly different signature in terms of syntax. The syntax is as follows:</p><div class="para1" id="calibre_link-1136">
            <div class="programcode" id="calibre_link-1137"><div class="fixedline">SUMMARIZECOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&lt;groupBy_columnName1&gt;...,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&lt;filterTable&gt;...,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&lt;name1&gt;,&lt;expression1&gt; ...</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><p class="simplepara" id="calibre_link-1138">Just as with the SUMMARIZE function, you can pass a dynamic number of parameters to this function. If the first parameter is a reference to a column, the SUMMARIZECOLUMNS function understands that this is a column you would like to group by. If you continue to pass column references, the function treats these as additional group by instructions.</p><p class="simplepara" id="calibre_link-1139">Once you pass a FILTER function (or string value), the function understands that these references are instructions to either apply a filter to the aggregation or to start adding columns that will be the result of a DAX expression such as SUM, COUNT, MIN, and so on.</p><p class="simplepara" id="calibre_link-1140">Using this syntax, the DAX you would use create the scenario using SUMMARIZECOLUMNS is shown in Listing <span><a href="#calibre_link-252" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-6</a></span>.</p><div class="para1" id="calibre_link-252">
            <div class="programcode" id="calibre_link-1141"><div class="fixedline">Summary Table using SUMMARIZECOLUMNS =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZECOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group by</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation Columns</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Qty",SUM('Fact Sale'[Quantity])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-6</span><p class="para3">DAX Example Using SUMMARIZECOLUMNS</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-1142">The difference between the <span id="calibre_link-1143">SUMMARIZE

</span> example in Listing <span><a href="#calibre_link-250" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-4</a></span> and the SUMMARIZECOLUMNS function in this example is the absence of the first parameter in the SUMMARIZE function. This function does not need to pass a base table; however, the results are the same. The function can also group using columns from different, but related, tables. The DAX engine can use the active relationships between the ‘Fact Sales’ table and the two-dimensional tables to return the results required.</p><section class="section" id="calibre_link-114"><h3 class="heading">SUMMARIZECOLUMNS with a&nbsp;Filter</h3><p class="simplepara" id="calibre_link-1144">Another difference between SUMMARIZE and SUMMARIZECOLUMNS is in the latter, you can incorporate a filter as one of the parameters. Using the same requirement as earlier, Listing <span><a href="#calibre_link-253" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-7</a></span> summarizes and aggregates, but only data where the [Sales Territory] is “SouthWest”.</p><div class="para1" id="calibre_link-253">
              <div class="programcode" id="calibre_link-1145"><div class="fixedline">Summary Table using SUMMARIZECOLUMNS (Southwest) =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZECOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group by --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Filter condition --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">FILTER(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ALL(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Dimension City'[Sales Territory]),</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Dimension City'[Sales Territory] = "Southwest"</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation Columns</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Qty",SUM('Fact Sale'[Quantity])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-7</span><p class="para3">The SUMMARIZECOLUMNS Function Using a Filter</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1146">The calculation produces the same 164-row result as the example used with the SUMMARIZE function (Listing <span><a href="#calibre_link-250" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-4</a></span>); however, there is no need to use the CALCULATETABLE function as a means of incorporating a filter. You can still wrap the SUMMARIZE function inside a CALCULATETABLE <span id="calibre_link-1147">function

</span> if you prefer, and if you are using the data provided in the WideWorldImportersDW dataset, there is very little to separate the various approaches in terms of query runtime.</p><p class="simplepara" id="calibre_link-1148">Under the cover, the SUMMARIZETABLE function appears to be doing fewer steps than the SUMMARIZE function; we will explore this type of analysis in more detail in Chapter <span><a href="#calibre_link-160" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>8</span></a></span>.</p></section></section><section class="section" id="calibre_link-115"><h2 class="heading">The GROUP BY Function</h2><p class="simplepara" id="calibre_link-1149">The final aggregation function to look at is the GROUPBY function. This is its <span id="calibre_link-1150">syntax

</span>
<span id="calibre_link-1151">
              
              
              
            </span>:</p><div class="para1" id="calibre_link-1152">
            <div class="programcode" id="calibre_link-1153"><div class="fixedline">GROUPBY(&lt;table&gt;, &lt;groupBy_columnName1&gt;..., &lt;name1&gt;,&lt;expression1&gt; ...)</div></div>
          </div><p class="simplepara" id="calibre_link-1154">GROUPBY is like the SUMMARIZE function in terms of syntax, and again, once you provide a single table reference as the first argument, you can pass any number of column references to let the GROUPBY function know the columns define the level of summarization.</p><p class="simplepara" id="calibre_link-1155">Where GROUPBY differs from SUMMARIZE and SUMMARIZECOLUMNS is in the code passed to the function as part of any of the &lt;expression&gt; arguments. GROUPBY only works with the DAX iterator functions&mdash;so it uses SUMX rather than SUM and AVERAGEX rather than AVERAGE. This makes the GROUPBY function useful in specific scenarios.</p><p class="simplepara" id="calibre_link-1156">If you wanted a calculated table to use the GROUPBY function to produce the same output as the SUMMARIZE and SUMMARIZECOLUMNS examples, you could write it as shown in Listing <span><a href="#calibre_link-254" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-8</a></span>.</p><div class="para1" id="calibre_link-254">
            <div class="programcode" id="calibre_link-1157"><div class="fixedline">Summary Table using GROUPBY =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;GROUPBY(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Table to Group --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group By --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation columns --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Qty",<strong class="emphasistypebold">SUMX( CURRENTGROUP(),'Fact Sale'[Quantity] )</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-8</span><p class="para3">DAX Example Using the GROUPBY Function</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-1158">The code is nearly identical to SUMMARIZE up to the final line, which adds the aggregation column. The DAX expression here is using the SUMX function instead of the SUM function. The SUMX function normally requires a table reference to be passed as the first argument, but here a CURRENTGROUP function is being passed instead. When the GROUPBY function was introduced to DAX, it came with a helper function called CURRENTGROUP(), which can be used in place of the original table.</p><section class="section" id="calibre_link-116"><h3 class="heading">The <span id="calibre_link-1159">CURRENTGROUP( ) Function
</span>
<span id="calibre_link-1160">
                
                
                
              </span>
<span id="calibre_link-1161">
                
                
              </span>
</h3><p class="simplepara" id="calibre_link-1162">The DAX iterator functions generally require a table reference to be passed as the first parameter. However, when used inside a GROUPBY function as is done here, the SUMX function must be passed to the CURRENTGROUP() function; any other value produces an error.</p><p class="simplepara" id="calibre_link-1163">Think of the placement of the CURRENTGROUP() function as a mapping back to the table that was passed as the first parameter of the GROUPBY function. In this case, the table passed was ‘Fact Sale’, so the SUMX function, in effect, processes rows from the ‘Fact Sale’ table.</p><div class="para1" id="calibre_link-1164">The earlier query at Listing <span><a href="#calibre_link-254" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-8</a></span> produces the same output as the previous examples using SUMMARIZE and SUMMARIZECOLUMNS; however, the results of running these three DAX functions side by side in a speed test are shown in Table <span><a href="#calibre_link-255" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-2</a></span>.<div class="table" id="calibre_link-255"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 4-2</span><p class="para3">Time in Milliseconds of Example Using Summary <span id="calibre_link-1165">Functions


</span>
</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">DAX Function</p></th><th class="calibre14"><p class="simplepara2">Average Time (ms)</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">SUMMARIZE</p></td><td class="calibre16"><p class="simplepara2">40</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">SUMMARIZECOLUMNS</p></td><td class="calibre16"><p class="simplepara2">35</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">GROUP BY</p></td><td class="calibre16"><p class="simplepara2">130</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1166">These results are based on the same input and output, and with this very simple example, they show that SUMMARIZECOLUMNS is slightly quicker than SUMMARIZE, whereas <span id="calibre_link-1167">GROUPBY


</span>
<span id="calibre_link-1168">
                
                
              </span>
<span id="calibre_link-1169">
                
              </span> is quite a bit slower.</p><p class="simplepara" id="calibre_link-1170">This suggests that, for small and simple operations, the three functions are practically interchangeable, and you are unlikely to need to worry about which might be the best to use. However, you may prefer to use SUMMARIZE or SUMMARIZECOLUMNS simply for the slightly easier syntax and because you will not need to work with the iterator/CURRENTGROUP requirement.</p><p class="simplepara" id="calibre_link-1171">You may be wondering what to use GROUPBY for given that it is likely to be slower and has a more complex syntax.</p><p class="simplepara" id="calibre_link-1172">Two examples I focus on are its iterators and its ability to perform multiple groupings in the same operation.</p></section><section class="section" id="calibre_link-117"><h3 class="heading">GROUPBY Iterators</h3><p class="simplepara" id="calibre_link-1173">Because the GROUPBY function uses the <span id="calibre_link-1174">DAX


</span>
<span id="calibre_link-1175">
                
                
              </span> iterator functions, such as SUMX, AVERAGEX, MINX, and so on, it can unlock advantages these functions have over standard aggregation functions that allow you to perform calculations that involve other data from the same row.</p><p class="simplepara" id="calibre_link-1176">An example that demonstrates this is extending the aggregation so it is a calculation involving multiple columns. This version multiplies the [Quantity] and [Unit Price] values together to produce a value for [Total Price], which can then be summed up.</p><p class="simplepara" id="calibre_link-1177">The modified code is shown in Listing <span><a href="#calibre_link-256" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-9</a></span>.</p><div class="para1" id="calibre_link-256">
              <div class="programcode" id="calibre_link-1178"><div class="fixedline">Summary Table using GROUPBY =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;GROUPBY(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Table to Group --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group By --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation columns --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Total Price",SUMX(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CURRENTGROUP(),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Fact Sale'[Quantity] * 'Fact Sale'[Unit Price])</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-9</span><p class="para3">The <span id="calibre_link-1179">SUMX Function
</span>
<span id="calibre_link-1180">
                        
                        
                        
                      </span>
<span id="calibre_link-1181">
                        
                        
                      </span> Used Inside a GROUPBY Function</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1182">Without much change, the function now produces a result that allows you to sum multiple columns from each row. The only change has been to the last line of code. The &lt;name&gt; value has been changed to now show “Sum of Total Price”. This has no impact on the calculation and is only good housekeeping. The main change is within the SUMX function; you can now write DAX expressions that include multiple columns from the same row&mdash;in this case, <span class="emphasisfontcategorynonproportional">* 'Fact Sale'[Unit Price]</span> is added to the &lt;expression&gt;. So, with a minor change to the calculation, you can unlock some interesting scenarios, and in this case, the change to the overall query time is undetectable.</p><p class="simplepara" id="calibre_link-1183">SUMMARIZE and SUMMARIZECOLUMNS can also use the iterator functions to calculate over multiple columns from the same row. The equivalent calculation using SUMMARIZECOLUMNS is shown in Listing <span><a href="#calibre_link-257" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-10</a></span>.</p><div class="para1" id="calibre_link-257">
              <div class="programcode" id="calibre_link-1184"><div class="fixedline">Summary Table using SUMMARIZECOLUMNS and SUMX =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZECOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group By --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation columns --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Total Price",SUMX(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Quantity] * 'Fact Sale'[Unit Price])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-10</span><p class="para3">Example of Using the SUMX Function with SUMMARIZECOLUMNS</p></div></div></div>
            </div><div class="formalpara" id="calibre_link-1185"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-1186">Be aware of the trap of thinking that SUMX (col1 * col2) is the same as SUM(col1) * SUM(col2). These produce quite different results. This is a common cause of confusion on internet help forums, particularly around sub/grand total lines.</p></div><p class="simplepara" id="calibre_link-1187">This example can be extended to use columns from related tables in the same calculation. If the ‘Dimension City’ <span id="calibre_link-1188">table


</span>
<span id="calibre_link-1189">
                
                
              </span> has a column called [Weighting] that might carry a multiplier for each city, then as long as you have a valid and active relationship between the ‘Fact Sale’ and ‘Dimension City’ <span id="calibre_link-1190">tables
</span>, you can extend the SUMX function to look more like this:</p><div class="para1" id="calibre_link-1191">
              <div class="programcode" id="calibre_link-1192"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMX(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CURRENTGROUP(),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Quantity] * 'Fact Sale'[Unit Price] <strong class="emphasistypebold">* RELATED('Dimension City</strong><strong class="emphasistypebold">'[Weighting])</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
            </div><p class="simplepara" id="calibre_link-1193">Note the use of the RELATED function to allow the calculation to find and use values from the [Weighting] column as part of the calculation.</p></section><section class="section" id="calibre_link-118"><h3 class="heading">The GROUPBY <span id="calibre_link-1194">Double Aggregation


</span>
<span id="calibre_link-1195">
                
                
              </span>
</h3><div class="bookfrontmatter" id="calibre_link-1196">Another feature of GROUPBY is the ability to perform multiple layers of aggregation in a single statement. For the first look at this, let’s use the dataset in Table <span><a href="#calibre_link-258" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-3</a></span>.<div class="table" id="calibre_link-258"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 4-3</span><p class="para3">Simple Dataset to Help Demonstrate Double Grouping</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Category</p></th><th class="calibre14"><p class="simplepara2">Value</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">1</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">2</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">3</em>
                        </p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">5</em>
                        </p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">6</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">7</em>
                        </p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1197">The <span id="calibre_link-1198">challenge


</span>
<span id="calibre_link-1199">
                
                
              </span> is to take the data in Table <span><a href="#calibre_link-258" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-3</a></span>, find only the highest value for each category, and then add these together to produce a single output for the table. The result should be 3 + 5 + 7 = 15 because the max value for Category A is 3, the max value for Category B is 5, and the max value for Category C is 7. This involves two layers of aggregation. The first is to find a MAX value for a group, and the second is a SUM over the results of the MAX operation.</p><p class="simplepara" id="calibre_link-1200">The SUMMARIZE, SUMMARIZECOLUMNS, and GROUPBY functions can all easily perform the first part of the requirement, which is to generate a three-row aggregation showing the maximum value for each of the categories.</p><p class="simplepara" id="calibre_link-1201">It is the next step that trips the SUMMARIZE and SUMMARIZECOLUMNS functions up because it’s not possible to layer or nest these functions in the same statement, whereas you can with GROUPBY.</p><p class="simplepara" id="calibre_link-1202">The calculation using GROUPBY to meet this requirement is shown in Listing <span><a href="#calibre_link-259" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-11</a></span>.</p><div class="para1" id="calibre_link-259">
              <div class="programcode" id="calibre_link-1203"><div class="fixedline">Table =</div><div class="fixedline">GROUPBY (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">GROUPBY (</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'table1',</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">Table1[Category],</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"My Max", MAXX ( CURRENTGROUP (), 'Table1'[Value] )</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Max values", SUMX ( CURRENTGROUP (), [My Max] )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-11</span><p class="para3">Calculated Table Using Two Layers of Summarization</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1204">There are two GROUPBY statements in this calculation. I refer to the first GROUPBY as the outer GROUPBY, whereas the second GROUPBY highlighted in Listing <span><a href="#calibre_link-259" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-11</a></span> is referred to as the inner GROUPBY.</p><p class="simplepara" id="calibre_link-1205">In this example, the inner GROUPBY is computed first, which returns a table as output. The outer <span id="calibre_link-1206">GROUPBY


</span>
<span id="calibre_link-1207">
                
                
              </span> uses this output as the first parameter that is going to perform the second level of aggregation over the dataset.</p><p class="simplepara" id="calibre_link-1208">The CURRENTGROUP() function appears twice in this calculation and this double grouping example provides a clearer example of the behavior of this function. Each instance of CURRENTGROUP() is paired with a relevant GROUPBY function. The CURRENTGROUP() in the highlighted section is used along with the MAXX iterator function as a reference to ‘Table1’, whereas the CURRENTGROUP() function in the final line is a reference to the output of the inner GROUPBY function.</p><p class="simplepara" id="calibre_link-1209">The example could have used either the SUMMARIZE or SUMMARIZECOLUMNS function in place of the inner GROUPBY, however, only GROUPBY can be used as the outer level of summarization.</p><p class="simplepara" id="calibre_link-1210">It would be better to use SUMMARIZE or SUMMARIZECOLUMNS as the inner layer of summarization in this example since you can meet this requirement without needing an iterator function.</p><p class="simplepara" id="calibre_link-1211">Introducing variables to the computation also helps make the code more readable; one way you can write this is shown in Listing <span><a href="#calibre_link-260" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-12</a></span>.</p><div class="para1" id="calibre_link-260">
              <div class="programcode" id="calibre_link-1212"><div class="fixedline">Table =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;VAR myInnerGroup =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZECOLUMNS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Table1[Category],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"My Max",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAX ('table1'[Value])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GROUPBY(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;myInnerGroup,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of max values",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CURRENTGROUP (), [My Max]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-12</span><p class="para3">Improved Version of Calculated Table Using Two Layers of Summarization</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1213">When you mix the power of iterator-based functions with the multilayer grouping ability of <span id="calibre_link-1214">GROUPBY


</span>
<span id="calibre_link-1215">
                
                
              </span>, you soon find it to be a useful summarization function for more complex scenarios despite the extra time it might take in some scenarios.</p></section><section class="section" id="calibre_link-119"><h3 class="heading">GROUPBY with a&nbsp;<span id="calibre_link-1216">Filter


</span>
<span id="calibre_link-1217">
                
                
              </span>
</h3><p class="simplepara" id="calibre_link-1218">As with the earlier functions, let’s look at how you might apply a filter to the GROUPBY function. Unlike with SUMMARIZECOLUMNS, there is no natural place in the parameter signature to pass a filter. Listing <span><a href="#calibre_link-261" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-13</a></span> shows the first of a pair of examples that restrict the standing example to where ‘Dimension City’[Sales Territory] = “Southwest”.</p><div class="para1" id="calibre_link-261">
              <div class="programcode" id="calibre_link-1219"><div class="fixedline">GROUPBY(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;-- Table to Group --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">FILTER('Fact Sale',RELATED('Dimension City'[Sales Territory])="Southwest"),</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group By --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation columns --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Qty",SUMX(CURRENTGROUP(),'Fact Sale'[Quantity])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-13</span><p class="para3">GROUPBY Function Using a Filter</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1220">Listing <span><a href="#calibre_link-261" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-13</a></span> uses the FILTER <span id="calibre_link-1221">function


</span>
<span id="calibre_link-1222">
                
                
              </span> as the first parameter of the GROUPBY function. The FILTER function returns a table, which is why this can still work in place of a specific table.</p><p class="simplepara" id="calibre_link-1223">Listing <span><a href="#calibre_link-262" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-14</a></span> shows an alternative notation that uses the CALCULATETABLE function.</p><div class="para1" id="calibre_link-262">
              <div class="programcode" id="calibre_link-1224"><div class="fixedline">CALCULATETABLE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;GROUPBY(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Table to Group --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Columns to Group By --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Label],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[State Province],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation columns --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Qty",SUMX(CURRENTGROUP(),'Fact Sale'[Quantity])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">FILTER('Dimension City',[Sales Territory]="Southwest")</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-14</span><p class="para3">Example Using CALCULATETABLE to Filter a GROUPBY</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1225">Here the filter is applied outside the GROUPBY function and is used as a parameter of <span id="calibre_link-1226">CALCULATETABLE


</span>
<span id="calibre_link-1227">
                
                
              </span>. This differs slightly from the first example in that you do not need to use the RELATED function for the cross-table filter to take effect. Both queries produce the same output and on the data volumes used in the WideWorldImportersDW, there was little to separate the two approaches in terms of performance, mostly due to the simple nature of the aggregation functions used.</p><div class="formalpara" id="calibre_link-1228"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-1229">Both these examples use GROUPBY over a physical table. You should show preference to SUMMARIZE and SUMMARIZECOLUMNS when you are using physical tables. These examples are intended to show how you might apply a filter with the GROUPBY function if you need to.</p></div></section></section><section class="section" id="calibre_link-120"><h2 class="heading">Subtotal and Total Lines</h2><p class="simplepara" id="calibre_link-1230">A slightly more advanced use of these summarization functions is being able to inject additional rows into the output in the form of subtotals and grand totals. This is not generally a requirement when writing DAX calculations in Microsoft Power BI because Power BI takes advantage of these functions to generate totals when it is generating the dynamic DAX behind visuals.</p><p class="simplepara" id="calibre_link-1231">If you are writing a DAX statement using the SUMMARIZE function using SQL Server Management Studio (SSMS), DAX Studio, SQL Server Reporting Services (SSRS), or other client tools, you can add the ROLLUP, ROLLUPGROUP, and ISSUBTOTAL functions to inject additional rows and information to the output. These queries work in Power BI, but you may need to filter them so as not to confuse the additional code that Power BI might add.</p><div class="para1" id="calibre_link-1232">Let’s use the same table from earlier, shown again here with a new column called Sub <span id="calibre_link-1233">Category


</span>. This time you are going to group this data by Category and/or Sub Category and show a value that is a sum of the Value column. Additionally, you’ll include subtotal and overall total lines as part of the output.<div class="table" id="calibre_link-1234"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 4-4</span><p class="para3">Simple Dataset to Help Demonstrate Double Grouping</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Category</p></th><th class="calibre14"><p class="simplepara2">Sub Category</p></th><th class="calibre14"><p class="simplepara2">Value</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">A1</p></td><td class="calibre16"><p class="simplepara2">1</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">A1</p></td><td class="calibre16"><p class="simplepara2">2</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">A2</em>
                      </p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">3</em>
                      </p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">B1</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">B2</em>
                      </p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">5</em>
                      </p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">C1</p></td><td class="calibre16"><p class="simplepara2">6</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">C2</em>
                      </p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">7</em>
                      </p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1235">This example uses the SUMMARIZE function to group the data using the Category column and includes an instruction to add an additional line to the output to carry a line for the overall total.</p><p class="simplepara" id="calibre_link-1236">The first <span id="calibre_link-1237">version


</span> of this query is as follows:</p><div class="para1" id="calibre_link-1238">
            <div class="programcode" id="calibre_link-1239"><div class="fixedline">SUMMARIZE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;table1,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ROLLUP ( 'table1'[Category]),</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Value", SUM ( 'table1'[Value] )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><div class="para1" id="calibre_link-1240">The <span id="calibre_link-1241">output


</span> from this calculation is shown in Table <span><a href="#calibre_link-263" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-5</a></span>.<div class="table" id="calibre_link-263"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 4-5</span><p class="para3">Output of the SUMMARIZE Function</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">[Category]</p></th><th class="calibre14"><p class="simplepara2">[Sum of Value]</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">6</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">9</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">13</em>
                      </p></td></tr><tr class="calibre17"><td class="calibre16">&nbsp;</td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">28</em>
                      </p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1242">The bottom row has no value in the Category column and shows the sum value of the other rows. This is the extra row added because the <span id="calibre_link-1243">ROLLUP function
</span>
<span id="calibre_link-1244">
              
              
              
            </span> was added to the calculation.</p><p class="simplepara" id="calibre_link-1245">The value shown in the final line is influenced by the aggregation function used by the column, which in this case was a SUM. Adding two columns that use the MAX and AVERAGE aggregation functions helps show the behavior (Listing <span><a href="#calibre_link-264" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-15</a></span>) and output (Table <span><a href="#calibre_link-265" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-6</a></span>) of the ROLLUP row.</p><div class="para1" id="calibre_link-264">
            <div class="programcode" id="calibre_link-1246"><div class="fixedline">SUMMARIZE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;table1,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ROLLUP ( 'table1'[Category]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Value", SUM ( 'table1'[Value] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Max of Value", MAX ( 'table1'[Value] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Average of Value", FIXED ( AVERAGE ( 'table1'[Value] ), 1 )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-15</span><p class="para3">Using SUMMARIZE with ROLLUP</p></div></div></div>
            <div class="table" id="calibre_link-265"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 4-6</span><p class="para3">The Output of SUMMARIZE with ROLLUP</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">[Category]</p></th><th class="calibre14"><p class="simplepara2">[Sum of Value]</p></th><th class="calibre14"><p class="simplepara2">[Max of Value]</p></th><th class="calibre14"><p class="simplepara2">[Average of Value]</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">6</p></td><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">2.0</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">9</p></td><td class="calibre16"><p class="simplepara2">5</p></td><td class="calibre16"><p class="simplepara2">4.5</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">13</em>
                      </p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">7</em>
                      </p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">6.5</em>
                      </p></td></tr><tr class="calibre17"><td class="calibre16">&nbsp;</td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">28</em>
                      </p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">7</em>
                      </p></td><td class="calibre16"><p class="simplepara2">
                        <em class="emphasistypeitalic">4.0</em>
                      </p></td></tr></tbody></table></div>
          </div><p class="simplepara" id="calibre_link-1247">The value of 7 in the bottom <span id="calibre_link-1248">cell
</span>
<span id="calibre_link-1249">
              
              
              
            </span> in the [Max of Value] column is not the result of a SUM function; rather, it inherits the default aggregation behavior used in the expression for the column. In this case, it shows the highest value from the underlying ‘Table1’[Value] column.</p><p class="simplepara" id="calibre_link-1250">The value in the bottom row of the [Average of Value] column shows that the ROLLUP function is running an aggregation over the raw data rather than an average of the three values shown above it. If it were performing an average of an average, the value would be 4.3.</p><p class="simplepara" id="calibre_link-1251">The FIXED function around the AVERAGE function in the expression specifies that the output should be displayed with a specified number of decimal points. This example uses one decimal place.</p><section class="section" id="calibre_link-121"><h3 class="heading">The <span id="calibre_link-1252">ISSUBTOTAL Function
</span>
<span id="calibre_link-1253">
                
                
                
              </span>
</h3><p class="simplepara" id="calibre_link-1254">You can add a column to the calculation to help identify which lines have been added using the ROLLUP function. Do this by adding the ISSUBTOTAL function to the expression of an aggregation column as follows:</p><div class="para1" id="calibre_link-1255">
              <div class="programcode" id="calibre_link-1256"><div class="fixedline">SUMMARIZE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;table1,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ROLLUP ( 'table1'[Category]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Value", SUM ( 'table1'[Value] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"Is Category Subtotal</strong><strong class="emphasistypebold">", ISSUBTOTAL('table1'[Category])</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
            </div><div class="para1" id="calibre_link-1257">The output of this calculation is shown in Table <span><a href="#calibre_link-266" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-7</a></span>.<div class="table" id="calibre_link-266"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 4-7</span><p class="para3">Output of the SUMMARIZE Function Using ISSUBTOTAL</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">[Category]</p></th><th class="calibre14"><p class="simplepara2">[Sum of Value]</p></th><th class="calibre14"><p class="simplepara2">[Is Category Subtotal]</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">6</p></td><td class="calibre16"><p class="simplepara2">False</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">9</p></td><td class="calibre16"><p class="simplepara2">False</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">13</em>
                        </p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">False</em>
                        </p></td></tr><tr class="calibre17"><td class="calibre16">&nbsp;</td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">28</em>
                        </p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">True</em>
                        </p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1258">This calculation now includes a column with true/false values that help identify which rows have been added to the output because of the ROLLUP function. In this example, only the bottom row carries a value of true in this column as shown in Table <span><a href="#calibre_link-266" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-7</a></span>.</p><p class="simplepara" id="calibre_link-1259">The <span id="calibre_link-1260">ISSUBTOTAL function
</span>
<span id="calibre_link-1261">
                
                
                
              </span> becomes more useful when extra layers of grouping are introduced to a SUMMARIZE function using ROLLUP. Listing <span><a href="#calibre_link-267" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-16</a></span> uses the SUMMARIZE function to create a summary table (Table <span><a href="#calibre_link-268" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-8</a></span>) that is grouped by two columns.</p><div class="para1" id="calibre_link-267">
              <div class="programcode" id="calibre_link-1262"><div class="fixedline">SUMMARIZE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;table1,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ROLLUP ( 'table1'[Category]<strong class="emphasistypebold">, 'table1'[Sub Category]</strong> ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Value", SUM ( 'table1'[Value] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;-----------</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Is Cat SubTotal", ISSUBTOTAL('table1'[Category]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"Is Sub Cat SubTotal", ISSUBTOTAL('table1'[Sub Category])</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-16</span><p class="para3">SUMMARIZE Using an Additional ROLLUP Parameter</p></div></div></div>
              <div class="table" id="calibre_link-268"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 4-8</span><p class="para3">Output of SUMMARIZE Using an Additional ROLLUP Parameter</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">[Category]</p></th><th class="calibre14"><p class="simplepara2">[Sub Category]</p></th><th class="calibre14"><p class="simplepara2">[Sum of Value]</p></th><th class="calibre14"><p class="simplepara2">[Is Cat Sub Total]</p></th><th class="calibre14"><p class="simplepara2">[Is Sub Cat Subtotal]</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">A1</p></td><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">False</p></td><td class="calibre16"><p class="simplepara2">False</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">A2</p></td><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">False</p></td><td class="calibre16"><p class="simplepara2">False</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">B1</em>
                        </p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">4</em>
                        </p></td><td class="calibre16"><p class="simplepara2">False</p></td><td class="calibre16"><p class="simplepara2">False</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">B2</em>
                        </p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">5</em>
                        </p></td><td class="calibre16"><p class="simplepara2">False</p></td><td class="calibre16"><p class="simplepara2">False</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">C1</em>
                        </p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">6</em>
                        </p></td><td class="calibre16"><p class="simplepara2">False</p></td><td class="calibre16"><p class="simplepara2">False</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">C2</em>
                        </p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">7</em>
                        </p></td><td class="calibre16"><p class="simplepara2">False</p></td><td class="calibre16"><p class="simplepara2">False</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16">&nbsp;</td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">6</em>
                        </p></td><td class="calibre16"><p class="simplepara2">False</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">True</em>
                        </p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16">&nbsp;</td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">9</em>
                        </p></td><td class="calibre16"><p class="simplepara2">False</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">True</em>
                        </p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16">&nbsp;</td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">13</em>
                        </p></td><td class="calibre16"><p class="simplepara2">False</p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">True</em>
                        </p></td></tr><tr class="calibre17"><td class="calibre16">&nbsp;</td><td class="calibre16">&nbsp;</td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">28</em>
                        </p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">True</em>
                        </p></td><td class="calibre16"><p class="simplepara2">
                          <em class="emphasistypeitalic">True</em>
                        </p></td></tr></tbody></table></div>
            </div><p class="simplepara" id="calibre_link-1263">Here you have introduced an additional parameter to the ROLLUP function, which tells the SUMMARIZE <span id="calibre_link-1264">function
</span>
<span id="calibre_link-1265">
                
                
                
              </span> to now group by two columns rather than one. This adds a [Sub Category] column but also adds three additional lines of subtotal over the groupings of Category.</p><p class="simplepara" id="calibre_link-1266">An additional aggregation column called [Is Sub Cat Subtotal] has been added using the ISSUBTOTAL function in the expression over the [Sub Category] column to show a true or false value. If the value in this column is false, the row is not a subtotal line of the [Sub Category] column. If the value is true, the line has been added for providing subtotal values.</p><div class="para1" id="calibre_link-1267">Each subtotal line of [Category] has the following characteristics:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-1268">The [Category] column is populated with a value.</p></li><li class="calibre8"><p class="para2" id="calibre_link-1269">The [Sub Category] column is blank.</p></li><li class="calibre8"><p class="para2" id="calibre_link-1270">The [Sum of Value] column carries the default aggregation result for the underlying rows for that category.</p></li><li class="calibre8"><p class="para2" id="calibre_link-1271">The [Is Cat Subtotal] column is false.</p></li><li class="calibre8"><p class="para2" id="calibre_link-1272">The [Is Sub Cat Subtotal] column is true.</p></li></ul></div>
</div><div class="para1" id="calibre_link-1273">The final line of the output happens to be the grand total line. It has the same characteristics as the subtotals over [Category] except<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-1274">The [Category] column is blank.</p></li><li class="calibre8"><p class="para2" id="calibre_link-1275">The [Is Cat Subtotal] column is true.</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-1276">This shows it is possible, with a combination of ROLLUP and ISSUBTOTAL, to enhance your output with additional information that can be useful in some scenarios. You can add additional functionality when using SUMMARIZE with the ROLLUPGROUP function, which when combined with ROLLUP, can be used to combine subtotals to achieve finer control over the final output.</p><p class="simplepara" id="calibre_link-1277">The ROLLUP and <span id="calibre_link-1278">ISSUBTOTAL functions
</span>
<span id="calibre_link-1279">
                
                
                
              </span> are designed to work with the SUMMARIZE function only. The SUMMARIZECOLUMNS function uses a separate set of functions when you are adding lines to the output for showing totals. The main function to highlight is the ROLLUPADDISSUBTOTAL function that is designed to work with SUMMARIZECOLUMNS.</p><p class="simplepara" id="calibre_link-1280">Listing <span><a href="#calibre_link-269" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-17</a></span> uses SUMMARIZECOLUMNS to yield the same output as in Listing <span><a href="#calibre_link-267" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">4-16</a></span>.</p><div class="para1" id="calibre_link-269">
              <div class="programcode" id="calibre_link-1281"><div class="fixedline">SUMMARIZECOLUMNS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ROLLUPADDISSUBTOTAL (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Table1[Category], "Is Cat Sub Total",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Table1[Sub Category], "Is Sub Cat SubTotal"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Value", SUM ( Table1[Value] )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 4-17</span><p class="para3">Using SUMMARIZECOLUMNS with ROLLUPADDISSUBTOTAL</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1282">Note that the syntax is simpler than with SUMMARIZE even though you get the same number of rows and columns. In addition, the ROLLUPADDISSUBTOTAL can be used multiple times and combined with the ROLLUPGROUP function to provide rich control over subtotal and subtotal groupings.</p></section></section></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-122">
<div id="calibre_link-1283" class="calibre2">
<div id="calibre_link-1284" class="calibre3"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1285"><div class="bookfrontmatter">©&nbsp;Philip Seamark&nbsp;2018</div><span class="pcalibre5"><span><span>Philip&nbsp;Seamark</span></span></span><span><span class="booktitle1" type="title" lang="en">Beginning DAX with Power BI</span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-3477-8_5" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">https://doi.org/10.1007/978-1-4842-3477-8_5</a></span></div></div><div class="maintitlesection"><h1 class="chaptertitle" lang="en">5.&nbsp;Joins</h1></div><div class="bookfrontmatter"><div class="bookfrontmatter"><span><span>Philip&nbsp;Seamark</span><sup class="calibre6"><a href="#calibre_link-208" class="pcalibre3 pcalibre4 pcalibre1 pcalibre2 pcalibre calibre7">1</a>&nbsp;<span class="contacticon"></span></sup></span></div><div class="bookfrontmatter"><div class="bookfrontmatter" id="calibre_link-208"><span class="affiliationnumber">(1)</span><div class="bookfrontmatter">UPPER HUTT, New Zealand</div></div><div class="clearboth">&nbsp;</div></div></div><div class="bookfrontmatter"><section class="section" id="calibre_link-123"><h2 class="heading">Joins in DAX</h2><p class="simplepara" id="calibre_link-1286">This chapter looks at options for using and combining data from different tables in calculations without necessarily using the relationship mechanism.</p><p class="simplepara" id="calibre_link-1287">It’s common for calculations to use data from multiple tables. Most scenarios can be covered automatically through the standard table relationship defined in the data model, but not in every case. If you need more flexibility, several DAX functions are available that support joining tables. Some of these provide an experience that should be familiar to you if you are used to writing T-SQL queries. I highlight the similarities and differences in this chapter.</p><div class="para1" id="calibre_link-1288">Here are the functions that I cover:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-1289">GENERATE and CROSSJOIN</p></li><li class="calibre8"><p class="para2" id="calibre_link-1290">NATURALINNERJOIN</p></li><li class="calibre8"><p class="para2" id="calibre_link-1291">NATURALLEFTOUTERJOIN</p></li><li class="calibre8"><p class="para2" id="calibre_link-1292">UNION</p></li><li class="calibre8"><p class="para2" id="calibre_link-1293">LOOKUPVALUE</p></li></ul></div>
</div><section class="section" id="calibre_link-124"><h3 class="heading">Standard Relationship</h3><p class="simplepara" id="calibre_link-1294">If your data model contains more than one table, it’s possible to define rule based links between tables using the standard DAX relationship mechanism. DAX relationships are a link between two tables that define rules on how the relationship should work. Calculations take advantage of these predefined relationships automatically, which can simplify how much code you need when you’re writing most calculations.</p><p class="simplepara" id="calibre_link-1295">There are some limitations in the standard DAX relationship mechanism that do not work for some scenarios.</p><div class="para1" id="calibre_link-1296">
<span id="calibre_link-1297">Relationships

</span> must conform to the following rules:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-1298">The relationship can only be one-to-one, or one-to-many.</p></li><li class="calibre8"><p class="para2" id="calibre_link-1299">Only a single column from each table can be used.</p></li><li class="calibre8"><p class="para2" id="calibre_link-1300">The match criteria must be an exact match equivalent of the = operator and cannot be based on other operators such as &gt;, &gt;=,&lt;, or &lt;= and so on.</p></li><li class="calibre8"><p class="para2" id="calibre_link-1301">Self joins cannot be used. The two tables must be different.</p></li></ul></div>
</div><section class="section" id="calibre_link-1302"><h4 class="heading2">The relationship can only be one-to-one, or one-to-many</h4><p class="simplepara" id="calibre_link-1303">This means that for at least one of the tables involved in the relationship, unique values must exist across every row in the table in the column used for the relationship. This is referred to as “the table on the one side of the <span id="calibre_link-1304">relationship

</span>.”</p><p class="simplepara" id="calibre_link-1305">Values that are the same and exist in more than one row in the table are considered duplicates and generate an error. This is something to be mindful of for future data loads. A successfully created relationship confirms that the current dataset conforms. However, future data loads may introduce duplicated data and therefore generate an error during the refresh.</p><p class="simplepara" id="calibre_link-1306">A common example of <span id="calibre_link-1307">one-to-many relationships
</span>
<span id="calibre_link-1308">
                  
                  
                </span> is between dimension and fact tables such as ‘Dimension Date’ and ‘Fact Sale’. The date table contains a single row for every day, which carries a unique value in the [Date] column. This satisfies the requirement for the table on the one side of a relationship, whereas the ‘Fact Sale’ table can have many rows that carry the same date in the column used in the relationship.</p><p class="simplepara" id="calibre_link-1309">This is a common pattern in data modeling. Fact (or event) tables often have relationships defined to dimension (or lookup) tables. The fact table can have many rows for the same date, customer, or location, with separate tables that contain a single row for every date, customer, or location. These tables typically sit on the one side of any relationship.</p><p class="simplepara" id="calibre_link-1310">You can also consider the tables on the one side of the relationship as <span id="calibre_link-1311">filter tables

</span>. These are ideal tables to use as the basis for slicers and filters in reports. Selections made on these slicers propagate via relationships to any related tables connected on the many side and filter fact data appropriately. This approach works well for analytics and reporting, and the pattern is often described as applying a star schema to your data. Relationships can be created between dimension tables to multiple fact tables. This allows filter selections to apply across large sections of data in the model.</p><p class="simplepara" id="calibre_link-1312">Filters only apply in the direction of the one table to the many table. This means a slicer using a column in the ‘Fact Sale’ table does not automatically apply to calculations using data from the ‘Dimension Date’ table.</p><p class="simplepara" id="calibre_link-1313">One-to-one relationships differ from one-to-<span id="calibre_link-1314">many
</span>
<span id="calibre_link-1315">
                  
                  
                </span> in that the column involved in each table must have unique values. This type of relationship effectively creates a single logical table, or in T-SQL, a full outer join across the two tables.</p></section><section class="section" id="calibre_link-1316"><h4 class="heading2">Only a single column from each table can be used</h4><p class="simplepara" id="calibre_link-1317">It’s not possible to define a relationship using anything more than <span id="calibre_link-1318">one column per table

</span>. If you have a scenario in your data in which you need to enforce a relationship that needs to use data from multiple columns, you can create a new column that concatenates these columns to a single value that you can then use in the relationship, as long as the new column still satisfies the rule of having unique values for any table being used on the one side.</p><p class="simplepara" id="calibre_link-1319">When you’re using this approach, be careful to avoid a key collision from two separate values combining to produce the same result. Combining values “AB” and “CDE” results in the same value as combining “ABC” and “DE”. In this case, an unusual delimiter should reduce the risk of a key collision, for example, “AB” and “#” and “CDE” would now be different than “ABC” and “#” and “DE”.</p></section><section class="section" id="calibre_link-1320"><h4 class="heading2">The match criteria must be an&nbsp;exact match</h4><p class="simplepara" id="calibre_link-1321">The default operator used between the tables involved in a relationship is the <span id="calibre_link-1322">= operator

</span>. This means that for rows to be matched, the relationship only pairs rows from either table where there is an exact match in the values of the two columns involved. This can be a trap when you’re working with similar-looking values.</p><p class="simplepara" id="calibre_link-1323">It’s possible to create a one-to-many (or one-to-one) relationship between a table that uses the Date datatype for the column on one side of the relationship and uses DateTime on the other. Only values at midnight in the column using the DateTime datatype can possibly match values from the column using the Date datatype. This can be confusing when you have two tables that appear to have data that should be matched and, although no errors appear, visuals show less data than you expect.</p><p class="simplepara" id="calibre_link-1324">In this event, consider converting the column in the table that is using the DateTime datatype to use Date instead. If the time component is important, you can use a second column that carries just the time component to satisfy most reporting requirements.</p><p class="simplepara" id="calibre_link-1325">Another common solution is to create a calculated column that only contains the date portion and then create a relationship using the calculated column.</p><p class="simplepara" id="calibre_link-1326">This behavior works well for most scenarios, but occasionally you may want to create a match between tables using more than just the <span id="calibre_link-1327">= operator

</span>. Sometimes using the &gt;= or &lt;= operators can be useful when you need to join rows that span a range of values. An example of this might be when, for each row in a table, you need to find rows in a separate table that are within a period of the first row, such as the prior 14 days.</p></section><section class="section" id="calibre_link-1328"><h4 class="heading2">Self joins cannot be used</h4><p class="simplepara" id="calibre_link-1329">You cannot create a relationship from a table connected back to itself. This type of relationship can be useful to represent hierarchies such as employee/manager scenarios in a table that contains employee data.</p><p class="simplepara" id="calibre_link-1330">The employee and manager can exist as different rows in the same table with values in columns such as EmployeeID and ManagerID being used to help link the two rows. The PATH and PATHITEM functions are available in DAX to help provide a flattened view of these types of data structures inside calculated columns.</p><p class="simplepara" id="calibre_link-1331">This was described to me once as a <span id="calibre_link-1332">Pigs-Ear relationship
</span>
<span id="calibre_link-1333">
                  
                  
                </span>. Not because it was considered a messy data modelling technique, but rather because of the way you might draw the line/arrow in any table relationship diagram. The arrow would look like an ear when drawn around the top corner of the box representing the table.</p><p class="simplepara" id="calibre_link-1334">Other self-join relationships might be useful for finding rows from a table prior to or following a specific row to be used in comparison scenarios.</p></section></section><section class="section" id="calibre_link-125"><h3 class="heading">How to Join Tables Without a Relationship<span id="calibre_link-1335">
                
                
              </span>
</h3><p class="simplepara" id="calibre_link-1336">Now that you understand some of the limitations of the built-in relationship mechanism, let’s explore some of the functions provided in DAX to help us in scenarios where the standard relationship can’t help.</p></section></section><section class="section" id="calibre_link-126"><h2 class="heading">The CROSSJOIN and GENERATE Functions</h2><p class="simplepara" id="calibre_link-1337">Probably my favorite and most used functions for <span id="calibre_link-1338">joining tables


</span> are the GENERATE and CROSSJOIN functions. They have the feel and exhibit a behavior like an INNER JOIN in T-SQL when you combine them with the DAX FILTER function.</p><section class="section" id="calibre_link-127"><h3 class="heading">
              <span id="calibre_link-1339">CROSSJOIN

</span>
              <span id="calibre_link-1340">
                
              </span>
            </h3><p class="simplepara" id="calibre_link-1341">The base syntax of the CROSSJOIN function is as follows.</p><div class="para1" id="calibre_link-1342">
              <div class="programcode" id="calibre_link-1343"><div class="fixedline">CROSSJOIN ( &lt;table&gt;, &lt;table&gt; [, &lt;table&gt;]...)</div></div>
            </div><p class="simplepara" id="calibre_link-1344">The minimum requirement is for two tables to be passed, but you can add additional tables. The result is a cartesian effect in which every row from the first table is matched with every row from the second table. Then every row from joining the first two tables is matched with every row in the third table. This can quickly generate output that is a table with many rows.</p><p class="simplepara" id="calibre_link-1345">The output of the CROSSJOIN function is a table. You can use this table as a calculated table if you are using a version of DAX that supports the use of calculated tables or as a table expression within a DAX calculation.</p><p class="simplepara" id="calibre_link-1346">If the table you use in the first argument has 10 rows, and the second table also has 10 rows, the unfiltered output is 100 rows. If an additional table also has 10 rows, then the unfiltered output is now 1,000 rows. This is equivalent to the following T-SQL statement:</p><div class="para1" id="calibre_link-1347">
              <div class="programcode" id="calibre_link-1348"><div class="fixedline">SELECT</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*</div><div class="fixedline">FROM TableA</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CROSS JOIN TableB</div></div>
            </div><p class="simplepara" id="calibre_link-1349">Or for those who are old school reading this book</p><div class="para1" id="calibre_link-1350">
              <div class="programcode" id="calibre_link-1351"><div class="fixedline">SELECT * FROM TableA, TableB</div></div>
            </div><p class="simplepara" id="calibre_link-1352">These T-SQL statements yield the same result. Neither has a WHERE clause to filter the number of rows for the final output down so it returns the number of rows in TableA × the number of rows in <span id="calibre_link-1353">TableB

</span>
<span id="calibre_link-1354">
                
              </span>.</p></section><section class="section" id="calibre_link-128"><h3 class="heading">GENERATE</h3><p class="simplepara" id="calibre_link-1355">The base syntax for <span id="calibre_link-1356">GENERATE

</span> is as follows:</p><div class="para1" id="calibre_link-1357">
              <div class="programcode" id="calibre_link-1358"><div class="fixedline">GENERATE ( &lt;table1&gt;, &lt;table3&gt; )</div></div>
            </div><p class="simplepara" id="calibre_link-1359">This differs from CROSSJOIN in that only two tables can be used, otherwise the output is the full cartesian product of the tables passed as parameters. The two parameters must be different tables.</p><div class="formalpara" id="calibre_link-1360"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-1361">Use GENERATE, and not CROSSJOIN, when you are planning to use the FILTER function.</p></div><div class="bookfrontmatter" id="calibre_link-1362">Let me use the following <em class="emphasistypeitalic">unrelated</em> tables (Table <span><a href="#calibre_link-209" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-1</a></span> and <span><a href="#calibre_link-210" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-2</a></span>) to demonstrate the behavior of the <span id="calibre_link-1363">GENERATE function

</span>.<div class="table" id="calibre_link-209"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-1</span><p class="para3">Dataset to Be Used as TableA</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">ID</p></th><th class="calibre14"><p class="simplepara2">Make</p></th><th class="calibre14"><p class="simplepara2">Model</p></th><th class="calibre14"><p class="simplepara2">Value</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">Toyota</p></td><td class="calibre16"><p class="simplepara2">Corolla</p></td><td class="calibre16"><p class="simplepara2">10</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">Hyundai</p></td><td class="calibre16"><p class="simplepara2">Elantra</p></td><td class="calibre16"><p class="simplepara2">20</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">Ford</p></td><td class="calibre16"><p class="simplepara2">Focus</p></td><td class="calibre16"><p class="simplepara2">30</p></td></tr></tbody></table></div>
<div class="table" id="calibre_link-210"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-2</span><p class="para3">Dataset to Be Used as TableB</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Make</p></th><th class="calibre14"><p class="simplepara2">Model</p></th><th class="calibre14"><p class="simplepara2">Year</p></th><th class="calibre14"><p class="simplepara2">Index</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Toyota</p></td><td class="calibre16"><p class="simplepara2">Corolla</p></td><td class="calibre16"><p class="simplepara2">2018</p></td><td class="calibre16"><p class="simplepara2">100</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Toyota</p></td><td class="calibre16"><p class="simplepara2">Corolla</p></td><td class="calibre16"><p class="simplepara2">2018</p></td><td class="calibre16"><p class="simplepara2">200</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Hyundai</p></td><td class="calibre16"><p class="simplepara2">Elantra</p></td><td class="calibre16"><p class="simplepara2">2019</p></td><td class="calibre16"><p class="simplepara2">300</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Hyundai</p></td><td class="calibre16"><p class="simplepara2">Elantra</p></td><td class="calibre16"><p class="simplepara2">2019</p></td><td class="calibre16"><p class="simplepara2">400</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">Ford</p></td><td class="calibre16"><p class="simplepara2">Focus</p></td><td class="calibre16"><p class="simplepara2">2018</p></td><td class="calibre16"><p class="simplepara2">500</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">Ford</p></td><td class="calibre16"><p class="simplepara2">Focus</p></td><td class="calibre16"><p class="simplepara2">2019</p></td><td class="calibre16"><p class="simplepara2">600</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1364">Let’s start with a simple <span id="calibre_link-1365">query

</span>. A calculated measure to show the total number of rows from the result of the <span id="calibre_link-1366">GENERATE function

</span> would look like this:</p><div class="para1" id="calibre_link-1367">
              <div class="programcode" id="calibre_link-1368"><div class="fixedline">My Count of Rows =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE('TableA','TableB')</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
            </div><p class="simplepara" id="calibre_link-1369">This returns the value of 18, which is the result of three rows from TableA multiplied by the six rows of TableB.</p><p class="simplepara" id="calibre_link-1370">This calculation can be updated to apply a join criteria<span id="calibre_link-1371">
                
                
              </span> on the [Make] columns as shown in Listing <span><a href="#calibre_link-211" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-1</a></span>.</p><div class="para1" id="calibre_link-211">
              <div class="programcode" id="calibre_link-1372"><div class="fixedline">My Count of Rows =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableA',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableB',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableA'[Make] = 'TableB'[Make]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-1</span><p class="para3">Using GENERATE in a Calculated Measure with a Filter</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1373">The <span id="calibre_link-1374">GENERATE function

</span> now uses a FILTER function as the second parameter that is applying the join criteria. This is the DAX equivalent of providing predicates in the ON or WHERE clauses in a T-SQL statement. The filter expression specifies that only rows between TableA and TableB that have matching values in the [Make] column should be returned. The result of this calculated measure is 6.</p><p class="simplepara" id="calibre_link-1375">This could have been achieved using a standard DAX relationship. Let’s now include a second column in the match requirement using [Model] as well as an additional criterion&mdash;that the value in the year column should be earlier than 2019.</p><p class="simplepara" id="calibre_link-1376">The new calculation with the additional filter criterion is shown in Listing <span><a href="#calibre_link-212" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-2</a></span>.</p><div class="para1" id="calibre_link-212">
              <div class="programcode" id="calibre_link-1377"><div class="fixedline">My Count of Rows =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableA',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableB',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableA'[Make] = 'TableB'[Make] &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'TableA'[Model] = 'TableB'[Model]</strong> &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'TableB'[Year] &lt; 2019</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-2</span><p class="para3">Using Additional Filter Criterion in a GENERATE Function</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1378">The FILTER function allows for rules that are more sophisticated than those you can use with standard DAX relationships. The result of this calculated measure over the sample data should be 3. I could have used <span class="emphasisfontcategorynonproportional">'TableB'[Year] = 2018</span> in this dataset to arrive at the same result, but I wanted to highlight the ability to use an operator other than = for the matching criteria.</p><p class="simplepara" id="calibre_link-1379">The same output could also be generated using a relationship and the following calculated measure:</p><div class="para1" id="calibre_link-1380">
              <div class="programcode" id="calibre_link-1381"><div class="fixedline">My Count of Rows =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS('TableA'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableB'[Year] &lt; 2019</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
            </div><section class="section" id="calibre_link-1382"><h4 class="heading2">Unique Column Names</h4><p class="simplepara" id="calibre_link-1383">So far, the examples using <span id="calibre_link-1384">GENERATE

</span> have all worked because they passed the output to the COUNTROWS function, which simply returned a count of the number of rows.</p><p class="simplepara" id="calibre_link-1385">If you intend to use the output of a GENERATE function as a calculated table, you soon encounter a problem regarding column names. In DAX, column names in physical and virtual tables must be unique. The output of the GENERATE function includes all columns from all tables passed to the function. Inevitably some of these tables have the same column names.</p><p class="simplepara" id="calibre_link-1386">If you try to create the following calculated table</p><div class="para1" id="calibre_link-1387">
                <div class="programcode" id="calibre_link-1388"><div class="fixedline">My Table = GENERATE('TableA','TableB')</div></div>
              </div><p class="simplepara" id="calibre_link-1389">you encounter an error such as “The Column with the name [Make] already exists in the ‘Table’ table.” In this example, the error refers to the clash over the [Make] column but also has an issue with the [Model] column that exists in both tables.</p><p class="simplepara" id="calibre_link-1390">In T-SQL, you control the name and number of columns returned using the SELECT clause in a query. In DAX, you can use the <span id="calibre_link-1391">SELECTCOLUMNS function

</span> to provide similar functionality. The primary use of this function is to allow you to partially select some columns from a table, but a side feature that’s useful here is that it also allows you to rename, or alias, columns along the way.</p><p class="simplepara" id="calibre_link-1392">Using the SELECTCOLUMNS function, you can rename the [Make] and [Model] columns in either table, or because you are using the = operator, you can choose to simply drop these columns from one of the tables, since their values should match and you only need to see one.</p><p class="simplepara" id="calibre_link-1393">Listings 5-3 and 5-4 show two examples that use the SELECTCOLUMNS function to return an error-free result.</p><div class="para1" id="calibre_link-1394">
                <div class="programcode" id="calibre_link-1395"><div class="fixedline">My Table =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableA',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableB',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"My Make", [Make],</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"My Model", [Model],</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"Year", [Year],</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"Index", [Index]</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-3</span><p class="para3">Using SELECTCOLUMNS with GENERATE</p></div></div></div>
              </div><div class="para1" id="calibre_link-213">
                <div class="programcode" id="calibre_link-1396"><div class="fixedline">My Table =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableA',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableB',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Year", [Year],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Index", [Index]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-4</span><p class="para3">Alternate Use of SELECTCOLUMNS with GENERATE</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-1397">In both examples, the second parameter of the GENERATE function is no longer just ‘TableB’; rather, it has been wrapped using the <span id="calibre_link-1398">SELECTCOLUMNS function

</span>. This function outputs a table that it shapes based on the rule you pass to it. In the first case, you instruct SELECTCOLUMNS to use ‘TableB’ and return four columns that are defined as &lt;name&gt;/&lt;expression&gt; pairs. This is how you can rename columns to avoid an error in the output of the GENERATE function.</p><p class="simplepara" id="calibre_link-1399">The second example (Listing <span><a href="#calibre_link-213" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-4</a></span>) simply omits the columns altogether for a cleaner effect and returns a table showing 18 rows, which is the full cartesian product of the two tables.</p><p class="simplepara" id="calibre_link-1400">A more realistic requirement might be to combine this with the earlier example at Listing <span><a href="#calibre_link-213" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-4</a></span> to return a calculated table with unique column names for rows that matched on [Make] and [Model] for years before 2019.</p><p class="simplepara" id="calibre_link-1401">The DAX for this is shown in Listing <span><a href="#calibre_link-214" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-5</a></span>.</p><div class="para1" id="calibre_link-214">
                <div class="programcode" id="calibre_link-1402"><div class="fixedline">My Table =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">FILTER(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableA',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableB',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"My Make", [Make],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"My Model", [Model],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Year", [Year],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Index", [Index]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">),</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">[Make] = [My Make]</strong> &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">[Model] = [My Model]</strong> &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">[Year] &lt; 2019</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-5</span><p class="para3">Combining GENERATE with FILTER and SELECTCOLUMNS</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-1403">Here GENERATE is wrapped with the FILTER function to allow the calculation to define the rules used when you’re matching rows between the tables. The inner SELECTCOLUMNS must return an alias for both the [Make] and [Model] columns in ‘TableB’ so the outer FILTER function can work with the table.</p><p class="simplepara" id="calibre_link-1404">This highlights that the filtering doesn’t take place during the join process; rather, it takes place over the single table output of the GENERATE function.</p><p class="simplepara" id="calibre_link-1405">The <span id="calibre_link-1406">T-SQL equivalent

</span> of this DAX statement including the renaming of the columns from ‘TableB’ is shown in Listing <span><a href="#calibre_link-215" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-6</a></span>.</p><div class="para1" id="calibre_link-215">
                <div class="programcode" id="calibre_link-1407"><div class="fixedline">SELECT</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A.[ID],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A.[Make],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A.[Model],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A.[Value],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B.[Make] AS [My Make],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B.[Model] AS [My Model],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B.[Year],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;B.[Index]</div><div class="fixedline">FROM TableA AS A</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN TableB AS B</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;&nbsp;A.Make = B.Make</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND A.Model = B.Model</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND B.Year &lt; 2019</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-6</span><p class="para3">T-SQL Equivalent of DAX Example</p></div></div></div>
              </div><div class="para1" id="calibre_link-1408">Both the DAX and T-<span id="calibre_link-1409">SQL

</span> statements produce the output shown in Table <span><a href="#calibre_link-216" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-3</a></span>.<div class="table" id="calibre_link-216"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-3</span><p class="para3">The Output of the DAX and T-SQL Example</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">ID</p></th><th class="calibre14"><p class="simplepara2">Make</p></th><th class="calibre14"><p class="simplepara2">Model</p></th><th class="calibre14"><p class="simplepara2">Value</p></th><th class="calibre14"><p class="simplepara2">My Make</p></th><th class="calibre14"><p class="simplepara2">My Model</p></th><th class="calibre14"><p class="simplepara2">Year</p></th><th class="calibre14"><p class="simplepara2">Index</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">Toyota</p></td><td class="calibre16"><p class="simplepara2">Corolla</p></td><td class="calibre16"><p class="simplepara2">10</p></td><td class="calibre16"><p class="simplepara2">Toyota</p></td><td class="calibre16"><p class="simplepara2">Corolla</p></td><td class="calibre16"><p class="simplepara2">2018</p></td><td class="calibre16"><p class="simplepara2">100</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">Hyundai</p></td><td class="calibre16"><p class="simplepara2">Elantra</p></td><td class="calibre16"><p class="simplepara2">20</p></td><td class="calibre16"><p class="simplepara2">Hyundai</p></td><td class="calibre16"><p class="simplepara2">Elantra</p></td><td class="calibre16"><p class="simplepara2">2018</p></td><td class="calibre16"><p class="simplepara2">300</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">Ford</p></td><td class="calibre16"><p class="simplepara2">Focus</p></td><td class="calibre16"><p class="simplepara2">30</p></td><td class="calibre16"><p class="simplepara2">Ford</p></td><td class="calibre16"><p class="simplepara2">Focus</p></td><td class="calibre16"><p class="simplepara2">2018</p></td><td class="calibre16"><p class="simplepara2">500</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1410">To remove the unnecessary [My Make] and [My Model] columns that were needed for the FILTER function, you can modify the calculation by wrapping the entire statement with another SELECTCOLUMNS statement. This is shown in Listing <span><a href="#calibre_link-217" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-7</a></span> using variables that can enhance readability.</p><div class="para1" id="calibre_link-217">
                <div class="programcode" id="calibre_link-1411"><div class="bookfrontmatter"><div class="fixedline1">My Table =</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR ModifiedTableB =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'TableB',</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"My Make", [Make],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"My Model", [Model],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Year", [Year],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Index", [Index]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR FilteredGENERATE =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE( 'TableA', ModifiedTableB ),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Make] = [My Make] &amp;&amp;</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Model] = [My Model] &amp;&amp;</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Year] &lt; 2019</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">RETURN</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FilteredGENERATE,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ID",[ID],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Make",[Make],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Model",[Model],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Year",[Year],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Index",[Index]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-7</span><p class="para3">Enhanced Version of Example <span id="calibre_link-1412">Removing Unwanted Columns

</span>
</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-1413">This calculation introduces a SELECTCOLUMNS <span id="calibre_link-1414">function

</span> at the final RETURN step that effectively drops the [My Make] and [My Model] columns by omitting these from the &lt;name&gt;/&lt;expression&gt; pairs.</p><p class="simplepara" id="calibre_link-1415">If you need to, you can use more sophisticated expressions with the SELECTCOLUMNS function other than simply the name of a column.</p></section><section class="section" id="calibre_link-1416"><h4 class="heading2">Using GENERATE to Multiply Rows</h4><p class="simplepara" id="calibre_link-1417">Another way to take advantage of the GENERATE/FILTER functions is to use them to expand the number of rows you have in an existing table to solve a visualization problem.</p><p class="simplepara" id="calibre_link-1418">A topic that arises from time to time on internet forums is how to take a table of entities that has a mixture of start/end dates and plot how many are active at any one time between their start/end dates.</p><div class="para1" id="calibre_link-1419">Consider the dataset in Table <span><a href="#calibre_link-218" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-4</a></span> of <span id="calibre_link-1420">hotel room occupancies

</span>
<span id="calibre_link-1421">
                  
                  
                  
                </span>. In this table, the date format is YYYY-MM-DD.<div class="table" id="calibre_link-218"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-4</span><p class="para3">Dataset to Be Used as an Occupancies Table</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">ID</p></th><th class="calibre14"><p class="simplepara2">Room</p></th><th class="calibre14"><p class="simplepara2">Check In</p></th><th class="calibre14"><p class="simplepara2">Check Out</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">101</p></td><td class="calibre16"><p class="simplepara2">2019-01-01</p></td><td class="calibre16"><p class="simplepara2">2019-01-02</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">102</p></td><td class="calibre16"><p class="simplepara2">2019-01-03</p></td><td class="calibre16"><p class="simplepara2">2019-01-04</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">103</p></td><td class="calibre16"><p class="simplepara2">2019-01-02</p></td><td class="calibre16"><p class="simplepara2">2019-01-05</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">4</p></td><td class="calibre16"><p class="simplepara2">101</p></td><td class="calibre16"><p class="simplepara2">2019-01-02</p></td><td class="calibre16"><p class="simplepara2">2019-01-05</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1422">To have a visual that shows how many of the rooms are occupied each night, one solution is to expand the <span id="calibre_link-1423">data

</span>
<span id="calibre_link-1424">
                  
                  
                  
                </span> from the original table to carry a row that represents every room/night combination. For the occupancy with an ID of 4, the room is occupied for three nights (from January 2 to January 4), so the task of plotting this on a visual is easier if this table has three rows for ID = 4, rather than the single row in this table.</p><p class="simplepara" id="calibre_link-1425">If there is a Date or Calendar table in the model with one row per day, including the days involved in the sample, you can use this to help create the rows you need. Listing <span><a href="#calibre_link-219" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-8</a></span> uses a dynamically created table as an alternative.</p><div class="para1" id="calibre_link-219">
                <div class="programcode" id="calibre_link-1426"><div class="fixedline">Table for Visual =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Occupancies',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">CALENDAR("2019-01-01","2019-01-05")</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Date] &gt;= [Check In] &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Date] &lt; [Check out]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ID", [ID],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Room", [Room],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Date", [Date]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-8</span><p class="para3">Using GENERATE with the <span id="calibre_link-1427">CALENDAR Function


</span>
<span id="calibre_link-1428">
                          
                          
                        </span>
</p></div></div></div>
              </div><div class="para1" id="calibre_link-1429">This returns the three-column <span id="calibre_link-1430">dataset


</span>
<span id="calibre_link-1431">
                  
                  
                </span> in Table <span><a href="#calibre_link-220" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-5</a></span>.<div class="table" id="calibre_link-220"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-5</span><p class="para3">The Output of the Code from Listing <span><a href="#calibre_link-219" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-8</a></span>.</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">ID</p></th><th class="calibre14"><p class="simplepara2">Room</p></th><th class="calibre14"><p class="simplepara2">Date</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">101</p></td><td class="calibre16"><p class="simplepara2">2019-01-01</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">103</p></td><td class="calibre16"><p class="simplepara2">2019-01-02</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">
                            <strong class="emphasistypebold">4</strong>
                          </p></td><td class="calibre16"><p class="simplepara2">
                            <strong class="emphasistypebold">101</strong>
                          </p></td><td class="calibre16"><p class="simplepara2">
                            <strong class="emphasistypebold">2019-01-02</strong>
                          </p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">102</p></td><td class="calibre16"><p class="simplepara2">2019-01-03</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">103</p></td><td class="calibre16"><p class="simplepara2">2019-01-03</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">
                            <strong class="emphasistypebold">4</strong>
                          </p></td><td class="calibre16"><p class="simplepara2">
                            <strong class="emphasistypebold">101</strong>
                          </p></td><td class="calibre16"><p class="simplepara2">
                            <strong class="emphasistypebold">2019-01-03</strong>
                          </p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">103</p></td><td class="calibre16"><p class="simplepara2">2019-01-04</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">
                            <strong class="emphasistypebold">4</strong>
                          </p></td><td class="calibre16"><p class="simplepara2">
                            <strong class="emphasistypebold">101</strong>
                          </p></td><td class="calibre16"><p class="simplepara2">
                            <strong class="emphasistypebold">2019-01-04</strong>
                          </p></td></tr></tbody></table></div>
</div><div class="para1" id="calibre_link-1432">As you can see, the row from the original <span id="calibre_link-1433">Occupancy


</span>
<span id="calibre_link-1434">
                  
                  
                </span> table with the ID of 4 now occurs three times in the new calculated table. This is the behavior you want and when plotted using the <span id="calibre_link-1435">Ribbon Chart


</span>
<span id="calibre_link-1436">
                  
                  
                </span>, it allows the visual to plot value for dates other than the original [Check In] and [Check Out] dates (Figure <span><a href="#calibre_link-221" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-1</a></span>).<figure class="figure1" id="calibre_link-221"><div class="mediaobject" id="calibre_link-1437"><img alt="../images/456681_1_En_5_Chapter/456681_1_En_5_Fig1_HTML.jpg" src="images/000060.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 5-1</span><p class="simplepara1">Output from Listing <span class="calibre9"><a href="#calibre_link-219" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-8</a></span> plotted using the Ribbon Chart visual</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1438">You can apply this technique to a table that represents employees and is used with hire/leaving dates or any <span id="calibre_link-1439">dataset


</span>
<span id="calibre_link-1440">
                  
                  
                </span> that contains multiple rows of overlapping start/end values.</p><p class="simplepara" id="calibre_link-1441">Before we dive in and break down the individual components, let’s look at what the equivalent T-SQL <span id="calibre_link-1442">statement


</span>
<span id="calibre_link-1443">
                  
                  
                </span> might look like (Listing <span><a href="#calibre_link-222" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-9</a></span>).</p><div class="para1" id="calibre_link-222">
                <div class="programcode" id="calibre_link-1444"><div class="fixedline">SELECT</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Occupancy.[ID],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Occupancy.[Room],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dates.[Date]</div><div class="fixedline">FROM Occupancy AS O&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Dates AS D</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;&nbsp;D.[Date] &gt;= O.[Check In]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND D.[Date] &lt; O.[Check Out]</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-9</span><p class="para3">The T-SQL Equivalent of the Code in Listing <span><a href="#calibre_link-219" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-8</a></span>
</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-1445">Jumping back to the DAX calculation, let’s break this apart to look at what each section is doing. Let’s start with the parameters passed to the GENERATE function. The first parameter is straightforward in that you are simply passing your ‘Occupancy’ <span id="calibre_link-1446">table


</span>
<span id="calibre_link-1447">
                  
                  
                </span>. The second parameter is the DAX function <span id="calibre_link-1448">CALENDAR


</span>
<span id="calibre_link-1449">
                  
                  
                </span>. This handy function produces a single column table of dates between the two date parameters passed to it.</p><div class="para1" id="calibre_link-1450">
                <div class="programcode" id="calibre_link-1451"><div class="fixedline">GENERATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;'Occupancies',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALENDAR("2019-01-01","2019-01-05")</div><div class="fixedline">),</div></div>
              </div><p class="simplepara" id="calibre_link-1452">In this case the two parameters are “2019-01-01” and “2019-01-05”, which represent the values between January 1, 2019, and January 5, 2019. This results in a table with five rows and just a single column called [Date]. You could rename this column using SELECTCOLUMNS, but in this case, there is no column-name collision in the GENERATE function, so you can leave it as it is.</p><p class="simplepara" id="calibre_link-1453">You could use a bigger range of dates, but doing so will not affect the result of the calculation, other than by possibly causing it to take slightly longer to generate data that will inevitably be ignored later in the calculation.</p><p class="simplepara" id="calibre_link-1454">The output of the GENERATE function at this point is a 20-row table. This is the cartesian product of 4 rows from the ‘Occupancies’ table matched with all 5 rows from the table expression output of the CALENDAR function.</p><p class="simplepara" id="calibre_link-1455">This is then wrapped with the <span id="calibre_link-1456">FILTER function


</span>
<span id="calibre_link-1457">
                  
                  
                </span> (Listing <span><a href="#calibre_link-223" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-10</a></span>), which specifies rules involving multiple columns to help decide which rows to keep and which to disregard. You don’t need dates that fall outside each occupancy for this requirement, but it could be interesting if you want to show when rooms are empty.</p><div class="para1" id="calibre_link-223">
                <div class="programcode" id="calibre_link-1458"><div class="fixedline">
                    <strong class="emphasistypebold">FILTER(</strong>
                  </div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Occupancies',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALENDAR("2019-01-01","2019-01-05")</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<strong class="emphasistypebold">,</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">[Date] &gt;= [Check In]</strong> &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">[Date] &lt; [Check out]</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">),</strong>
</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-10</span><p class="para3">The FILTER Section from Listing <span><a href="#calibre_link-219" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-8</a></span>
</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-1459">The filter function accepts the table expression output of the GENERATE function as its first parameter. Filter rules are then applied to help reduce the dataset to only the rows you need.</p><p class="simplepara" id="calibre_link-1460">This example highlights one of the other benefits of using the GENERATE function over standard table relationships. The FILTER function uses an operator other than = instead of using the &gt;= and &lt; operators to allow a match over a range of rows for each occupancy.</p><p class="simplepara" id="calibre_link-1461">Finally, the <span id="calibre_link-1462">FILTER function


</span>
<span id="calibre_link-1463">
                  
                  
                </span> is wrapped inside a SELECTCOLUMNS function to control and name the columns returned to the calculated table.</p></section><section class="section" id="calibre_link-1464"><h4 class="heading2">Multiplying Rows Using a Numbers Table</h4><p class="simplepara" id="calibre_link-1465">A similar use of the GENERATE table to help multiply rows is to join to a table containing numbers. A <em class="emphasistypeitalic">numbers table</em> is a general-purpose utility table that contains a single column of sequential numbers starting at zero and going up to a value that makes sense for your data model.</p><div class="para1" id="calibre_link-1466">Let’s say you want to expand the Table <span><a href="#calibre_link-224" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-6</a></span> to produce a copy of each row, with the number of copies controlled by the value in the Factor column.<div class="table" id="calibre_link-224"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-6</span><p class="para3">
<span id="calibre_link-1467">Dataset

</span>
<span id="calibre_link-1468">
                          
                          
                          
                        </span> to Be Used as Table1 Table</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Item</p></th><th class="calibre14"><p class="simplepara2">Factor</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">1</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">2</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">3</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1469">Listing <span><a href="#calibre_link-225" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-11</a></span> shows the DAX calculation table to expand this data.</p><div class="para1" id="calibre_link-225">
                <div class="programcode" id="calibre_link-1470"><div class="fixedline">New Table =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Table1',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATESERIES(1,3)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,[Factor] &lt;= [Value]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"New Col", [Factor] * [Value]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-11</span><p class="para3">
<span id="calibre_link-1471">Using GENERATESERIES

</span>
<span id="calibre_link-1472">
                          
                          
                          
                        </span> to Create Rows</p></div></div></div>
              </div><div class="para1" id="calibre_link-1473">This produces the <span id="calibre_link-1474">output

</span>
<span id="calibre_link-1475">
                  
                  
                  
                </span> in Table <span><a href="#calibre_link-226" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-7</a></span>.<div class="table" id="calibre_link-226"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-7</span><p class="para3">
<span id="calibre_link-1476">Output

</span>
<span id="calibre_link-1477">
                          
                          
                          
                        </span> from the Code in Listing <span><a href="#calibre_link-225" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-11</a></span>
</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Item</p></th><th class="calibre14"><p class="simplepara2">Factor</p></th><th class="calibre14"><p class="simplepara2">Value</p></th><th class="calibre14"><p class="simplepara2">New Col</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">1</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">3</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">6</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">9</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1478">To break apart this calculation, start with the inner GENERATE function. This is similar to the previous occupancy example, only instead of passing the CALENDAR function, it uses the GENERATESERIES function. This function generates a single row table with a range of whole numbers. This is the syntax for <span id="calibre_link-1479">GENERATESERIES

</span>
<span id="calibre_link-1480">
                  
                  
                  
                </span>:</p><div class="para1" id="calibre_link-1481">
                <div class="programcode" id="calibre_link-1482"><div class="fixedline">GENERATESERIES (&lt;startValue&gt;, &lt;endValue&gt; [, &lt;incrementValue&gt;])</div></div>
              </div><p class="simplepara" id="calibre_link-1483">The first and second parameters control the start and end values of the number range. This example creates a table with just three rows. The third parameter is optional and if it is not supplied, as in this example, it defaults to 1. The GENERATESERIES function is essentially creating a dynamic numbers table.</p><p class="simplepara" id="calibre_link-1484">
<span id="calibre_link-1485">GENERATESERIES

</span>
<span id="calibre_link-1486">
                  
                  
                  
                </span> was introduced in October 2017 and is not currently available in all DAX environments. To replicate this functionally in earlier versions of DAX, use the CALENDAR function as follows:</p><div class="para1" id="calibre_link-1487">
                <div class="programcode" id="calibre_link-1488"><div class="fixedline">GENERATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;'Table1',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(CALENDAR(1,3),"Value",INT([Date]))</div><div class="fixedline">)</div></div>
              </div><p class="simplepara" id="calibre_link-1489">The table expression output from the GENERATE function is passed to the FILTER function, which then applies the rule [Factor] &lt;= [Value] to determine which rows to return.</p><p class="simplepara" id="calibre_link-1490">Finally, the <span id="calibre_link-1491">ADDCOLUMNS function

</span>
<span id="calibre_link-1492">
                  
                  
                  
                </span> is used as an alternative to SELECTCOLUMNS. In this example, you don’t need to handle any column name collisions for the GENERATE function, so you can use ADDCOLUMNS to append a new column to all the existing output. This example also uses an expression that involves a calculation over multiple values to demonstrate how to include a more meaningful calculation if you need to.</p></section><section class="section" id="calibre_link-1493"><h4 class="heading2">Using GENERATE to Self-Join</h4><p class="simplepara" id="calibre_link-1494">The last example uses GENERATE to perform a self-join and uses a simplified ‘Sales’ table that shows dates on which a customer has made a purchase. For each purchase, the requirement here is to understand how long it has it been since that customer previously made a purchase.</p><div class="para1" id="calibre_link-1495">The example uses the <span id="calibre_link-1496">dataset


</span>
<span id="calibre_link-1497">
                  
                  
                </span> in Table <span><a href="#calibre_link-227" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-8</a></span>.<div class="table" id="calibre_link-227"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-8</span><p class="para3">Dataset to Be Used as a Sales Table</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Customer</p></th><th class="calibre14"><p class="simplepara2">Purchase Date</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-01</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-07</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-21</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-25</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-05</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-12</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-17</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-22</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1498">The calculated table is shown in Listing <span><a href="#calibre_link-228" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span>.</p><div class="para1" id="calibre_link-228">
                <div class="programcode" id="calibre_link-1499"><div class="bookfrontmatter"><div class="fixedline1">New Table =</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR SelfJoin =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales',</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales',</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"xCustomer",[Customer],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"xPurchase Date",[Purchase Date]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[xPurchase Date] &lt; [Purchase Date] &amp;&amp;</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Customer] = [xCustomer]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR LastPurchases =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;GROUPBY(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SelfJoin,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sales[Customer],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sales[Purchase Date],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Last Purchase",MAXX(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CURRENTGROUP(),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[xPurchase Date]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">RETURN</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NATURALLEFTOUTERJOIN('Sales',&nbsp;&nbsp;LastPurchases),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Days since last purchase",</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR DaysSince = INT([Purchase Date] - [Last Purchase])</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN IF (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT ISBLANK([Last Purchase]),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DaysSince</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-12</span><p class="para3">The Calculated Table to Find Last Purchases Using Self-<span id="calibre_link-1500">Join


</span>
<span id="calibre_link-1501">
                          
                          
                        </span>
</p></div></div></div>
              </div><div class="para1" id="calibre_link-1502">The output of this calculation is Table <span><a href="#calibre_link-229" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-9</a></span>, which shows the original table (Table <span><a href="#calibre_link-227" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-8</a></span>) with two new <span id="calibre_link-1503">columns


</span>
<span id="calibre_link-1504">
                  
                  
                </span>. The new columns show the date the Customer made their previous purchase and a value that represents the number of days it has been since that <span id="calibre_link-1505">purchase


</span>
<span id="calibre_link-1506">
                  
                  
                </span>.<div class="table" id="calibre_link-229"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-9</span><p class="para3">Dataset Showing Output of the Code in Listing <span><a href="#calibre_link-228" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span>
</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Customer</p></th><th class="calibre14"><p class="simplepara2">Purchase Date</p></th><th class="calibre14"><p class="simplepara2">Last Purchase</p></th><th class="calibre14"><p class="simplepara2">Days Since Purchase</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-01</p></td><td class="calibre16">&nbsp;</td><td class="calibre16">&nbsp;</td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-07</p></td><td class="calibre16"><p class="simplepara2">2019-01-01</p></td><td class="calibre16"><p class="simplepara2">6</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-21</p></td><td class="calibre16"><p class="simplepara2">2019-01-07</p></td><td class="calibre16"><p class="simplepara2">14</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-25</p></td><td class="calibre16"><p class="simplepara2">2019-01-21</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-05</p></td><td class="calibre16">&nbsp;</td><td class="calibre16">&nbsp;</td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-12</p></td><td class="calibre16"><p class="simplepara2">2019-01-05</p></td><td class="calibre16"><p class="simplepara2">7</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-17</p></td><td class="calibre16"><p class="simplepara2">2019-01-12</p></td><td class="calibre16"><p class="simplepara2">5</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-22</p></td><td class="calibre16"><p class="simplepara2">2019-01-17</p></td><td class="calibre16"><p class="simplepara2">5</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1507">You can use the [Days Since Purchase] column in a variety of calculated measures to help you understand customer <span id="calibre_link-1508">behavior


</span>
<span id="calibre_link-1509">
                  
                  
                </span> such as the average time between purchases and the minimum and maximum gaps in time between purchases.</p><p class="simplepara" id="calibre_link-1510">To understand the calculation, you can easily break the code in Listing <span><a href="#calibre_link-228" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span> into three blocks made up of the two variables declarations and the final return.</p><p class="simplepara" id="calibre_link-1511">The objective of the first variable is to create a table expression that joins every row from the eight-row ‘Sales’ table joined back to itself matching every row, but applying a filter that will match on CustomerID and for any previous purchase.</p><p class="simplepara" id="calibre_link-1512">The <span id="calibre_link-1513">T-SQL equivalent


</span>
<span id="calibre_link-1514">
                  
                  
                </span> of this VAR statement is shown in Listing <span><a href="#calibre_link-230" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-13</a></span>.</p><div class="para1" id="calibre_link-230">
                <div class="programcode" id="calibre_link-1515"><div class="fixedline">SELECT</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.Customer,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.[Purchase Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R.Customer AS [xCustomer],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R.[Purchase Date] AS [xPurchase Date]</div><div class="fixedline">INTO #SelfJoin</div><div class="fixedline">FROM Sales AS L</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Sales AS R</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;&nbsp;R.Customer = L.Customer</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND R.[Purchase Date] &lt; L.[Purchase Date]</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-13</span><p class="para3">T-SQL Equivalent of the First Variable from Listing <span><a href="#calibre_link-228" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span>
</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-1516">This produces a 12-row result that, for some transactions, finds multiple matches because at this point, the query is looking for ALL previous purchases. The very first purchase for each customer is missing because there are no prior purchases. The pattern of this query is similar to Listing <span><a href="#calibre_link-217" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-7</a></span> because it has used multiple columns in the join criteria, it uses an operator other than =, and finally, it uses <span id="calibre_link-1517">SELECTCOLUMNS


</span>
<span id="calibre_link-1518">
                  
                  
                </span> to rename columns to avoid a column-name collision.</p><p class="simplepara" id="calibre_link-1519">At this point, the final RETURN statement could simply return the SelfJoin variable, which allows inspection of the data for correctness. The table expression produced by this variable is not intended as the final output; it is intended as a data-preparation step for the next variable.</p><p class="simplepara" id="calibre_link-1520">The VAR LastPurchases statement summarizes the SelfJoin variable to a single line per [Customer] and [Purchase Date] combination. An aggregation column called “Last Purchase” is added, which finds the latest value in the [xPurchase Date] column. This identifies the date needed for the previous purchase.</p><p class="simplepara" id="calibre_link-1521">Because the intention is to summarize a table expression rather than a physical table, the SUMMARIZE or SUMMARIZECOLUMNS functions are not available. However, the GROUPBY is available and can use the <span id="calibre_link-1522">SelfJoin variable


</span>
<span id="calibre_link-1523">
                  
                  
                </span> as its first parameter. The second and third parameters name the columns to group by. The final parameter is a DAX expression using the MAXX iterator function to find the latest value for each combination. The CURRENTGROUP() function is used to help the MAXX function make use of the table expression stored in the SelfJoin variable.</p><div class="para1" id="calibre_link-1524">At this point the result is a six-row table (Table <span><a href="#calibre_link-231" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-10</a></span>). This is not intended as the final result, nor does it carry any information about the first-ever purchase by each customer. This result set needs to be added back to the original data, which happens in the next step.<div class="table" id="calibre_link-231"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-10</span><p class="para3">Dataset Output of First Variable from Listing <span><a href="#calibre_link-228" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span>
</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Customer</p></th><th class="calibre14"><p class="simplepara2">Purchase Date</p></th><th class="calibre14"><p class="simplepara2">Last Purchase</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-07</p></td><td class="calibre16"><p class="simplepara2">2019-01-01</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-21</p></td><td class="calibre16"><p class="simplepara2">2019-01-07</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-25</p></td><td class="calibre16"><p class="simplepara2">2019-01-21</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-12</p></td><td class="calibre16"><p class="simplepara2">2019-01-05</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-17</p></td><td class="calibre16"><p class="simplepara2">2019-01-12</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-22</p></td><td class="calibre16"><p class="simplepara2">2019-01-17</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1525">The T-SQL equivalent of this statement is shown in Listing <span><a href="#calibre_link-232" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-14</a></span>.</p><div class="para1" id="calibre_link-232">
                <div class="programcode" id="calibre_link-1526"><div class="fixedline">SELECT</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Customer],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Purchase Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAX([xPurchase Date]) AS [Last Purchase]</div><div class="fixedline">INTO #LastPurchases</div><div class="fixedline">FROM #SelfJoin</div><div class="fixedline">GROUP BY</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Customer],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Purchase Date]</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-14</span><p class="para3">T-SQL Equivalent of Second Variable from Listing <span><a href="#calibre_link-228" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span>
</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-1527">The last step is to take the table expression stored in the LastPurchases variable and join it back to the original <span id="calibre_link-1528">table


</span>
<span id="calibre_link-1529">
                  
                  
                </span>. This needs to be an outer semi join so you keep the row that represents the initial purchase by each customer.</p><p class="simplepara" id="calibre_link-1530">The intention is to match every row from the original ‘Sales’ table with rows from the LastPurchases table expression, joining them where there is a match in both the [Customer] and [Purchase Date] columns. Rows in the ‘Sales’ table that cannot be matched to rows in the LastPurchases table expression need to be retained.</p><p class="simplepara" id="calibre_link-1531">The GENERATE function does not easily provide “left join” functionality between tables. You can do this in a roundabout way by using multiple steps involving FILTER and further GROUPBY functions, or you can use the NATURALLEFTOUTERJOIN function to obtain the desired result.</p><p class="simplepara" id="calibre_link-1532">In the final <span id="calibre_link-1533">RETURN statement


</span>
<span id="calibre_link-1534">
                  
                  
                </span>, the <span id="calibre_link-1535">NATURALLEFTOUTERJOIN


</span>
<span id="calibre_link-1536">
                  
                  
                </span> is passed two tables. The first is the original eight-row ‘Sales’ table. The second is the six-row table expression stored in the LastPurchases variables. The function checks every column in both tables and automatically matches any column that shares the same name and datatype, as well as the same lineage (more about this later).</p><div class="para1" id="calibre_link-1537">
                <div class="programcode" id="calibre_link-1538"><div class="fixedline">NATURALLEFTOUTERJOIN('Sales',&nbsp;&nbsp;LastPurchases)</div></div>
              </div><div class="para1" id="calibre_link-1539">In this example, both the ‘Sales’ and LastPurchases tables passed to <span id="calibre_link-1540">NATURALLEFTOUTERJOIN


</span>
<span id="calibre_link-1541">
                  
                  
                </span> have [Customer] and [Purchase Date] <span id="calibre_link-1542">columns


</span>
<span id="calibre_link-1543">
                  
                  
                </span> that also share the same datatype. This returns a three-column table (Table <span><a href="#calibre_link-233" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-11</a></span>) that still has one more requirement to fill.<div class="table" id="calibre_link-233"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-11</span><p class="para3">Output of NATURALLEFTOUTERJOIN from Listing <span><a href="#calibre_link-228" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span>
</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Customer</p></th><th class="calibre14"><p class="simplepara2">Purchase Date</p></th><th class="calibre14"><p class="simplepara2">Last Purchase</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-01</p></td><td class="calibre16">&nbsp;</td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-07</p></td><td class="calibre16"><p class="simplepara2">2019-01-01</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-21</p></td><td class="calibre16"><p class="simplepara2">2019-01-07</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">2019-01-25</p></td><td class="calibre16"><p class="simplepara2">2019-01-21</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-05</p></td><td class="calibre16">&nbsp;</td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-12</p></td><td class="calibre16"><p class="simplepara2">2019-01-05</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-17</p></td><td class="calibre16"><p class="simplepara2">2019-01-12</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16"><p class="simplepara2">2019-01-22</p></td><td class="calibre16"><p class="simplepara2">2019-01-17</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1544">The final requirement is to have a column that carries a number that shows, for each customer purchase, how many days have passed since their last purchase. This is achieved by wrapping the NATURALLEFTOUTERJOIN function with an ADDCOLUMNS function (Listing <span><a href="#calibre_link-234" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-15</a></span>).</p><div class="para1" id="calibre_link-234">
                <div class="programcode" id="calibre_link-1545"><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ADDCOLUMNS(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NATURALLEFTOUTERJOIN('Sales',&nbsp;&nbsp;LastPurchases<strong class="emphasistypebold">),</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"Days since last purchase",</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">VAR DaysSince = INT([Purchase Date] - [Last Purchase])</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT ISBLANK([Last Purchase]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DaysSince</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-15</span><p class="para3">The Final RETURN Statement from Listing <span><a href="#calibre_link-228" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span>
</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-1546">The ADDCOLUMNS function appends a single column to the output of the <span id="calibre_link-1547">NATURALLEFTOUTERJOIN function


</span>
<span id="calibre_link-1548">
                  
                  
                </span>. The “Days since last purchase” <span id="calibre_link-1549">parameter


</span>
<span id="calibre_link-1550">
                  
                  
                </span> provides a name for the new column, while the last parameter starting with a nested VAR statement is a DAX expression that returns the difference between the [Purchase Date] and [Last Purchase] columns.</p><p class="simplepara" id="calibre_link-1551">The INT function is used to convert the DateTime output of the subtraction to a whole number. You can use the DATEDIFF function at this point as long as the [Last Purchase] values are always the same or earlier than values in the [Purchase column].</p><p class="simplepara" id="calibre_link-1552">This calculation returns the expected values for each row except for the customers’ initial purchases. For these rows, it returns values such as 43,466 and 43,470, which could skew subsequent usage of this column in further calculations.</p><p class="simplepara" id="calibre_link-1553">To address these high numbers, an IF function tests to see if the [Last Purchase] column carries a value. In the event that there is no value, it returns a blank, otherwise it returns the value showing the difference between the purchase dates.</p><p class="simplepara" id="calibre_link-1554">For reference, the T-SQL equivalent of the final RETURN statement is shown in Listing <span><a href="#calibre_link-235" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-16</a></span>.</p><div class="para1" id="calibre_link-235">
                <div class="programcode" id="calibre_link-1555"><div class="fixedline">SELECT</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.Customer,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.[Purchase Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;R.[Last Purchase],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATEDIFF(DAY,R.[Last Purchase],L.[Purchase Date]) AS [Days since last purchase]</div><div class="fixedline">FROM #Sales AS L</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEFT OUTER JOIN #LastPurchases AS R</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;&nbsp;L.Customer = R.Customer</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND L.[Purchase Date] = R.[Purchase Date]</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-16</span><p class="para3">T-SQL Equivalent of Final RETURN Statement from Listing <span><a href="#calibre_link-228" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span>
</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-1556">A simpler alternative version of the calculated table that produces the same result but doesn’t use a self-<span id="calibre_link-1557">join


</span>
<span id="calibre_link-1558">
                  
                  
                </span> technique is shown in Listing <span><a href="#calibre_link-236" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-17</a></span>.</p><div class="para1" id="calibre_link-236">
                <div class="programcode" id="calibre_link-1559"><div class="fixedline">New Table =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Last Purchase", MAXX(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Customer] = EARLIER([Customer]) &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Purchase Date] &lt; EARLIER([Purchase Date])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Purchase Date]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Days since last purchase", IF(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NOT ISBLANK([Last Purchase]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATEDIFF([Last Purchase], [Purchase Date],DAY)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-17</span><p class="para3">Simpler Alternative for Listing <span><a href="#calibre_link-228" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span>
</p></div></div></div>
              </div></section></section></section><section class="section" id="calibre_link-129"><h2 class="heading">NATURALINNERJOIN and NATURALLEFTOUTERJOIN</h2><p class="simplepara" id="calibre_link-1560">The <span id="calibre_link-1561">NATURALINNERJOIN function

</span>
<span id="calibre_link-1562">
              
            </span> allows you to join two tables using the following syntax:</p><div class="para1" id="calibre_link-1563">
            <div class="programcode" id="calibre_link-1564"><div class="fixedline">&nbsp;NATURALINNERJOIN ( &lt;leftTable&gt;, &lt;rightTable&gt;)</div></div>
          </div><p class="simplepara" id="calibre_link-1565">This function matches every row from the first table with every row from the second table that has matching values in any column that shares the same column name and <span id="calibre_link-1566">datatype

</span>
<span id="calibre_link-1567">
              
            </span>.</p><p class="simplepara" id="calibre_link-1568">If a row from either table cannot be matched to a row in the other table, it is dropped from the result. The additional requirement is that both tables must be derived from the same physical source table. This is known as having the <em class="emphasistypeitalic">same lineage</em>.</p><p class="simplepara" id="calibre_link-1569">Once matching rows are found, the columns used in the match are returned once along with any additional columns from the left and right tables that were not used as part of the matching exercise.</p><p class="simplepara" id="calibre_link-1570">The <span id="calibre_link-1571">NATURALLEFTOUTERJOIN function
</span>
<span id="calibre_link-1572">
              
              
            </span> has the same two-parameter requirement, only it keeps rows from the table passed as the first parameter that find no matching rows from the table passed as the second parameter.</p><p class="simplepara" id="calibre_link-1573">As the names suggest, these functions are like the INNER JOIN and LEFT OUTER JOIN statements in T-SQL.</p><section class="section" id="calibre_link-130"><h3 class="heading">Lineage</h3><p class="simplepara" id="calibre_link-1574">A lineage requirement exists for both the NATURALINNERJOIN and NATURALLEFTOUTERJOIN functions, which tends to limit the number of scenarios in which they might be useful.</p><p class="simplepara" id="calibre_link-1575">In the WideWorldImportersDW dataset, the ‘Fact Sale’ table contains a column called [City Key], which uses the whole number datatype. The ‘Dimension City’ table has a column with the same name and datatype, but because these are separate tables, the following DAX produces an error.</p><div class="para1" id="calibre_link-1576">
              <div class="programcode" id="calibre_link-1577"><div class="fixedline">New Table = NATURALINNERJOIN('Fact Sale','Dimension City')</div></div>
            </div><p class="simplepara" id="calibre_link-1578">Wrapping the NATURALINNERJOIN with a FILTER in the same way you did earlier with GENERATE does not get around this error. It is the same with NATURALLEFTOUTERJOIN. The most common use of these functions is similar to the previous example to look for previous purchases as shown at Listing <span><a href="#calibre_link-236" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-17</a></span>.</p><p class="simplepara" id="calibre_link-1579">Typically a single table is used as a starting point in a multistatement DAX calculation that involves variables. One or more table expressions are generated from the source table and stored in variables. These table expressions may be summarized or filtered to manipulate the source data to then join back to the original table. In this case, the DAX engine knows that although you may be working with a column that has been aggregated or renamed many times, it can still trace the value back to the same source table involved in the join.</p><div class="para1" id="calibre_link-1580">One way to work around this limitation is to use the SELECTCOLUMNS function. Tables&nbsp;<span><a href="#calibre_link-237" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span> and <span><a href="#calibre_link-238" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-13</a></span> demonstrate this.<div class="table" id="calibre_link-237"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-12</span><p class="para3">Dataset to Be Used as the Table1 Table</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">ID</p></th><th class="calibre14"><p class="simplepara2">Value1</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">1</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">2</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">3</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">D</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr></tbody></table></div>
<div class="table" id="calibre_link-238"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-13</span><p class="para3">Dataset to Be Used as the Table2 Table</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">ID</p></th><th class="calibre14"><p class="simplepara2">Value2</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">3</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">D</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">E</p></td><td class="calibre16"><p class="simplepara2">5</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">F</p></td><td class="calibre16"><p class="simplepara2">6</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1581">The following calculation to join these tables fails with an <span id="calibre_link-1582">error

</span>
<span id="calibre_link-1583">
                
              </span>.</p><div class="para1" id="calibre_link-1584">
              <div class="programcode" id="calibre_link-1585"><div class="fixedline">New Table = NATURALINNERJOIN('Table1','Table2')</div></div>
            </div><p class="simplepara" id="calibre_link-1586">This is despite the calculation meeting two of the requirements of having a column in each table using the same name and datatype. <span id="calibre_link-1587">NATURALLEFTOUTERJOIN
</span>
<span id="calibre_link-1588">
                
                
              </span> produces the same error. To get around this, use SELECTCOLUMNS as shown in Listing <span><a href="#calibre_link-239" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-18</a></span>. Table <span><a href="#calibre_link-240" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-14</a></span> shows the output from this code.</p><div class="para1" id="calibre_link-239">
              <div class="programcode" id="calibre_link-1589"><div class="fixedline">New Table =</div><div class="fixedline">VAR LeftTable&nbsp;&nbsp;=</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Table1',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ID",[ID] &amp; "",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Value1",[Value1]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">VAR RightTable =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Table2',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ID",[ID] &amp; "",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Value2",[Value2]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NATURALINNERJOIN(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LeftTable,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RightTable</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-18</span><p class="para3">Calculated Table Using <span id="calibre_link-1590">NATURALINNERJOIN

</span>
<span id="calibre_link-1591">
                        
                      </span>
</p></div></div></div>
              <div class="table" id="calibre_link-240"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-14</span><p class="para3">The Output of the Code in Listing <span><a href="#calibre_link-239" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-18</a></span>
</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">ID</p></th><th class="calibre14"><p class="simplepara2">Value1</p></th><th class="calibre14"><p class="simplepara2">Value2</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">3</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">D</p></td><td class="calibre16"><p class="simplepara2">4</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr></tbody></table></div>
            </div><p class="simplepara" id="calibre_link-1592">An approach to take here is to append an empty text value to the column name of each column you intend to use to join by the NATURALINNERJOIN function. The same technique works for <span id="calibre_link-1593">NATURALLEFTOUTERJOIN
</span>
<span id="calibre_link-1594">
                
                
              </span> and matches on multiple columns that share the same name and datatype. There are probably good reasons why the lineage requirement exists for these functions, particularly in terms of performance over larger datasets, so be mindful of this when you are using this technique.</p><div class="para1" id="calibre_link-1595">The output of the same query using <span id="calibre_link-1596">NATURALLEFTOUTERJOIN
</span>
<span id="calibre_link-1597">
                
                
              </span> is shown in Table <span><a href="#calibre_link-241" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-15</a></span>.<div class="table" id="calibre_link-241"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-15</span><p class="para3">The Output of Code from Listing <span><a href="#calibre_link-239" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-18</a></span> Using NATURALLEFTOUTERJOIN</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">ID</p></th><th class="calibre14"><p class="simplepara2">Value1</p></th><th class="calibre14"><p class="simplepara2">Value2</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16">&nbsp;</td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">2</p></td><td class="calibre16">&nbsp;</td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">3</p></td><td class="calibre16"><p class="simplepara2">3</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">D</p></td><td class="calibre16"><p class="simplepara2">4</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr></tbody></table></div>
</div></section></section><section class="section" id="calibre_link-131"><h2 class="heading">UNION</h2><p class="simplepara" id="calibre_link-1598">The join functions covered so far allow tables to be joined horizontally. If you need to join two or more vertically, you can use the <span id="calibre_link-1599">UNION function
</span>
<span id="calibre_link-1600">
              
              
            </span>. This operates the same way UNION ALL works in T-SQL. The syntax for UNION is as follows:</p><div class="para1" id="calibre_link-1601">
            <div class="programcode" id="calibre_link-1602"><div class="fixedline">UNION ( &lt;table1&gt;, &lt;table2&gt; [, &lt;tableN&gt;...])</div></div>
          </div><p class="simplepara" id="calibre_link-1603">The function expects each table passed to have the same number of columns, otherwise, an error is produced. SELECTCOLUMNS and ADDCOLUMNS are useful functions to help you shape tables to the point where they have the same number of columns for UNION to work.</p><p class="simplepara" id="calibre_link-1604">An effective use case for UNION is in conjunction with NATURALLEFTOUTERJOIN over a base table that is missing data. You can use the NATURALLEFTOUTERJOIN to help identify the gaps and then generate a table with dummy values that can be joined vertically back to the base table using the UNION function for a more complete table.</p><div class="para1" id="calibre_link-1605">If you use the UNION function with the Table1 and Table2 datasets (see Tables&nbsp;<span><a href="#calibre_link-237" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-12</a></span> and <span><a href="#calibre_link-238" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-13</a></span>) from the previous example, the output is shown in Table <span><a href="#calibre_link-242" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-16</a></span>.<div class="table" id="calibre_link-242"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 5-16</span><p class="para3">The Output of the UNION of Table1 and Table2</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">ID</p></th><th class="calibre14"><p class="simplepara2">Value1</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">1</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">2</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">3</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">D</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">3</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">D</p></td><td class="calibre16"><p class="simplepara2">4</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">E</p></td><td class="calibre16"><p class="simplepara2">5</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">F</p></td><td class="calibre16"><p class="simplepara2">6</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1606">Note that the rows from Table1 and Table2 that are identical still return as separate rows and you don’t have an option to perform a DISTINCT style T-SQL during the UNION. If you want to do this, you can wrap the <span id="calibre_link-1607">UNION
</span>
<span id="calibre_link-1608">
              
              
            </span> with a DISTINCT function to remove duplicate rows:</p><div class="para1" id="calibre_link-1609">
            <div class="programcode" id="calibre_link-1610"><div class="fixedline">Table =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DISTINCT(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UNION('Table1',Table2)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><p class="simplepara" id="calibre_link-1611">Columns are matched in the order in which they appear in the tables passed to the UNION function. If there is a difference in the datatype for a column between columns that are being connected, the DAX engine falls back to the datatype that can carry both sets of data; for example, if a whole number column is aligned with a text column, the resulting column has a datatype of Text.</p><p class="simplepara" id="calibre_link-1612">It’s also possible to union a table onto itself as a technique to quickly double or triple your source table. The following code returns a table that has three times the number of rows as Table1.</p><div class="para1" id="calibre_link-1613">
            <div class="programcode" id="calibre_link-1614"><div class="fixedline">Union Table = UNION(Table1,Table1,Table1)</div></div>
          </div></section><section class="section" id="calibre_link-132"><h2 class="heading">
            <span id="calibre_link-1615">LOOKUPVALUE

</span>
            <span id="calibre_link-1616">
              
            </span>
          </h2><p class="simplepara" id="calibre_link-1617">The last function I cover in this chapter is one that may be more familiar to power users of EXCEL than T-SQL. The function is not so much a tool to join tables as it is a function to allow you to retrieve values from other tables without using a DAX relationship.</p><p class="simplepara" id="calibre_link-1618">The syntax for LOOKUPVALUE is as follows:</p><div class="para1" id="calibre_link-1619">
            <div class="programcode" id="calibre_link-1620"><div class="fixedline">LOOKUPVALUE ( &lt;resultColumnNAme&gt;, &lt;searchColumnName&gt;, &lt;searchValue&gt;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[, &lt;searchColumnName&gt;, &lt;searchValue&gt;]...)</div></div>
          </div><p class="simplepara" id="calibre_link-1621">The first parameter specifies the value to be returned by the function. When you use this in a calculated column, this is the value that ultimately shows in the new column. The column can be any column from any table including the table you may be adding to the calculated column.</p><p class="simplepara" id="calibre_link-1622">The second and third parameters are &lt;search&gt;/&lt;value&gt; pairs. The &lt;searchColumnName&gt; parameter needs to be a column from the same table as the first parameter. The &lt;searchValue&gt; carries either a column to be used for values to search for, or it can be a hardcoded value.</p><p class="simplepara" id="calibre_link-1623">The function needs to return a single result, so the LOOKUPVALUE function generates an error if it finds more than one distinct value. A common use of LOOKUPVALUE is between a table that might normally exist on the many side of a one-to-many relationship and the LOOKUPTABLE being used to search the table on the one side of the relationship for a value.</p><p class="simplepara" id="calibre_link-1624">An example that uses the WideWorldImportersDW data might be to add a column to the ‘Fact Sales’ table that carries a value that it finds from the ‘Dimension City’ table. This does not need a relationship to be defined between these tables.</p><p class="simplepara" id="calibre_link-1625">Listing <span><a href="#calibre_link-243" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">5-19</a></span> adds a column that shows the [Continent] for each sale.</p><div class="para1" id="calibre_link-243">
            <div class="programcode" id="calibre_link-1626"><div class="fixedline">New Column =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOOKUPVALUE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Value to be returned for this new column --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[Continent],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Column to search --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[City Key],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Value in column to search --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[City Key]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 5-19</span><p class="para3">Calculated Column Using LOOKUPVALUE Function</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-1627">The first parameter ‘Dimension City’[Continent] specifies the column that is used to find a value that eventually returns to the new calculated <span id="calibre_link-1628">column

</span>
<span id="calibre_link-1629">
              
            </span>.</p><p class="simplepara" id="calibre_link-1630">The row used to return the value for [Continent] is determined by the next two parameters. ‘Dimension City’[City key] tells LOOKUPVALUE this is the column you want to use when you are looking for rows, and the ‘Fact Sale’[City Key] tells LOOKUPVALUE the exact value to look for. This case uses the value from the [City Key] column in the ‘Fact Sale’ table.</p><p class="simplepara" id="calibre_link-1631">The &lt;searchValue&gt; parameter can be hardcoded or the result of a calculation. If it is hardcoded, it means you have the same value in every row of the new column.</p><p class="simplepara" id="calibre_link-1632">Additional &lt;searchColumnName&gt; and &lt;searchValue&gt; sets of criteria can be passed to the LOOKUPVALUE function, which might provide more flexibility over a standard relationship, however this is likely to be inefficient over larger datasets on top of the requirement to ensure the LOOKUPVALUE function returns a single value for each search.</p></section></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-42">
<div id="calibre_link-1633" class="calibre2">
<div id="calibre_link-1634" class="calibre3"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1635"><div class="bookfrontmatter">©&nbsp;Philip Seamark&nbsp;2018</div><span class="pcalibre5"><span><span>Philip&nbsp;Seamark</span></span></span><span><span class="booktitle1" type="title" lang="en">Beginning DAX with Power BI</span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-3477-8_6" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">https://doi.org/10.1007/978-1-4842-3477-8_6</a></span></div></div><div class="maintitlesection"><h1 class="chaptertitle" lang="en">6.&nbsp;Filtering</h1></div><div class="bookfrontmatter"><div class="bookfrontmatter"><span><span>Philip&nbsp;Seamark</span><sup class="calibre6"><a href="#calibre_link-270" class="pcalibre3 pcalibre4 pcalibre1 pcalibre2 pcalibre calibre7">1</a>&nbsp;<span class="contacticon"></span></sup></span></div><div class="bookfrontmatter"><div class="bookfrontmatter" id="calibre_link-270"><span class="affiliationnumber">(1)</span><div class="bookfrontmatter">UPPER HUTT, New Zealand</div></div><div class="clearboth">&nbsp;</div></div></div><div class="bookfrontmatter"><section class="section" id="calibre_link-133"><h2 class="heading">Implicit Filtering</h2><p class="simplepara" id="calibre_link-1636">Filtering data is inevitable in modern reporting solutions. It is rare these days when you need to create a report that simply counts the rows or performs simple calculations over every row in a table.</p><p class="simplepara" id="calibre_link-1637">One of the many excellent features of interactive tools such as <span id="calibre_link-1638">Power BI

</span> is how they can apply filters interactively over the underlying data. If you click around on visuals in a report page, other visuals react and respond dynamically to show you new values representative of the selection you just made.</p><p class="simplepara" id="calibre_link-1639">This is mostly implicit filtering that happens automatically due to rules in the underlying data model. Selecting from a slicer, filter, or visual not only filters the table the data has comes from but propagates down through to tables that have relationships defined to the table you have just filtered, and not just to tables directly related, but to <span id="calibre_link-1640">intergenerational tables

</span>, as long as they are on the many side of one-to-many relationships.</p><p class="simplepara" id="calibre_link-1641">Filters <em class="emphasistypeitalic">can</em> propagate from the many side through to the table on the one side as long as the <span id="calibre_link-1642">cross-filtering property

</span> of the relationship is set to both.</p><p class="simplepara" id="calibre_link-1643">For simple examples, it’s possible to meet your requirements by importing data into a data model and creating appropriate relationships. Implicit measures can be used in your report, meaning you can get away with writing no code and still produce a useful report.</p><p class="simplepara" id="calibre_link-1644">Using the <span id="calibre_link-1645">WideWorldImportersDW

</span> example to help you understand, let’s focus on three tables and walk through how filtering works using standard relationships and then look at how you can use some of the filter functions provided in DAX for extra control and flexibility.</p><p class="simplepara" id="calibre_link-1646">The three tables are ‘Dimension Date’, ‘Dimension Stock Item’, and ‘Fact Sale’, with the relationships in Figure <span><a href="#calibre_link-271" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-1</a></span> defined in the data model. ‘Dimension Date’ has a one-to-many relationship to ‘Fact Sale’, with the ‘Dimension Date’ table on the one side. The column on the ‘Fact Sale’ table is [Invoice Date Key], whereas the column used in the ‘Dimension Date’ table is [Date]. Both these columns use the Date datatype.</p><div class="para1" id="calibre_link-1647">The <span id="calibre_link-1648">‘Dimension Stock Item’ table

</span> also has a one-to-many relationship to the ‘Fact Sale’ table with [Stock Item Key] used as the column for each table.<figure class="figure1" id="calibre_link-271"><div class="mediaobject" id="calibre_link-1649"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig1_HTML.jpg" src="images/000077.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-1</span><p class="simplepara1">The relationships between three tables in the model</p></div></figcaption></figure>
</div><div class="formalpara" id="calibre_link-1650"><h3 class="heading1">Tip</h3><p class="para3" id="calibre_link-1651">In the Relationship View, try to put the tables on the one side of one-to-many relationships above the tables on the many side. This helps to visually reinforce the trickle-down effect of filters. Selecting a column in a table on the one side filters rows in the table on the many side, but not the other way around.</p></div><p class="simplepara" id="calibre_link-1652">This is a common pattern in data modelling for analytics and reporting. The table on the one side is generally a list of items you might like to slice and dice from the rows of the table on the many side. As the table name suggests, these are often referred to as <span id="calibre_link-1653">
              <em class="emphasistypeitalic">dimension tables</em>
              
              
            </span>.</p><p class="simplepara" id="calibre_link-1654">Dimension tables typically have one row per entity that represents the lowest level of detail to group by. The column that represents the lowest grain should be unique and contains the value that appears in your related table on the many side.</p><p class="simplepara" id="calibre_link-1655">The tables on the many side can have multiple rows with the same value in the column used in the relationship. These are often referred to as fact tables. Hopefully your <span id="calibre_link-1656">‘Fact Sales’ table

</span> has many rows for any given date. Equally, it’s possible and quite normal for the table on the many side to have no rows that match a column on the one side. If trading doesn’t take place on weekends or holidays, there may not be rows for these days, and this is important to remember when you design your data model.</p><p class="simplepara" id="calibre_link-1657">Fact tables often represent actions, events, or transactions, and usually they have a time component. A good rule of thumb to help decide which data should be shaped into a Fact table versus a Dimension table is this: if you would like to count, sum, or show a trend of the data over time, then consider using a fact table. If the data is how you might like to slice and dice, then it is probably a suitable candidate to use as a dimension table.</p><p class="simplepara" id="calibre_link-1658">In the <span id="calibre_link-1659">WideWorldImportersDW dataset

</span>, the lowest grain for the ‘Dimension Date’ table is a specific day and does not contain columns or rows that represent hours, minutes, or seconds.</p><p class="simplepara" id="calibre_link-1660">Additional columns in the <span id="calibre_link-1661">‘Dimension Date’ table

</span> allow you to group days in useful ways, such as by calendar month. These additional columns do not have to be unique and can be customized to suit your organization’s reporting requirements.</p><p class="simplepara" id="calibre_link-1662">The ‘Dimension Date’ table in this dataset allows rows to be grouped into calendar and fiscal ranges such as months and years. Additional columns provide alternative formatting such as [Short Month] (Jan, Feb, Mar, . . . ), and the [Month] column (January, February, March, . . . ).</p><p class="simplepara" id="calibre_link-1663">Any column used from ‘Dimension Date’ in any part of your report automatically sends filtering information to the related ‘Fact Sale’ table via the columns used in the relationship. There is no need to only use the columns defined in the relationship in slicers, filters, or in the axis areas of your visuals.</p><p class="simplepara" id="calibre_link-1664">Starting with a very simple reporting requirement to show a count of the number of sales by invoice date, we can add the following calculated measure to the data model:</p><div class="para1" id="calibre_link-1665">
            <div class="programcode" id="calibre_link-1666"><div class="fixedline">Count of Sales = COUNTROWS('Fact Sale')</div></div>
          </div><p class="simplepara" id="calibre_link-1667">When this measure is dropped onto the reporting canvas using a table visual, it shows a value of 228,265. This happens to be the same number of rows as are in the ‘Fact Sale’ table. No filtering has taken place in the calculation of this value; the COUNTROWS function has simply run a single pass over the ‘Fact Sale’ table counting every row.</p><div class="para1" id="calibre_link-1668">If the [Invoice Date Key] field from the <span id="calibre_link-1669">‘Fact Sale’ table

</span> is added to the same visual&mdash;note that this is the field from the ‘Fact Sale’ table, not the ‘Dimension Date’ table&mdash;you should see what appears in Figure <span><a href="#calibre_link-272" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-2</a></span>.<figure class="figure1" id="calibre_link-272"><div class="mediaobject" id="calibre_link-1670"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig2_HTML.jpg" src="images/000069.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-2</span><p class="simplepara1">Sample of table visual using [Invoice Date Key] and implicit measure</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1671">Figure&nbsp;<span><a href="#calibre_link-272" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-2</a></span> shows the first few rows of a result set that has 1,069 rows. Each cell in the [Count of Sales] column has effectively run the calculated measure, but now an implicit filter context is being applied (also known as <span id="calibre_link-1672">
              <em class="emphasistypeitalic">query context</em>
              
              
            </span>).</p><p class="simplepara" id="calibre_link-1673">This means the value of 89 in the top row of the <span id="calibre_link-1674">Count of Sales

</span> column has effectively run the following calculation.</p><div class="para1" id="calibre_link-1675">
            <div class="programcode" id="calibre_link-1676"><div class="fixedline">Count of Sales = COUNTROWS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER('Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=DATE(2013,1,1)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><p class="simplepara" id="calibre_link-1677">The DAX engine has dynamically applied a filter condition to the original calculation, which is specific to that specific cell.</p><div class="formalpara" id="calibre_link-1678"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-1679">Remember that every value shown in your report is the result of its own unique calculation and does not rely on the order or output of other calculations. This includes totals and subtotals.</p></div><p class="simplepara" id="calibre_link-1680">The row for Wednesday, January 2, 2013, returned a value for a Count of Sales measure of 207. This is the result of DAX applying a slightly different automatic filter to the original calculation. In this case, the filter applied has the effect of asking the calculation engine to count every row in the ‘Fact Sales’ table that meets the criteria that the value in the [Invoice Date Key] table must equal January 2, 2013.</p><div class="para1" id="calibre_link-1681">This first example used the [Invoice Date Key] from the <span id="calibre_link-1682">‘Fact Sale’ table

</span>. Now let’s use the [Date] column from a related table instead and have a look at what happens (Figure <span><a href="#calibre_link-273" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-3</a></span>).<figure class="figure1" id="calibre_link-273"><div class="mediaobject" id="calibre_link-1683"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig3_HTML.jpg" src="images/000061.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-3</span><p class="simplepara1">Sample of table visual using [Date] column from ‘Dimension Date’ table</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1684">The calculations produce the same result, only this time we used a column from a different table. The <span id="calibre_link-1685">DAX engine

</span> automatically applies a filter to every calculation in the Count of Sales column (except, in this case, for the very bottom total). The difference here is that the filtering is taking place in the <span id="calibre_link-1686">‘Dimension Date’ table

</span>, which then makes its way down through the one-to-many relationship and is applied to the data in the ‘Fact Sale’ table.</p><p class="simplepara" id="calibre_link-1687">To generate a value of 89 for the top row, the DAX engine knows you want to filter the data for rows associated with the January 1, 2013. The [Date] column is unique in the ‘Dimension Date’ table and is also the column specified in the active relationship between ‘Dimension Date’ and ‘Fact Sale’.</p><p class="simplepara" id="calibre_link-1688">Information contained in the relationship is required because you are using columns from two tables to generate the value for the calculated measure. So, the DAX engine finds every row in the ‘Fact Sale’[Invoice Date Key] column that has an exact match with the filtered value from the ‘Dimension Date’[Date] column. It’s these rows that are used by the [Count of Sales] calculated measure to generate a value for the relevant cells.</p><p class="simplepara" id="calibre_link-1689">A good question to ask at this point is why you should use the column from the ‘Dimension Date’ table when it produces the same result as using the [Invoice Date Key] column from the actual ‘Fact Sales’ table. Surely it is more efficient to use a column from the same table to filter the rows in which the data is being used in the calculations?</p><div class="para1" id="calibre_link-1690">Some <span id="calibre_link-1691">advantages

</span> of using filters from related tables include the following:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-1692"><em class="emphasistypeitalic">Dimension tables can be used to filter multiple fact-style tables.</em> This example contains a single fact table. If you also had report visuals that used data from other fact tables, such as ‘Fact Purchase’ or ‘Fact Order’, these probably have relationships to the same ‘Dimension Date’ table. Any slicer or filter based on a column from the ‘Dimension Date’ table automatically propagates down through multiple one-to-many relationships to be applied to calculations using columns in each of the related fact tables.</p></li><li class="calibre8"><p class="para2" id="calibre_link-1693"><em class="emphasistypeitalic">Dimension</em> <span id="calibre_link-1694">
                    <em class="emphasistypeitalic">tables</em>
                    
                    
                  </span> <em class="emphasistypeitalic">allow you to include columns that group rows together in meaningful ways.</em> The ‘Date’ table contains a unique row for every day. A [Calendar Year] column can carry the value of "2019" for all 365 rows in ‘Dimension Date’ that have a value between January 1, 2019, and December 31, 2019. Equally, columns in the ‘Dimension Date’ table can carry values that help identify and filter rows for specific months, quarters, working days, holidays, specific events, and so on. Storing these “useful columns to group by” in a single table makes for a more efficient and easier-to-maintain data model.</p></li><li class="calibre8"><p class="para2" id="calibre_link-1695"><em class="emphasistypeitalic">Dimension tables typically guarantee one row per entity that they represent and are not prone to the same gaps and duplication that you may see in a fact table.</em> In the simple case I have used here, there is no data for Sunday, January 6, 2013. This probably reflects the way this organizations works. By using the [Date] column from the ‘Dimension Date’ table, you can use the guaranteed availability of <em class="emphasistypeitalic">all</em> days to your advantage in some calculations&mdash;particularly time intelligence DAX functions designed to assume the column being used contains no gaps.</p></li></ul></div>
</div><div class="para1" id="calibre_link-1696">In Figure <span><a href="#calibre_link-274" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-4</a></span>, both visuals use the ‘Dimension Date’ [Date] column rather than the ‘Fact Sale’ [Invoice Date Key] column. These both clearly show no rows for January 6. This gap could be important and easily lost if you were using the [Invoice Date Key] column in the row header or axis.<figure class="figure1" id="calibre_link-274"><div class="mediaobject" id="calibre_link-1697"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig4_HTML.jpg" src="images/000020.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-4</span><p class="simplepara1">Table and bar chart visuals using the [Date] column with a gap for a day with no data</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1698">Let’s go back to the original example for just one more tweak. Rather than using the ‘Dimension Date’[Date] column in the visual, let’s use another column from the <span id="calibre_link-1699">‘Dimension Date’ table

</span> along with the [Count of Rows] calculated measure. Remember the [Date] column is guaranteed to be unique because it is being used as the column on the one side of a one-to-many relationship, so for every row in the example used so far, only one value is being passed through the relationship to the ‘Fact’ table as part of the filter context.</p><div class="para1" id="calibre_link-1700">This time let’s use the [Calendar Year] column from the <span id="calibre_link-1701">‘Dimension Dates’ table

</span> in the visual. This should produce the result shown in Figure <span><a href="#calibre_link-275" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-5</a></span>.<figure class="figure1" id="calibre_link-275"><div class="mediaobject" id="calibre_link-1702"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig5_HTML.jpg" src="images/000032.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-5</span><p class="simplepara1">The table <span id="calibre_link-1703" class="calibre9">visual

</span> using the [Calendar Year] field and implicit measure</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1704">Figure&nbsp;<span><a href="#calibre_link-275" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-5</a></span> shows five values being generated by the [Count of Sales] calculated measure. Four of these are being filtered by the [Calendar Year] column, while the very bottom value of 228,265 is not affected by any filtering. The result of 60,968 for the top row starts by applying a filter over the ‘Dimension Date’ table looking for all rows in the which the [Calendar Year] column has a value of 2013. This should find exactly 365 rows that the DAX engine then uses to find every associated [Date] value. This group of [Date] values filters through the one-to-many relationship down to the ‘Fact Sale’ table to help identify which rows can be used by the calculated measure.</p><p class="simplepara" id="calibre_link-1705">The DAX used in the [Count of Sales] calculated measure only mentions the ‘Fact Sale’ table, which is passed to the COUNTROWS function. There is no mention in the calculation about specific columns, how matching is to take place, or anything about other tables in the data model. All this filtering happens implicitly, with a little bit of help from a predefined relationship between two tables. DAX provides a FILTER function, but it is not needed to satisfy this requirement.</p></section><section class="section" id="calibre_link-134"><h2 class="heading">Explicit Filtering</h2><p class="simplepara" id="calibre_link-1706">All the filters in the preceding example Figure <span><a href="#calibre_link-275" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-5</a></span> were used in implicit filtering, meaning no DAX filter functions were used in the calculation itself. This allows basic reports to be created, but inevitably, you need more sophisticated filtering logic to meet more sophisticated reporting requirements.</p><p class="simplepara" id="calibre_link-1707">DAX provides several filter functions and this section examines some common and useful examples using these functions. Filter functions in DAX not only allow you to provide additional layers of filtering to the implicit filtering for calculations, but they also allow you to specifically override the current filter context, allowing your calculations to use data from rows they might not otherwise have access to.</p><section class="section" id="calibre_link-135"><h3 class="heading">The FILTER Function</h3><p class="simplepara" id="calibre_link-1708">The first <span id="calibre_link-1709">filter function

</span> we look at is the FILTER function. The syntax for this function is as follows:</p><div class="para1" id="calibre_link-1710">
              <div class="programcode" id="calibre_link-1711"><div class="fixedline">FILTER ( &lt;table&gt;, &lt;filter expression&gt; )</div></div>
            </div><p class="simplepara" id="calibre_link-1712">The first parameter is a reference to the table you would like the filter to be applied to. The second parameter needs to be a valid DAX expression that results in a Boolean true or false that is logically applied to every row in the table used as the first parameter. The output of the FILTER function is a table. This is important to know when you’re using the FILTER function nested inside other DAX functions. It may be used as parameter for any function that accepts a table as a reference.</p><p class="simplepara" id="calibre_link-1713">Sticking with the [Count of Sales] measure, let’s add the FILTER function with a simple expression to see what happens to the calculation.</p><p class="simplepara" id="calibre_link-1714">Consider the calculated measure in Listing <span><a href="#calibre_link-276" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-1</a></span>.</p><div class="para1" id="calibre_link-276">
              <div class="programcode" id="calibre_link-1715"><div class="fixedline">Count of Sales (10 or more) =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">FILTER(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Fact Sale',</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Fact Sale'[Quantity] &gt; 10</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-1</span><p class="para3">Using the FILTER Function with COUNTROWS</p></div></div></div>
            </div><div class="para1" id="calibre_link-1716">The difference between this and the earlier calculation is this version uses a <span id="calibre_link-1717">FILTER function

</span> in place of the original ‘Fact Sale’ table reference. The result of this change is shown in Figure <span><a href="#calibre_link-277" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-6</a></span>.<figure class="figure1" id="calibre_link-277"><div class="mediaobject" id="calibre_link-1718"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig6_HTML.jpg" src="images/000012.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-6</span><p class="simplepara1">Adding a [Count of Sales (10 or more)] measure to a table visual</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1719">The new calculated measure is added to the table visual as a third column. To understand how we arrived at a value of 30,588 for the top row, let’s look at what is happening. In this example, there are two layers of filtering taking place. The first layer is the implicit filter (query context), which is being driven from the [Calendar Year] column. The second layer is the explicit rule used in the FILTER function for Listing <span><a href="#calibre_link-276" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-1</a></span> over the ‘Fact Sale’[Quantity] column.</p><p class="simplepara" id="calibre_link-1720">The implicit filter context restricts the number of rows visible to the COUNTROWS function to 60,968 rows. Then for each of these rows, a Boolean test is applied to determine if the value from the [Quantity] column is higher than 10. This test effectively discards any of the remaining 60,968 rows that have a value lower than 11. The result is a DAX table returned from the FILTER function to the COUNTROWS function that happens to have 30,588 rows to be counted.</p><p class="simplepara" id="calibre_link-1721">The key thing to remember is filtering is ordered, applied in layers, and is not a single operation. This allows for additional flexibility when you are creating DAX for more sophisticated reporting requirements.</p><p class="simplepara" id="calibre_link-1722">You can extend the <span id="calibre_link-1723">DAX

</span> used as the filter expression to include more specific requirements, as shown in Listing <span><a href="#calibre_link-278" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-2</a></span>.</p><div class="para1" id="calibre_link-278">
              <div class="programcode" id="calibre_link-1724"><div class="fixedline">Count of Sales (10 or more) =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Quantity] &gt;= 10</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">&amp;&amp; RELATED('Dimension Stock Item'[Size]) = "M"</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-2</span><p class="para3">Calculated Measure Using Filter Criteria from a Related Table</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1725">This example applies an additional rule that limits the number of rows from the ‘Fact Sale’ table still further to use the implicit filter (query context) being passed down from the ‘Dimension Date’ table due to the use of the [Calendar Year] column in the visual. Then in addition to the original explicit filter requirement to only consider rows that have a value of 10 or higher, an extra rule has been added that applies a filter to another related table. Because a relationship exists between ‘Dimension Stock Item’ and ‘Fact Sales’, this filter requirement is also applied to ultimately restrict the number of rows from ‘Fact Sales’ that are eventually passed to the COUNTROWS function to be counted.</p><div class="para1" id="calibre_link-1726">The result is now a smaller value for the calculated measure in the third column of Figure <span><a href="#calibre_link-279" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-7</a></span>.<figure class="figure1" id="calibre_link-279"><div class="mediaobject" id="calibre_link-1727"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig7_HTML.jpg" src="images/000081.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-7</span><p class="simplepara1">Output using the code from Listing <span class="calibre9"><a href="#calibre_link-278" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-2</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1728">Using the <span id="calibre_link-1729">FILTER function

</span> in this way allows you to apply additional restrictions on top of any implicit filter (query context) that happens to be in effect. This means you can create calculations that have some rules hardcoded into the calculation but can still use the measures in many visuals, each with their own implicit filter context that can be combined with the explicit filters to generate useful dynamic results.</p><section class="section" id="calibre_link-1730"><h4 class="heading2">
                <span id="calibre_link-1731">Overriding Filters

</span>
              </h4><div class="bookfrontmatter" id="calibre_link-1732">So far, the filtering has been cumulative, meaning different layers of filtering have simply been discarding rows at various points in the calculation. In DAX, there are filter functions that provide the ability to override filtering applied by the implicit filter layer. These are the functions we will look at that allow this:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-1733">CALCULATE and CALCULATETABLE</p></li><li class="calibre8"><p class="para2" id="calibre_link-1734">ALL</p></li><li class="calibre8"><p class="para2" id="calibre_link-1735">ALLEXCEPT</p></li><li class="calibre8"><p class="para2" id="calibre_link-1736">ALLSELECTED</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-1737">There are several scenarios in which these functions can be useful. Examples include their ability to perform period comparisons, running <span id="calibre_link-1738">totals

</span>, and percentage of total calculations, to name a few. In each of these scenarios, a calculation may need access to values stored in rows that have been disregarded by the implicit filter.</p></section><section class="section" id="calibre_link-1739"><h4 class="heading2">
                <span id="calibre_link-1740">Percentage of Total

</span>
              </h4><p class="simplepara" id="calibre_link-1741">Starting with a percentage of total measure, you can use the count of rows by year example to demonstrate how to override the implicit filter context. By default, any calculated measure used in a visual has a layer of automatic filtering applied to it driven by other columns used in the same visual.</p><div class="para1" id="calibre_link-1742">
                <div class="programcode" id="calibre_link-1743"><div class="fixedline">Count of Sales = COUNTROWS('Fact Sale')</div></div>
              </div><p class="simplepara" id="calibre_link-1744">The [Count of Sales] calculated measure, when used in the same visual as the ‘Dimension Date’[Calendar Year] column, has a layer of implicit filtering that means the COUNTROWS function can only consider a portion of the actual rows from ‘Fact Sales’.</p><p class="simplepara" id="calibre_link-1745">If the requirement is to understand what proportion each year is of the overall total, you need a way to instruct the DAX engine to ignore the implicit filter context. DAX provides CALCULATE and CALCULATETABLE to help manage this.</p><p class="simplepara" id="calibre_link-1746">Figure&nbsp;<span><a href="#calibre_link-280" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-8</a></span> demonstrates this using the following calculated measure:</p><div class="para1" id="calibre_link-1747">
                <div class="programcode" id="calibre_link-1748"><div class="fixedline">Count of all Sales = CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ALL('Fact Sale')</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div></div>
                <figure class="figure1" id="calibre_link-280"><div class="mediaobject" id="calibre_link-1749"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig8_HTML.jpg" src="images/000086.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-8</span><p class="simplepara1">Output using the ALL function</p></div></figcaption></figure>
              </div><p class="simplepara" id="calibre_link-1750">Let’s break this down and explain the calculation in more detail.</p><p class="simplepara" id="calibre_link-1751">First, the inner COUNTROWS <span id="calibre_link-1752">function

</span> is the same as what was used in the [Count of Sales] calculated measure. It counts the number of all rows in the ‘Fact Sale’ table that it can see. This is normally a version of the table filtered by the query context. In this case, the COUNTROWS function is wrapped inside a CALCULATE function.</p><p class="simplepara" id="calibre_link-1753">The CALCULATE function has the following syntax:</p><div class="para1" id="calibre_link-1754">
                <div class="programcode" id="calibre_link-1755"><div class="fixedline">CALCUALTE ( &lt;expression&gt;, &lt;filter1&gt;, &lt;filter2&gt; ... )</div></div>
              </div><p class="simplepara" id="calibre_link-1756">The function executes the expression provided in the first parameter in the context of the filters supplied by the additional parameters. As the syntax for the CALCULATE function suggests, there can be any number of filter expressions. In the [Count of all Sales] example, the parameter being passed to the CALCULATE function is the ALL function. The effect of using the ALL function here is to remove any implicit filter context that may be in effect on the ‘Fact Sale’ table, which is the table specified as the parameter of the ALL function.</p><div class="formalpara" id="calibre_link-1757"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-1758">The use of CALCULATE and ALL in this way removes all filter context including any hardcoded explicit filter rules you may have used elsewhere such as a Report, Page, or Visual filter.</p></div><p class="simplepara" id="calibre_link-1759">This now allows for a calculation to be written that combines the [Count of Sales] with [Count of all Sales] to generate a value that shows a percentage of total for each row. The output of this calculation is shown in Figure <span><a href="#calibre_link-281" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-9</a></span>.</p><div class="para1" id="calibre_link-1760">
                <div class="programcode" id="calibre_link-1761"><div class="fixedline">Count of Sales % =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Count of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Count of all Sales]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
                <figure class="figure1" id="calibre_link-281"><div class="mediaobject" id="calibre_link-1762"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig9_HTML.jpg" src="images/000033.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-9</span><p class="simplepara1">Output with an additional calculated measure</p></div></figcaption></figure>
              </div><p class="simplepara" id="calibre_link-1763">In this example in Figure <span><a href="#calibre_link-281" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-9</a></span>, the table passed to the ALL function was ‘Fact Sales’. The <span id="calibre_link-1764">function

</span> removed any implicit filter context from the ‘Fact Sales’ table, which was the query context being generated by the ‘Dimension Date’[Calendar Year] column. If the ‘Dimension Date’ table was used in place of ‘Fact Sale’, the filter context would instead be removed from the ‘Dimension Date’ table. This subtle change doesn’t end up changing the values of the visual used in this example.</p><p class="simplepara" id="calibre_link-1765">The net effect of the overall filtering still passes the same rows to the COUNTROWS function. There may be a small difference in performance, but we look at that in Chapter <span><a href="#calibre_link-160" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>8</span></a></span> when I cover optimizing DAX.</p><p class="simplepara" id="calibre_link-1766">If you include some additional columns to the table visual, this will demonstrate the difference when you specify which table to use in the ALL function with calculated measures.</p><p class="simplepara" id="calibre_link-1767">Consider the two calculated measures in Listings <span><a href="#calibre_link-282" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-3</a></span> and <span><a href="#calibre_link-283" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-4</a></span>.</p><div class="para1" id="calibre_link-282">
                <div class="programcode" id="calibre_link-1768"><div class="fixedline">Count of all (<strong class="emphasistypebold">Dim Date</strong>) Sales =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL(<strong class="emphasistypebold">'Dimension Date'</strong>)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-3</span><p class="para3">Calculated Measure Using ALL with the ‘Dimension Date’ Table</p></div></div></div>
              </div><div class="para1" id="calibre_link-283">
                <div class="programcode" id="calibre_link-1769"><div class="fixedline">Count of all (<strong class="emphasistypebold">Fact Sales</strong>) Sales =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL(<strong class="emphasistypebold">'Fact Sale'</strong>)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-4</span><p class="para3">Calculated Measure Using <span id="calibre_link-1770">ALL

</span> with the 'Fact Sale' Table</p></div></div></div>
              </div><div class="para1" id="calibre_link-1771">The only difference between these calculated measures is the table used in the ALL function. These yield the same results via two separate paths when you use them in a visual with just the ‘Dimension Date’[Calendar Year] column. However, if you introduce a filter from a table other than ‘Dimension Date’, you will see a difference. This case (shown in Figure <span><a href="#calibre_link-284" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-10</a></span>) uses the ‘Fact Sale’[Package] column, in which all rows have just one of the following four values: Bag, Each, Packet, or Pair.<figure class="figure1" id="calibre_link-284"><div class="mediaobject" id="calibre_link-1772"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig10_HTML.jpg" src="images/000038.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-10</span><p class="simplepara1">Output using code from Listings <span class="calibre9"><a href="#calibre_link-282" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-3</a></span> and <span class="calibre9"><a href="#calibre_link-283" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-4</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1773">For each cell/computation in the third, fourth, and fifth columns of Figure <span><a href="#calibre_link-284" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-10</a></span>, the calculated measure starts with an automatic filter context that is relevant for the row in question. The [Count of Sales] measure doesn’t remove any of the implicit filter context, so the values reflect the true number of rows in the ‘Fact Sale’ table that happen to match the [Calendar Year] and [Package] columns.</p><p class="simplepara" id="calibre_link-1774">However, for the [Count of all (Dim Date) Sales] calculated measure, the only filter context being removed is any that exists on the ‘Dimension Date’ table and not any filter context being applied to the ‘Fact Sale’ table. This explains why you see different values between the rows where the value for [Package] is Bag and rows with a different value for [Package].</p><p class="simplepara" id="calibre_link-1775">What is happening here is the <span id="calibre_link-1776">implicit

</span> filter being driven by the [Calendar Year] column is being removed, while the implicit filter being driven by the [Package] column is not being removed.</p><p class="simplepara" id="calibre_link-1777">For the [Count of all (Fact Sales) Sales] calculated measure, the ALL function is clearing all implicit filters from the ‘Fact Sales’ table, which includes any implicit filters being passed down from related tables; therefore, the COUNTROWS function can now use every row in the ‘Fact Sale’ table to generate a value.</p><p class="simplepara" id="calibre_link-1778">The implied filter <span id="calibre_link-1779">context

</span> is not just driven from other columns used in the same visual. Implied filter context can be driven from filters external to the current visual. These can take the form of selections made to slicers on the same report, or other non-DAX-based external filter settings.</p></section><section class="section" id="calibre_link-1780"><h4 class="heading2">Explicit Filters</h4><p class="simplepara" id="calibre_link-1781">Functions that allow the removal of implicit filter context have no effect on explicit filters. This means that if you use a specific filter rule in a calculated <span id="calibre_link-1782">measure

</span>, this filter condition cannot be removed by a downstream calculation.</p><p class="simplepara" id="calibre_link-1783">Consider the two calculated measures in Listings <span><a href="#calibre_link-285" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-5</a></span> and <span><a href="#calibre_link-286" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-6</a></span>.</p><div class="para1" id="calibre_link-285">
                <div class="programcode" id="calibre_link-1784"><div class="fixedline">Count of Sales (10 or more) =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Quantity] &gt;= 10</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-5</span><p class="para3">Calculated Measure Applying Filter to [Quantity] Column</p></div></div></div>
              </div><div class="para1" id="calibre_link-286">
                <div class="programcode" id="calibre_link-1785"><div class="fixedline">Count of all (Explicit) Sales =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">[Count of Sales (10 or more)],</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL('Fact Sale')</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-6</span><p class="para3">Calculated Measure Showing the effect of the ALL Function with the Calcuated Measure from Listing <span><a href="#calibre_link-285" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-5</a></span>
</p></div></div></div>
              </div><div class="para1" id="calibre_link-1786">When the calculation is used in the <span id="calibre_link-1787">table visual

</span>, you get the output shown in Figure <span><a href="#calibre_link-287" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-11</a></span>.<figure class="figure1" id="calibre_link-287"><div class="mediaobject" id="calibre_link-1788"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig11_HTML.jpg" src="images/000013.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-11</span><p class="simplepara1">Output using code from Listings <span class="calibre9"><a href="#calibre_link-285" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-5</a></span> and <span class="calibre9"><a href="#calibre_link-286" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-6</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1789">In Figure <span><a href="#calibre_link-287" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-11</a></span>, the fourth column uses the [Count of all (Explicit) Sales] calculated measure. The value shown in each cell is the result of a mixture of implicit filter context and explicit filtering. The value of 30,588 represents the number of rows from ‘Fact Sales’ that belong to the [Calendar Year] of 2013, which is the implicit filter context, along with the additional restriction to only count rows where the ‘Fact Sale’[Quantity] is greater than or equal to 10. You end up with five different values, including the Total row at the bottom.</p><p class="simplepara" id="calibre_link-1790">However, for the [Count of all (Explicit) Sales] calculated measure in the final column, the ALL function is being used to specify that all implicit filter context that may exist on the <span id="calibre_link-1791">‘Fact Sale’ table

</span> should be removed. The result is the same value of 114,687, because the implicit filtering on [Calendar Year] is being removed using the ALL function. This shows that the query context has been removed by the ALL function, while the upstream filtering that ‘Fact Sale’[Quantity] &gt;=10 remains.</p><p class="simplepara" id="calibre_link-1792">Perhaps a more meaningful name for the <span id="calibre_link-1793">ALL function

</span> might have been REMOVEALLIMPLICITFILTERS, which perhaps is a better indication of the objective of the function. I have used the term <em class="emphasistypeitalic">implicit</em> throughout this chapter. The key point is although it is effective at removing all inherited filters, an explicit filter, as used here to limit the result to rows where the [Quantity] is greater than or equal to 10, is not affected.</p></section><section class="section" id="calibre_link-1794"><h4 class="heading2">The ALL Function</h4><p class="simplepara" id="calibre_link-1795">The previous section introduced the powerful <span id="calibre_link-1796">ALL function

</span>. Let’s take a closer look at this function. The syntax is as follows:</p><div class="para1" id="calibre_link-1797">
                <div class="programcode" id="calibre_link-1798"><div class="fixedline">ALL (&nbsp;&nbsp;&lt;table&gt; | &lt;column&gt; [, &lt;column&gt; ...]&nbsp;&nbsp;)</div></div>
              </div><p class="simplepara" id="calibre_link-1799">The | symbol between the &lt;table&gt; and the first &lt;column&gt; value signifies an “or.” This means the first parameter can be a table OR a column. If the first parameter is a table, there is no option for a second parameter. In this case, all implicit filter context is removed from the specified table, which effectively returns all rows from the table. If a column is used as the first parameter, then additional columns can be used as the second and third parameters as long as all the columns come from the same table.</p><p class="simplepara" id="calibre_link-1800">A more efficient use of the [Count of all (Explicit) Sales] calculated measure from the previous section would be</p><div class="para1" id="calibre_link-1801">
                <div class="programcode" id="calibre_link-1802"><div class="fixedline">Count of all (Explicit) Sales =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Count of Sales (10 or more)],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ALL('Dimension Date'[Calendar Year])</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
              </div><p class="simplepara" id="calibre_link-1803">The change to the calculated measure is that the ALL function is now using a column instead of a table as its parameter. More importantly, the column being passed to the ALL function is the same column being used to drive the implicit filtering. The values produced by this updated version are the same as the version that used the ‘Fact Sales’ table as a parameter.</p><p class="simplepara" id="calibre_link-1804">In this example, different values are produced for each cell if any other column is used by the <span id="calibre_link-1805">ALL function

</span>. The query plan generated for both versions of these calculated measures was the same, so swapping a &lt;table&gt; for a &lt;column&gt; here has no effect on performance. In other cases, swapping a &lt;table&gt; for a &lt;column&gt; can provide faster performance.</p><section class="section" id="calibre_link-1806"><h5 class="heading2">The <span id="calibre_link-1807">ALLEXCEPT Function

</span>
</h5><p class="simplepara" id="calibre_link-1808">Another DAX function that provides the ability to override implicit filters is the ALLEXCEPT function. This is similar to the ALL function in the way it can be used to clear filters, however, with this function, the parameters are used to specify which filters retain implicit filters.</p><p class="simplepara" id="calibre_link-1809">This is the syntax of the ALLEXCEPT function:</p><div class="para1" id="calibre_link-1810">
                  <div class="programcode" id="calibre_link-1811"><div class="fixedline">ALLEXCEPT ( &lt;table&gt;, &lt;column&gt; [, &lt;column&gt; ...] )</div></div>
                </div><p class="simplepara" id="calibre_link-1812">With ALLEXCEPT, the minimum requirement is to pass both a table and a column. One or more columns can be used as additional parameters. This function provides a handy alternative to the ALL function when used on tables with lots of columns.</p><p class="simplepara" id="calibre_link-1813">If you have a table with 30 columns and a calculation that needs to clear implicit filters on 28 of these, using the ALL function requires 28 parameters to be passed. However, using the ALLEXCEPT function only requires 3 columns to be passed.</p><div class="para1" id="calibre_link-1814">Consider the Table <span><a href="#calibre_link-288" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-1</a></span>.<div class="table" id="calibre_link-288"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 6-1</span><p class="para3">Dataset to Be Used as Table1 Table</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">ColumnA</p></th><th class="calibre14"><p class="simplepara2">ColumnB</p></th><th class="calibre14"><p class="simplepara2">ColumnC</p></th><th class="calibre14"><p class="simplepara2">ColumnD</p></th><th class="calibre14"><p class="simplepara2">ColumnE</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">A</p></td><td class="calibre16"><p class="simplepara2">Apple</p></td><td class="calibre16"><p class="simplepara2">Australia</p></td><td class="calibre16"><p class="simplepara2">Athletics</p></td><td class="calibre16"><p class="simplepara2">10</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">B</p></td><td class="calibre16"><p class="simplepara2">Banana</p></td><td class="calibre16"><p class="simplepara2">Brazil</p></td><td class="calibre16"><p class="simplepara2">Athletics</p></td><td class="calibre16"><p class="simplepara2">15</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">C</p></td><td class="calibre16"><p class="simplepara2">Cherry</p></td><td class="calibre16"><p class="simplepara2">Canada</p></td><td class="calibre16"><p class="simplepara2">Cricket</p></td><td class="calibre16"><p class="simplepara2">30</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-1815">The calculated measures in Listings <span><a href="#calibre_link-289" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-7</a></span> and <span><a href="#calibre_link-290" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-8</a></span> have the same net effect.</p><div class="para1" id="calibre_link-289">
                  <div class="programcode" id="calibre_link-1816"><div class="fixedline">ALL Measure =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Table1'[ColumnE]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ALL(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Table1[ColumnA],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Table1[ColumnB],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Table1[ColumnC]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-7</span><p class="para3">A Calculated Measure Using the ALL <span id="calibre_link-1817">Function

</span> with Specific Columns</p></div></div></div>
                </div><div class="para1" id="calibre_link-290">
                  <div class="programcode" id="calibre_link-1818"><div class="fixedline">ALLEXEPT Measure =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Table1'[ColumnE]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ALLEXCEPT(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Table1,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Table1[ColumnD]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-8</span><p class="para3">A Calculated Measure Using the ALLEXCEPT Function with Specific Columns</p></div></div></div>
                </div><div class="para1" id="calibre_link-1819">The result of adding both calculated measures to a table visual is shown in Figure <span><a href="#calibre_link-291" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-12</a></span>.<figure class="figure1" id="calibre_link-291"><div class="mediaobject" id="calibre_link-1820"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig12_HTML.jpg" src="images/000039.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-12</span><p class="simplepara1">Output using code from Listings <span class="calibre9"><a href="#calibre_link-289" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-7</a></span> and <span class="calibre9"><a href="#calibre_link-290" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-8</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1821">The two right-hand <span id="calibre_link-1822">columns

</span> in Figure <span><a href="#calibre_link-291" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-12</a></span> show the output of both versions of the calculated measure. In each case, implicit filters being generated by the first three columns are being cleared leaving only implicit filters from ColumnD to be considered by the SUM function inside CALCULATE.</p><p class="simplepara" id="calibre_link-1823">What this also shows is that you can perform Percentage of Total calculations against subcategories within your data. Using either the ALL or ALLEXCEPT function in this way, you can generate a value showing the sum of values in ColumnE, grouped by ColumnD. You can then use this in a calculation that shows the proportion of ColumnE that is Brazil over every row that has Athletics in ColumnD.</p><p class="simplepara" id="calibre_link-1824">The calculated measure in Listing <span><a href="#calibre_link-292" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-9</a></span> returns a value that represents a percentage of a subcategory. The results are shown in Figure <span><a href="#calibre_link-293" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-13</a></span>.</p><div class="para1" id="calibre_link-292">
                  <div class="programcode" id="calibre_link-1825"><div class="fixedline">ColumnD Ratio =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Table1'[ColumnE]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">[ALL Measure],</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-9</span><p class="para3">A Calculated Measure Incorporating a Calculated Measure from Listing <span><a href="#calibre_link-289" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-7</a></span>
</p></div></div></div>
                  <figure class="figure1" id="calibre_link-293"><div class="mediaobject" id="calibre_link-1826"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig13_HTML.jpg" src="images/000005.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-13</span><p class="simplepara1">Output of <span id="calibre_link-1827" class="calibre9">code

</span> from Listing <span class="calibre9"><a href="#calibre_link-292" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-9</a></span> when formatted as a percent</p></div></figcaption></figure>
                </div></section><section class="section" id="calibre_link-1828"><h5 class="heading2">The ALLSELECTED Function</h5><p class="simplepara" id="calibre_link-1829">The final function to look at in this section is the <span id="calibre_link-1830">ALLSELECTED function

</span>. Like ALL and ALLEXCEPT, the purpose of this function is to remove implicit or inherited filtering from the current calculation to allow access to rows of data that would otherwise be unavailable. The difference between ALLSELECTED and the earlier functions is that ALLSELECTED only removes implicit filters that are generated within the same query.</p><p class="simplepara" id="calibre_link-1831">This is especially useful in Power BI where each value on a visual can be influenced by filters from many places. Values can be filtered explicitly through hardcoded DAX or implicitly through other fields in the same visual such as column or row headers (or fields used on an axis). Lastly, filters can be inherited from selections made external to the current visual. It is the distinction between implicit filters generated by filters on fields in the current visual and external filters where ALLSELECTED is most useful.</p><p class="simplepara" id="calibre_link-1832">To get a feel for using all of these functions with WideWorldImportersDW data, consider the Listings <span><a href="#calibre_link-294" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-10</a></span>, <span><a href="#calibre_link-295" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-11</a></span>, and <span><a href="#calibre_link-296" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-12</a></span>.</p><div class="para1" id="calibre_link-294">
                  <div class="programcode" id="calibre_link-1833"><div class="fixedline">Sum of Quantity = SUM('Fact Sale'[Quantity])</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-10</span><p class="para3">Calculated Measure Using SUM</p></div></div></div>
                </div><div class="para1" id="calibre_link-295">
                  <div class="programcode" id="calibre_link-1834"><div class="fixedline">ALL Quantity =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ALL</strong>('Fact Sale')</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-11</span><p class="para3">Calculated Measure Using the ALL Function to Manage Filter Context</p></div></div></div>
                </div><div class="para1" id="calibre_link-296">
                  <div class="programcode" id="calibre_link-1835"><div class="fixedline">ALLSELECTED Quantity =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ALLSELECTED</strong>('Fact Sale')</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-12</span><p class="para3">Calculated <span id="calibre_link-1836">Measure

</span> Using the ALLSELECTED to Manage Filter Context</p></div></div></div>
                </div><div class="para1" id="calibre_link-1837">When these measures are used in a table visual along with the ‘Dimension Date’[Calendar Year] column, you get the result in Figure <span><a href="#calibre_link-297" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-14</a></span>.<figure class="figure1" id="calibre_link-297"><div class="mediaobject" id="calibre_link-1838"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig14_HTML.jpg" src="images/000066.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-14</span><p class="simplepara1">Output using code from Listings <span class="calibre9"><a href="#calibre_link-294" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-10</a></span>, <span class="calibre9"><a href="#calibre_link-295" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-11</a></span>, and <span class="calibre9"><a href="#calibre_link-296" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-12</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1839">There is no difference between the values in the [ALL Quantity] and [ALLSELECTED Quantity] columns. The assumption here is that no other visuals or external filters are being used to generate this result. Both the ALL and ALLSELECTED functions are removing the implicit filtering being driven from the [Calendar Year] column.</p><div class="para1" id="calibre_link-1840">However, when an external filter is added to the report, such as a slicer over a field in a related table, you can see how the values are affected (Figure <span><a href="#calibre_link-298" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-15</a></span>).<figure class="figure1" id="calibre_link-298"><div class="mediaobject" id="calibre_link-1841"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig15_HTML.jpg" src="images/000021.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-15</span><p class="simplepara1">Output of the code from Listings <span class="calibre9"><a href="#calibre_link-294" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-10</a></span>, <span class="calibre9"><a href="#calibre_link-295" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-11</a></span>, and <span class="calibre9"><a href="#calibre_link-296" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-12</a></span> with filtering from a slicer</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1842">In this case, a slicer has been added using the ‘Dimension Stock Item’[Buying Package] <span id="calibre_link-1843">field

</span> and a selection of Each has been made. The three calculated measures now react differently to this external filter.</p><p class="simplepara" id="calibre_link-1844">The [Quantity] calculated measure now generates a sum over the Quantity field, and it inherits two layers of implied filter context. The value of 1,725,397 for the top row is first influenced by the [Calendar Year] field filtering rows in the ‘Fact Sale’ table that are relevant to 2013, while the second layer of filtering that comes from the slicer is set to Each. Both layers accumulate to leave the SUM function to only use rows that match both criteria. No filters are overridden for this calculated measure.</p><p class="simplepara" id="calibre_link-1845">The [ALL Quantity] calculated measure uses the ALL function to remove any implied filter context from the calculation. This removes filtering from both the internal layer being driven by the [Calendar Year] field and the external layer of implicit filtering being driven by the slicer. The net result is every cell has the same value including the total. This also happens to be the sum of every ‘Fact Sale’[Quantity] column.</p><p class="simplepara" id="calibre_link-1846">The [ALLSELECTED Quantity] calculated measure now shows a different value than the [ALL Quantity] column. This is because the ALLSELECTED function removes the internal layer of filtering being driven by the [Calendar Year] column, but it doesn’t remove any filtering coming from the slicer. If a different <span id="calibre_link-1847">selection

</span> is now made to the slicer, the [ALLSELECTED Quantity] measure updates with new values, while the [ALL Quantity] measure remains unchanged.</p><p class="simplepara" id="calibre_link-1848">The three calculated measures in this example can be used as the basis for additional measures that highlight data in interesting ways. All are potentially useful in your report. Hopefully these examples show the intent and approach of the different filter functions. It’s possible to target a very fine grain of row selection using these functions to provide extensive flexibility.</p></section></section><section class="section" id="calibre_link-1849"><h4 class="heading2">
                <span id="calibre_link-1850">Running Totals

</span>
              </h4><p class="simplepara" id="calibre_link-1851">The ability to remove implicit filters from calculations is also useful when used to generate running totals. To create a calculated measure that shows the running total of the ‘Fact Sale’[Quantity] column, start with a core DAX expression such as this:</p><div class="para1" id="calibre_link-1852">
                <div class="programcode" id="calibre_link-1853"><div class="fixedline">SUM('Fact Sale'[Quantity])</div></div>
              </div><p class="simplepara" id="calibre_link-1854">The challenge is that when you use this expression in a visual, the calculation only considers values in the ‘Fact Sale’[Quantity] column that are implicitly filtered by other fields. If the ‘Dimension Date’[Calendar Year] field is also used in the query, the result produced for this calculation correctly shows the SUM for each specific calendar year but does not have access to data relating to other years to provide a running total effect. This is where the ALL, ALLEXCEPT, and ALLSELECTED functions can help.</p><p class="simplepara" id="calibre_link-1855">To see a demonstration of running totals using WideWorldImportersDW data, consider the following calculated measures in Listings <span><a href="#calibre_link-299" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-13</a></span> and <span><a href="#calibre_link-300" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-14</a></span>.</p><div class="para1" id="calibre_link-299">
                <div class="programcode" id="calibre_link-1856"><div class="fixedline">Sum of Quantity = SUM('Fact Sale'[Quantity])</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-13</span><p class="para3">A Calculated Measure Using SUM</p></div></div></div>
              </div><div class="para1" id="calibre_link-300">
                <div class="programcode" id="calibre_link-1857"><div class="fixedline">Running Total =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL('Dimension Date'[Calendar Year]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAX('Dimension Date'[Calendar Year]) &gt;= 'Dimension Date'[Calendar Year])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-14</span><p class="para3">A Calculated <span id="calibre_link-1858">Measure

</span> Using the FILTER Function to Generate a Running Total</p></div></div></div>
              </div><div class="para1" id="calibre_link-1859">When these calculated columns are added to a visual that also uses the ‘Dimension Date’[Calendar Year] column, the results in Figure <span><a href="#calibre_link-301" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-16</a></span> are produced.<figure class="figure1" id="calibre_link-301"><div class="mediaobject" id="calibre_link-1860"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig16_HTML.jpg" src="images/000050.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-16</span><p class="simplepara1">Output of the code from Listings <span class="calibre9"><a href="#calibre_link-299" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-13</a></span> and <span class="calibre9"><a href="#calibre_link-300" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-14</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1861">The values in the [Sum of Quantity] column all show the result of the calculation being run with the relevant implicit filter being driven from the [Calendar Year] column. The bottom value of 8,950,628 in this column has no implicit filter context, so it calculates over every row in the ‘Fact Sale’ table.</p><p class="simplepara" id="calibre_link-1862">For the [Running Total] calculation, the SUM function is wrapped inside a CALCULATE function that allows additional filtering instructions to be defined, in this case, the targeted removal of some implicit filtering. For the result of 4,969,058 for 2014, the SUM function needs to have access to rows that relate to 2013.</p><p class="simplepara" id="calibre_link-1863">The first parameter of the FILTER <span id="calibre_link-1864">function

</span> uses the ALL function to remove any implicit filtering from the [Calendar Year] column. This has the effect of exposing every row from the ‘Fact Sale’ table to the SUM function. If you stopped here, you would simply see the value of 8,950,628 repeated in every cell.</p><p class="simplepara" id="calibre_link-1865">The second parameter of the FILTER function specifies <span class="emphasisfontcategorynonproportional">MAX ('Dimension Date'[Calendar Year]) &gt;= 'Dimension Date'[Calendar Year])</span><em class="emphasistypeitalic">,</em> which defines a filtering rule that now reduces rows from the ‘Fact Sale’ table to only those that mean this Boolean condition. For the first row in the table visual, this means only rows that related to 2013. For the second row, this includes all rows that relate to 2013 as well as 2014. This is the magic that provides the effect of a running total.</p><p class="simplepara" id="calibre_link-1866">Each cell in the [Running Total] column is an independent calculation that does not rely on, or use, the output from any previous calculation in the visual. The calculations can run in any order and will only consider rows that survive the multiple layers of filtering being applied.</p><p class="simplepara" id="calibre_link-1867">DAX can perform these calculations very quickly due to the in-memory, column-based nature of the xVelocity engine, so the extra flexibility provided through the independent nature of cell-based calculations generally outweighs any downsides of read duplication. It is good to keep this in mind if you are building running totals over many calculations. In this example, the [Running Total] calculation executes five times.</p><p class="simplepara" id="calibre_link-1868">If the ‘Dimension Date’[Date] column was used in place of ‘Dimension Date’[Calendar Year] for both the calculated measure and the visual, there would be 1,462 executions of the calculated measure (one for each row at the [Date] level and then one for the total). Any values in rows related to January 1, 2013, would be used by every one of the 1,462 executions.</p><section class="section" id="calibre_link-1869"><h5 class="heading2">ALLSELECTED on Running Total</h5><p class="simplepara" id="calibre_link-1870">The [Running Total] calculated measure shown previously in Listing <span><a href="#calibre_link-300" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-14</a></span> used the ALL function to remove any implicit filters being driven by the ‘Dimension Date’[Calendar Year] column. When employed in this manner, other slicers and filters used external to the visual that are based on columns other than ‘Dimension Date’[Calendar Year] filter through to the SUM calculation. This means they give a running total from the start of the first record in the [Calendar Year] column, but the rows also have an additional filter applied that is relevant to the selection of the slicer.</p><p class="simplepara" id="calibre_link-1871">The exception to this is if a slicer or external filter is based on the ‘Dimension Date’[Calendar Year] column. In this case, the value produced if the slicer is filtered to 2015 is still 7,709,324. All rows that relate to 2013 and 2014 are still considered by the SUM.</p><p class="simplepara" id="calibre_link-1872">If the calculation is changed to use the <span id="calibre_link-1873">ALLSELECTED function

</span> in place of the ALL function, any slicer or external filter based on ‘Dimension Date’[Calendar Year] now only considers rows that relate to selections in the slicer.</p><p class="simplepara" id="calibre_link-1874">This can be demonstrated using the three calculated measures in Listings <span><a href="#calibre_link-302" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-15</a></span>, <span><a href="#calibre_link-303" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-16</a></span>, and <span><a href="#calibre_link-304" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-17</a></span>.</p><div class="para1" id="calibre_link-302">
                  <div class="programcode" id="calibre_link-1875"><div class="fixedline">Sum of Quantity = SUM('Fact Sale'[Quantity])</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-15</span><p class="para3">A Calculated Measure Using SUM</p></div></div></div>
                </div><div class="para1" id="calibre_link-303">
                  <div class="programcode" id="calibre_link-1876"><div class="fixedline">Running Total <strong class="emphasistypebold">ALL</strong> =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ALL</strong>('Dimension Date'[Calendar Year]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAX('Dimension Date'[Calendar Year]) &gt;= 'Dimension Date'[Calendar Year])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-16</span><p class="para3">Running a Total Calculated Measure Using the ALL Function to Manage the Filter Context</p></div></div></div>
                </div><div class="para1" id="calibre_link-304">
                  <div class="programcode" id="calibre_link-1877"><div class="fixedline">Running Total <strong class="emphasistypebold">ALLSELECTED</strong> =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ALLSELECTED</strong>('Dimension Date'[Calendar Year]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAX('Dimension Date'[Calendar Year]) &gt;= 'Dimension Date'[Calendar Year])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-17</span><p class="para3">Running a Total Calculated Measure Using the ALLSELECTED Function to Manage Filter Context</p></div></div></div>
                </div><div class="para1" id="calibre_link-1878">Figure&nbsp;<span><a href="#calibre_link-305" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-17</a></span> shows the result when a selection has been made to a slicer using the ‘Dimension Date’[Calendar Year] <span id="calibre_link-1879">column

</span>. In this example, two selections are made to the slicer for 2015 and 2016.<figure class="figure1" id="calibre_link-305"><div class="mediaobject" id="calibre_link-1880"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig17_HTML.jpg" src="images/000070.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-17</span><p class="simplepara1">Output of code from Listings <span class="calibre9"><a href="#calibre_link-302" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-15</a></span>, <span class="calibre9"><a href="#calibre_link-303" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-16</a></span>, and <span class="calibre9"><a href="#calibre_link-304" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-17</a></span> with filtering from slicer using two selections</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1881">The difference between the two running total calculated measures is the way each reacts to the slicer. The version that uses ALL removes all filtering over the ‘Dimension Date’[Calendar Year] column, regardless of where the filter originated, whereas the version using ALLSELECTED retains the filtering context from the slicer. This means the calculation using ALLSELECTED cannot access rows from ‘Fact Sale’ that relate to 2013 or 2014, so the running total is started from 2015 rather than from 2013.</p><p class="simplepara" id="calibre_link-1882">Either approach may suit your reporting requirements. Sometimes you need to use one approach, other times you need the other. This example hopefully demonstrates how you can use the different filter functions to achieve what you need.</p></section><section class="section" id="calibre_link-1883"><h5 class="heading2">
                  <span id="calibre_link-1884">Resetting Running Totals

</span>
                </h5><p class="simplepara" id="calibre_link-1885">A slight variation on the running total measure is to provide a running total over a value for a subcategory that resets between categories. For instance, this can be demonstrated using the ‘Dimension Date’ table, where the category is Calendar Year and the subcategory is Calendar Month.</p><p class="simplepara" id="calibre_link-1886">The following calculated column is first added to the ‘Dimension Date’ table:</p><div class="para1" id="calibre_link-1887">
                  <div class="programcode" id="calibre_link-1888"><div class="fixedline">Calendar Month = STARTOFMONTH('Dimension Date'[Date])</div></div>
                </div><p class="simplepara" id="calibre_link-1889">This generates a new column that carries a value that shows the first day of every relevant month.</p><p class="simplepara" id="calibre_link-1890">A modified version of the [Running Total ALL] calculated measure with differences highlighted is shown in Listing <span><a href="#calibre_link-306" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-18</a></span>.</p><div class="para1" id="calibre_link-306">
                  <div class="programcode" id="calibre_link-1891"><div class="fixedline">Running Total ALL =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Dimension Date'[Calendar Month],</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Year]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">MAX('Dimension Date'[Calendar Month]) &gt;= 'Dimension Date'[Calendar Month]</strong> &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">MAX('Dimension Date'[Calendar Year]) = 'Dimension Date'[Calendar Year])</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-18</span><p class="para3">Running Total Calculated Measure That Resets Each Year</p></div></div></div>
                </div><div class="para1" id="calibre_link-1892">When used in a Matrix visual with the ‘Dimension Date’[Calendar Year] and the new ‘Dimension Date’[Calendar Month] columns, the calculated measure produces the result in Figure <span><a href="#calibre_link-307" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-18</a></span>.<figure class="figure1" id="calibre_link-307"><div class="mediaobject" id="calibre_link-1893"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig18_HTML.jpg" src="images/000078.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-18</span><p class="simplepara1">Output using code from Listing <span class="calibre9"><a href="#calibre_link-306" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-18</a></span>. Running totals are reset for 2014</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1894">In this calculation, the FILTER <span id="calibre_link-1895">function

</span> uses more sophisticated rules to determine which filters should be removed or applied to decide which rows can be considered by the SUM function.</p><p class="simplepara" id="calibre_link-1896">The ALL function removes any implied filtering from the [Calendar Year] and [Calendar Month] columns. At this point, the SUM calculation returns the value of 8,950,628 for every cell in the [Running Total ALL] column.</p><p class="simplepara" id="calibre_link-1897">However, additional filtering is being applied by rules in the FILTER function. Two conditions need to be met according to these rules.</p><p class="simplepara" id="calibre_link-1898">The first condition is that rows in the ‘Fact Sale’ table related to each ‘Dimension Date’[Calendar Month] must be the same, or lower (earlier) than the Calendar Month from the row header. This is the condition that provides the running total effect.</p><p class="simplepara" id="calibre_link-1899">This is a confusing notation. There appear to be two references to the same ‘Dimension Date’[Calendar Month] object. These are not the same objects. One refers to the version of ‘Dimension Date’ in the query context, while the other refers to the version of ‘Dimension Date’ used in the filter context.</p><p class="simplepara" id="calibre_link-1900">The ‘Dimension Date’[Calendar Month] wrapped in the MAX function on the left-hand side of the &gt;= operator is referring to the query context. The MAX function guarantees just one value to be used in the comparison.</p><p class="simplepara" id="calibre_link-1901">The ‘Dimension Date’[Calendar Month] on the right-hand side of the &gt;= operator refers to the filter context. It is these records, including downstream rows in ‘Fact Sale’ that are used and passed to the SUM function.</p><p class="simplepara" id="calibre_link-1902">The other criteria in the filter <span id="calibre_link-1903">expression

</span> is to specify only rows from ‘Fact Sale’ that have a relationship to ‘Dimension Date’[Calendar Year] that matches the value from the Calendar Year row header. This is the part of the code that resets the running total.</p><p class="simplepara" id="calibre_link-1904">This requirement could also be satisfied using the following calculated measure:</p><div class="para1" id="calibre_link-1905">
                  <div class="programcode" id="calibre_link-1906"><div class="fixedline">Running Total YTD =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;TOTALYTD(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
                </div><p class="simplepara" id="calibre_link-1907">The TOTALYTD function provides a running total for each Calendar Month as well as resetting each year. Although this is simpler, it is only designed to work with date-based columns and it provides less flexibility around your running total. The [Running Total ALL] version uses a pattern that you can apply to different types of data, with more control over the rules around when to reset the running total (if at all).</p></section><section class="section" id="calibre_link-1908"><h5 class="heading2">Running Totals as a&nbsp;<span id="calibre_link-1909">Rank

</span> (Calculated Column)</h5><p class="simplepara" id="calibre_link-1910">An alternative use of the running total pattern is to provide a ranking over a set of data with the output being a column rather than a measure. This calculated column provides a version that establishes a ranking from 1 to 403 for customers based on overall sales (Listing <span><a href="#calibre_link-308" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-19</a></span>). The calculation relies on a one-to-many relationship existing between the ‘Dimension Customer’ and ‘Fact Sale’ tables.</p><div class="para1" id="calibre_link-308">
                  <div class="programcode" id="calibre_link-1911"><div class="fixedline">Customer Rank Column =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;RANKX(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Customer',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Excluding Tax])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-19</span><p class="para3">A Calculated Column Using RANKX Over a Relationship</p></div></div></div>
                </div><p class="simplepara" id="calibre_link-1912">An interesting feature to point out about this DAX statement is the use of CALCULATE. This is required to convert the current row context to a filter context to allow the SUM function to correctly generate the correct value for each row using information across the relationship. If the CALCULATE statement is removed, the SUM function simply returns the same value over and over. The value returned is the sum of every row in the ‘Fact Sale’ table.</p><p class="simplepara" id="calibre_link-1913">This calculation only computes when data is being refreshed into the model because it is a calculated column. Filters and slicers have no effect on the number returned.</p><p class="simplepara" id="calibre_link-1914">To help understand the approach of the DAX formula, take a look at the T-SQL equivalent (Listing <span><a href="#calibre_link-309" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-20</a></span>).</p><div class="para1" id="calibre_link-309">
                  <div class="programcode" id="calibre_link-1915"><div class="bookfrontmatter"><div class="fixedline1">WITH Ranking (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Customer Key],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Total Excluding Tax]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AS</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D.[Customer Key],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM(F.[Total Excluding Tax]) AS [Total Excluding Tax]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM Dimension.Customer AS D</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Fact.Sale AS F</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON F.[Customer Key] = D.[Customer Key]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GROUP BY</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;D.[Customer Key]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECT</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.[Customer Key],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNT(*) AS [Final Ranking]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FROM Ranking AS L</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INNER JOIN Ranking AS R</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON L.[Total Excluding Tax] &lt;= R.[Total Excluding Tax]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GROUP BY</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L.[Customer Key]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ORDER BY</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNT(*)</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-20</span><p class="para3">The T-SQL Equivalent of the DAX Code in Listing <span><a href="#calibre_link-308" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-19</a></span>
</p></div></div></div>
                </div><p class="simplepara" id="calibre_link-1916">The final select statement performs a self-join back to the predicate on the INNER JOIN <span id="calibre_link-1917">filtering

</span> out rows with a higher value for [Total Excluding Tax]. You can obtain a ranking by counting the number or rows after the INNER JOIN. You can achieve this in other ways using T-SQL, but this version is useful to help you understand the approach taken by the DAX formula.</p><p class="simplepara" id="calibre_link-1918">The FILTER function takes a similar approach to a T-SQL self-join, which you can tailor to suit different requirements by using different filtering rules.</p></section><section class="section" id="calibre_link-1919"><h5 class="heading2">
                  <span id="calibre_link-1920">Period Comparison

</span>
                </h5><p class="simplepara" id="calibre_link-1921">A common requirement is to compare a value for one period to a previous period. This allows further calculations to show variation percentages, among other things. One example is showing a value for a measure for a specific month next to a value of the same measure for the previous month (or the same month from a previous year).</p><p class="simplepara" id="calibre_link-1922">Consider the example of comparing to a previous month when you take a look at the four calculated measures in Listings <span><a href="#calibre_link-310" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-21</a></span>&ndash;<span><a href="#calibre_link-311" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-24</a></span>.</p><div class="para1" id="calibre_link-310">
                  <div class="programcode" id="calibre_link-1923"><div class="fixedline">Using Filter =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL('Dimension Date'[Calendar Month]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAX('Dimension Date'[Calendar Month]) = EDATE('Dimension Date'[Calendar Month],1)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-21</span><p class="para3">A Period Comparison Calculated Measure Using the ALL Function to Manage Filter Context</p></div></div></div>
                </div><div class="para1" id="calibre_link-311">
                  <div class="programcode" id="calibre_link-1924"><div class="fixedline">Using Parallel Period =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PARALLELPERIOD('Dimension Date'[Date],-1,MONTH)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-22</span><p class="para3">A Period Comparison Calculated Measure Using PARALLELPERIOD</p></div></div></div>
                </div><div class="para1" id="calibre_link-1925">
                  <div class="programcode" id="calibre_link-1926"><div class="fixedline">Using Date Add =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATEADD('Dimension Date'[Date],-1,MONTH)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-23</span><p class="para3">A Period Comparison Calculated Measure Using DATEADD</p></div></div></div>
                </div><div class="para1" id="calibre_link-1927">
                  <div class="programcode" id="calibre_link-1928"><div class="fixedline">Using Previous Month =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PREVIOUSMONTH('Dimension Date'[Date])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-24</span><p class="para3">A <span id="calibre_link-1929">Period Comparison

</span> Calculated Measure Using PREVIOUSMONTH</p></div></div></div>
                </div><div class="para1" id="calibre_link-1930">All four calculated measures produce the same result, which you can see in Figure <span><a href="#calibre_link-312" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-19</a></span> as the columns on the right-hand side.<figure class="figure1" id="calibre_link-312"><div class="mediaobject" id="calibre_link-1931"><img alt="../images/456681_1_En_6_Chapter/456681_1_En_6_Fig19_HTML.jpg" src="images/000029.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-19</span><p class="simplepara1">Output of code from Listings <span class="calibre9"><a href="#calibre_link-310" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-21</a></span>&ndash;<span class="calibre9"><a href="#calibre_link-311" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-24</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-1932">For the February 2013 row, all four calculated measures return the value of 46,176, which happens to be the value of [Sum of Quantity] for January 2013. Aside from the fact that two of the measures also provide a value in the [Total] column, they all react to external slicers and filters.</p><p class="simplepara" id="calibre_link-1933">The [Using Filter] measure, is the most complex to write; however, it allows the most flexibility for customizing the filtering rules. It is easy to add and apply additional layers of explicit filtering in this instance. You can also configured the [Using Filter] measure to always look at a specific month rather than a relative month.</p><p class="simplepara" id="calibre_link-1934">The [Using Parallel Period] and [Using Date Add] versions take advantage of functions that don’t require the ALL or ALLSELECTED <span id="calibre_link-1935">functions

</span> to access out-of-context data. These functions also provide the ability to customize to suit other time periods. Perhaps the requirement is to always compare the current month with one that is always two months prior, or twelve months prior. Both the PARALLELPERIOD and DATEADD functions allow QUARTER and YEAR as options to return. You can also use them with positive numbers and negative numbers for the interval.</p><p class="simplepara" id="calibre_link-1936">Finally, the [Using Previous Month] measure provides the simplest format of the four measures but the least flexibility.</p><p class="simplepara" id="calibre_link-1937">In this case, all four calculated measures are evaluating an expression over a column in the ‘Fact Sale’ table, but they use a column in the ‘Dimension Date’ table to determine the date period. These use the rule determined by the active relationship between these tables, which in this case is based on the ‘Fact Sale’[Invoice Date key]. If the calculation should be grouped using a different column in ‘Fact Sale’, then you can add USERELATIONSHIP as additional parameter to the CALCULATE function. This allows a visual to show values that represent measures by delivery date if that is what you require.</p><p class="simplepara" id="calibre_link-1938">The ‘Dimension Date’[Date] column also features in each of these calculated measures. This column exists in a table where contiguous dates are guaranteed. Some of the time intelligence&ndash;based measures rely on this to work. If a date column from ‘Fact Sale’ is used, unexpected results may occur that may not initially be obvious.</p><p class="simplepara" id="calibre_link-1939">I analyze a breakdown of the individual performance of these measures in Chapter <span><a href="#calibre_link-160" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>8</span></a></span>.</p></section><section class="section" id="calibre_link-1940"><h5 class="heading2">Calculated <span id="calibre_link-1941">Columns and the&nbsp;EARLIER Function

</span>
</h5><p class="simplepara" id="calibre_link-1942">A handy function to use when you are writing calculated columns is the EARLIER function. This function provides a logical equivalent of a T-SQL self-join, which allows calculations to access data from rows other than the current row. This can include data from rows in related tables. The name of this function doesn’t clearly explain how it works; perhaps an alternative name might be more useful.</p><p class="simplepara" id="calibre_link-1943">To see how this function can be used, add a calculated column to the ‘Fact Sale’ table. This column should carry values that show, for each transaction, the date of the previous transaction for that customer. You can then use this calculation as the basis for determining the number of days since last purchase and it can then be averaged and plotted over time in a way that helps you understand changes to the frequency of visits by customers.</p><p class="simplepara" id="calibre_link-1944">The DAX calculated column is shown in Listing <span><a href="#calibre_link-313" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-25</a></span>.</p><div class="para1" id="calibre_link-313">
                  <div class="programcode" id="calibre_link-1945"><div class="fixedline">Last Purchase Date =&nbsp;&nbsp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LASTDATE(' Fact Sale'[Invoice Date Key]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Customer Key] = EARLIER('Fact Sale'[Customer Key])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; 'Fact Sale'[Invoice Date Key] &lt; EARLIER('Fact Sale'[Invoice Date Key])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-25</span><p class="para3">A Calculated Column Using EARLIER</p></div></div></div>
                </div><p class="simplepara" id="calibre_link-1946">When this calculation is added to the ‘Fact Sale’ table, a new column shows for each row the last time that specific customer was invoiced.</p><p class="simplepara" id="calibre_link-1947">The T-SQL equivalent is shown in Listing <span><a href="#calibre_link-314" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-26</a></span>.</p><div class="para1" id="calibre_link-314">
                  <div class="programcode" id="calibre_link-1948"><div class="bookfrontmatter"><div class="fixedline1">SELECT</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Current].[Sale Key],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Current].[Customer Key],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Current].[Invoice Date Key],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAX([EARLIER].[Invoice Date Key]) AS [Last Purchase Date]</div><div class="fixedline1">FROM Fact.Sale AS [Current]</div></div><div class="bookfrontmatter"><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LEFT JOIN FACT.Sale AS [<strong class="emphasistypebold">EARLIER</strong>]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ON&nbsp;&nbsp;[Earlier].[Customer Key] = [Current].[Customer Key]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AND [Earlier].[Invoice Date Key] &lt; [Current].[Invoice Date Key]</div></div><div class="bookfrontmatter"><div class="fixedline1">WHERE</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Current].[Customer Key] = 10</div></div><div class="bookfrontmatter"><div class="fixedline1">GROUP BY</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Current].[Sale Key],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Current].[Customer Key],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Current].[Invoice Date Key]</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-26</span><p class="para3">The T-SQL Equivalent of the DAX code in Listing <span><a href="#calibre_link-313" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-25</a></span>
</p></div></div></div>
                </div><p class="simplepara" id="calibre_link-1949">In order for each row in ‘Fact Sale’ to find the correct value to use as the last purchase date, it needs access to information that isn’t contained in its row. It needs a way to look at other rows from the table. The EARLIER <span id="calibre_link-1950">function

</span> allows a form of logical self-join that, when used in the FILTER function, allows the calculation to find the relevant rows.</p><p class="simplepara" id="calibre_link-1951">In this case, a single row in the ‘Fact Sale’ table first finds every row from the self-join table that is a match on [Customer Key]. This includes rows that have an [Invoice Date Key] after the value from the current row. Then the additional filter requirement that limits rows from the outer [Invoice Date Key] so they have a smaller value than the [Invoice Date Key] of the current row is applied.</p><p class="simplepara" id="calibre_link-1952">This can still produce multiple values so the LASTDATE function is used in the expression to pick a single date that happens to be the oldest of the remaining dates. You could also use the MAX function in place of LASTDATE in this case.</p><p class="simplepara" id="calibre_link-1953">This calculated column produces a value that is relevant for every row in the table, and because it is a calculated column rather than a calculated measure, it cannot be changed using report slicers or filters.</p><p class="simplepara" id="calibre_link-1954">The name of the EARLIER function implies that it may provide functionality that looks for a previous row based on ordering. This is not the case, and perhaps a name like OUTERTABLE would be more meaningful.</p><p class="simplepara" id="calibre_link-1955">Variables provide an alternative <span id="calibre_link-1956">notation

</span> for the EARLIER function. The calculated column in Listing <span><a href="#calibre_link-315" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-27</a></span> does the same job using VAR instead of EARLIER.</p><div class="para1" id="calibre_link-315">
                  <div class="programcode" id="calibre_link-1957"><div class="fixedline">Last Purchase Date =</div><div class="fixedline">
                      <strong class="emphasistypebold">VAR CustomerKey = 'Fact Sale'[Customer Key]</strong>
                    </div><div class="fixedline">
                      <strong class="emphasistypebold">VAR InvoiceDateKey = 'Fact Sale'[Invoice Date Key]</strong>
                    </div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LASTDATE('Fact Sale'[Invoice Date Key]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Customer Key] = <strong class="emphasistypebold">CustomerKey</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; 'Fact Sale'[Invoice Date Key] &lt; <strong class="emphasistypebold">InvoiceDateKey</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-27</span><p class="para3">A Calculated Column Using Variables in Place of EARLIER per Listing <span><a href="#calibre_link-313" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-25</a></span>
</p></div></div></div>
                </div><p class="simplepara" id="calibre_link-1958">The differences between this and the original version using EARLIER have been highlighted and they make the CALCULATE code a little easier to read.</p></section></section></section><section class="section" id="calibre_link-136"><h3 class="heading">
              <span id="calibre_link-1959">Filters and Calculated Tables

</span>
            </h3><p class="simplepara" id="calibre_link-1960">If you are using a version of DAX that allows the use of calculated tables, a simple use of the FILTER function can be to create copies of tables filtered to certain conditions. This might be useful for debugging, or if you need to solve performance challenges in your data model.</p><p class="simplepara" id="calibre_link-1961">If your dataset is large and you have some <span id="calibre_link-1962">calculations

</span> that you know will only ever run over a subset of the same data, then you can use DAX to create calculated tables from existing tables with explicit filters defined.</p><p class="simplepara" id="calibre_link-1963">An example of this might be if you need to create a smaller version of the ‘Dimension Customer’ table that only includes the top ten customers defined by the ‘Customer Rank’ calculation at Listing <span><a href="#calibre_link-308" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-19</a></span>.</p><p class="simplepara" id="calibre_link-1964">You might find this useful for scenarios in which you need a mixture of behavior for customer-based slicers in your report page.</p><p class="simplepara" id="calibre_link-1965">The DAX for the calculated table using the FILTER function is shown in Listing <span><a href="#calibre_link-316" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">6-28</a></span>.</p><div class="para1" id="calibre_link-316">
              <div class="programcode" id="calibre_link-1966"><div class="fixedline">Top 10 Customers =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Customer',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Customer'[Customer Rank] &lt;= 10</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 6-28</span><p class="para3">A Calculated Table Using FILTER</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-1967">If a new customer generates enough activity to jump into the top ten based on the rules defined in the calculated column, this calculated table will dynamically reflect that.</p></section></section></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-0">
<div id="calibre_link-1968" class="calibre2">
<div id="calibre_link-1969" class="calibre3"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1970"><div class="bookfrontmatter">©&nbsp;Philip Seamark&nbsp;2018</div><span class="pcalibre5"><span><span>Philip&nbsp;Seamark</span></span></span><span><span class="booktitle1" type="title" lang="en">Beginning DAX with Power BI</span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-3477-8_7" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">https://doi.org/10.1007/978-1-4842-3477-8_7</a></span></div></div><div class="maintitlesection"><h1 class="chaptertitle" lang="en">7.&nbsp;Dates</h1></div><div class="bookfrontmatter"><div class="bookfrontmatter"><span><span>Philip&nbsp;Seamark</span><sup class="calibre6"><a href="#calibre_link-1" class="pcalibre3 pcalibre4 pcalibre1 pcalibre2 pcalibre calibre7">1</a>&nbsp;<span class="contacticon"></span></sup></span></div><div class="bookfrontmatter"><div class="bookfrontmatter" id="calibre_link-1"><span class="affiliationnumber">(1)</span><div class="bookfrontmatter">UPPER HUTT, New Zealand</div></div><div class="clearboth">&nbsp;</div></div></div><div class="bookfrontmatter"><p class="para" id="calibre_link-1971">Most data models involve an element of date or time. I can’t remember the last time I worked on a data model that didn’t involve date values anywhere in the data.</p><p class="simplepara" id="calibre_link-1972">Business data invariably involves tables of transactions that include a <span id="calibre_link-1973">point-in-time value

</span>. Sometimes a row of data might carry multiple <span id="calibre_link-1974">DateTime fields

</span> to represent different actions relevant to that transaction. In the case of a customer order, there may be values to show the point in time of the original order, the pick-up date, the delivery date, and the invoice date. Downstream reporting requirements may need to group data by any of these DateTime values to provide a perspective relevant to different parts of the business.</p><p class="simplepara" id="calibre_link-1975">Sensor log data may include a field that identifies the sensor, another that shows the point in time of the reading (possibly down to a microsecond), and the value for the reading itself.</p><p class="simplepara" id="calibre_link-1976">Other types of data inevitably have at least one component that records a DateTime value that represents a point in time that is relevant for the other data in the row or batch.</p><div class="para4" id="calibre_link-1977">For reporting and analytics, data models often need to organize raw data using the following three types of questions:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-1978"><em class="emphasistypeitalic">What has happened:</em> For example, “Where have we come from?”</p></li><li class="calibre8"><p class="para2" id="calibre_link-1979"><em class="emphasistypeitalic">The current state:</em> For example, “Where are we now?”</p></li><li class="calibre8"><p class="para2" id="calibre_link-1980"><em class="emphasistypeitalic">The future:</em> For example, “Where are we going?”</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-1981">To answer each of the questions will require the ability to organize data by date or time. The first helps show values for facts and events that have taken place historically. This might illustrate patterns for a metric that ebb and flow historically. For instance, recent data can be trending up or down. Or cyclic or seasonal trends might appear and be useful when you are grouping, sorting, and plotting data over time. Being able to group and sort historic data into time buckets makes the job of understanding what has happened much easier.</p><p class="simplepara" id="calibre_link-1982">It can be useful to show the current state of data in short-term planning. To know how much money is currently available in an account, or how many items are currently in stock, or the current location of a vehicle or item can provide useful insights that help you when you are developing short-term plans.</p><p class="simplepara" id="calibre_link-1983">Finally, being able to forecast likely values for upcoming points in time satisfies a separate set of reporting requirements. Using forecast data to help accurately size and optimize future staff and stock levels can save an organization valuable time and resources. This information can lead to improvements in overall efficiency.</p><p class="simplepara" id="calibre_link-1984">All three requirements depend on date and time data in some shape or form. Organizing data into buckets and groups that are sorted chronologically makes the task of creating useful reports much easier.</p><section class="section" id="calibre_link-137"><h2 class="heading">
            <span id="calibre_link-1985">Date

</span>
          </h2><p class="simplepara" id="calibre_link-1986">In DAX, the term <em class="emphasistypeitalic">Date</em> often refers to individual days or groupings of days where there is no detail of hours, minutes, or seconds. Even if the underlying data carries a value that represents hours, minutes, or seconds, Date likely indicates the value without hours, minutes, or seconds. Dates can then be organized into many group types. Obvious groups are calendar year or month, or fiscal year or month. Other useful groupings can include weeks, or days of the week, month, or year. There are many ways to group Dates. Some are common to diverse types of data, whereas others can be highly unique to your organization.</p><p class="simplepara" id="calibre_link-1987">Plenty of meaningful <span id="calibre_link-1988">reports

</span> can be generated using data where the lowest granularty is Date. Even if the raw data happens to carry information regarding the point in time to the second a transaction happened, stripping out hours, minutes, and seconds to show the number of sales per day, month, or year, is often more useful than reports that represent the finer level of detail.</p></section><section class="section" id="calibre_link-138"><h2 class="heading">
            <span id="calibre_link-1989">Time

</span>
          </h2><p class="simplepara" id="calibre_link-1990">In data modelling, Time is often used to refer to a point in time that includes a value for the hour, minute, and second (sometimes millisecond). This may or may not have a value for year, month, and day. Sometimes a Time value can be perfectly meaningful with a value such as 10:37 am and it does not matter which day it belongs to. This value can be broken up into groupings such as 10 am, or Morning (or Late Morning), with data aggregated and used to show or compare.</p></section><section class="section" id="calibre_link-139"><h2 class="heading">
            <span id="calibre_link-1991">Date/Calendar Tables

</span>
          </h2><p class="simplepara" id="calibre_link-1992">A useful data structure for most data models is to include a table that carries a set of rows that covers a range of individual days. This table is often referred to as a Date or Calendar table. Sometimes these tables cover a very wide range of time. In other variations, the earliest date in this table may only be around the time of the earliest day found anywhere in your data model. These tables can also have rows that represent days a long way into the future.</p><p class="simplepara" id="calibre_link-1993">A key characteristic of a Date table is that each day is represented by a single row. There should be no duplicate rows for any individual day, and more importantly, there should be no gaps in the data. So, every day that occurs in between the dates that happen to be the oldest and newest values in the table should be represented by a single row in the table.</p><p class="simplepara" id="calibre_link-1994">Time tables have similar characteristics to Date tables. First, they have a row to represent the lowest level of granularty, starting with the lowest <span id="calibre_link-1995">value

</span> and ending with the highest value. The decision of what granularty should be the lowest for a Time table depends on your reporting requirements. The lowest level of granularty for a Time table can be hours or minutes (or lower). In the case of minutes, the table should have 1,440 rows that individually represent every minute between midnight and 11:59 pm. If the lowest granularty happens to be hour, only 24 rows are required.</p><p class="simplepara" id="calibre_link-1996">When creating a relationship between a Date (or Time) table and other tables in your data model, place the Date table on the one side of the relationship. The column involved in the relationship needs to be unique and can be any datatype. Ideally the column in the related table is the same datatype and only has values that can be exactly matched to values from the column in your Date table. It’s perfectly fine to have rows in your Date table that have no matching rows in the related table, but you have a problem if the mismatch is the other way around.</p><div class="formalpara" id="calibre_link-1997"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-1998">If the column used in a relationship from your Date table does not contain hours, minutes, or seconds, whereas the column from the related table does, many rows may not match. If this is the case, visuals that use fields from the Date table on an axis will report lower-than-expected values. No error will be generated, so this is potentially easy to miss.</p></div><p class="simplepara" id="calibre_link-1999">For Date tables, I typically like to use the column that uses the Date datatype, although integer values such as 20190101 work just as well. The main thing is to make sure that the values in each column involved in the relationship use the same data format.</p><p class="simplepara" id="calibre_link-2000">Date tables can have relationships to multiple tables at the same time. This allows selections made using a slicer (or filter) that uses the Date table to propagate through to all related tables.</p><div class="para1" id="calibre_link-2001">It’s possible to create multiple relationships between a Date table and another table in the model. As mentioned earlier, a sales table may have columns that represent various stages of an order. The order <span id="calibre_link-2002">date

</span>, delivery date, and invoice date may all have different values on the same row. Figure <span><a href="#calibre_link-2" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-1</a></span> shows two relationships between ‘Dimension Date’ and ‘Fact Sale’. The solid line between the two tables represents the active relationship. Calculations using data from tables will use this relationship by default. If a calculation needs to use rules from an inactive relationship, it can use the USERELATIONSHIP function as part of the calculation.<figure class="figure1" id="calibre_link-2"><div class="mediaobject" id="calibre_link-2003"><img alt="../images/456681_1_En_7_Chapter/456681_1_En_7_Fig1_HTML.jpg" src="images/000080.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-1</span><p class="simplepara1">Relationships between ‘Dimension Date’ and ‘Fact Sale’</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2004">In this diagram, the active relationship between ‘Dimension Date’ and ‘Fact Sale’ is based on the [Invoice Date Key], whereas the inactive relationship uses the [Delivery Date Key].</p><p class="simplepara" id="calibre_link-2005">The calculations shown in Listings <span><a href="#calibre_link-3" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-1</a></span> and <span><a href="#calibre_link-4" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-2</a></span> show how relationships can be used. The [Count of Invoice Rows] calculated measure only contains an expression about data from ‘Fact Sale’. When this measure is used in a visual that has fields from ‘Dimension Date’, query context will automatically filter groups of rows from ‘Fact Sale’ according to [Invoice Date Key].</p><p class="simplepara" id="calibre_link-2006">The [Count of Delivery Rows] measure uses the USERELATIONSHIP to override the default <span id="calibre_link-2007">behavior

</span> in order to generate a value that can be used to plot the number of rows where a delivery was made for a given group of ‘Dimension Date’ values.</p><div class="para1" id="calibre_link-3">
            <div class="programcode" id="calibre_link-2008"><div class="fixedline">Count of Invoice Rows =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS('Fact Sale')</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-1</span><p class="para3">Calculated Measure Using COUNTROWS</p></div></div></div>
          </div><div class="para1" id="calibre_link-4">
            <div class="programcode" id="calibre_link-2009"><div class="fixedline">Count of Delivery Rows =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">USERELATIONSHIP(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Dimension Date'[Date],</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Fact Sale'[Delivery Date Key]</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-2</span><p class="para3">Calculated Measure Using USERELATIONSHIP over Inactive Relationship</p></div></div></div>
          </div><div class="para1" id="calibre_link-2010">Figure&nbsp;<span><a href="#calibre_link-5" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-2</a></span> shows both these calculated measures over the first six calendar months of the WideWorldImportersDW dataset.<figure class="figure1" id="calibre_link-5"><div class="mediaobject" id="calibre_link-2011"><img alt="../images/456681_1_En_7_Chapter/456681_1_En_7_Fig2_HTML.jpg" src="images/000059.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-2</span><p class="simplepara1">A clustered column chart visual using code from Listings <span class="calibre9"><a href="#calibre_link-3" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-1</a></span> and <span class="calibre9"><a href="#calibre_link-4" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-2</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2012">Multiple Date tables are perfectly normal in a data model and allow you to use multiple date <span id="calibre_link-2013">ranges

</span> in a report. Some calculations can use selections made using a slicer with one Date table, whereas other calculations can produce values that consider selections made using a slicer over another Date table. These are not common, but you can use them to solve trickier reporting scenarios.</p><p class="simplepara" id="calibre_link-2014">The bare minimum requirement of a Date table is having a single column that represents a day. Usually additional columns in the Date table allow for the grouping and ordering of days. Obvious groupings are Year, Quarter, and Month. Some Date tables have dozens of additional columns to suit various date groupings.</p><p class="simplepara" id="calibre_link-2015">Later in this chapter I show you an example of how you can generate a Date table using DAX functions without using external data. Often an organization has an external dataset that you can import into your data model that already contains the rows and columns that will be useful. The query editor also provides you with the ability to generate data for a Date table that you can customized to suit your purposes.</p><section class="section" id="calibre_link-140"><h3 class="heading">
              <span id="calibre_link-2016">Automatic Date Tables

</span>
            </h3><p class="simplepara" id="calibre_link-2017">There is a feature in Power BI Desktop that automatically creates hidden Date tables for your model. If this is enabled, Power BI creates a hidden Date table for every column in every table that uses a Date/DateTime datatype (and is not already involved in one side of a relationship). If your model has five Date/DateTime columns, Power BI Desktop adds five hidden Date tables to the model. The intention of these hidden tables is to help provide an automatic layer of time intelligence to your model.</p><div class="para1" id="calibre_link-2018">If you import a table of data to your model and one of the columns in the table uses a Date datatype, Power BI adds a table with seven columns (Table <span><a href="#calibre_link-6" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-1</a></span>) that is populated with enough days to cover the data in your imported table, rounded out to the start and end of each year.<div class="table" id="calibre_link-6"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 7-1</span><p class="para3">The Structure and Sample Data from the Power BI Autocreated Date Table</p></div></div><table class="calibre10"><colgroup class="calibre11"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre12"><tr class="calibre13"><th class="calibre14"><p class="simplepara2">Date</p></th><th class="calibre14"><p class="simplepara2">Year</p></th><th class="calibre14"><p class="simplepara2">MonthNo</p></th><th class="calibre14"><p class="simplepara2">Month</p></th><th class="calibre14"><p class="simplepara2">QuarterNo</p></th><th class="calibre14"><p class="simplepara2">Quarter</p></th><th class="calibre14"><p class="simplepara2">Day</p></th></tr></thead><tbody class="calibre15"><tr class="calibre13"><td class="calibre16"><p class="simplepara2">2019-01-01</p></td><td class="calibre16"><p class="simplepara2">2019</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">January</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">Qtr 1</p></td><td class="calibre16"><p class="simplepara2">1</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">2019-01-03</p></td><td class="calibre16"><p class="simplepara2">2019</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">January</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">Qtr 1</p></td><td class="calibre16"><p class="simplepara2">2</p></td></tr><tr class="calibre13"><td class="calibre16"><p class="simplepara2">2019-01-03</p></td><td class="calibre16"><p class="simplepara2">2019</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">January</p></td><td class="calibre16"><p class="simplepara2">1</p></td><td class="calibre16"><p class="simplepara2">Qtr 1</p></td><td class="calibre16"><p class="simplepara2">3</p></td></tr><tr class="calibre17"><td class="calibre16"><p class="simplepara2">…</p></td><td class="calibre16"><p class="simplepara2">…</p></td><td class="calibre16"><p class="simplepara2">…</p></td><td class="calibre16"><p class="simplepara2">…</p></td><td class="calibre16"><p class="simplepara2">…</p></td><td class="calibre16"><p class="simplepara2">…</p></td><td class="calibre16"><p class="simplepara2">…</p></td></tr></tbody></table></div>
</div><p class="simplepara" id="calibre_link-2019">The structure of this table can be a good starting template for any Date table you design. The first column is unique and used in the relationship. The other columns simply provide grouping values. In Power <span id="calibre_link-2020">BI

</span>, by default, if the Date field from your table is dropped onto a visual, you have the option of using a hierarchy based on this automatic table or simply using the values from your actual table.</p><p class="simplepara" id="calibre_link-2021">This table quickly provides you with the ability to slice and dice by year, quarter, month, or day of month.</p><p class="simplepara" id="calibre_link-2022">If you have a good handle on using Date tables and have a quality dataset of your own to use, you can turn this feature off in the options and settings.</p></section></section><section class="section" id="calibre_link-141"><h2 class="heading">Quick Measures</h2><p class="simplepara" id="calibre_link-2023">In 2017, Power BI introduced a feature called <span id="calibre_link-2024">Quick Measures
</span>
<span id="calibre_link-2025">
              
              
            </span>. This feature allows report authors to quickly create calculated measures using a dialog box instead of writing DAX by hand. These measures cover a variety of common scenarios such as year-to-date totals and rolling averages. However, at the time of this writing, Quick Measures only uses data from an automatically provided Date table and cannot be used with columns from your own Date table. Once the Quick Measure has been created and you have the pattern for the calculation, you can then modify and tweak it to use other Date tables if you need to.</p><p class="simplepara" id="calibre_link-2026">If you examine the DAX code for a calculated measure created by the Quick Measures feature, you may notice a slightly different syntax is used to reference the column from the automatic Date table. The core expression in a Year-To-Date calculated measure created as a Quick Measures might look like this:</p><div class="para1" id="calibre_link-2027">
            <div class="programcode" id="calibre_link-2028"><div class="fixedline">TOTALYTD(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Table1'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Table1'[My Date Col]<strong class="emphasistypebold">.[Date]</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><p class="simplepara" id="calibre_link-2029">The highlighted part of the preceding <span id="calibre_link-2030">code
</span>
<span id="calibre_link-2031">
              
              
            </span> shows a special syntax that only works with automatic Date tables provided by Power BI. There are three parts to this syntax. The first is ‘Table1’, which is a reference to the table being used. The second is [My Date Col], which is a reference to the column to be used from Table1. The third is the [Date] column reference. This is the name of the column from the automatic Date table. Values from this column will be used by the SUM expression, rather than values from the [My Date Col] column, which might have gaps or other date-based issues.</p></section><section class="section" id="calibre_link-142"><h2 class="heading">
            <span id="calibre_link-2032">Sorting by Columns

</span>
          </h2><p class="simplepara" id="calibre_link-2033">The structure of the automatic Date table highlights another frequent problem you are apt to encounter when working with Date tables. This has to do with the default sort order of text-based columns. By default, Power BI sorts text-based columns alphabetically. The automatic table has two text-based columns: [Month] and [Quarter]. If either of these columns are used in a visual, the values are sorted alphabetically. In the case of the [Month] column, values like April, August, and December are at the start, while November, October, and September are at the end.</p><p class="simplepara" id="calibre_link-2034">This is a list of the calendar months using the default sort ordering:</p><div class="para1" id="calibre_link-2035">
            <div class="programcode" id="calibre_link-2036"><div class="fixedline">April</div><div class="fixedline">August</div><div class="fixedline">December</div><div class="fixedline">February</div><div class="fixedline">January</div><div class="fixedline">July</div><div class="fixedline">June</div><div class="fixedline">March</div><div class="fixedline">May</div><div class="fixedline">Novenber</div><div class="fixedline">October</div><div class="fixedline">September</div></div>
          </div><p class="simplepara" id="calibre_link-2037">It’s highly unlikely that you will ever need to deliberately organize data in this way, however. To override this behavior, use the Sort by Column feature, which allows a column to be sorted using another column. Typically, the nominated column is numeric, but it doesn’t have to be. A common pattern in a Date table is that for every text-based column in the table, a numeric equivalent column exists, purely for sorting the text column. The numeric column used for sorting can be used by multiple columns. For instance, you could use [MonthNo] to sort [Long Month Description] as well as [Sort Month Description]. You could also hide the [MonthNo] column to help tidy the model.</p><p class="simplepara" id="calibre_link-2038">The Sort by <span id="calibre_link-2039">Column

</span> feature is not limited to sorting dates; you can also use it to arrange values like Low, Medium, and High in an order that makes sense for your visuals. Not only does it sort the order of values used in visuals, it also controls the order they appear in legends and filters/slicers. You can also use it to control the order in which categories might appear in the bars of a stacked bar chart.</p><p class="simplepara" id="calibre_link-2040">It’s a useful feature, but it requires values in the [Sort By] column to have a many-to-one match with values in the column being sorted. For every row with a value of [January] in the [Month] column, only one distinct value can appear in any of the values used in the [Sort By] column. In this case, every value for “January” would be 1.</p></section><section class="section" id="calibre_link-143"><h2 class="heading">Including the Year When Using Month</h2><p class="simplepara" id="calibre_link-2041">When planning a Date table, consider including information about the year in any month label or identifier, particularly when the dataset covers more than a year. Rather than converting a date of January 1, 2019, into a value of [January], use [January 2019]. If you don’t, calculations may combine data associated with this date with January data from other years.</p><p class="simplepara" id="calibre_link-2042">A good format to use for the numeric version of a month is YYYYMM. This keeps data from the same months, but different years, apart, but it also provides a good column to sort by. Using two uppercase M characters adds a leading zero for months one through nine.</p></section><section class="section" id="calibre_link-144"><h2 class="heading">
            <span id="calibre_link-2043">Time Intelligence

</span>
          </h2><p class="simplepara" id="calibre_link-2044">A term used regularly when building data models in DAX is <em class="emphasistypeitalic">time intelligence</em>. This essentially refers to the concept of combining calculations/measures with the element of time. It is the ability to not only group and organize data into periods of time, but also to understand how each period sits in relation to any other grouping chronologically. Reporting requirements, such as showing comparisons between related time periods or building periods to date measures, are commonplace when you’re designing a data model that is intended to be used for reporting and analytics.</p><p class="simplepara" id="calibre_link-2045">Data grouped into categories such as Year, Month, and Day share similar characteristics to non-time-bound groupings of data. Calculations, such as count, sum, average, and so on, are just as meaningful to time-based groupings as they are to non-time-based groups. However, a key difference between time-based groups and non-time-based (such as Size, Color, and Weight), is that calculations using time-based groups often need to reflect and show how data in your model sits in relation to other data in your model with respect to time.</p><p class="simplepara" id="calibre_link-2046">When you look at this in more detail, counts, sums, and other calculations that are sliced by the product colors Red, Green, Yellow, and Blue, often have no strong relationship with each other. You might display them in any order on a visual and just as happily compare values between Red and Blue as you would Green and Yellow.</p><p class="simplepara" id="calibre_link-2047">With dates however, it is more likely that you’ll need to keep categories for Jan 2019, Feb 2019, Mar 2019, and Apr 2019 in sequential order to be able to compare them. Calculations that produce values for Feb 2019 data are more likely to be compared with calculations based on the previous or preceding months. It is still possible to organize DateTime categories in any order, as you might do with the example of using categories based on color, but this is not likely to be a common requirement.</p><p class="simplepara" id="calibre_link-2048">An additional element of time-based reporting is that it can be just as important to show periods where you have no data as it can be to show time <span id="calibre_link-2049">periods

</span> with data. When you’re grouping by color using data that has no values for red, omitting a placeholder for red on the axis of a visual can be quite normal. However, if you have no data for a day, or a date period, you may still want to represent this fact by making sure there is a placeholder for the period on the axis.</p><p class="simplepara" id="calibre_link-2050">DAX provides a series of time-intelligence functions that are aware of chronological relationships and how they relate to each other. You can add these functions to your calculations that take care of common time-based tasks through the minimal use of DAX.</p></section><section class="section" id="calibre_link-145"><h2 class="heading">
            <span id="calibre_link-2051">Year to Date

</span>
          </h2><p class="simplepara" id="calibre_link-2052">If you need to show the cumulative value of a measure over time since the start of each calendar year, there are several ways you can write this type of calculation. One approach is to create a calculated measure that uses CALCULATE and ALL or ALLSELECTED to clear implicit filters; this allows SUM to access data outside the current query context in order to produce a value since the start of the year.</p><p class="simplepara" id="calibre_link-2053">Another option is to use a calculation to meet this requirement that you can build using a time-intelligence function. With the TOTALYTD function, you can add a calculated measure (Listing <span><a href="#calibre_link-7" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-3</a></span>) to your data model that represents a cumulative value of your expression over a calendar year. Figure <span><a href="#calibre_link-8" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-3</a></span> shows the output of this calculation.</p><div class="para1" id="calibre_link-7">
            <div class="programcode" id="calibre_link-2054"><div class="fixedline">My Year to Date (Date Table) =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">TOTALYTD (</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-3</span><p class="para3">Year-to-<span id="calibre_link-2055">Date

</span> Calculated Measure Using TOTALYTD</p></div></div></div>
            <figure class="figure1" id="calibre_link-8"><div class="mediaobject" id="calibre_link-2056"><img alt="../images/456681_1_En_7_Chapter/456681_1_En_7_Fig3_HTML.jpg" src="images/000001.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-3</span><p class="simplepara1">Output of the code from Listing <span class="calibre9"><a href="#calibre_link-9" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-3</a></span> resetting each calendar year</p></div></figcaption></figure>
          </div><p class="simplepara" id="calibre_link-2057">The chart in Figure <span><a href="#calibre_link-8" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-3</a></span> shows a bar for each calendar month over a period of two years. Each calculation includes a value that is a sum of the current month and all months since the start of the calendar year. The cumulative values reset each year.</p><p class="simplepara" id="calibre_link-2058">The function requires only two parameters. The first is the expression to be used for a calculation. The SUM function in this calculation uses data from the ‘Fact Sale’[Quantity] column. You could also use another calculated measure in place of a DAX expression.</p><p class="simplepara" id="calibre_link-2059">The second parameter needs to be a reference to a date column.</p><p class="simplepara" id="calibre_link-2060">The example doesn’t use a date column from the same table as the <span id="calibre_link-2061">column

</span> passed to the SUM function; instead, it uses a value from a table that conforms to the rules of a classic date table (one row per day with no gaps or overlaps). In this case, the data is automatically grouped by [Invoice Date Key] because this is the column used in an active relationship. To override the default relationship, it’s possible to pass a filter an additional rule. This might take the form of using USERELATIONSHIP or another explicit filter that you would like to apply over the top of the DAX expression for extra flexibility.</p><p class="simplepara" id="calibre_link-2062">The CALCULATE function is not required, nor has there been any use of functions to clear implicit filters. The filter context is being overridden automatically by the TOTALYTD function, allowing the SUM function to see all data it needs to produce a cumulative value.</p><p class="simplepara" id="calibre_link-2063">When this calculated measure is used in a visual that uses other fields from the ‘Dimension Date’ table, not only does the measure show the appropriately accumulated value for each point in time, it resets back to zero for each year. There is no code in the calculation to instruct the function on how to order the data. This is taken care of automatically because this is a time-intelligence function.</p><div class="formalpara" id="calibre_link-2064"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-2065">Always note which table any date field you use for the axis on your visual comes from. Using date columns from different tables has an impact on the implicit filters passed to your calculated measures and therefore can help you get the right (or wrong) result.</p></div><p class="simplepara" id="calibre_link-2066">If you want to use this function but have data to accumulate from a month other than January, you can add an optional parameter. This makes the function useful for fiscal periods that don’t start on January 1 each year. If your organization has a fiscal year that ends on the last day of each June, add the value “6/30” as a third parameter. This tells the function to use the 30th day of the 6th month to reset the cumulative measure.</p><div class="para1" id="calibre_link-2067">
            <div class="programcode" id="calibre_link-2068"><div class="fixedline">My Year to Date (Date Table) =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;TOTALYTD (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"6/30"</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><p class="simplepara" id="calibre_link-2069">Some functions that are similar TOTALYTD are TOTALMTD and TOTALQTD. These allow you to add calculations that help provide Month-to-<span id="calibre_link-2070">Date

</span> and Quarter-to-Date totals to your data model.</p><section class="section" id="calibre_link-146"><h3 class="heading">Period Comparisons</h3><p class="simplepara" id="calibre_link-2071">You can use other time-intelligence functions to help make <span id="calibre_link-2072">period comparison calculations

</span> easier. On a report, it is often helpful to show the value for the same metric for a month immediately prior, or perhaps to show the same calendar month from the previous year next to the value for the current month. These can be extended show values based on the difference&mdash;for example, this month is 2 percent up from the previous month or 5 percent down from the same time last year.</p><p class="simplepara" id="calibre_link-2073">Like with the TOTALYTD example, it’s possible to build a period comparison calculation that uses the CALCULATE function along with explicit filtering rules, but using a time-intelligence function can make this task easier.</p><p class="simplepara" id="calibre_link-2074">The calculated measure in Listing <span><a href="#calibre_link-10" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-4</a></span> generates a value that shows the value of an expression for the previous month.</p><div class="para1" id="calibre_link-10">
              <div class="programcode" id="calibre_link-2075"><div class="fixedline">QTY for Previous Month =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity]<strong class="emphasistypebold">,</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">PREVIOUSMONTH('Dimension Date'[Date])</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-4</span><p class="para3">Previous Month Calculated Measure Using PREVIOUSMONTH</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2076">The calculated measure passes the PREVIOUSMONTH function as a filter to the CALCULATE <span id="calibre_link-2077">function

</span> to control the data used by the [Sum of Quantity] measure. The PREVIOUSMONTH function returns a table of dates that represents a list of values for each day of the previous calendar month. The function handles any quirks that occur due to consecutive months having a different number of days.</p><p class="simplepara" id="calibre_link-2078">You can now add a simple calculated measure (Listing <span><a href="#calibre_link-11" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-5</a></span>) to show a percentage difference between the current and previous month.</p><div class="para1" id="calibre_link-11">
              <div class="programcode" id="calibre_link-2079"><div class="fixedline">QTY % Diff to Prev Month =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity] - [QTY for Previous Month],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[QTY for Previous Month]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-5</span><p class="para3">Percentage Difference Calculated Measure Incorporating the Code in Listing <span><a href="#calibre_link-10" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-4</a></span>
</p></div></div></div>
            </div><div class="para1" id="calibre_link-2080">Figure&nbsp;<span><a href="#calibre_link-12" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-4</a></span> shows these measures added to a table visual in Power BI using the Calendar month field from the ‘Date Dimension’ table.<figure class="figure1" id="calibre_link-12"><div class="mediaobject" id="calibre_link-2081"><img alt="../images/456681_1_En_7_Chapter/456681_1_En_7_Fig4_HTML.jpg" src="images/000015.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-4</span><p class="simplepara1">Output of code in Listings <span class="calibre9"><a href="#calibre_link-10" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-4</a></span> and <span class="calibre9"><a href="#calibre_link-11" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-5</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2082">The [Sum of Quantity] <span id="calibre_link-2083">column

</span> shows a value relevant to the calendar month for that row. The [QTY for Previous Month] column is a calculation that uses the PREVIOUSMONTH function, whereas the [QTY % Diff to Prev Month] column shows the variation using a percentage.</p><p class="simplepara" id="calibre_link-9">The [QTY % Diff to Previous Month] calculation could incorporate the logic for both steps in one using variables as is shown in Listing <span><a href="#calibre_link-13" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-6</a></span>.</p><div class="para1" id="calibre_link-13">
              <div class="programcode" id="calibre_link-2084"><div class="fixedline">VAR PrevMonth =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PREVIOUSMONTH('Dimension Date'[Date])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity] - <strong class="emphasistypebold">PrevMonth,</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">PrevMonth</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-6</span><p class="para3">Condensed Version of Listings <span><a href="#calibre_link-10" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-4</a></span> and <span><a href="#calibre_link-11" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-5</a></span> Using Variables</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2085">This version stores the result of the CALCULATE function that is using PREVIOUSMONTH as a filter in the PrevMonth variable, which is then used multiple times in the final RETURN statement. Using the output of a variable multiple times can help improve performance.</p><div class="para1" id="calibre_link-2086">These are other-time intelligence functions that can be used as filters with CALCULATE:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-2087">PREVIOUSDAY/NEXTDAY</p></li><li class="calibre8"><p class="para2" id="calibre_link-2088">PREVIOUSQUARTER/NEXTQUARTER</p></li><li class="calibre8"><p class="para2" id="calibre_link-2089">PREVIOUSYEAR/NEXTYEAR</p></li><li class="calibre8"><p class="para2" id="calibre_link-2090">SAMEPERIODLASTYEAR</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-2091">Each of these functions return a table of dates that can be used as a filter parameter for the CALCULATE <span id="calibre_link-2092">function

</span>. Substituting PREVIOUSMONTH with SAMEPERIODLASTYEAR produces a value from the expression that is filtered to the same calendar month for the previous year.</p><p class="simplepara" id="calibre_link-2093">The DATEADD and PARALLELPERIOD functions also return a table of dates that can be used as a filter in a CALCULATE function. These provide more flexibility than functions such as PREVIOUSMONTH in that they can be configured to jump multiple steps forward or backward to help achieve other reporting requirements.</p><p class="simplepara" id="calibre_link-2094">The calculations in Listings <span><a href="#calibre_link-14" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-7</a></span> and <span><a href="#calibre_link-15" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-8</a></span> use the DATEADD and PARALLELPERIOD functions to produce a value using data going back three months. Both functions have the same parameter signature.</p><div class="para1" id="calibre_link-14">
              <div class="programcode" id="calibre_link-2095"><div class="fixedline">QTY (Month -3) =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">PARALLELPERIOD(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-3</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,MONTH)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-7</span><p class="para3">Calculated Measure Using PARALLELPERIOD to Look Back Three Months</p></div></div></div>
            </div><div class="para1" id="calibre_link-15">
              <div class="programcode" id="calibre_link-2096"><div class="fixedline">QTY (Month -3) =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">DATEADD(</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-3</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,MONTH)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-8</span><p class="para3">Calculated Measure Using <span id="calibre_link-2097">DATEADD

</span> to Look Back Three Months</p></div></div></div>
            </div></section></section><section class="section" id="calibre_link-147"><h2 class="heading">The <span id="calibre_link-2098">Rolling Average

</span>
</h2><p class="simplepara" id="calibre_link-2099">Another common requirement is to show calculations that use data spanning a period relative to the current value, such as a rolling sum/average of the previous <em class="emphasistypeitalic">n</em> number of days, weeks, or months. These measures help provide a smoother view of trends and can eliminate some of the fluctuation noise created by more granular time periods.</p><p class="simplepara" id="calibre_link-2100">For these types of measures to work, the calculations need to override the default filter context with a new filter that is eventually used by the core DAX expression. The objective is to create a table of days that covers the period intended for the calculation.</p><p class="simplepara" id="calibre_link-2101">There are multiple ways to approach this in DAX. Here are a couple of suggestions for creating a calculated measure that shows the rolling average of a daily sum over ‘Fact Sale’[Quantity].</p><p class="simplepara" id="calibre_link-2102">The first version is Listing <span><a href="#calibre_link-16" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-9</a></span>, which looks back seven days.</p><div class="para1" id="calibre_link-16">
            <div class="programcode" id="calibre_link-2103"><div class="bookfrontmatter"><div class="fixedline1">Avg Qty Last 7 Days (Date Table) =</div><div class="fixedline1">VAR DateFilter =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;DATESINPERIOD(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAX('Dimension Date'[Date]),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-7,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DAY</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR RollingSUM =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateFilter</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline1">RETURN</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE( RollingSUM, COUNTROWS( DateFilter) )</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-9</span><p class="para3">Rolling Average Calculated Measure Looking Back Seven Days</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2104">The DateFilter variable uses the DATESINPERIOD function to create a table that contains the previous seven days including the current day. The MAX <span id="calibre_link-2105">function

</span> helps to select a single date from what might be many days depending on the context of the calculation when it is executed.</p><p class="simplepara" id="calibre_link-2106">If the calculation is being used on a visual that uses ‘Dimension Date’[Date] on an axis, row, or column header, the MAX function only ever needs to pick from a single date. However, if the calculation is being used on a visual that uses the ‘Dimension Date’[Calendar Month] on an axis, row, or column header, there will be multiple days for each month. The MAX function simply selects one of the dates, which in this case, is the last day of each calendar month. You could use other functions, such as MIN, LASTDATE, and FIRSTDATE, here in place of MAX.</p><p class="simplepara" id="calibre_link-2107">The table returned by the DATESINPERIOD used in this calculation should never carry more than seven rows.</p><p class="simplepara" id="calibre_link-2108">The next step performs a sum over data in the ‘Fact Sale’ table that is filtered using the dates stored in the DateFilter variable. Finally, the RETURN statement uses the DIVIDE function to output the final value. The COUNTROWS function uses the number of rows in the DateFilter variable to ensure the six days at the beginning return appropriate averages, rather than simply dividing by seven. However, the COUNTROWS function does not account for days that have no values. The preceding version simply sums all the <span id="calibre_link-2109">data

</span> it sees in a seven-day period and divides that by seven. In this dataset, there are no invoices generated on Sundays, so a more desirable approach could be to divide the sum of quantity for the period by the number of days with data.</p><p class="simplepara" id="calibre_link-2110">The final RETURN statement for the previous example can be enhanced with an additional step to filter days with no data (Listing <span><a href="#calibre_link-17" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-10</a></span>).</p><div class="para1" id="calibre_link-17">
            <div class="programcode" id="calibre_link-2111"><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RollingSUM,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">FILTER(DateFilter,</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">[Sum of Quantity]&gt;0)</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-10</span><p class="para3">Updated RETURN Statement Using FILTER for Code in Listing <span><a href="#calibre_link-16" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-9</a></span>
</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2112">Or you can use the AVERAGEX function to apply the same effect (Listing <span><a href="#calibre_link-18" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-11</a></span>).</p><div class="para1" id="calibre_link-18">
            <div class="programcode" id="calibre_link-2113"><div class="fixedline">Avg Qty Last 7 Days (Date Table) =</div><div class="fixedline">VAR DateFilter =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DATESINPERIOD(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAX('Dimension Date'[Date]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-7,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DAY</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;AVERAGEX(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateFilter,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-11</span><p class="para3">Alternative Version of Listing <span><a href="#calibre_link-16" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-9</a></span> Using AVERAGEX</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2114">In this case, the AVERAGEX function is an iterator, so the DateFilter variable is passed as the first argument. Remember this variable only contains a single <span id="calibre_link-2115">column

</span> table of dates with just seven rows. The AVERAGEX function considers that some days have no data and only divides the sum by a divisor appropriate to the underlying data.</p><p class="simplepara" id="calibre_link-2116">Another variation of this uses the DATESBETWEEN function to generate a list of dates to be used to override the calculation (Listing <span><a href="#calibre_link-19" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-12</a></span>).</p><div class="para1" id="calibre_link-19">
            <div class="programcode" id="calibre_link-2117"><div class="fixedline">Avg Qty Last 7 Days (Date Table) =</div><div class="fixedline">VAR DateFilter =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DATESBETWEEN(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LASTDATE('Dimension Date'[Date])-6,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LASTDATE('Dimension Date'[Date])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;AVERAGEX(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateFilter,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Quantity]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-12</span><p class="para3">Alternative Version of Listing <span><a href="#calibre_link-18" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-11</a></span> Using DATESBETWEEN</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2118">The DATESBETWEEN function differs from DATESINPERIOD in that it uses two fixed dates to determine the date range rather than using a single date with a relative offset. The DATESINPERIOD function has the advantage of being able to specify offset periods such as year, quarter, and month as well as day.</p></section><section class="section" id="calibre_link-148"><h2 class="heading">Rolling Your Own Table</h2><p class="simplepara" id="calibre_link-2119">Having a dedicated, centralized date table in your data model is not only useful for filtering and grouping data across multiple tables in unison, but it can also help you provide a stable set of dates for time intelligence functions to make use of.</p><p class="simplepara" id="calibre_link-2120">There are multiple ways to add a date table to a data model. You can import date data from an existing data source that already carries one row per day for a date range that covers all the data in your model, or you can generate your own date table using the query editor or DAX.</p><p class="simplepara" id="calibre_link-2121">This section shows you how to build a data table from scratch using DAX functions without needing to rely on an external data source. You do not need to have a version of DAX that supports calculated tables.</p><p class="simplepara" id="calibre_link-2122">The starting point is a DAX function that can generate a table with the appropriate number of rows. The two functions that help with this are CALENDAR and CALENDARAUTO. Both generate a contiguous series of dates in a single column table.</p><section class="section" id="calibre_link-149"><h3 class="heading">CALENDAR</h3><p class="simplepara" id="calibre_link-2123">You can use the <span id="calibre_link-2124">CALENDAR function

</span> when you know the start and end dates for the date range required for your model.</p><p class="simplepara" id="calibre_link-2125">The syntax for this function is</p><div class="para1" id="calibre_link-2126">
              <div class="programcode" id="calibre_link-2127"><div class="fixedline">CALENDAR ( &lt;startDate&gt;, &lt;endDate&gt; )</div></div>
            </div><p class="simplepara" id="calibre_link-2128">Some suggested variations for using this function are as follows:</p><div class="para1" id="calibre_link-2129">
              <div class="programcode" id="calibre_link-2130"><div class="bookfrontmatter"><div class="fixedline1">Dates = CALENDAR("2016-01-01", "2019-12-31" )</div></div><div class="bookfrontmatter"><div class="fixedline1">Dates = CALENDAR(DATE(2016,1,1), TODAY())</div></div><div class="bookfrontmatter"><div class="fixedline1">Dates = CALENDAR(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FIRSTDATE('Fact Sale'[Invoice Date Key]),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LASTDATE('Fact Sale'[Invoice Date Key])</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">Dates = CALENDAR(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STARTOFYEAR( 'Fact Sale'[Invoice Date Key] ),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ENDOFYEAR( 'Fact Sale'[Invoice Date Key] )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div></div>
            </div><p class="simplepara" id="calibre_link-2131">The output for each of these statements is a table with a single column called [Date] that you can use as the basis for adding columns using additional DAX <span id="calibre_link-2132">expressions

</span>.</p></section><section class="section" id="calibre_link-150"><h3 class="heading">CALENDARAUTO</h3><p class="simplepara" id="calibre_link-2133">A handy alternative to the <span id="calibre_link-2134">CALENDAR function

</span> is CALENDARAUTO. The CALENDARAUTO function does not require parameters. To generate its own start and end dates, it looks at existing tables in the data model for columns that use Date or DateTime datatypes. If it finds them, it finds the newest and oldest values before rounding out to the start and end of each calendar year.</p><p class="simplepara" id="calibre_link-2135">Any calculation using CALENDARAUTO is re-executed each time data is refreshed, so if new data arrives in your data model that falls outside the existing date boundary, rows in a table using this function are added automatically.</p></section><section class="section" id="calibre_link-151"><h3 class="heading">Expanding the Date Table</h3><p class="simplepara" id="calibre_link-2136">The first columns I normally add to a date table provide the ability to slice and dice by calendar month. You can add these using the <span id="calibre_link-2137">ADDCOLUMNS function

</span>, which adds columns to a base table, each as a pair of parameters that specifies the name of the new column along with the DAX expression to be used to generate the value for each row of that column (Listing <span><a href="#calibre_link-20" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-13</a></span>).</p><div class="para1" id="calibre_link-20">
              <div class="programcode" id="calibre_link-2138"><div class="fixedline">Dates =</div><div class="fixedline">VAR BaseTable = CALENDAR("2016-01-01",TODAY())</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BaseTable,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"MonthID", FORMAT([Date],"YYYYMM"),</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"Calendar Month", FORMAT([Date],"MMMM YY")</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-13</span><p class="para3">Calculated Table Using <span id="calibre_link-2139">ADDCOLUMNS

</span> to Build on CALENDAR</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2140">Let’s call this calculated table Dates. The CALENDAR function is used to generate a single column table that has a contiguous sequence of dates beginning on January 1, 2016, that run to the current day and is assigned to the BaseTable variable. This table grows by one row each day.</p><p class="simplepara" id="calibre_link-2141">Two columns named MonthID and Calendar Month are added using the ADDCOLUMNS function. The MonthID column is added so the text-based Calendar Month column can be sorted chronologically. Both columns use the FORMAT function to convert the intrinsic date value stored in the [Date] column to a value useful for each column.</p><p class="simplepara" id="calibre_link-2142">The <span id="calibre_link-2143">FORMAT function

</span> converts numbers or dates into text values. Characters, symbols, and other text can be added as part of the conversion. The FORMAT function can be used with format string rules to help enforce the number of decimals to be displayed.</p><p class="simplepara" id="calibre_link-2144">FORMAT can also convert date values to text using predefined or custom formatting rules. In this case, both columns added to the Date table opt for custom strings. Uppercase M characters represent the underlying month. Two M characters return a two-character number padded with a leading zero. A date that falls in January returns “01”, whereas a date that falls in December returns “12”. The uppercase Y represents a year component. Four Y characters signify that the full year including the century should be generated as text. Two Y characters return the two least significant values from the year, so 1918 and 2018 both return “18”.</p><p class="simplepara" id="calibre_link-2145">The <span id="calibre_link-2146">FORMAT function

</span> used for the MonthID column uses a format string of “YYYYMM”. When this format string is applied to a date such as the January 5, 2019, the output is “201901”. The output for July 4, 2019, is “201907”. The text data in this column is now sorted chronologically for date. This means that “202008” always appears later than “199910”, so you can use this column to control the sort order of the Calendar Month column.</p><p class="simplepara" id="calibre_link-2147">The format string used by the FORMAT function for Calendar Month is “MMMM YY”. Four uppercase M characters signify that the month name should be used in full. The space character used in the format string also flows through to the final output. Hyphens and other dashes or separators can also be used here. Finally, the two uppercase Y characters are used to ensure that data across years is not grouped together. The output of this function for January 5, 2019, would be “January 19”, whereas July 4, 2019, would be “July 19”.</p><div class="formalpara" id="calibre_link-2148"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-2149">When using text to represent a calendar month, it is good practice to include extra text to also uniquely identify the year. Otherwise you risk having January 2019 data merged with January 2020 in the same calculation.</p></div><p class="simplepara" id="calibre_link-2150">Once the calculated table has been added to the model, the Calendar Month column can be set to use the MonthID as its Sort By column. You can hide the MonthID column and create relationships between this table and other tables in the model.</p><p class="simplepara" id="calibre_link-2151">An alternative version of the <span id="calibre_link-2152">MonthID column

</span> involves using a DateTime value rather than an integer datatype (Listing <span><a href="#calibre_link-21" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-14</a></span>). When DateTime fields are used on the axis of many of the visuals in Power BI, labels are dynamically scaled so no scrolling is required. This also allows the column to use date-based functions in additional calculations. The code shown in Listing <span><a href="#calibre_link-21" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-14</a></span> ensures every value for the “Calendar Month” column still only has one unique value rows for the MonthID column. The [Date] value for the “Month” column is converted to be the first day for each month using the DATE, YEAR, and MONTH functions.</p><div class="para1" id="calibre_link-21">
              <div class="programcode" id="calibre_link-2153"><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BaseTable,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"Month", DATE(YEAR([Date]),MONTH([Date]),1),</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Calendar Month", FORMAT([Date],"MMMM YY")</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-14</span><p class="para3">Using a [Date] Value in Place of Text for the Code in Listing <span><a href="#calibre_link-20" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-13</a></span>
</p></div></div></div>
            </div></section><section class="section" id="calibre_link-152"><h3 class="heading">
              <span id="calibre_link-2154">Adding the Year

</span>
            </h3><p class="simplepara" id="calibre_link-2155">To add a column for the calendar year, use the parameters with the ADDCOLUMNS function (Listing <span><a href="#calibre_link-22" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-15</a></span>).</p><div class="para1" id="calibre_link-22">
              <div class="programcode" id="calibre_link-2156"><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BaseTable,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Month", DATE(YEAR([Date]),MONTH([Date]),1),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Calendar Month", FORMAT([Date],"MMMM YY"),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"Year", FORMAT( [Date], "YYYY" )</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-15</span><p class="para3">Adding a Year Column to the Calculated Table</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2157">This adds a text column called “Year” that is already sorted chronologically so it has no need for another column to be generated to fix sorting issues. I have come across an interesting requirement to force the sorting of years to be in reverse. This was to control the order in which values in this column appear when they are used as a column header on a matrix. The requirement was to show later years on the left with older values on the right. To solve this issue, you can add the following helper column to the model:</p><div class="para1" id="calibre_link-2158">
              <div class="programcode" id="calibre_link-2159"><div class="fixedline">"YearSortID-", 0 - YEAR( [Date] )</div></div>
            </div><p class="simplepara" id="calibre_link-2160">This produces a negative version of the year, meaning that when a Year <span id="calibre_link-2161">column

</span> is sorted by this column, the order is flipped so 2019 appears after 2020.</p></section><section class="section" id="calibre_link-153"><h3 class="heading">Fiscal Year</h3><p class="simplepara" id="calibre_link-2162">To add a column to carry a value for the <span id="calibre_link-2163">fiscal year

</span>, one approach is to add the expression in Listing <span><a href="#calibre_link-23" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-16</a></span> to the ADDCOLUMNS statement.</p><div class="para1" id="calibre_link-23">
              <div class="programcode" id="calibre_link-2164"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Fiscal Year",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR FY_Month_Starts = 6</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN YEAR([Date]) - IF(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MONTH([Date]) &lt; FY_Month_Starts,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Then Add a 1 to the year --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Else leave as is&nbsp;&nbsp;--</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-16</span><p class="para3">Name and Expression to Add a Column Called “Fiscal Year” to the ADDCOLUMNS Function</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2165">This statement creates a column named “Fiscal Year”. The expression declares a variable called FY_Month_Starts, which is assigned an integer between 2 and 12. A fiscal year starting in June would use 6. The RETURN statement begins with a value for the current calendar year and then subtracts a year depending on the logic in the IF statement.</p><p class="simplepara" id="calibre_link-2166">This calculation outputs the same value for both Fiscal and Calendar year for dates after June 1. Dates between January 1 and the end of May would automatically retain the value for the previous year.</p><p class="simplepara" id="calibre_link-2167">To create a column that shows a month number based on a fiscal calendar, you can add the calculation in Listing <span><a href="#calibre_link-24" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-17</a></span>.</p><div class="para1" id="calibre_link-24">
              <div class="programcode" id="calibre_link-2168"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Fiscal Month No",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR FY_Month_Starts = 6</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN MOD(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MONTH([Date]) - FY_Month_Starts,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)+1</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-17</span><p class="para3">Name and Expression to Add a Column Called “Fiscal Month No” to the ADDCOLUMNS <span id="calibre_link-2169">Function

</span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2170">The value assigned to the FY_Month_Starts variable represents the calendar month number to use as a starting point. This calculation produces a value of 1 for June, 2 for July, 3 for August, through to 12 for May.</p></section><section class="section" id="calibre_link-154"><h3 class="heading">
              <span id="calibre_link-2171">Days from Today

</span>
            </h3><p class="simplepara" id="calibre_link-2172">A handy column to have in any date table is one that carries a number, negative or positive, that shows how many days each row is in relation to the current day. This column can then be used to provide date-based filters that are relative and dynamic. A suggested calculation for this is</p><div class="para1" id="calibre_link-2173">
              <div class="programcode" id="calibre_link-2174"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Days from Today",INT( [Date] - TODAY())</div></div>
            </div><p class="simplepara" id="calibre_link-2175">This column carries a value of 0 for the row that has a value in the [Date] column that matches the current day. Values in rows that have future values have positive numbers, whereas date values in the past have negative numbers.</p><p class="simplepara" id="calibre_link-2176">To use this column to enforce a dynamic view of the last 14 days of data, add this field to a Report, Page, or Visual filter and assign an advanced rule saying it should only show values between &ndash;14 and 0. Once set, the filter setting can be left alone, and the <span id="calibre_link-2177">report

</span> always shows the most recent 14 days.</p></section><section class="section" id="calibre_link-155"><h3 class="heading">
              <span id="calibre_link-2178">Weekly Buckets

</span>
            </h3><p class="simplepara" id="calibre_link-2179">Weeks can be tricky columns to work with and generally they don’t play nicely with other date-based groups such as months and years. It’s common for weeks to be split across the boundaries of month or year buckets so often that they need to be used in isolation from other types of date groupings.</p><p class="simplepara" id="calibre_link-2180">Weeks are still a useful way to organized dates in a model, however. An effective way to do this is to group batches of seven days using a value that is either the first or last date of the week. The WEEKDAY function is useful to help achieve this because it assigns each [Date] a value between 1 and 7 depending on which day of the week it is. The calculation for a week starting column might look like this:</p><div class="para1" id="calibre_link-2181">
              <div class="programcode" id="calibre_link-2182"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Week Starting Sunday", [Date] -&nbsp;&nbsp;( WEEKDAY( [Date] ) -1 )</div></div>
            </div><p class="simplepara" id="calibre_link-2183">By default, the WEEKDAY function assumes a week begins on a Sunday, so it assigns the value of 1 to any date that happens to be a Sunday, 2 to Monday, 3 to Tuesday, and so on until Saturday which is assigned 7. The calculation then offsets each value by 1 so it becomes zero based. The new value is then subtracted from [Dates], which now aligns all dates to the closest Sunday they follow.</p><p class="simplepara" id="calibre_link-2184">A calculation that uses Monday instead of Sunday as the basis for a week starting column is the following:</p><div class="para1" id="calibre_link-2185">
              <div class="programcode" id="calibre_link-2186"><div class="fixedline">"Week Starting Monday", [Date] -&nbsp;&nbsp;WEEKDAY( [Date], 3 )</div></div>
            </div><p class="simplepara" id="calibre_link-2187">The WEEKDAY function now has a second parameter that instructs the function to return a value between 0 and 6 with Monday being 0, Tuesday being 1, Wednesday being 2, and so on through to Sunday which is 6. This output is already zero based so you no longer need to subtract 1 from the result.</p><p class="simplepara" id="calibre_link-2188">A slightly trickier scenario is one in which the week needs to start or finish based on a day other than a Sunday or Monday. In this case you can add the code in Listing <span><a href="#calibre_link-25" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-18</a></span>.</p><div class="para1" id="calibre_link-25">
              <div class="programcode" id="calibre_link-2189"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Week Starting Wednesday",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR myWeekDay = WEEKDAY( [Date], 3 )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">VAR offset = 2</strong>&nbsp;&ndash; 0=Mon, 1=Tues, 2=Wed, 3=Thur, 4=Fri 5=Sat, 6=Sun</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN [Date]&nbsp;&ndash; MOD( myWeekDay&nbsp;&ndash; offset, 7 )</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-18</span><p class="para3">Name and Expression to Add a Column Called “Week Starting Wednesday” to the ADDCOLUMNS Function</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2190">You can configure this expression so any day can be the starting day for the week. The value assigned to the offset variable controls which day to use. In this case, it has been set to 2, which means Wednesday is the starting day for each week. For Saturday, you would assign a value of 5 to the offset variable.</p><p class="simplepara" id="calibre_link-2191">Once these DateTime <span id="calibre_link-2192">columns

</span> are in place, you can add additional columns that count the number of weeks to or from a milestone. The current day is again a good milestone to work from, so a column that shows “Weeks from today” might look like this:</p><div class="para1" id="calibre_link-2193">
              <div class="programcode" id="calibre_link-2194"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Weeks from today",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;([Date] -&nbsp;&nbsp;WEEKDAY([Date],3)) - TODAY()</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7)</div></div>
            </div><p class="simplepara" id="calibre_link-2195">This calculation includes the same logic used in the “Week starting Monday” column, but it extends to find the number of actual days between the starting date for the week and the current day (TODAY). The calculation then divides by seven to provide a zero-based index that shows negative numbers for dates in the past and positive numbers for future dates.</p></section><section class="section" id="calibre_link-156"><h3 class="heading">Is Working Day</h3><p class="simplepara" id="calibre_link-2196">Two columns that can help represent <span id="calibre_link-2197">working days

</span> can be a simple column that shows just 1 or 0 values that reflect if the specific row happens to be a working day or not and a column that shows the number of working days from a point (such as the current day).</p><p class="simplepara" id="calibre_link-2198">The first example (Listing <span><a href="#calibre_link-26" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-19</a></span>) assumes that Monday through Friday should be marked as 1 to represent a working day, while Saturday and Sunday should be marked with a 0 to represent a weekend date. You can reverse this if you intend to show weekends as 1 and weekdays as 0.</p><div class="para1" id="calibre_link-26">
              <div class="programcode" id="calibre_link-2199"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Is Work Day",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF(&nbsp;&nbsp;-- Zero based index with Monday being 0 is less than 5</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WEEKDAY( [Date], 3 ) &lt; 5,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- THEN --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- ELSE --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-19</span><p class="para3">Name and Expression to Add a Column Called “Is Work Day” to the ADDCOLUMNS Function</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2200">The WEEKDAY function returns a value between 0 and 6 to each [Date] when used with the optional second parameter of 3. Mondays = 0, Tuesdays = 1, and on through to Sunday, which is 6. The IF statement simply tests the output of the WEEKDAY function and assigns the appropriate value.</p><p class="simplepara" id="calibre_link-2201">A second useful column (Listing <span><a href="#calibre_link-27" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">7-20</a></span>) is one that shows the number of working days since a specific point in time. This example uses the current day as the point to count from and dynamically updates each day.</p><div class="para1" id="calibre_link-27">
              <div class="programcode" id="calibre_link-2202"><div class="fixedline">Working Days From Today =</div><div class="fixedline">VAR ColDate = 'Dates'[Date]</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;IF( ColDate &lt; TODAY(),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- THEN --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0-CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Dates'[Is Working Day]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL(Dates),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dates'[Date] &gt;= ColDate &amp;&amp;&nbsp;&nbsp;'Dates'[Date] &lt; TODAY()</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- ELSE --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Dates'[Is Working Day]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL(Dates),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dates'[Date] &lt;= ColDate &amp;&amp;&nbsp;&nbsp;'Dates'[Date] &gt; TODAY()</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)+0</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 7-20</span><p class="para3">Calculated Column Showing the Number of Working Days from the Current Date.</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2203">This calculation can only be added to an existing physical Date table. It cannot be added as part of the ADDCOLUMN function used in a create table statement since the ALL function relies on a table that must already exist.</p><p class="simplepara" id="calibre_link-2204">The calculation also relies on having a column called [Is Working Day] that already exists on the table. I included a suggested version of this earlier in the “Is Working Day” section. The calculation stores the value from the 'Date' column in a variable called ColDate. This can only ever be one value at a time. The IF statement then decides which of the two CALCULATE statements should be used. The first is designed to handle all the rows older than the current date, while the second CALCULATE applies a slightly different logic to calculate the value for rows newer than the current date. Only one of the two CALCULATE functions runs per row.</p><p class="simplepara" id="calibre_link-2205">You could compress this into a single <span id="calibre_link-2206">CALCULATE

</span> statement, but I have presented it like this to show you the general approach. Both CALCULATE statements use the ALL function to unlock rows other than the specific row being calculated. The SUM function can then use data from a wider range of rows to produce the result.</p><p class="simplepara" id="calibre_link-2207">These calculations do not take public holidays into account since holidays can vary wildly from region to region and even year to year. A suggested <span id="calibre_link-2208">approach

</span> to handling public holidays is to keep a separate table that carries a row for every instance. This can be maintained manually or be sourced from various local datasets. You can then use data from such a table in calculations to help determine if a row in your actual date table falls on a public holiday.</p></section><section class="section" id="calibre_link-157"><h3 class="heading">
              <span id="calibre_link-2209">Weekday Name

</span>
            </h3><p class="simplepara" id="calibre_link-2210">You can use the FORMAT function to show a column that simply carries the name of the day of the week. The DAX code for adding this using ADDCOLUMNS follows:</p><div class="para1" id="calibre_link-2211">
              <div class="programcode" id="calibre_link-2212"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Weekday name", FORMAT([Date],"DDDD")</div></div>
            </div><p class="simplepara" id="calibre_link-2213">There are four uppercase D characters used here in the format string to specify that the weekday should be shown in full, such as “Monday” or “Tuesday”. Using three uppercase D characters returns an abbreviated version such as “Mon” or “Tue”.</p></section><section class="section" id="calibre_link-158"><h3 class="heading">Rolling Your Own&mdash;Summary</h3><p class="simplepara" id="calibre_link-2214">It is easy enough to generate a Date table for your model using only DAX. You can use a mixture of these suggestions to form the basis of a date table suitable for your data model. The examples are designed to give you an idea of how you might approach creating columns that you can tweak to suit your own organization’s requirements.</p></section></section><section class="section" id="calibre_link-159"><h2 class="heading">
            <span id="calibre_link-2215">Optimizing Dates

</span>
          </h2><p class="simplepara" id="calibre_link-2216">Raw data from source systems often carries data to represent a value that points to a specific date and time. This is quite common when you’re dealing with sensor, Internet of Things (IOT), or transactional datasets. These may carry a field that shows the year, month, day, hour, minute, and second. A good practice to follow when using this type of data is to split the value into two or more columns.</p><p class="simplepara" id="calibre_link-2217">One column should be Date only, so it should be truncated to only show the year, month, and day. The second column (if you need it at all) can carry a version of the time. The time can be truncated to just a number between 0 and 23 to represent the hour of the day, or it can be a number between 0 and 1,440, which represents the specific minute of the day the event took place.</p><p class="simplepara" id="calibre_link-2218">The reason for doing this is to help optimize the data model for speed. When the DAX engine imports data, it splits tables of data to individual columns. The data in each column is then compressed to unique values. If you have a field in your raw data that carries a DateTime field down to the second (or microsecond), the column is highly unique and therefore does not compress much.</p><p class="simplepara" id="calibre_link-2219">If your raw data is an output from an IOT sensor that creates five readings every second, and you import this data “as is” to your model, it has the potential to create 157 million unique values per year that cannot be compressed (5 readings per second * 60 seconds * 60 minutes * 24 hours * 365 days = 157,680,000).</p><p class="simplepara" id="calibre_link-2220">If the same sensor data is split into two columns, one column for the Date component and the other column for showing a value for the minute of the day, the Date column will have just 365 unique values whereas the column representing the minute will have just 1,440. This approach means the raw data can be highly compressed when imported and it is still possible to perform the same <span id="calibre_link-2221">calculations

</span> using this much smaller and faster data model.</p></section></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-160">
<div id="calibre_link-2222" class="calibre2">
<div id="calibre_link-2223" class="calibre3"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-2224"><div class="bookfrontmatter">©&nbsp;Philip Seamark&nbsp;2018</div><span class="pcalibre5"><span><span>Philip&nbsp;Seamark</span></span></span><span><span class="booktitle1" type="title" lang="en">Beginning DAX with Power BI</span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-3477-8_8" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">https://doi.org/10.1007/978-1-4842-3477-8_8</a></span></div></div><div class="maintitlesection"><h1 class="chaptertitle" lang="en">8.&nbsp;Debugging and Optimizing</h1></div><div class="bookfrontmatter"><div class="bookfrontmatter"><span><span>Philip&nbsp;Seamark</span><sup class="calibre6"><a href="#calibre_link-317" class="pcalibre3 pcalibre4 pcalibre1 pcalibre2 pcalibre calibre7">1</a>&nbsp;<span class="contacticon"></span></sup></span></div><div class="bookfrontmatter"><div class="bookfrontmatter" id="calibre_link-317"><span class="affiliationnumber">(1)</span><div class="bookfrontmatter">UPPER HUTT, New Zealand</div></div><div class="clearboth">&nbsp;</div></div></div><div class="bookfrontmatter"><section class="section" id="calibre_link-161"><h2 class="heading">Debugging in <span id="calibre_link-2225">DAX

</span>
</h2><p class="simplepara" id="calibre_link-2226">A good question in any language is, “How can I debug the code?” Some languages have sophisticated tools that provide the programmer with the ability to walk step by step through execution of the code as the application runs. These debug tools often allow you to pause at various points to inspect all nature of useful properties and values so you get a clearer idea on the actual flow of logic as it pans out. This is not always the path the you expect, but at least being able to debug can help you identify sections of code you need to improve.</p><p class="simplepara" id="calibre_link-2227">Unfortunately, DAX doesn’t have such a sophisticated tool available to debug with, but fortunately it also doesn’t have the same degree of logical pathways that you might expect in even a simple application. Calculations in DAX are often single-line statements that are as simple as passing just one parameter to a function.</p><p class="simplepara" id="calibre_link-2228">Step debugging the following calculated measure probably won’t provide you with much useful information, but the output is quick to generate and enough to help you understand the reason behind the result.</p><div class="para1" id="calibre_link-2229">
            <div class="programcode" id="calibre_link-2230"><div class="fixedline">Count of Table = COUNTROWS( 'Table' )</div></div>
          </div><p class="simplepara" id="calibre_link-2231">Given that calculated measures can be executed many times inside a report page, it can be difficult to isolate the execution of a specific instance to understand what filter context may or may not be at play for that case.</p><p class="simplepara" id="calibre_link-2232">That said, although you can’t start <span id="calibre_link-2233">debugging

</span> or step and run through your code, you can apply several types of manual techniques to your code while you’re building calculations. This is what I like to think of as old-school debugging.</p><p class="simplepara" id="calibre_link-2234">The general principal is to break calculations out into separate, smaller versions and use the output of each smaller calculation to help understand the values being generated. By reducing the logic down to smaller baby steps, you can inspect each value to see which ones match your expectations and which may be different. Tracing the baby steps through to the first point where they generate unexpected results should be the fasted way to show which aspect of code needs your attention.</p><p class="simplepara" id="calibre_link-2235">If you have a calculation generating unexpected results, make a copy and change the core expression to something simpler, such as a COUNTROWS function. Doing this can often help you figure out how many rows are being considered for the calculation.</p><p class="simplepara" id="calibre_link-2236">In the case of a tricky calculated column that consists of several nested functions, create some temporary columns that are subsets of each function.</p><p class="simplepara" id="calibre_link-2237">To walk through an example, take a look at the calculated column in Listing <span><a href="#calibre_link-318" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-1</a></span>; this calculation shows a percentage ratio for each product sold per day.</p><div class="para1" id="calibre_link-318">
            <div class="programcode" id="calibre_link-2238"><div class="fixedline">Product Ratio of Daily Sales =</div><div class="fixedline">DIVIDE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Amount]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=EARLIER('Fact Sale'[Invoice Date Key]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Stock Item Key]=EARLIER('Fact Sale'[Stock Item Key])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Amount]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=EARLIER('Fact Sale'[Invoice Date Key])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-1</span><p class="para3">Calculated Column Creating a Ratio of Sales Against a Grand Total</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2239">The first <span id="calibre_link-2240">CALCULATE 

</span>in this statement attempts to determine the total value for the specific product for each day. Because there may be other transactions on the same day for the same product, the calculation needs to check to see if there are other rows in the same table with the same [Stock Item Key] and [Invoice Date Key]. If it can’t find any, and there is only one transaction per day for the product, this value should exactly match the value in the [Total Amount] column. If other rows are found for the same [Stock Item Key] and [Invoice Date Key], the SUM function should generate the correct value for all transactions combined and then assign that value to each instance of that product.</p><p class="simplepara" id="calibre_link-2241">The only values that can be seen are the numbers returned as the final output of the entire calculated column. Intermediate values such as those generated by the first CALCULATE function are lost.</p><p class="simplepara" id="calibre_link-2242">The second CALCULATE attempts to derive a total value for sales for each day. This daily total is used with the first value to derive a percentage for each product/day combination. Once again, the way the calculation has been written, you do not see these intermediate values. How can we you sure the values used in the DIVIDE calculation are the values you think they should be?</p><p class="simplepara" id="calibre_link-2243">The easiest way to break this calculation down is to create a separate observable entity for each of the CALCULATE functions. This can take the form of several new calculated columns, or you can use variables and control which variable is returned via the RETURN statement.</p><section class="section" id="calibre_link-162"><h3 class="heading">Debugging Using Columns</h3><p class="simplepara" id="calibre_link-2244">Using the calculated <span id="calibre_link-2245">column approach

</span>, you can add the three calculated columns in Listings <span><a href="#calibre_link-319" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-2</a></span>, <span><a href="#calibre_link-320" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-3</a></span>, and <span><a href="#calibre_link-321" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-4</a></span>.</p><div class="para1" id="calibre_link-319">
              <div class="programcode" id="calibre_link-2246"><div class="fixedline">Product Sub Total =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Amount]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=EARLIER('Fact Sale'[Invoice Date Key]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Stock Item Key]=EARLIER('Fact Sale'[Stock Item Key])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-2</span><p class="para3">Calculated Column Showing the Sub Category Total</p></div></div></div>
            </div><div class="para1" id="calibre_link-320">
              <div class="programcode" id="calibre_link-2247"><div class="fixedline">Daily Sub Total =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Amount]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=EARLIER('Fact Sale'[Invoice Date Key])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-3</span><p class="para3">Calculated Column Showing the Overall Total</p></div></div></div>
            </div><div class="para1" id="calibre_link-321">
              <div class="programcode" id="calibre_link-2248"><div class="fixedline">Divide Test =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Product Sub Total],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Daily Sub Total]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-4</span><p class="para3">Calculated Column Incorporating Listings <span><a href="#calibre_link-319" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-2</a></span> and <span><a href="#calibre_link-320" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-3</a></span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2249">In these listings, the two CALCULATE functions from Listing <span><a href="#calibre_link-318" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-1</a></span> have been separated into their own calculated columns while a third calculated column uses the DIVIDE function that incorporates the other calculated columns. You can visually inspect this in the Data View as a form of debugging. You can use these three new calculated columns in addition to the original version of the calculated <span id="calibre_link-2250">column

</span>.</p><div class="para1" id="calibre_link-2251">Figure&nbsp;<span><a href="#calibre_link-322" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-1</a></span> shows a sample of the table with the three new “debug” columns. The table has been filtered to only show data for January 1, 2016, and it is ordered by the [Stock Item Key] column.<figure class="figure1" id="calibre_link-322"><div class="mediaobject" id="calibre_link-2252"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig1_HTML.jpg" src="images/000030.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-1</span><p class="simplepara1">Output of the code in Listings <span class="calibre9"><a href="#calibre_link-319" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-2</a></span>, <span class="calibre9"><a href="#calibre_link-320" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-3</a></span>, and <span class="calibre9"><a href="#calibre_link-321" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-4</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2253">The [Product Sub Total] value of 750 for the first row seems to match the [Total Amount] column. There is only one row for [Stock Item Key] = 1, so this looks good. The next two rows have been highlighted in a box. This shows that there were two transactions on this day for [Stock Item Key] = 9. The individual totals of 49.2 and 12.3 combine for a total of 61.5. This is the value repeated for both rows in the [Product Sub Total] column, which is the desired result. The number still to be tested is the value of 13,888 that is repeated in every row of the [Daily Sub Total] column.</p><p class="simplepara" id="calibre_link-2254">One approach to testing this is to first create a calculated measure that uses SUM of the [Total Amount] column and then use this calculation in a visual where a filter is set to the same day as the test data. If the source system is a SQL database, another option is to write a query to help reconcile this value. Ideally T-SQL queries should be kept simple, otherwise the test can be compromised by errors in the T-SQL statement, so avoid joins and stick to simple SUM and COUNT functions with just the bare minimum of <span id="calibre_link-2255">code

</span> in any WHERE clause.</p></section><section class="section" id="calibre_link-163"><h3 class="heading">Debugging Using <span id="calibre_link-2256">Variables

</span>
</h3><p class="simplepara" id="calibre_link-2257">An alternative to the preceding approach is to make use of variables. The object is to break the calculation into smaller chunks of code wherever practical. The same code split up into variables might look like Listing <span><a href="#calibre_link-323" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-5</a></span>.</p><div class="para1" id="calibre_link-323">
              <div class="programcode" id="calibre_link-2258"><div class="bookfrontmatter"><div class="fixedline1">Product Ratio of Daily Sales =</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR InvoiceDateKeyCol = 'Fact Sale'[Invoice Date Key]</div><div class="fixedline1">VAR StockItemKeyCol = 'Fact Sale'[Stock Item Key]</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR <strong class="emphasistypebold">ProductSubTotal</strong> =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Amount]),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL('Fact Sale'),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=InvoiceDateKeyCol,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Stock Item Key]=StockItemKeyCol</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR DailySubTotal =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Amount]),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL('Fact Sale'),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=InvoiceDateKeyCol</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR ReturnValue =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ProductSubTotal,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DailySubTotal</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">RETURN&nbsp;&nbsp;<strong class="emphasistypebold">ProductSubTotal</strong>
</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-5</span><p class="para3">Calculated Measure Using RETURN to Control the Final Output Variable</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2259">In Figure <span><a href="#calibre_link-324" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-5</a></span>, I have modified the original calculated measure to use variables to store the various sections of code. Apart from the fact that this is now more readable, the final RETURN statement is not obliged to return the last variable to be declared.</p><p class="simplepara" id="calibre_link-2260">The RETURN statement here returns the <span id="calibre_link-2261">ProductSubTotal

</span> and not the ReturnValue variable, meaning once this calculated column is executed, numbers visible in this column in the Data View represent the output of the first CALCULATE function and not the output of the final DIVIDE statement.</p><p class="simplepara" id="calibre_link-2262">When these values have been checked and confirmed to be as expected, you can update the final RETURN statement so it returns the DailySubTotal variable. When this has been confirmed as being correct, you can set the RETURN statement to use the ReturnValue column.</p><p class="simplepara" id="calibre_link-2263">The downside of this approach is that only one variable can be returned at any one time. You can take a hybrid approach if one of the calculated columns used earlier produces a value that might be useful in several other calculations, however. You can use the [Daily Sub Total] column to create similar “percentage of”&ndash;type calculations that involve other columns in the table.</p></section><section class="section" id="calibre_link-164"><h3 class="heading">Debugging Calculated Measures</h3><p class="simplepara" id="calibre_link-2264">When it comes to <span id="calibre_link-2265">calculated measures

</span>, the principle is the same. The calculated measure in Listing <span><a href="#calibre_link-325" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-6</a></span> meets the same product ratio of daily sales requirement in a single calculation.</p><div class="para1" id="calibre_link-325">
              <div class="programcode" id="calibre_link-2266"><div class="fixedline">Product Ratio of Daily Sales as Measure =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Amount]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLSELECTED('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=MAX('Fact Sale'[Invoice Date Key]) &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Stock Item Key]=MAX('Fact Sale'[Stock Item Key])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Amount]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLSELECTED('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=MAX('Fact Sale'[Invoice Date Key])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-6</span><p class="para3">Calculated Measure to Be Debugged</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2267">Listings <span><a href="#calibre_link-326" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-7</a></span>, <span><a href="#calibre_link-327" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-8</a></span>, and <span><a href="#calibre_link-328" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-9</a></span> show how to debug this DAX by breaking it into three separate calculated measures.</p><div class="para1" id="calibre_link-326">
              <div class="programcode" id="calibre_link-2268"><div class="fixedline">Product Sub Total as Measure =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Amount]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLSELECTED('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=MAX('Fact Sale'[Invoice Date Key]) &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Stock Item Key]=MAX('Fact Sale'[Stock Item Key])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-7</span><p class="para3">Calculated Measure <span id="calibre_link-2269">Showing 

</span>Total for Sub Category</p></div></div></div>
            </div><div class="para1" id="calibre_link-327">
              <div class="programcode" id="calibre_link-2270"><div class="fixedline">Product Sub Total as Measure =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Fact Sale'[Total Amount]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLSELECTED('Fact Sale'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Invoice Date Key]=MAX('Fact Sale'[Invoice Date Key]) &amp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Stock Item Key]=MAX('Fact Sale'[Stock Item Key])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-8</span><p class="para3">Calculated Measure Showing Overall Total</p></div></div></div>
            </div><div class="para1" id="calibre_link-328">
              <div class="programcode" id="calibre_link-2271"><div class="fixedline">Product Ratio as Measure =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Product Sub Total as Measure],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Daily Sub Total as Measure]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-9</span><p class="para3">Calculated Column Incorporating Listings <span><a href="#calibre_link-326" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-7</a></span> and <span><a href="#calibre_link-327" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-8</a></span>
</p></div></div></div>
            </div><div class="para1" id="calibre_link-2272">Because these are <span id="calibre_link-2273">calculated measures

</span>, you need to add them to a visual such as the table visual in Figure <span><a href="#calibre_link-329" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-2</a></span> in order for the values to be inspected. In this figure, the [Invoice Date Key], [Stock Item Key], and [Total Amount] columns have been added to the same visual to provide the calculated measures with some query context.<figure class="figure1" id="calibre_link-329"><div class="mediaobject" id="calibre_link-2274"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig2_HTML.jpg" src="images/000079.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-2</span><p class="simplepara1">Output of the code in Listings <span class="calibre9"><a href="#calibre_link-326" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-7</a></span>, <span class="calibre9"><a href="#calibre_link-327" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-8</a></span>, and <span class="calibre9"><a href="#calibre_link-328" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-9</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2275">The final three columns in Figure <span><a href="#calibre_link-329" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-2</a></span> show the results of each calculated measure. You can use this format to help reconcile against the value for [Total Amount]. The rows in which [Stock Item Key] = 9 add up correctly for the [Product Sub Total as Measure] values.</p><p class="simplepara" id="calibre_link-2276">Keeping the <span id="calibre_link-2277">calculation

</span> as a single statement but using the RETURN statement to control which variable to return works just as well. The advantage of splitting out to separate calculated measures is that you can then use each measure in other calculations. This introduces a degree of code fragmentation when you are trying to follow code that uses multiple calculated measures, however.</p><p class="simplepara" id="calibre_link-2278">A common reason why calculated measures generate unexpected results is incorrect filtering. As calculated measures grow in complexity, particularly those that mix the use of clearing or applying layers of filtering of the data, this means the core expression doesn’t use the data as you expect it to.</p><p class="simplepara" id="calibre_link-2279">Sometimes this becomes obvious when each component is broken out into smaller chucks in the way as shown earlier in this chapter at Listing <span><a href="#calibre_link-325" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-6</a></span>. If this still doesn’t clarify why a value might be different than what you are expecting, using alternative functions in your core expression may help shed light on the issue.</p><p class="simplepara" id="calibre_link-2280">Taking a copy of your calculated measure and substituting <span class="emphasisfontcategorynonproportional">SUM ('Fact Sale'[Total Amount])</span> with <span class="emphasisfontcategorynonproportional">COUNTROWS ('Fact Sale')</span> can sometimes be enough to help identify a filter-related issue. Otherwise substituting with other expressions to show the MIN or MAX of a column, such as <span class="emphasisfontcategorynonproportional">MAX ('Fact Sale'[Invoice Date Key]),</span> might be enough to help clarify any issues with filtering.</p><div class="para1" id="calibre_link-2281">Some additional functions that can be useful when debugging manually are these:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-2282">HASONEFILTER: Returns true when the specified column has one and only one direct filter value.</p></li><li class="calibre8"><p class="para2" id="calibre_link-2283">HASONEVALUE: Returns true when there’s only one value in the specified column after it is cross filtered.</p></li><li class="calibre8"><p class="para2" id="calibre_link-2284">ISCROSSFILTERED: Returns true when the specified table or column is cross filtered.</p></li><li class="calibre8"><p class="para2" id="calibre_link-2285">ISFILTERED: Returns true when there are direct filters on the specified column.</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-2286">These <span id="calibre_link-2287">functions

</span> produce true/false outputs and can be useful when you add them to new calculated measures and to the same table visual you are using to debug with. These provide useful information about the level of filtering that the engine is applying. When you are happy your code is running as expected, you can remove these temporary calculated measures.</p><p class="simplepara" id="calibre_link-2288">A final tip is to use a blank report page for debugging and start with just the data you need. If you try to debug measures on a busy report page that has other visuals and filters, it can be tricky to isolate an issue. Once the calculation is working as you expect it to, you can remove or hide the report page you used to debug.</p></section><section class="section" id="calibre_link-165"><h3 class="heading">External Tools</h3><div class="bookfrontmatter" id="calibre_link-2289">Whether you are writing DAX calculations in Power BI, Excel, or SSAS, there are several useful tools that you can use to help produce better calculations. These are three that we will look at in this chapter:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-2290">DAX Studio</p></li><li class="calibre8"><p class="para2" id="calibre_link-2291">SSMS (SQL Server Management Studio)</p></li><li class="calibre8"><p class="para2" id="calibre_link-2292">SQL Server Profiler</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-2293">These tools are all free, and if you are already working with Microsoft SQL Server databases, you probably already have SSMS and SSMS Profiler installed. This section shows you how to get started and highlights key ways each tool can be helpful.</p><section class="section" id="calibre_link-2294"><h4 class="heading2">DAX Studio</h4><p class="simplepara" id="calibre_link-2295">The first tool to look at is the highly recommended DAX Studio, which describes itself as the ultimate tool for working with DAX queries. You can find documentation on DAX Studio including a link to download from <span class="emphasisfontcategorynonproportional">daxstudio.org</span>.</p><div class="para1" id="calibre_link-2296">Once DAX Studio is downloaded and installed, you can create connections to <span id="calibre_link-2297">data models

</span> hosted by the following engines:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-2298">PowerPivot in Excel</p></li><li class="calibre8"><p class="para2" id="calibre_link-2299">Power BI Desktop</p></li><li class="calibre8"><p class="para2" id="calibre_link-2300">Azure Analysis Services</p></li><li class="calibre8"><p class="para2" id="calibre_link-2301">Azure Analysis Services Tabular</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-2302">This means that if you have a copy of <span id="calibre_link-2303">Power BI Desktop

</span> open with a data model loaded with data, you can open DAX Studio and create a connection to the Power BI Desktop model and start issuing queries.</p><div class="para1" id="calibre_link-2304">The first dialog you encounter when opening DAX Studio is one that asks which data model you would like to connect to (Figure <span><a href="#calibre_link-330" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-3</a></span>). If you have multiple copies of Power BI Desktop, you can select which one you would like to connect to from a drop-down list.<figure class="figure1" id="calibre_link-330"><div class="mediaobject" id="calibre_link-2305"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig3_HTML.jpg" src="images/000062.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-3</span><p class="simplepara1">The <span id="calibre_link-2306" class="calibre9">connection dialog

</span> in DAX Studio</p></div></figcaption></figure>
</div><div class="para1" id="calibre_link-2307">Once connected to a model, the <span id="calibre_link-2308">application

</span> should appear as it does in Figure <span><a href="#calibre_link-331" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-4</a></span>.<figure class="figure1" id="calibre_link-331"><div class="mediaobject" id="calibre_link-2309"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig4_HTML.jpg" src="images/000023.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-4</span><p class="simplepara1">The main screen of <span id="calibre_link-2310" class="calibre9">DAX Studio

</span>
</p></div></figcaption></figure>
<div class="orderedlist"><ol class="unorderedlistmarkbullet"><li class="listitem"><span class="itemnumber">1.</span><div class="itemcontent"><p class="para2" id="calibre_link-2311">The ribbon across the top is loaded with features you can use for editing and optimizing your DAX; you can hide this to provide more space to write DAX.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><span class="itemnumber">2.</span><div class="itemcontent"><p class="para2" id="calibre_link-2312">The Metadata panel allows you to explore the structure of your model. You can drag tables and columns to the query editor to save yourself from having to type longer object names. Every DAX function is listed in this panel along with some interesting DMV (dynamic management views) queries.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><span class="itemnumber">3.</span><div class="itemcontent"><p class="para2" id="calibre_link-2313">The query editor is where you can write and edit your DAX queries. This features full IntelliSense that suggest functions, tables, columns, and measures as you type.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><span class="itemnumber">4.</span><div class="itemcontent"><p class="para2" id="calibre_link-2314">The Output bar consists of several tabs that contain information regarding any query that has been run. The Results tab shows the output of the query. You can enable other tabs to see query plans and internal server timings.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><span class="itemnumber">5.</span><div class="itemcontent"><p class="para2" id="calibre_link-2315">The Status bar along the bottom shows information about the current connection.</p></div><div class="clearboth">&nbsp;</div></li></ol></div>
</div><p class="simplepara" id="calibre_link-2316">Once you connect to a data model, you can start writing DAX in the query editor. When you are ready to run your query, click the Run button on the ribbon or press F5. As long as your query has no errors, you can see the output in a grid in the Results tab of the Output panel. There is an option on the ribbon to output the results to a file, which can be a handy way to manually extract data from your data model.</p><div class="formalpara" id="calibre_link-2317"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-2318">Every DAX query run in DAX Studio must begin with the keyword EVALUATE and must output a table.</p></div><p class="simplepara" id="calibre_link-2319">Taking the code from a calculated measure and running it in DAX Studio produces an error. The following statements will both fail to run:</p><div class="para1" id="calibre_link-2320">
                <div class="programcode" id="calibre_link-2321"><div class="fixedline">My Measure = COUNTROWS('Fact Sale')</div><div class="fixedline">COUNTROWS('Fact Sale')</div></div>
              </div><p class="simplepara" id="calibre_link-2322">Even adding the <span id="calibre_link-2323">EVALUATE keyword

</span> in front of both statements produces an error because the output of the COUNTROWS function is not a table.</p><div class="para1" id="calibre_link-2324">
                <div class="programcode" id="calibre_link-2325"><div class="fixedline">EVALUATE</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS('Fact Sale')</div></div>
              </div><p class="simplepara" id="calibre_link-2326">To get a query like this using the <span id="calibre_link-2327">COUNTROWS function

</span> to work, you need to wrap it in a function that can output to a table such as ROW.</p><div class="para1" id="calibre_link-2328">
                <div class="programcode" id="calibre_link-2329"><div class="fixedline">EVALUATE</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ROW(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"My Value",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS('Fact Sale')</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
              </div><div class="para1" id="calibre_link-2330">This statement produces the following (Figure <span><a href="#calibre_link-324" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-5</a></span>) in the Results tab of the Output panel.<figure class="figure1" id="calibre_link-324"><div class="mediaobject" id="calibre_link-2331"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig5_HTML.jpg" src="images/000041.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-5</span><p class="simplepara1">Simple query in DAX Studio including results</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2332">One of the simplest queries to run in DAX Studio is to use <span id="calibre_link-2333">EVALUATE

</span> with the name of a table in the model.</p><div class="para1" id="calibre_link-2334">
                <div class="programcode" id="calibre_link-2335"><div class="fixedline">EVALUATE</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'</div></div>
              </div><p class="simplepara" id="calibre_link-2336">This is the equivalent of <span class="emphasisfontcategorynonproportional">SELECT</span> <span class="emphasisfontcategorynonproportional">* FROM [Dimension Date]</span> and shows every row and every column of the ‘Dimension Date’ table. To reduce the number of rows in the output, you can use filter functions with the table.</p><div class="para1" id="calibre_link-2337">
                <div class="programcode" id="calibre_link-2338"><div class="fixedline">EVALUATE</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Year]=2016</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
              </div><p class="simplepara" id="calibre_link-2339">The preceding calculation returns all columns from the ‘Dimension Date’ table but only rows that belong to [Calendar Year] = 2016.</p><p class="simplepara" id="calibre_link-2340">The following calculation is the equivalent of <span class="emphasisfontcategorynonproportional">SELECT TOP 10 * FROM [Dimension Date] ORDER BY [Date] Desc</span>:</p><div class="para1" id="calibre_link-2341">
                <div class="programcode" id="calibre_link-2342"><div class="fixedline">EVALUATE</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;TOPN(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DESC</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
              </div><p class="simplepara" id="calibre_link-2343">If you want to develop and test how a calculated column might look, you can use syntax such as this:</p><div class="para1" id="calibre_link-2344">
                <div class="programcode" id="calibre_link-2345"><div class="fixedline">EVALUATE</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Fact Sale',</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"My Test Column",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">'Fact Sale'[Unit Price] * 'Fact Sale'[Quantity]</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
              </div><p class="simplepara" id="calibre_link-2346">The <span id="calibre_link-2347">SELECTCOLUMNS function

</span> used in this example means the output only contains one column; however, it produces as many rows as there are in the ‘Fact Sale’ table. You can add additional columns as needed, or, if it is more useful to see every column from your base table including your additional calculation, using the ADDCOLUMNS function might be better (Listing <span><a href="#calibre_link-332" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-10</a></span>).</p><div class="para1" id="calibre_link-332">
                <div class="programcode" id="calibre_link-2348"><div class="fixedline">EVALUATE</div><div class="fixedline">
                    <strong class="emphasistypebold">VAR DoubleMe = 2</strong>
                  </div><div class="fixedline">
                    <strong class="emphasistypebold">RETURN</strong>
                  </div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"My Test Column",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale'[Unit Price] * 'Fact Sale'[Quantity],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">"My Test Column 2",</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">VAR X = COUNTROWS('Fact Sale') * DoubleMe</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">RETURN X</strong>
</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-10</span><p class="para3">DAX Query with an Additional Column Using <span id="calibre_link-2349">Nested Variables

</span>
</p></div></div></div>
              </div><div class="para1" id="calibre_link-2350">Expanding the logic to include additional columns can be done as shown in Listing <span><a href="#calibre_link-332" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-10</a></span>. This also demonstrates how you can use variables both before and inside a query. Figure <span><a href="#calibre_link-333" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-6</a></span> shows the results of Listing <span><a href="#calibre_link-332" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-10</a></span>.<figure class="figure1" id="calibre_link-333"><div class="mediaobject" id="calibre_link-2351"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig6_HTML.jpg" src="images/000008.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-6</span><p class="simplepara1">Output of the code in Listing <span class="calibre9"><a href="#calibre_link-332" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-10</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2352">An option to help test calculated measures is to use the DEFINE MEASURE statement to keep DAX logic for the measure separate from the EVALUATE query.</p><p class="simplepara" id="calibre_link-2353">Listing <span><a href="#calibre_link-334" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-11</a></span> creates a new calculated measure that exists only in the scope of this query and is not visible to anyone else using the data model.</p><div class="para1" id="calibre_link-334">
                <div class="programcode" id="calibre_link-2354"><div class="bookfrontmatter"><div class="fixedline1">DEFINE MEASURE</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;'FACT Sale'[My test measure] = COUNTROWS('Fact Sale')</div></div><div class="bookfrontmatter"><div class="fixedline1">EVALUATE</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZECOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Year],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Column Name here",</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">[My test measure]</strong>
</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">)</strong>
</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;ORDER BY</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Year] DESC</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-11</span><p class="para3">DAX Query Using DEFINE <span id="calibre_link-2355">MEASURE

</span> to Create Query-Scope Calculated Measure</p></div></div></div>
              </div><p class="simplepara" id="calibre_link-2356">The DEFINE MEASURE statement creates an area where you can add multiple measures. Each measure must have the full notation of ‘tablename’[measure name] = preceding the DAX expression. The code used in the expression is the same as what you use when creating a calculated measure directly in the data model. The measure name must include a table.</p><div class="para1" id="calibre_link-2357">The measure can then be used in the EVALUATE query with the results visible in the results tab when it is run (Figure <span><a href="#calibre_link-335" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-7</a></span>). Syntax error messages appear in the Output tab of the Results panel if there are errors in the code.<figure class="figure1" id="calibre_link-335"><div class="mediaobject" id="calibre_link-2358"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig7_HTML.jpg" src="images/000002.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-7</span><p class="simplepara1">Output of code from Listing <span class="calibre9"><a href="#calibre_link-334" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-11</a></span> using DEFINE <span id="calibre_link-2359" class="calibre9">MEASURE

</span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2360">Another element of running queries in a <span id="calibre_link-2361">client tool

</span> such as DAX Studio is that you can add an ORDER BY statement to the query; this is also shown in Listing <span><a href="#calibre_link-334" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-11</a></span>.</p><p class="simplepara" id="calibre_link-2362">These are the basics for getting queries to run in DAX Studio. Additional features are useful for optimizing queries and we look at these in more detail later in this chapter.</p><p class="simplepara" id="calibre_link-2363">In addition to having a larger area for the query editor and a host of tools that are useful when you’re editing longer DAX queries, you can save and store your queries as separate files. Doing so can help you back up and provide source control over individual queries.</p><p class="simplepara" id="calibre_link-2364">The <span id="calibre_link-2365">Format Query (F6)

</span> feature allows you to tidy queries by adding tabs and carriage returns at key places to help improve query readability.</p><p class="simplepara" id="calibre_link-2366">You can run multiple queries at the same time, as shown here:</p><div class="para1" id="calibre_link-2367">
                <div class="programcode" id="calibre_link-2368"><div class="bookfrontmatter"><div class="fixedline1">DEFINE MEASURE 'Fact Sale'[Right Now] = FORMAT(NOW(),"hh:mm:ss.ms")</div></div><div class="bookfrontmatter"><div class="fixedline1">EVALUATE</div><div class="fixedline1">&nbsp;ROW("Q1",[Right Now])</div></div><div class="bookfrontmatter"><div class="fixedline1">EVALUATE</div><div class="fixedline1">&nbsp;ROW("Q3",[Right Now])</div></div><div class="bookfrontmatter"><div class="fixedline1">EVALUATE</div><div class="fixedline1">&nbsp;SAMPLE(10000,'Fact Sale','Fact Sale'[Invoice Date Key])</div></div></div>
              </div><p class="simplepara" id="calibre_link-2369">When you run this query, it returns three datasets to the Results panel.</p><div class="para1" id="calibre_link-2370">You can view the results for each <span id="calibre_link-2371">EVALUATE statement

</span> by clicking the numbered vertical tabs. The result of the third and final EVALUATE query from the batch is shown in Figure <span><a href="#calibre_link-336" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-8</a></span>. Note that two of the queries used the calculated measure from the DEFINE MEASURE section. The final query uses the SAMPLE function to perform a random filter over 1,000 rows from the ‘Fact Sale’ table.<figure class="figure1" id="calibre_link-336"><div class="mediaobject" id="calibre_link-2372"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig8_HTML.jpg" src="images/000017.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-8</span><p class="simplepara1">The last result set from three queries run simultanously</p></div></figcaption></figure>
</div></section><section class="section" id="calibre_link-2373"><h4 class="heading2">SSMS (SQL Server Management Studio) <span id="calibre_link-2374">
                  
                </span>
</h4><p class="simplepara" id="calibre_link-2375">Another tool to help develop and debug your DAX calculations is Microsoft SSMS. If you are working with Microsoft SQL databases, you probably already have this tool. If you don’t, a quick internet search will point you to the correct download location for this on the Microsoft site. It is a large download because it contains features useful for working with the entire Microsoft SQL suite of products and not just DAX models.</p><p class="simplepara" id="calibre_link-2376">Just like DAX Studio, you can use SSMS to connect to DAX data models such as Power BI Desktop and <span id="calibre_link-2377">SSAS
</span> Tabular. However, to connect to Power BI Desktop, you need to know the port number on your local machine being used by the instance you want to connect to. This number changes each time you open Power BI Desktop. DAX Studio shows the port number once you are connected on the Status bar in the format of <em class="emphasistypeitalic">localhost:nnnn</em> where <em class="emphasistypeitalic">nnnn</em> is the port number. So, if you have DAX Studio, you can use this as a quick way to identify the port number you need if you also want to use SSMS to connect to your model.</p><div class="formalpara" id="calibre_link-2378"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-2379">You can start Power BI Desktop on a specific port by navigating to the folder where the Desktop executable is located and running this command from the console:</p><div class="para1" id="calibre_link-2380">
                  <div class="programcode" id="calibre_link-2381"><div class="fixedline">PBIDesktop /diagnosticsport:XXXX</div></div>
                </div></div><div class="bookfrontmatter" id="calibre_link-2382">Another way to find the current port number is via the Resource Monitor (Figure <span><a href="#calibre_link-337" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-9</a></span>) for your operating system (or a similar tool); look for any listening network ports using the msmdsrv.exe executable. This is easier if you only have one instance of Power BI Desktop open.<figure class="figure1" id="calibre_link-337"><div class="mediaobject" id="calibre_link-2383"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig9_HTML.jpg" src="images/000072.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-9</span><p class="simplepara1">Using Windows 10 Resource Monitor to find a listening port for Power BI Desktop</p></div></figcaption></figure>
</div><div class="para1" id="calibre_link-2384">In this case, the Resource Monitor is showing that port number 57310 is a listening port by msmdsrv.exe, so you can use it when connecting from <span id="calibre_link-2385">SSMS
</span> using the properties in Figure <span><a href="#calibre_link-338" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-10</a></span>.<figure class="figure1" id="calibre_link-338"><div class="mediaobject" id="calibre_link-2386"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig10_HTML.jpg" src="images/000025.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-10</span><p class="simplepara1">Example connect dialog for SSMS for connecting to the Power BI Desktop</p></div></figcaption></figure>
</div><div class="formalpara" id="calibre_link-2387"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-2388">The Server Type needs to be set to Analysis Services. This might not be the default value of this property.</p></div><p class="simplepara" id="calibre_link-2389">Once connected, DAX queries must conform to the same requirements as those you use for DAX Studio. These include that you need to use the EVALUATE keyword for every query and that all results should be in a DAX table.</p><p class="simplepara" id="calibre_link-2390">Otherwise SSMS provides IntelliSense and a host of other features to help you build DAX calculations. All the query examples used in this chapter to demonstrate DAX Studio work in SSMS except for multiple EVALUATE <span id="calibre_link-2391">statements
</span> in the same batch.</p></section><section class="section" id="calibre_link-2392"><h4 class="heading2">Other <span id="calibre_link-2393">Client Tools

</span>
</h4><p class="simplepara" id="calibre_link-2394">Once you know the server and port number for the DAX engine you wish to query, you can use any tool that has the ability connect to an instance of SSAS Tabular. You can even connect Power BI Desktop to another instance of Power BI Desktop. This is probably not so useful for developing DAX queries, but doing so can help optimize your data model by allowing DMV queries to be issued with the results plotted using the fantastic array of visuals in Power BI.</p></section></section></section><section class="section" id="calibre_link-166"><h2 class="heading">Optimizing</h2><p class="simplepara" id="calibre_link-2395">Optimization is a broad and potentially advanced topic&mdash;enough to justify a book on its own, in fact. In this section, I try to cover some of the more useful techniques that you can used to improve the performance of your model. I have split the suggestions into two sections. The first section is for optimizing data models and the second focuses on optimizing DAX queries and also covers how to take advantage of tools such as DAX Studio and SSMS to improve performance.</p><section class="section" id="calibre_link-167"><h3 class="heading">Optimizing Data Models</h3><p class="simplepara" id="calibre_link-2396">Let’s begin by removing unused data.</p><section class="section" id="calibre_link-2397"><h4 class="heading2">
                <span id="calibre_link-2398">Removing Unused Data

</span>
              </h4><p class="simplepara" id="calibre_link-2399">The first tip is to make sure you only include data you need in the model. The larger the model, the more work calculations you need to do, and surplus data, even if it’s not used in any calculation, can still have a detrimental effect on compression and performance of the model.</p><p class="simplepara" id="calibre_link-2400">Although it might be initially useful to import every row and every column from various tables in your source system for data exploration purposes, make sure you allow time to review and remove unused columns and rows from your data model before you publish your report to a production environment.</p><p class="simplepara" id="calibre_link-2401">Highly unique data sitting in unused columns can have a negative effect on the compression used by the DAX engine to store the data. Good columns to target to find such unused data are IDENTITY or Autonumber columns that are useful to have in an OLTP source system but that often have little value in an OLAP data model. Unless you need to display values from these columns in your report, removing them can help considerably reduce the size of your data model.</p><p class="simplepara" id="calibre_link-2402">You can use a free tool called Power BI Helper to help identify columns that aren’t being used in a model. You should remove any column that it highlights from the data model and only add them back if you need them for the report. You can download the Power BI Helper from <span><a href="http://radacad.com/power-bi-helper" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre"><span>
                    <span class="emphasisfontcategorynonproportional">http://radacad.com/power-bi-helper</span>
                  </span></a></span>.</p><p class="simplepara" id="calibre_link-2403">If you are comfortable using DMV, then issuing the following DMV query against your data model using DAX Studio or SSMS, once sorted, can provide you with useful insight into which objects (columns) in your model are using the most memory.</p><div class="para1" id="calibre_link-2404">
                <div class="programcode" id="calibre_link-2405"><div class="fixedline">Select * from $System.discover_object_memory_usage</div></div>
              </div><p class="simplepara" id="calibre_link-2406">These columns are good ones to check to see if they can be removed.</p><p class="simplepara" id="calibre_link-2407">Removing unused columns is one technique, but also consider the number of rows you import into your model. If the data model only needs to support a certain range of time, then consider importing just enough data to cover the period required.</p><p class="simplepara" id="calibre_link-2408">Also consider compressing data as part of the import process. If a dataset from a source system has many rows per day, such as the kind you might find in some IOT Sensor data, group the data before or during the import. It may be possible to satisfy reporting requirements using data that has been presummarized down to a single row per day that also contains a value for the <span id="calibre_link-2409">COUNT

</span>, MIN, MAX, and AVERAGE of the rows that have been compressed.</p><p class="simplepara" id="calibre_link-2410">These suggestions are helpful to reduce the overall size of the data model. If you try these out using a Power BI Desktop model, make a note of the file size of the saved PBIX file before and after the changes. I have seen instances where the file size was reduced from over 800 MB down to less than 40 MB without breaking any visuals in the report. This was mainly a combination of running the suggested DMV against the data model, identifying column objects using the most memory, and removing them from the model. In this case, most columns removed were IDENTITY columns sitting in tables with several hundreds of millions of rows.</p><div class="formalpara" id="calibre_link-2411"><h3 class="heading1">Note</h3><p class="para3" id="calibre_link-2412">Hiding a column in the model does not affect performance. Remove unused columns from the data import logic.</p></div></section><section class="section" id="calibre_link-2413"><h4 class="heading2">Creating Summary Tables</h4><p class="simplepara" id="calibre_link-2414">Another technique that doesn’t address the overall size of the model is to create additional <span id="calibre_link-2415">summary tables

</span> inside your model. You can generate these tables either in DAX or as part of the import process in the query editor.</p><p class="simplepara" id="calibre_link-2416">If you have a large table with many rows that you need kept in its original form to meet some reporting requirements, consider creating summary tables you can use in visuals and calculations that don’t need to drill down to the finest detail of the original table.</p><p class="simplepara" id="calibre_link-2417">Take the example of the ‘Fact Sale’ table in the WideWorldImportersDW dataset. This contains 228,265 rows with detail on every sale.</p><p class="simplepara" id="calibre_link-2418">Creating a summary version of this table by Calendar Month and Customer in this dataset would reduce this down to 5,239 rows. Such a summary <span id="calibre_link-2419">table

</span> can support any visual or calculation that requires this level of detail and it is 1/50th of the size. Performance improvements using this approach are amplified when you are creating reports using tables that have many hundreds of millions of rows.</p><p class="simplepara" id="calibre_link-2420">You can create dozens of summary tables from a single large table to provide a highly customized level of performance tuning. In this event, I recommend a good naming convention to help you keep track.</p><section class="section" id="calibre_link-2421"><h5 class="heading2">
                  <span id="calibre_link-2422">Precalculating Data

</span>
                </h5><p class="simplepara" id="calibre_link-2423">Consider using calculated columns instead of calculated measures for metrics that are not required to be dynamic. An example of this might be a ranking measure that determines who are the best customers or sales people based on data in a large table. It’s possible to perform these types of calculations as calculated measures or calculated columns. However, if you don’t need to dynamically recalculate the metric to respect changing slicer or filter selections, then depending on the size of the data, using a calculated column will probably improve the performance of your model.</p></section><section class="section" id="calibre_link-2424"><h5 class="heading2">
                  <span id="calibre_link-2425">Splitting Up Unique Columns

</span>
                </h5><p class="simplepara" id="calibre_link-2426">If you have a column in your dataset that has highly unique values, such as a DateTime column that includes detail from year to millisecond, or an IDENTITY or Autonumber column, then consider splitting it into multiple columns.</p><p class="simplepara" id="calibre_link-2427">The DateTime example is straightforward in that it can be split neatly into one column that carries a value for day, while other <span id="calibre_link-2428">columns

</span> carry values for hours, minutes, or seconds. If you don’t need to report to a level of detail finer than day, then remove this information from the data model altogether.</p><p class="simplepara" id="calibre_link-2429">Look for other opportunities to split columns where the data can have multiple meanings. These might include values that represent the make and model of a car, or address data that includes a level of detail that isn’t useful for the reports, such as suburb or street.</p></section><section class="section" id="calibre_link-2430"><h5 class="heading2">
                  <span id="calibre_link-2431">Simplifying Table Structure

</span>
                </h5><p class="simplepara" id="calibre_link-2432">DAX data models can provide accurate calculations using a table structure that mirrors the table structure of your source system. This includes calculations that span many generations of a set of table relationships. However, your model will probably perform much faster if you flatten your data structures to reduce the number of relationships that need to be used per calculation.</p><p class="simplepara" id="calibre_link-2433">A good model to follow is to organize your data into fact and dimension tables. This is commonly known as a star schema and it has been proven to work well for reporting and analytic workloads.</p></section><section class="section" id="calibre_link-2434"><h5 class="heading2">
                  <span id="calibre_link-2435">Fact Tables

</span>
                </h5><p class="simplepara" id="calibre_link-2436">Start by identifying entities in your data that you would like to count, sum, and generally visualize over time. These entities should form the basis of fact tables in your model. Each row in a fact table should be an instance, activity, event, or transaction that the fact table represents. If you have 100 sales, then ideally a ‘Fact Sales’ table should have 100 rows.</p><p class="simplepara" id="calibre_link-2437">Do not try and mix multiple facts in a single table. If you need to report and analyze sales and payments, avoid the temptation of combining both sets of data in the same fact table. Have a fact table for sales and another fact table for payments.</p><p class="simplepara" id="calibre_link-2438">Avoid creating <span id="calibre_link-2439">relationships

</span> between fact tables. Many useful calculations can be performed over unrelated fact tables that share a common dimension table.</p><p class="simplepara" id="calibre_link-2440">Once you have identified the fact tables you need, bring as many columns of data from other source system tables into the fact table as you can to satisfy known reporting needs, but be careful to still retain the <em class="emphasistypeitalic">1 row = 1 fact</em> rule. If you can make the fact table 100-percent self-sufficient, you will get the best performance. Only make exceptions for columns that might be useful in a dimension table that are connected to other fact tables&mdash;for example, rather than replicate a month, quarter, and year table in every fact table, move these to a dimension table.</p><p class="simplepara" id="calibre_link-2441">Try to avoid data models that involve calculations that use data using relationships that span three or more levels.</p></section><section class="section" id="calibre_link-2442"><h5 class="heading2">Dimension Tables</h5><p class="simplepara" id="calibre_link-2443">Think of <span id="calibre_link-2444">dimension tables

</span> as filter/slicer tables that are only useful for slicing and dicing your fact tables. They generally don’t contain data you intend to count, sum, or use in calculations. If they do, consider if this data should be used in a fact table instead. Dimension tables are most useful for providing a single place for filter selections to apply across relationships to multiple fact tables.</p><p class="simplepara" id="calibre_link-2445">The first dimension table you add to any model will probably be a date table. If you have multiple fact tables, then this likely has a relationship to each of these with a value that represents a single day. Any filter/slicer selection made to any column in this table propagates down through to filter any connected fact table.</p><p class="simplepara" id="calibre_link-2446">If you have a dimension table that is only related to one table, consider combining the two into a single table.</p></section></section><section class="section" id="calibre_link-2447"><h4 class="heading2">Optimizing DAX Queries</h4><p class="simplepara" id="calibre_link-2448">It’s possible to write a query many ways and get the same result. Five people may produce five different approaches that each have unique performance characteristics. In this section, I cover some of the more useful tips and techniques for making DAX calculations more efficient. Some of these are enough to help you solve a performance issue you may encounter. Other solutions are a mix of improvements made to DAX calculations and enhancements to the underlying data structures.</p><p class="simplepara" id="calibre_link-2449">In this section, I also show you how you can use tools such as DAX Studio and SQL Server Profiler to help optimize your DAX queries.</p><section class="section" id="calibre_link-2450"><h5 class="heading2">Storage Engine vs. Formula <span id="calibre_link-2451">Engine

</span>
</h5><p class="simplepara" id="calibre_link-2452">DAX queries use two engines when running calculations: the <span id="calibre_link-2453">storage engine (SE)
</span> and the <span id="calibre_link-2454">formula engine (FE)
</span>.</p><p class="simplepara" id="calibre_link-2455">The <em class="emphasistypeitalic">storage engine</em> is the faster of the two and has the primary objective of retrieving all the data it needs to compute the query from the in-memory data stores. The storage engine is multithreaded, so it can complete multiple operations in parallel. The storage engine can perform simple calculations while retrieving data, but these need to be calculations that don’t rely on any other storage engine task that might be happening in parallel as part of the same query.</p><p class="simplepara" id="calibre_link-2456">Results from storage engine activity can be stored in the cache to help speed up subsequent queries. In the case where you have a calculated measure that is executed many times by the same visual to produce a value for each data point, this caching can play a role in helping speed up all the calculations used in a visual.</p><p class="simplepara" id="calibre_link-2457">The <em class="emphasistypeitalic">formula engine</em> is single-threaded and capable of more sophisticated logic including calculations in which the order of the steps involved is important to the result. Results from formula engine activity are not cached so they must be recalculated each time.</p><p class="simplepara" id="calibre_link-2458">When a query is passed to the DAX engine, the storage engine starts by retrieving relevant data and the formula engine completes the job.</p><p class="simplepara" id="calibre_link-2459">A good approach to use to <span id="calibre_link-2460">optimize

</span> a slow DAX <span id="calibre_link-2461">query
</span>
<span id="calibre_link-2462">
                    
                  </span> is to try and understand which components of the query are being completed by the storage engine and which are being completed by the formula engine; then see if some of the work being handled by the formula engine can be moved to the storage engine.</p><div class="para1" id="calibre_link-2463">A quick way to tell how much of your query is using the storage engine instead of the formula engine is by using DAX Studio. There is an option on the ribbon (Figure <span><a href="#calibre_link-339" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-11</a></span>) to enable server timings as well as the query plan.<figure class="figure1" id="calibre_link-339"><div class="mediaobject" id="calibre_link-2464"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig11_HTML.jpg" src="images/000006.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-11</span><p class="simplepara1">Options on the DAX Studio ribbon for turning on additional debug options</p></div></figcaption></figure>
</div><div class="para1" id="calibre_link-2465">With these options enabled, any individual query run in DAX Studio now generates additional information that shows how long the engine took to complete the query. This also shows the breakdown of how much of the overall time was used by the storage engine instead of the formula engine (Figure <span><a href="#calibre_link-340" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-12</a></span>).<figure class="figure1" id="calibre_link-340"><div class="mediaobject" id="calibre_link-2466"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig12_HTML.jpg" src="images/000046.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-12</span><p class="simplepara1">Example output of server timings for a query run in DAX Studio</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2467">Figure&nbsp;<span><a href="#calibre_link-340" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-12</a></span> show an example of a query that took a total of 15 milliseconds to complete. The first 3 <span id="calibre_link-2468">milliseconds

</span>
<span id="calibre_link-2469">
                    
                  </span>
<span id="calibre_link-2470">
                    
                  </span> were spent by the storage engine, which ran two parallel processes to collect all the data required. When the storage engine finished, the formula engine took over and needed 12 milliseconds to finish the query. The formula engine was active for 80 percent of this query, and the storage engine did not benefit from the storage engine cache.</p><p class="simplepara" id="calibre_link-2471">This information doesn’t explain which parts of your DAX query were handled by the storage engine vs. the formula engine, but it does give you a baseline for understanding how other versions of the same query behave.</p><p class="simplepara" id="calibre_link-2472">When optimizing, it is important to clear the cache each time you run an updated version of your query. If you don’t, you may get the impression that your newer version is better because the overall time is faster, where in fact it could be taking advantage of cached data from a previous query. This is easy to do in DAX Studio by setting an option on the Run button to clear the cache each time.</p><p class="simplepara" id="calibre_link-2473">To understand which components of a query are being handled by the storage engine or the formula engine, you need to dive down into a query plan generated by a trace over the server. Just as you can run traces on a Microsoft SQL server to analyze T-SQL queries, SSAS engines can provide the same ability to capture events that show various subcomponents of individual queries. Because Power BI <span id="calibre_link-2474">Desktop

</span>
<span id="calibre_link-2475">
                    
                  </span>
<span id="calibre_link-2476">
                    
                  </span> uses an SSAS engine, you can use tools such as SQL Server Profiler to capture interesting events while a query is run to show exactly how the DAX engine went about the task of completing the query. Certain events show as being activities completed by the storage engine, while others show up as belonging to the formula engine.</p><p class="simplepara" id="calibre_link-2477">This is quite an advanced topic, so apart from showing you how to run a trace over a DAX query later in this chapter and from showing you that it is this underlying trace data that DAX Studio uses to obtain the server timings, I do not dig deeper. DAX Studio shows both the physical and logical query plans used by the query in a Query Plan tab along with some pseudo-T-SQL generated by the underlying trace to show the work of each storage engine subquery.</p></section><section class="section" id="calibre_link-2478"><h5 class="heading2">
<span id="calibre_link-2479">Filtering

</span> Early and Appropriately</h5><p class="simplepara" id="calibre_link-2480">If you are tasked with producing a handwritten list of all the words in a dictionary that began with the letter X, one approach is to start by making a list of every word in the dictionary from A to Z and then cross out all the words that don’t begin with the X. Or you and five friends can each take a copy of the same dictionary and start writing words from different pages that have words starting with the letter X. The second approach is much faster due to the fact that less work is required and that it is shared.</p><p class="simplepara" id="calibre_link-2481">You can apply the same approach to DAX calculations. The earlier you can apply a filter without affecting the result, the bigger the impact doing so has on the overall time the calculation takes.</p><p class="simplepara" id="calibre_link-2482">The two DAX calculations in Listings <span><a href="#calibre_link-341" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-12</a></span> and <span><a href="#calibre_link-342" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-13</a></span> demonstrate this nicely. Both calculations return identical results. The first query shows a sum of a quantity column along with a year-to-date calculation. The data is being filtered to a specific sales territory and month of the year.</p><div class="para1" id="calibre_link-341">
                  <div class="programcode" id="calibre_link-2483"><div class="fixedline">EVALUATE</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Number],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[Sales Territory],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"SUM Qty", SUM('Fact Sale'[Quantity]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"YTD Qty", TOTALYTD(SUM('Fact Sale'[Quantity]),'Dimension Date'[Date])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City' [Sales Territory] = "Southeast"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; 'Dimension Date'[Calendar Month Number] =11</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ORDER BY</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date]</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-12</span><p class="para3">A DAX Query Using FILTER After SUMMARIZE</p></div></div></div>
                </div><div class="para1" id="calibre_link-2484">This query <span id="calibre_link-2485">produces

</span> 77 rows along with the output in Figure <span><a href="#calibre_link-343" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-13</a></span> in the Server Timing window in DAX Studio.<figure class="figure1" id="calibre_link-343"><div class="mediaobject" id="calibre_link-2486"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig13_HTML.jpg" src="images/000014.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-13</span><p class="simplepara1">The server timing output for the code in Listing <span class="calibre9"><a href="#calibre_link-341" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-12</a></span> using DAX Studio</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2487">The query took 301 milliseconds in total and spent a considerable amount of that time in the formula engine. This query was executed multiple times over a cold cache and this timing is typical.</p><p class="simplepara" id="calibre_link-2488">Listing <span><a href="#calibre_link-342" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-13</a></span> shows another query that produces the same output.</p><div class="para1" id="calibre_link-342">
                  <div class="programcode" id="calibre_link-2489"><div class="bookfrontmatter"><div class="fixedline1">EVALUATE</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR PreFilteredTable =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Fact Sale',</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Number],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[Sales Territory]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension City'[Sales Territory] = "Southeast",</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Calendar Month Number] =11</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline1">RETURN</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PreFilteredTable,&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"SUM Qty", CALCULATE(SUM('Fact Sale'[Quantity])),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"YTD Qty", TOTALYTD(SUM('Fact Sale'[Quantity]),'Dimension Date'[Date])</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">ORDER BY</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;'Dimension Date'[Date]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 8-13</span><p class="para3">Alternate Version of Listing <span><a href="#calibre_link-341" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-12</a></span> Applying a Filter <span id="calibre_link-2490">Earlier

</span> in the Logic</p></div></div></div>
                </div><div class="para1" id="calibre_link-2491">This version also produces 77 rows and the output of the Server Timing window is shown in Figure <span><a href="#calibre_link-344" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-14</a></span>.<figure class="figure1" id="calibre_link-344"><div class="mediaobject" id="calibre_link-2492"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig14_HTML.jpg" src="images/000054.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-14</span><p class="simplepara1">The server timing output for faster code in Listing <span class="calibre9"><a href="#calibre_link-342" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-13</a></span> using DAX Studio</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2493">The updated version took a total of 44 milliseconds. Both versions used five storage engine queries to retrieve the data, but in the updated query, filtering took place before the results were passed to the <span id="calibre_link-2494">SUM

</span> and TOTALYTD functions. The storage engine returned smaller batches to the formula engine. None of the storage engine queries had more than 1,464 rows, whereas the previous query had storage engine results of over 19,000 rows passed to the formula engine for extra processing.</p><p class="simplepara" id="calibre_link-2495">Hopefully this example shows you how you might take advantage of some very helpful information that is available in DAX Studio. You do not need to run every query through this process, but isolating slower calculations to be tuned and optimized in DAX Studio is an effective use of time.</p><p class="simplepara" id="calibre_link-2496">Another useful tip regarding filters in DAX, particularly the use of filter functions, is that that these functions, such as the ALL function, can often operate over tables or columns. If you can achieve the same result by using a specific column rather than an entire table, you will probably enjoy some performance gains. Passing an entire table can cause unnecessary work, especially if passing just a table column can achieve the same result.</p></section><section class="section" id="calibre_link-2497"><h5 class="heading2">
                  <span id="calibre_link-2498">SQL Server Profiler

</span>
                </h5><p class="simplepara" id="calibre_link-2499">To run a trace using Profiler, start Profiler directly or via SSMS. Make a connection to an instance of Analysis Services using a server name that your DAX engine is listening on. If you are connecting to an instance of Power BI Desktop, you need to know the port number being used by that instance. This changes each time you stop and start Power BI Desktop. DAX Studio shows the port number in use on the Status bar, otherwise you can get this information using process monitoring tools such as Resource Monitor or the Windows Sysinternals version of Process Explorer.</p><div class="para1" id="calibre_link-2500">These are some useful events to enable for each trace:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-2501">Query Begin</p></li><li class="calibre8"><p class="para2" id="calibre_link-2502">DAX Query Plan</p></li><li class="calibre8"><p class="para2" id="calibre_link-2503">Query Subcube</p></li><li class="calibre8"><p class="para2" id="calibre_link-2504">VertiPaq SE Query End</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-2505">Start the <span id="calibre_link-2506">trace

</span>, then run your DAX query, then stop or pause the trace at a point where you can review the results.</p><div class="para1" id="calibre_link-2507">The diagram in Figure <span><a href="#calibre_link-345" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-15</a></span> shows events captured by Profiler when it was used to trace the second version of the previous query. More detail is available when you click on individual rows in the trace window.<figure class="figure1" id="calibre_link-345"><div class="mediaobject" id="calibre_link-2508"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig15_HTML.jpg" src="images/000000.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-15</span><p class="simplepara1">Sample of output for code in Listing <span class="calibre9"><a href="#calibre_link-341" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-12</a></span> using Profiler</p></div></figcaption></figure>
</div><div class="para1" id="calibre_link-2509">It’s also possible to enable tracing in Power BI Desktop by turning on the Enable Tracing option in the settings under diagnostics (Figure <span><a href="#calibre_link-346" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">8-16</a></span>). This creates *.trc files that you can open and analyze using Profiler. The *.trc files are stored in the folder shown in the same setting window.<figure class="figure1" id="calibre_link-346"><div class="mediaobject" id="calibre_link-2510"><img alt="../images/456681_1_En_8_Chapter/456681_1_En_8_Fig16_HTML.jpg" src="images/000082.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-16</span><p class="simplepara1">Option in Power BI Desktop settings that allows trace files to be generated</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2511">There often plenty of options available to help your queries run faster. Some involve you modifying the data <span id="calibre_link-2512">model

</span> itself, and you can achieve others through changes to DAX calculations. In general, if you remember that calculations using the storage engine are good, and that it is also preferable to have data models that are small and simple, you are probably going to end up with a well-optimized model (and happy end users).</p><p class="simplepara" id="calibre_link-2513">Remember to also make effective use of online material. DAX has been around since 2009 and there is a fantastic community of users that share interesting ways to approach common problems.</p></section></section></section></section></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-168">
<div id="calibre_link-2514" class="calibre2">
<div id="calibre_link-2515" class="calibre3"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-2516"><div class="bookfrontmatter">©&nbsp;Philip Seamark&nbsp;2018</div><span class="pcalibre5"><span><span>Philip&nbsp;Seamark</span></span></span><span><span class="booktitle1" type="title" lang="en">Beginning DAX with Power BI</span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-3477-8_9" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">https://doi.org/10.1007/978-1-4842-3477-8_9</a></span></div></div><div class="maintitlesection"><h1 class="chaptertitle" lang="en">9.&nbsp;Practical DAX</h1></div><div class="bookfrontmatter"><div class="bookfrontmatter"><span><span>Philip&nbsp;Seamark</span><sup class="calibre6"><a href="#calibre_link-347" class="pcalibre3 pcalibre4 pcalibre1 pcalibre2 pcalibre calibre7">1</a>&nbsp;<span class="contacticon"></span></sup></span></div><div class="bookfrontmatter"><div class="bookfrontmatter" id="calibre_link-347"><span class="affiliationnumber">(1)</span><div class="bookfrontmatter">UPPER HUTT, New Zealand</div></div><div class="clearboth">&nbsp;</div></div></div><div class="bookfrontmatter"><p class="para" id="calibre_link-2517">This chapter focuses on building a model using DAX and without using external data sources. In this chapter, you build your own dataset. All data is generated using step-by-step examples that showcase various tips and techniques you may find useful.</p><p class="simplepara" id="calibre_link-2518">The final model has a structure resembling what you might use for a small organization with tables for sales, dates, and products. Because the number of rows for each table is automatically generated, you can use the final model for optimizing DAX calculations over a large dataset. By changing a few numbers here and there, you can generate a sales table with 5, 50, or 500 million rows of data with which to test different approaches to optimizing calculations.</p><p class="simplepara" id="calibre_link-2519">These step-by-step exercises rely on you using a version of DAX that can create calculated tables. This includes Power BI Desktop and SSAS Tabular but not PowerPivot for Excel 2016 (or earlier).</p><section class="section" id="calibre_link-169"><h2 class="heading">Creating a Numbers Table</h2><p class="simplepara" id="calibre_link-2520">The first step is to create a <span id="calibre_link-2521">numbers table

</span>, in this case, a single-column table with a sequence of numbers starting at 0 and running to 1,000. You will be able to use this utility table to join to other tables using range-based conditions, such as when the value in this table is less than 5. In this exercise, the numbers table is used to multiply a single row from a table into many rows.</p><p class="simplepara" id="calibre_link-2522">To create a <span id="calibre_link-2523">numbers table

</span> you have several options. Before the GENERATESERIES function became available, the only way to create this type of table was to take advantage of the CALENDAR function. Not all versions of DAX have the GENERATESERIES function. Dates in DAX are stored as integer values, so you can use the CALENDAR function to generate rows of dates that you can then convert back to integer values. In Power BI Desktop, the date December 30, 1899, is stored as 0. The value of 1 belongs to the December 31, 1899, and 2 is January 1, 1900. Interestingly, the value of &ndash;1 belongs to December 29, 1899, so if you need to represent data back in the 1600s with DAX, you can, but you need to use numbers that are in the vicinity of &ndash;100,000.</p><p class="simplepara" id="calibre_link-2524">Here is how you can create a numbers calculated table (see Figure <span><a href="#calibre_link-348" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-1</a></span>) using the CALENDAR function:</p><div class="para1" id="calibre_link-2525">
            <div class="programcode" id="calibre_link-2526"><div class="fixedline">Numbers =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALENDAR(0,1000),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"N", INT ( [Date] )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><p class="simplepara" id="calibre_link-2527">To achieve the same result using the GENERATESERIES function, the code you use to create the calculated table is</p><div class="para1" id="calibre_link-2528">
            <div class="programcode" id="calibre_link-2529"><div class="fixedline">&nbsp;Numbers =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATESERIES( 0,1000 ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"N", [Value]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div>
          </div><div class="para1" id="calibre_link-2530">Both examples produce a table with 1,001 rows called Numbers with a single column called N. The SELECTCOLUMNS function is used in both cases to rename the column to N. The INT function in the example using the CALENDAR function is used to convert the date output to its underlying number.<figure class="figure1" id="calibre_link-348"><div class="mediaobject" id="calibre_link-2531"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig1_HTML.jpg" src="images/000064.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-1</span><p class="simplepara1">A sample of the <span id="calibre_link-2532" class="calibre9">Numbers table

</span>
</p></div></figcaption></figure>
</div></section><section class="section" id="calibre_link-170"><h2 class="heading">Adding a Date Table</h2><p class="simplepara" id="calibre_link-2533">The next step is to add a <span id="calibre_link-2534">date table

</span> to the data model. You can use the DAX in Listing <span><a href="#calibre_link-349" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-1</a></span> to generate this.</p><div class="para1" id="calibre_link-349">
            <div class="programcode" id="calibre_link-2535"><div class="bookfrontmatter"><div class="fixedline1">Dates =</div><div class="fixedline1">VAR BaseTable =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;CALENDAR (&nbsp;&nbsp;DATE(2016, 1, 1), TODAY () )</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR AddYears =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BaseTable,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Year", YEAR ( [Date] )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR AddMonths =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddYears,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Month", DATE(YEAR([Date]),MONTH([Date]),1),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Month label", FORMAT ( [Date], "MMM YY" )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR AddDay =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddMonths,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Day Label", FORMAT ( [Date], "DDD d MMM YY" )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">RETURN</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;AddDay</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-1</span><p class="para3">Calculated Table to Create a Simple Date Table</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2536">This <span id="calibre_link-2537">statement

</span> begins with the single column output of the CALENDAR function, which is then assigned to the BaseTable variable. The virtual table has one row per day starting on January 1, 2016, and running sequentially through until the current date.</p><p class="simplepara" id="calibre_link-2538">You can use additional variables to incrementally add columns throughout the calculation. In this code, the AddYears variable takes the table represented by the BaseTable variable and appends a column called “Year” using the YEAR function to extract a value from the [Date] column.</p><p class="simplepara" id="calibre_link-2539">The AddMonths variable uses ADDCOLUMNS to append two additional columns. These allow rows to be grouped into calendar months. The “Month” column uses the DateTime datatype and converts each date value back to be the first date for the month it represents. The “Month label” column uses the FORMAT function to convert dates to text. The format string notation of MMM YY means dates such as July 4, 2018, are converted to a text value of “Jul 18”. You need to set the Sort by Column property of the “Month label” column to use the “Month” column, otherwise values in this column appear alphabetically when used in visuals.</p><div class="para1" id="calibre_link-2540">The final AddDay variable uses the ADDCOLUMNS function to add a column called “Day Label”. This uses the FORMAT function to convert the date from each row into a text value using the format string, “DDD d MMM YY”. This format string converts July 4, 2018, to “Wed 4 Jul 18”. This text-based column needs to have its Sort by Column property set to the "Date" column to ensure sensible sorting when used in visuals. Figure <span><a href="#calibre_link-350" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-2</a></span> shows the first few rows generated by the date table.<figure class="figure1" id="calibre_link-350"><div class="mediaobject" id="calibre_link-2541"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig2_HTML.jpg" src="images/000010.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-2</span><p class="simplepara1">Sample <span id="calibre_link-2542" class="calibre9">output

</span> of the date table created by Listing <span class="calibre9"><a href="#calibre_link-349" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-1</a></span>
</p></div></figcaption></figure>
</div></section><section class="section" id="calibre_link-171"><h2 class="heading">Creating the Sales Table</h2><p class="simplepara" id="calibre_link-2543">The next table you need to create is a <span id="calibre_link-2544">sales table

</span>. The objective is to generate a table that shows sales over a timespan that you can use to build a sales report. This section covers each step you need to use showing the DAX and explaining the code.</p><p class="simplepara" id="calibre_link-2545">The first task is to generate a random number of sales for each day. The DAX for this is shown in Listing <span><a href="#calibre_link-351" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-2</a></span>.</p><div class="para1" id="calibre_link-351">
            <div class="programcode" id="calibre_link-2546"><div class="fixedline">Sales =</div><div class="fixedline">VAR FirstTable =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dates,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Numbers</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[N] &lt; RANDBETWEEN ( 2, 7 )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Date",[Date])</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-2</span><p class="para3">Excerpt from a Calculated Table to Create a Sales Table</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2547">The output of this statement is a table with a single column of dates. Each date occurs anywhere from two to six times and effectively creates a placeholder row that you can use to add columns. The CROSSJOIN and FILTER <span id="calibre_link-2548">functions

</span> are used to combine the existing date and numbers tables you created earlier. Without the FILTER function, the CROSSJOIN matches each row from the date table to all 1,001 rows in the numbers table. It’s unlikely that a real sales table would have exactly 1,001 sales per day, so the FILTER function uses the <span id="calibre_link-2549">RANDBETWEEN function
</span> to create a more randomized number of sales per day. In this case, each day has somewhere between two and seven sales transactions.</p><p class="simplepara" id="calibre_link-2550">You can set the lower boundary to zero so you have some days with no sales, and you can increase the upper bound as one way of generating a larger set of sales.</p><p class="simplepara" id="calibre_link-2551">You can use the <span id="calibre_link-2552">SELECTCOLUMNS function
</span> to ensure that only the columns you need from the date and numbers tables flow through to the output, which is assigned as a virtual table to the FirstTable variable in Listing <span><a href="#calibre_link-351" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-2</a></span>.</p><p class="simplepara" id="calibre_link-2553">The next task is to add a column called “Product” (Listing <span><a href="#calibre_link-352" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-3</a></span>) that carries a value to represent the product that was sold.</p><div class="para1" id="calibre_link-352">
            <div class="programcode" id="calibre_link-2554"><div class="fixedline">VAR AddPRoduct =</div><div class="fixedline">ADDCOLUMNS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FirstTable,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Product",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;VAR myMake =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RANDBETWEEN ( 65, 90 )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;VAR myModel =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FORMAT ( RANDBETWEEN ( 1, 5 ), "-#" )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REPT ( UNICHAR ( myMake ), 3 ) &amp; myModel</div><div class="fixedline">)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-3</span><p class="para3">Adding a Product Column to Listing <span><a href="#calibre_link-351" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-2</a></span>
</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2555">This code starts by using the FirstTable variable as input for the ADDCOLUMNS function. A nested variable called Make begins a new level of variable scope. This scope is separated from the layer being used by the FirstTable and AddProduct variables, and the RETURN function is used to drop a single value back as the third parameter of the <span id="calibre_link-2556">ADDCOLUMNS function
</span>
<span id="calibre_link-2557">
              
              
            </span>. You can achieve the same result without using a nested variable, but it would be harder to read.</p><p class="simplepara" id="calibre_link-2558">The myMake variable uses the RANDBETWEEN function to generate a random number between 65 and 90. These numbers are used because they represent the range on the ASCII table for the uppercase letters of the alphabet. The value of 65 represents the letter “A,” 66 is “B,” and this continues to 90, which is the uppercase “Z.” The random number is stored in the myMake variable.</p><p class="simplepara" id="calibre_link-2559">The myModel variable uses the RANDBETWEEN function to generate a random number between 1 and 5. This is then converted to text using the FORMAT function with a format string of “-#”. The hyphen in the format string is preserved while the hashtag placeholder tells FORMAT where the number should go. This creates a string such as “-1” or “-5”.</p><p class="simplepara" id="calibre_link-2560">The final RETURN statement concatenates the myMake and myModel variables together to produce a text value that looks like a product code. The number stored in myMake is first converted to an uppercase letter between A and Z using the UNICHAR function. The output of the UNICHAR function is then repeated three times using the REPT function. This turns a value of “A” into “AAA”, and when combined with the text in the myMake variable, it produces a result such as “AAA-4” or “DDD-1”.</p><div class="para1" id="calibre_link-2561">At this point the output of the calculated table looks like Figure <span><a href="#calibre_link-353" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-3</a></span>.<figure class="figure1" id="calibre_link-353"><div class="mediaobject" id="calibre_link-2562"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig3_HTML.jpg" src="images/000045.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-3</span><p class="simplepara1">Sample output of the sales table including Listing <span class="calibre9"><a href="#calibre_link-352" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-3</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2563">UNICHAR is a great function that you can use to add KPI indicators, such as trend arrows or emoji pictures, to reports to emphasize a point.</p><p class="simplepara" id="calibre_link-2564">The next column that is added represents a <span id="calibre_link-2565">quantity

</span> sold (Listing <span><a href="#calibre_link-354" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-4</a></span>). This builds on the existing code by passing the AddProduct variable as the first parameter of the ADDCOLUMNS function.</p><div class="para1" id="calibre_link-354">
            <div class="programcode" id="calibre_link-2566"><div class="fixedline">VAR AddQuantity =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddProduct,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Qty",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR Q = RANDBETWEEN ( 1, 1000 )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN 5 - INT ( LOG ( Q, 4 ) )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-4</span><p class="para3">Adding the Qty Column to the Sales Table</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2567">The ADDCOLUMNS function appends a single column called “Qty”. A nested variable scope begins here in the third parameter. The intention is not only to generate a random number between 1 and 5, but to make sure the distribution of random values is not even. In a real-life sales table, it’s likely that most transactions will involve a quantity of 1. The next most common is 2 and the number of purchases reduces as the quantity increases.</p><div class="para1" id="calibre_link-2568">The LOG function used here applies a logarithmic distribution for quantities between 1 and 5. When this code is added to the calculated table statement and plotted on a visual using the count of each value in the Qty <span id="calibre_link-2569">column

</span> (Figure <span><a href="#calibre_link-355" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-4</a></span>), it shows most transactions are single-quantity transactions. The number of transactions with a quantity of 2 is nearly half that of 1, whereas transactions using a quantity of 3 drop off by more than half.<figure class="figure1" id="calibre_link-355"><div class="mediaobject" id="calibre_link-2570"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig4_HTML.jpg" src="images/000034.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-4</span><p class="simplepara1">Chart showing distribution of quantity values</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2571">This is the desired effect of the calculation and you can tweak it further to suit your needs.</p><div class="para1" id="calibre_link-2572">The output of the sales calculated table using the code so far is similar to Figure <span><a href="#calibre_link-356" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-5</a></span>.<figure class="figure1" id="calibre_link-356"><div class="mediaobject" id="calibre_link-2573"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig5_HTML.jpg" src="images/000018.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-5</span><p class="simplepara1">Sample of the sales table including the QTY column</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2574">The next column added is for Price. The code for this column is shown in Listing <span><a href="#calibre_link-357" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-5</a></span>.</p><div class="para1" id="calibre_link-357">
            <div class="programcode" id="calibre_link-2575"><div class="fixedline">VAR AddPrice =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddQuantity,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Price", DIVIDE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RANDBETWEEN ( 1, 1e5 ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100 )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-5</span><p class="para3">Adding a Price Column to the Sales Table</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2576">The ADDCOLUMNS function appends a column to the table stored in the AddQuantity variable. The new column is called “Price” and the formula uses the RANDBETWEEN <span id="calibre_link-2577">function

</span> to generate a number between 1 and 100,000. The notation of 1e5 shows that scientific notation can be used as an option. The value of 1e5 is shorthand for 1 × 10<sup class="calibre18">5</sup> (or 1 × 10 to the power of 5), which equals 100,000.</p><p class="simplepara" id="calibre_link-2578">Once this random number is generated, the DIVIDE function is used to convert this to a value that represents a value of 1,000 or less, with two decimal places. A feature of the DIVIDE function is that it handles “divide by zero” errors better than the / operator; however, the / operator performs better and you should give it preference if there is no chance of a “divide by zero” error. Here is an example:</p><div class="para1" id="calibre_link-2579">
            <div class="programcode" id="calibre_link-2580"><div class="fixedline">RANDBETWEEN( 1, 1e5) / 100</div></div>
          </div><p class="simplepara" id="calibre_link-2581">In Listing <span><a href="#calibre_link-357" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-5</a></span>, there is no attempt to align prices across product codes. If having price values consistent across products is important for your testing, you can shift the logic shown here to generate a random price to a product calculated table and add it to the sales table via a relationship.</p><p class="simplepara" id="calibre_link-2582">The final column that needs to be added combines [Price] and [Qty] to create a [Total] column. This demonstrates that a new column can use values derived from earlier parts of the same code.</p><p class="simplepara" id="calibre_link-2583">Listing <span><a href="#calibre_link-358" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-6</a></span> is the full version of the code that creates the sales calculated table.</p><div class="para1" id="calibre_link-358">
            <div class="programcode" id="calibre_link-2584"><div class="bookfrontmatter"><div class="fixedline1">Sales =</div><div class="fixedline1">VAR FirstTable =</div><div class="fixedline1">SELECTCOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dates,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Numbers</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[N] &lt; RANDBETWEEN ( 2, 7 )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;"Date",[Date]) <span id="calibre_link-2585">
                    
                    
                  </span>
</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR AddPRoduct =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FirstTable,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Product",</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR Make =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RANDBETWEEN ( 65, 90 )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR myModel =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FORMAT ( RANDBETWEEN ( 1, 5 ), "-#" )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REPT ( UNICHAR ( MAke ), 3 ) &amp; myModel</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR AddQuantity =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddPRoduct,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Qty",</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VAR Q = RANDBETWEEN ( 1, 1000 )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RETURN 5 - INT ( LOG ( Q, 4 ) )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR AddPrice =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddQuantity,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Price", DIVIDE (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RANDBETWEEN ( 1, 1e5 ),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100 )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="fixedline1">
                  <strong class="emphasistypebold">VAR AddTotal =</strong>
                </div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">ADDCOLUMNS ( AddPrice, "Total", [Price] * [Qty] )</strong>
</div><div class="fixedline1">
                  <strong class="emphasistypebold">RETURN</strong>
                </div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;<strong class="emphasistypebold">AddTotal</strong>&nbsp;&nbsp;&nbsp;&nbsp;</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-6</span><p class="para3">The Complete Calculated Table for the Sales Table</p></div></div></div>
          </div><div class="para1" id="calibre_link-2586">Figure&nbsp;<span><a href="#calibre_link-359" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-6</a></span> shows a sample of the table that uses this code.<figure class="figure1" id="calibre_link-359"><div class="mediaobject" id="calibre_link-2587"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig6_HTML.jpg" src="images/000048.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-6</span><p class="simplepara1">Sample output of the <span id="calibre_link-2588" class="calibre9">sales

</span> table including the Total column</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2589">The table now has five columns and potentially hundreds of millions of rows. You can control the number of rows with the calculation that is used to generate the numbers table along with the FILTER criteria for the FirstTable variable. Bear in mind that each change you make to the any part of any of the calculated tables causes the data to recalculate for every table in the model. This generates new values each time but could take a long time to calculate if you have it configured to generate extremely large datasets.</p><p class="simplepara" id="calibre_link-2590">The sales table can now be related to the date table using the [Date] column in each table.</p></section><section class="section" id="calibre_link-172"><h2 class="heading">
            <span id="calibre_link-2591">Optimizing Sales

</span>
          </h2><p class="simplepara" id="calibre_link-2592">The data model now has a detailed sales table with rows that represent individual transactions. This table could grow to be very large. The sales table could have the same product appear in multiple rows for the same day. This is more likely to happen if the code to generate the sales table is deliberately set to generate a very large table. When it comes to building reports using tables in the dataset, not all report visuals need to use the finest level of detail available in the larger tables.</p><p class="simplepara" id="calibre_link-2593">For instance, if you have a visual that only needs to show the sum of the Qty column by day and never by product, using the sales table can be quite an inefficient approach.</p><p class="simplepara" id="calibre_link-2594">An alternative is to generate a summarized version of the sales table grouped by day, but have no ability to slice and dice by product.</p><p class="simplepara" id="calibre_link-2595">The code to generate a calculated table for this is shown in Listing <span><a href="#calibre_link-360" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-7</a></span>.</p><div class="para1" id="calibre_link-360">
            <div class="programcode" id="calibre_link-2596"><div class="fixedline">Daily Summary =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZECOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales'[Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Items Sold", SUM('Sales'[Qty]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Revenue", SUM('Sales'[Total])&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-7</span><p class="para3">Summary of the Calculated Table of the Sales Table in Listing <span><a href="#calibre_link-358" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-6</a></span>
</p></div></div></div>
          </div><p class="simplepara" id="calibre_link-2597">This creates a three-column table that summarizes multiple lines per ‘Sales’[Date] down to a single line while generating a value for each row using the SUM function to provide aggregate totals over the Qty and Total columns.</p><p class="simplepara" id="calibre_link-2598">A visual using this table is going to be faster than one using the sales table, especially if the sales table ends up with a very large number of rows.</p><p class="simplepara" id="calibre_link-2599">A downside of creating summary tables such as this is that they increase the memory footprint of the overall data model and make the data refresh process take longer. The other obvious downside is that any visual using the summary table can only be sliced and diced by the grain in the table, which in this case is [Date] and not [Product].</p><p class="simplepara" id="calibre_link-2600">If you have a <span id="calibre_link-2601">report

</span> that is slow to interact with and does not use summary tables, this is a strategy well worth considering.</p></section><section class="section" id="calibre_link-173"><h2 class="heading">Calculated Columns vs. Calculated Measures</h2><p class="simplepara" id="calibre_link-2602">A common question asked by people new to data modelling with DAX (and some not so new) is along the lines of “When should I use a calculated measure and when should I use a calculated column?” This is a fair question and confusion can be caused by the fact that usage of these can overlap. It’s possible to show the same value in a report that comes from a calculated column as comes from a calculated measure.</p><p class="simplepara" id="calibre_link-2603">The main difference between calculated columns and calculated measures is the point in time the calculation is executed and how the result of the calculation is stored.</p><section class="section" id="calibre_link-174"><h3 class="heading">
              <span id="calibre_link-2604">Calculated Columns

</span>
            </h3><p class="simplepara" id="calibre_link-2605">With calculated columns, the DAX expression used by the calculation is only executed when data for the table is refreshed. The expression is calculated once for every row in the table, and the single value generated by the calculation is stored as the value in the column for that row and it cannot be changed. It’s as if the value generated by the calculated column existed in the source data that was used to import for the table.</p><p class="simplepara" id="calibre_link-2606">Consider calculated columns as part of the data-load process. These calculations execute as one of the very last steps of the data-load process and no user interaction is involved.</p><p class="simplepara" id="calibre_link-2607">Complex <span id="calibre_link-2608">calculated columns

</span> over larger data sets make data refreshing take longer. If the data model is configured to refresh once a day in the early hours of the morning, however, this should have only a minor impact on users of your reports.</p><p class="simplepara" id="calibre_link-2609">The values generated by calculated columns are stored physically in the data model, which means columns added to very large tables may have a noticeable effect on the memory size of the data model.</p><p class="simplepara" id="calibre_link-2610">Calculated columns are row based, meaning they can quickly perform calculations if all the information required is contained within the same row. Calculations can still use data from rows other than the current row.</p></section><section class="section" id="calibre_link-175"><h3 class="heading">Calculated Measures</h3><p class="simplepara" id="calibre_link-2611">With calculated measures, the DAX expression could be executed every time a page loads or when a user changes a filter or slicer selection. The DAX expression contained within the calculated measure is executed once for every value that uses it in a report. If a calculated measure is used in a <span id="calibre_link-2612">table or matrix visual


</span>, it is executed as many times as there are cells in the grid that use it to show a value. When one is used on a line chart visual with 100 points in a series, it executes 100 times for each point, with each execution having a slightly different filter context.</p><p class="simplepara" id="calibre_link-2613">Calculated measures are dynamic and respond to user interaction. They recalculate quickly and often but do not store output in the data model, so they have no impact on the physical size of the data model. Increasing the number of calculated measures in your data model has no impact on speed or size of the model at rest.</p><p class="simplepara" id="calibre_link-2614">Calculated measures are quick to process calculations using a single column over many rows, but you can still write them in a way that allows row-based data processing using <span id="calibre_link-2615">iterators


</span>.</p><p class="simplepara" id="calibre_link-2616">To better understand the difference between a calculated column and a calculated measure, let’s look at how a report requirement might be handled using both options. In Listing <span><a href="#calibre_link-361" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-8</a></span> the requirement is to show a cumulative sum over the ‘Daily Summary’[Sum of Revenue] column from the recently created calculated table in Listing <span><a href="#calibre_link-360" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-7</a></span>.</p><div class="para1" id="calibre_link-361">
              <div class="programcode" id="calibre_link-2617"><div class="fixedline">Calculate Revenue as Column =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Daily Summary'[Sum of Revenue]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL('Daily Summary'),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Daily Summary'[Date]&lt;=EARLIER('Daily Summary'[Date])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-8</span><p class="para3">Cumulative Sum as Calculated <span class="emphasisfontcategorynonproportional">Column</span> Is Added to the Calculated Table in Listing <span><a href="#calibre_link-360" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-7</a></span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2618">This calculation executes as many times as there are rows in the <span id="calibre_link-2619">‘Daily Summary’ table


</span>. The <span id="calibre_link-2620">FILTER function


</span> allows each execution of the SUM function to use a different set of values each time. The execution for the row on the oldest day (January 1, 2016) only presents one row to the SUM function. The execution of the SUM expression for the row for January 2, 2012, uses two values. These two executions can take place in any order and still produce the same result.</p><p class="simplepara" id="calibre_link-2621">Once the calculated column has been added, the data model is now larger. In this case, all values in the new column are unique, so there is very little data compression.</p><p class="simplepara" id="calibre_link-2622">Now consider the same calculation but as a calculated measure (Listing <span><a href="#calibre_link-362" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-9</a></span>).</p><div class="para1" id="calibre_link-362">
              <div class="programcode" id="calibre_link-2623"><div class="fixedline">Calculate Revenue as Measure =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM('Daily Summary'[Sum of Revenue]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLSELECTED('Daily Summary'[Date]),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Daily Summary'[Date]&lt;=MAX('Daily Summary'[Date])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-9</span><p class="para3">Cumulative Sum as a Calculated Measure Added to the Calculated Table in Listing <span><a href="#calibre_link-360" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-7</a></span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2624">In this case, adding the calculated measure to the model doesn’t execute the code. The calculated measure remains dormant until it is used in a visual. Once the calculated measure is used in a visual, it is executed once for every value it needs to generate for a visual. Typically this is the number of items in an axis, row, or column header.</p><p class="simplepara" id="calibre_link-2625">The syntax of the calculated measure and column are very similar. Both use the CALCULATE function and the same core SUM expression over the [Sum of Revenue] column. Both apply an instruction to tell the DAX engine what data can be used by the SUM function.</p><div class="para1" id="calibre_link-2626">Finally, when both are added to a table visual along with the <span id="calibre_link-2627">‘Daily Summary’[Date] field


</span>, you see the result in Figure <span><a href="#calibre_link-363" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-7</a></span>.<figure class="figure1" id="calibre_link-363"><div class="mediaobject" id="calibre_link-2628"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig7_HTML.jpg" src="images/000056.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-7</span><p class="simplepara1">Output of the code from Listings <span class="calibre9"><a href="#calibre_link-361" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-8</a></span> and <span class="calibre9"><a href="#calibre_link-349" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-9</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2629">The two columns produce an identical result for each row in the table. The <span id="calibre_link-2630">[Calculate Revenue as Column]


</span> simply retrieves data directly from the column in memory and no DAX computations are required. Each cell in the [Calculate Revenue as Measure] column runs the code in the calculated measure. Each execution of the measure has a slightly different query context. In this case the query context is from the row header filtering on each [Date].</p><p class="simplepara" id="calibre_link-2631">If you analyze both approaches using DAX Studio, you start to see how the two differ in terms of overall performance.</p><p class="simplepara" id="calibre_link-2632">The first test uses the calculated column to see how much work was required by the model to produce values for the visual. The option to clear the cache on each run is turned on as is the ability to view the server timings and query plan (Listing <span><a href="#calibre_link-364" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-10</a></span>).</p><div class="para1" id="calibre_link-364">
              <div class="programcode" id="calibre_link-2633"><div class="fixedline">EVALUATE</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Daily Summary'</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, "Date", 'Daily Summary'[Date]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, "Calculate Revenue as Column", 'Daily Summary'[Calculate Revenue as Column]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) ORDER BY [Date]</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-10</span><p class="para3">DAX Query to Test the Performance of Listing <span><a href="#calibre_link-361" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-8</a></span> Using DAX Studio</p></div></div></div>
            </div><div class="para1" id="calibre_link-2634">Running this calculation ten times over a cold cache yields an average total execution of around 12 milliseconds. As you can see in Figure <span><a href="#calibre_link-365" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-8</a></span>, the majority of that output time (usually 90 percent) was spent in the formula engine with a very small amount being spent in the storage engine.<figure class="figure1" id="calibre_link-365"><div class="mediaobject" id="calibre_link-2635"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig8_HTML.jpg" src="images/000003.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-8</span><p class="simplepara1">
<span id="calibre_link-2636" class="calibre9">Server timing output


</span> of code from Listing <span class="calibre9"><a href="#calibre_link-364" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-10</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2637">Listing <span><a href="#calibre_link-366" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-11</a></span> shows the same test using the calculated measure instead of the calculated column. Once again, DAX Studio is used to capture the server timings of the query over a cold cache.</p><div class="para1" id="calibre_link-366">
              <div class="programcode" id="calibre_link-2638"><div class="fixedline">EVALUATE</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Daily Summary'</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, "Date", 'Daily Summary'[Date]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;, "Calculate Revenue as Measure", [Calculate Revenue as Measure]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) ORDER BY [Date]</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-11</span><p class="para3">
<span id="calibre_link-2639">DAX Query Testing


</span> the Performance of Listing <span><a href="#calibre_link-362" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-9</a></span> Using DAX Studio</p></div></div></div>
            </div><div class="para1" id="calibre_link-2640">This code produces identical output except it uses a calculated measure instead of a calculated column. Running the query many times yielded average query times around the 1.4 second mark (1,400 milliseconds), usually with 99 percent of that being spent in the formula engine (Figure <span><a href="#calibre_link-367" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-9</a></span>).<figure class="figure1" id="calibre_link-367"><div class="mediaobject" id="calibre_link-2641"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig9_HTML.jpg" src="images/000075.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-9</span><p class="simplepara1">
<span id="calibre_link-2642" class="calibre9">Server timing output


</span> of the code from Listing <span class="calibre9"><a href="#calibre_link-366" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-11</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2643">Although this is slower, it is no surprise. The calculated column has the advantage of being precalculated. The time spent by the calculated column to generate the data for the column in the first place is around the same as what we see here with the calculated measure.</p><p class="simplepara" id="calibre_link-2644">Let’s look at the two calculations and compare them on the flexibility front. After adding a relationship between the <span id="calibre_link-2645">‘Dates’ and ‘Daily Summary’ tables


</span>, a slicer is added to the same report page that uses the ‘Dates’[Year] column. When this slicer is set to 2017, the result in Figure <span><a href="#calibre_link-368" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-10</a></span> can be observed using two visuals.</p><div class="para1" id="calibre_link-2646">First, the table visual shows that the calculated measure is now showing different values to the calculated column. The reason for this is the values being generated by each new execution of the calculated measure now have a different filter context than they did before. The SUM expression within the calculated measure no longer considers rows that belong to 2016 and 2018. The effect of this additional filtering means the values have been reset and are now only cumulative from the start of 2017.<figure class="figure1" id="calibre_link-368"><div class="mediaobject" id="calibre_link-2647"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig10_HTML.jpg" src="images/000051.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-10</span><p class="simplepara1">
<span id="calibre_link-2648" class="calibre9">Table and line chart


</span> visual showing the results from Listing <span class="calibre9"><a href="#calibre_link-361" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-8</a></span> and <span class="calibre9"><a href="#calibre_link-362" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-9</a></span> with the slicer set to 2017</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2649">The column simply outputs the same precalculated values as before. Nothing has changed except the slicer simply stops the visuals from plotting values for dates other than those in 2017.</p><p class="simplepara" id="calibre_link-2650">So, let’s revisit the question I posed at the beginning of this section: “When should I use a calculated column vs. a calculated measure?”</p><p class="simplepara" id="calibre_link-2651">If you want the fastest result and have little need to slice and dice data in different ways, a calculated column is a good choice. If you want to have values that react and respond to user interaction, then calculated measures are a good choice.</p><p class="simplepara" id="calibre_link-2652">If you have a problem with the speed and performance of an interactive report, the best place to start looking is probably the code used in your calculated measures rather than the code from your calculated columns.</p></section><section class="section" id="calibre_link-176"><h3 class="heading">Show All Sales for the&nbsp;Top Ten Products</h3><p class="simplepara" id="calibre_link-2653">To extend on the data you’ve built so far, let’s look at a few examples of how to build some additional summary tables using different techniques. The first example creates a table that holds every sale record but just displays the top ten products by revenue. The first step is to identify which products should be considered top-ten products. Then, using this list, a new table is created that uses all sales filtered for just these products.</p><p class="simplepara" id="calibre_link-2654">The DAX for the calculated table is shown in Listing <span><a href="#calibre_link-369" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-12</a></span>.</p><div class="para1" id="calibre_link-369">
              <div class="programcode" id="calibre_link-2655"><div class="bookfrontmatter"><div class="fixedline1">All Sales for Top 10 Products =</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR InnerGroup =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZECOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Group BY --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales'[Product],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation Column --</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sum of Revenue", SUM('Sales'[Total])</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR Top10PRoducts =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;TOPN(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InnerGroup,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Sum of Revenue],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DESC</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">RETURN</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;NATURALINNERJOIN (</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales',</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Top10PRoducts</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-12</span><p class="para3">Calculated Table Showing Sales for the <span id="calibre_link-2656">Best Ten Products


</span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2657">The first variable in this calculation uses the <span id="calibre_link-2658">SUMMARIZECOLUMNS function


</span> to create a table expression aggregated over the ‘Sales’[Product] column. This produces an unsorted working table with one row per product. Each product carries a value in the “Sum of Revenue” column that shows an aggregate of total sales over all time. This might be an opportunity to tweak the filtering so it only considers a date range that is recent and relative to the current period&mdash;for example, you might revise it so it only considers sales for the last three months.</p><p class="simplepara" id="calibre_link-2659">The second step uses the <span id="calibre_link-2660">TOPN function


</span> to identify and return the top ten rows from the <span id="calibre_link-2661">InnerGroup table expression


</span> when they are sorted by [Sum of Revenue] in descending order. The TOPN function is a filter function, so it returns a table with the same number of columns as in the InnerGroup variable to the Top10Products variable but in this case only ten rows.</p><p class="simplepara" id="calibre_link-2662">You can tweak this function to look for a different number of products at the top or bottom using the ordered table. To find the products with the least sales, simply change the order by parameter from DESC to ASC.</p><p class="simplepara" id="calibre_link-2663">An alternative to using the TOPN function is to assign a ranking column to the InnerGroup variable, which can then use the value in the ranking column to filter the table. You could use the DAX example in Listing <span><a href="#calibre_link-370" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-13</a></span> as an alternative. Figure <span><a href="#calibre_link-371" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-11</a></span> shows the output from this listing.</p><div class="para1" id="calibre_link-370">
              <div class="programcode" id="calibre_link-2664"><div class="bookfrontmatter"><div class="fixedline1">VAR AddRankColumn =&nbsp;&nbsp;</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;ADDCOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InnerGroup,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"My Rank",RANKX( InnerGroup, [Sum of Revenue] )</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR Top10PRoducts =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddRankColumn,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[My Rank]&lt;=10</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-13</span><p class="para3">Alternative DAX That Could Be Used in Listing <span><a href="#calibre_link-369" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-12</a></span> in Place of the <span id="calibre_link-2665">TOPN Function


</span>
</p></div></div></div>
              <figure class="figure1" id="calibre_link-371"><div class="mediaobject" id="calibre_link-2666"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig11_HTML.jpg" src="images/000084.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-11</span><p class="simplepara1">Sample output of the code in Listing <span class="calibre9"><a href="#calibre_link-369" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-12</a></span> using the rank column added in Listing <span class="calibre9"><a href="#calibre_link-370" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-13</a></span>
</p></div></figcaption></figure>
            </div><p class="simplepara" id="calibre_link-2667">An advantage of adding a rank column like the one in Figure <span><a href="#calibre_link-371" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-11</a></span> instead of the <span id="calibre_link-2668">TOPN function


</span> is that you can use the data in additional calculations such as for performing comparisons of ranking between periods. For instance, you could create two working tables that show an aggregation and ranking of sales for products over contiguous periods. You could then generate a filtered table to show products that have improved (or deteriorated) between the two periods.</p><p class="simplepara" id="calibre_link-2669">This variation uses the <span id="calibre_link-2670">FILTER function


</span> over the AddRankColumn table expression. If you want to identify the bottom items, the RANKX function takes an optional parameter to sort the data DESC or ASC. This allows the FILTER function to use the &lt;=10 predicate to find the products with the lowest values for sales.</p><p class="simplepara" id="calibre_link-2671">At this point, both versions have a table expression with just ten rows that should represent the products with the best sales.</p><p class="simplepara" id="calibre_link-2672">The last step is to return a copy of the raw sales data filtered for just the products contained in the Top10Products variable. The <span id="calibre_link-2673">NATURALINNERJOIN function


</span> works well for this with the final RETURN statement performing the equivalent of a T-SQL INNER JOIN between the 'Sales' table and the table expression contained in the Top10Products variable.</p><p class="simplepara" id="calibre_link-2674">The NATURALINNERJOIN function automatically creates join criteria using columns that exist in both tables that have the same name, datatype, and lineage. Multiple column can be used in the join, but in this case, only the [Product] column meets all three requirements. Because the [Product] column in the Top10Products variable can be traced back to the sales table as its origin (via several working variables), it meets the lineage requirement.</p><p class="simplepara" id="calibre_link-2675">The <span id="calibre_link-2676">CALCULATETABLE function


</span> can be used in place of NATURALINNERJOIN. The parameter signature is the same for both functions. NATURALINNERJOIN is performed in the formula engine, while CALCULATETABLE (‘Sales’, Top10Products) pushes the filtering operation to the storage engine.</p><p class="simplepara" id="calibre_link-2677">Columns other than [Product] from both tables used in the join are retained. The <span id="calibre_link-2678">SELECTCOLUMNS function


</span> can be used to control which columns are returned by removing or renaming any unwanted columns.</p><div class="para1" id="calibre_link-2679">A sample of the final table should look something like Figure <span><a href="#calibre_link-372" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-12</a></span>.<figure class="figure1" id="calibre_link-372"><div class="mediaobject" id="calibre_link-2680"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig12_HTML.jpg" src="images/000067.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-12</span><p class="simplepara1">Sample output of the calculated table in Listing <span class="calibre9"><a href="#calibre_link-369" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-12</a></span>
</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2681">The values in these columns are all based on random numbers so it’s the structure that should match your version rather than values.</p><p class="simplepara" id="calibre_link-2682">This calculated table is rebuilt each time your data model is refreshed. Once built, it provides you with a smaller and faster table to use with visuals that only need to work with the bestselling products. This is especially useful if the number of rows in the 'Sales' table grows to be very large.</p></section><section class="section" id="calibre_link-177"><h3 class="heading">Double Grouping</h3><p class="simplepara" id="calibre_link-2683">A more complex scenario might involve a requirement to perform two or more layers of summarization over data using multiple working tables to generate a new summary table.</p><p class="simplepara" id="calibre_link-2684">Consider a requirement to show a summary table with one row for every product in the sales table, along with the average value for the best ten days for each value. The challenge here is that the best ten days involve different days for each product. Once the best ten days are known for each product, an average can then be generated.</p><div class="para1" id="calibre_link-2685">The following technique makes use of these:<div class="bookfrontmatter"><ul class="unorderedlistmarkbullet"><li class="calibre8"><p class="para2" id="calibre_link-2686">SUMMARIZECOLUMNS</p></li><li class="calibre8"><p class="para2" id="calibre_link-2687">GENERATE</p></li><li class="calibre8"><p class="para2" id="calibre_link-2688">GROUPBY and CURRENTGROUP</p></li><li class="calibre8"><p class="para2" id="calibre_link-2689">MAXX iterator function</p></li><li class="calibre8"><p class="para2" id="calibre_link-2690">An interesting technique to derive a RANK</p></li></ul></div>
</div><p class="simplepara" id="calibre_link-2691">The first step of several is to create a working table (Listing <span><a href="#calibre_link-373" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-14</a></span>) that will be used as a summary of the daily sales for each product. The raw data may contain multiple transactions for the same product on the same day. This will be the first layer of summarization performed.</p><div class="para1" id="calibre_link-373">
              <div class="programcode" id="calibre_link-2692"><div class="fixedline">VAR InnerGroup =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZECOLUMNS(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Group BY --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales'[Product],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'Sales'[Date],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation Column --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Daily Revenue", SUM('Sales'[Total])</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-14</span><p class="para3">
<span id="calibre_link-2693">Summary Calculated Table


</span> of the Sales Table in Listing <span><a href="#calibre_link-358" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-6</a></span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2694">The <span id="calibre_link-2695">InnerGroup variable


</span> stores a three-column table showing daily sales for every product for every day it has sales. The next step is to identify which days happen to be the best ten days for each product. This normally involves applying a product-specific ranking value over the [Daily Revenue] column. The <span id="calibre_link-2696">RANKX iterator


</span> would provide a way to add a column to the table at this point that ranks each row in relation to every other row in the table. But what you need here is a way to have a column that ranks each day of sales <em class="emphasistypeitalic">per product</em>.</p><p class="simplepara" id="calibre_link-2697">One technique is to apply the three steps in Listing <span><a href="#calibre_link-374" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-15</a></span> to the calculation.</p><div class="para1" id="calibre_link-374">
              <div class="programcode" id="calibre_link-2698"><div class="bookfrontmatter"><div class="fixedline1">VAR CopyOfSummaryTable =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTCOLUMNS(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;InnerGroup,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"ProductA",[Product],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"DateA",[Date],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Daily RevenueA",[Daily Revenue],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"RowCounter", 1</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR CrossJoinTables =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GENERATE( CopyOfSummaryTable, InnerGroup ),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Product] = [ProductA] &amp;&amp;</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Daily Revenue]&lt;=[Daily RevenueA]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div></div><div class="bookfrontmatter"><div class="fixedline1">VAR ProductByDateRanking =</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GROUPBY(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CrossJoinTables,</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Product],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Date],</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Daily Revenue", MAXX(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CURRENTGROUP(),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Daily Revenue]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Rank",&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMX(</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CURRENTGROUP(),</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[RowCounter]</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;&nbsp;</div></div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-15</span><p class="para3">Additional DAX for the Code in Listing <span><a href="#calibre_link-373" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-14</a></span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2699">In this code, the <span id="calibre_link-2700">CopyOfSummaryTable variable


</span> is used to store a copy of the InnerGroup variable. The [Product], [Date], and [Daily Revenue] columns are renamed using SELECTCOLUMNS to avoid a clash over column names when this version of the table is joined back to the InnerGroup table in the next step. The columns are simply renamed to have the “A” character appended.</p><p class="simplepara" id="calibre_link-2701">A new column called [RowCounter] is also added at this step and it is hardcoded to be 1. This column is going to provide the basis for the ranking calculation. Each row is duplicated for every row found for the same product that has a higher value for [Daily Revenue]. Once the duplication has happened, a SUM over the [RowCounter] generates a value that represents the rank.</p><p class="simplepara" id="calibre_link-2702">The next step applies a cartesian join between the InnerGroup and the CrossJoinTables table variables. A FILTER function makes sure that only rows from InnerGroup are matched with rows from CopyOfSummaryTable that have the same value for [Product]. The <span class="emphasisfontcategorynonproportional">[Daily Revenue] &lt;= [Daily RevenueA]</span> logic allows for as many rows from the CopyOfSummaryTable variable that have the same or higher value for [Daily Revenue] from the InnerGroup variable.</p><p class="simplepara" id="calibre_link-2703">For any given product in the <span id="calibre_link-2704">InnerGroup table variable


</span>, the row that happens to have the highest value for [Daily Revenue] for that product only finds one matching row from CopyOfSummaryTable (it finds itself). The InnerGroup row for the same product with the next highest value finds two matching rows, and so on, until the row from InnerGroup with the lowest value for the same product is the only row left unmatched. This row is then matched with every other row from CopyOfSummaryTable for the same product, meaning a SUM over the [RowCounter] column returns a number that has the highest number (lowest ranking).</p><p class="simplepara" id="calibre_link-2705">The last step in this section is to group the cartesian output of the previous step back to a single row per product and day. Neither the SUMMARIZE nor the <span id="calibre_link-2706">SUMMARIZECOLUMNS functions


</span> can be used over a table expression stored in a variable. Both functions only work with a physical table. Fortunately, the GROUPBY function can be used, but aggregation expressions must use iterator functions. This creates a summary table over the CrossJoinTables variable grouping by [Product] and [Date].</p><p class="simplepara" id="calibre_link-2707">There is no <span id="calibre_link-2708">COUNTROWSX iterator function


</span> in DAX; if it existed, it could be used to count the number of rows belonging to each [Product] and [Date] while they were being summarized to provide a value for rank. In this case, the [RowCounter] column introduced in the first step allows an equivalent approach to be taken by performing a SUMX over the hardcoded values in this column.</p><p class="simplepara" id="calibre_link-2709">If no BLANK values are in the column, an alternative is to simply COUNTAX(CURRENTGROUP(), [Column]) to avoid introducing the column that has a value of 1 in every row.</p><p class="simplepara" id="calibre_link-2710">The <span id="calibre_link-2711">CURRENTGROUP() function


</span> used in both the MAXX and SUMX functions is a reference back to the table used as the first parameter in the GROUPBY function.</p><p class="simplepara" id="calibre_link-2712">Here the <span id="calibre_link-2713">MAXX function


</span> is being used to allow the daily sales total for each day to be stored in the [Daily Revenue] column. This helps reduce duplicated instances of the same value back to a single instance for each product/day. This value does not reflect the max of individual transactions, rather it represents the combined sales total for the product across each day. This is not the step that performs the aggregation; instead it helps preserve the daily sales data through to the next step.</p><div class="para1" id="calibre_link-2714">The output of the <span id="calibre_link-2715">ProductByDateRanking variable


</span> would look something like Figure <span><a href="#calibre_link-375" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-13</a></span>.<figure class="figure1" id="calibre_link-375"><div class="mediaobject" id="calibre_link-2716"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig13_HTML.gif" src="images/000027.gif" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-13</span><p class="simplepara1">Sample output of the cod in Listings <span class="calibre9"><a href="#calibre_link-373" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-14</a></span> and <span class="calibre9"><a href="#calibre_link-374" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-15</a></span> ordered by rank</p></div></figcaption></figure>
</div><p class="simplepara" id="calibre_link-2717">When sorted by product and rank, the daily revenue data appears as expected. Notice the dates for each row jump around. Each product has different days that make up the different ranking positions.</p><p class="simplepara" id="calibre_link-2718">This table carries a ranking value for any day in which the product registers a sale. The next step is to filter this data down to be just the top ten rows by rank for each product. Listing <span><a href="#calibre_link-376" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-16</a></span> shows this straightforward use of the FILTER function.</p><div class="para1" id="calibre_link-376">
              <div class="programcode" id="calibre_link-2719"><div class="fixedline">VAR TopTenDaysPerPRoduct =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ProductByDateRanking,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Rank]&lt;=10</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-16</span><p class="para3">Additional Step to the Code in Listing <span><a href="#calibre_link-374" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-15</a></span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2720">Now you have a set of data that only covers the ten best days by product. The last step to meet the initial requirements is to create an average over the [Daily Sales] per product. Again, remember that SUMMARIZE and SUMMARIZECOLUMNS cannot be used here because they do not work with table expressions stored in variables. So, the last step (Listing <span><a href="#calibre_link-377" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-17</a></span>) uses the GROUPBY function to perform the average.</p><div class="para1" id="calibre_link-377">
              <div class="programcode" id="calibre_link-2721"><div class="fixedline">RETURN OuterGroup =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GROUPBY(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TopTenDaysPerProduct,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Group BY --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Product],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-- Aggregation Column --</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Average of Top 10 Best Days",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AVERAGEX(</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CURRENTGROUP(), [Daily Revenue]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Listing 9-17</span><p class="para3">Final <span id="calibre_link-2722">RETURN Statement


</span> Added to the Code in Listing <span><a href="#calibre_link-376" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-16</a></span>
</p></div></div></div>
            </div><p class="simplepara" id="calibre_link-2723">The step now aggregates the working data from the previous step using the <span id="calibre_link-2724">TopTenDaysPerProduct variable


</span> down to just one row per product. All products will have a row in this table. Then the <span id="calibre_link-2725">AVERAGEX iterator function


</span> is used in conjunction with the <span id="calibre_link-2726">CURRENTGROUP() function


</span> to perform an average over the [Daily Revenue] data for each product.</p><div class="para1" id="calibre_link-2727">The final output is a two-column table (Figure <span><a href="#calibre_link-378" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-14</a></span>) that meets the unusual reporting requirement. I didn’t choose this scenario because it is likely to be a frequent problem you encounter. Instead, I chose it because it showcases a variety of techniques that you can use in DAX to address scenarios that have an extra degree of complexity.<figure class="figure1" id="calibre_link-378"><div class="mediaobject" id="calibre_link-2728"><img alt="../images/456681_1_En_9_Chapter/456681_1_En_9_Fig14_HTML.jpg" src="images/000036.jpg" class="calibre4" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-14</span><p class="simplepara1">Sample of accumated code in Listings <span class="calibre9"><a href="#calibre_link-373" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-14</a></span>&ndash;<span class="calibre9"><a href="#calibre_link-377" class="pcalibre3 pcalibre4 calibre5 pcalibre1 pcalibre2 pcalibre">9-17</a></span>
</p></div></figcaption></figure>
</div></section></section></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-244">
<div id="calibre_link-2729" class="calibre2">
<div id="calibre_link-2730" class="calibre3"><div class="bookfrontmatter"><div class="index" type="index" id="calibre_link-2731"><div class="bookfrontmatter"><h3 class="heading">Index</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">A</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">ADDCOLUMNS function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Arithmetic operators</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">B</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Bracket game</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">C</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Calculated column</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Calculated measure</div><div class="bookfrontmatter">fact sale table</div><div class="bookfrontmatter">fully qualified</div><div class="bookfrontmatter">SUM function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Calculated table</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">CALCULATE function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">CALENDARAUTO function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Comparison operators</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Concatenation operator</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Container</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Context</div><div class="bookfrontmatter">defined</div><div class="bookfrontmatter">filter</div><div class="bookfrontmatter"><span class="indexentryseelabel">See</span>Filter context</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">COUNTROWS function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">CROSSJOIN function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">CURRENTGROUP() function</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">D</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Data analysis expressions (DAX)</div><div class="bookfrontmatter">calculated column</div><div class="bookfrontmatter">calculated measure</div><div class="bookfrontmatter">calculated table</div><div class="bookfrontmatter">comments</div><div class="bookfrontmatter">defined</div><div class="bookfrontmatter">functions</div><div class="bookfrontmatter">relationships</div><div class="bookfrontmatter"><span class="indexentryseelabel">See</span>Relationships</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Data models</div><div class="bookfrontmatter">ADDCOLUMNS function</div><div class="bookfrontmatter">adding year</div><div class="bookfrontmatter">automatic date tables</div><div class="bookfrontmatter">CALENDAR function</div><div class="bookfrontmatter">components</div><div class="bookfrontmatter">columns</div><div class="bookfrontmatter">data</div><div class="bookfrontmatter">hierarchies</div><div class="bookfrontmatter">measures</div><div class="bookfrontmatter">relationships</div><div class="bookfrontmatter">tables</div><div class="bookfrontmatter">defined</div><div class="bookfrontmatter">date/calendar tables</div><div class="bookfrontmatter">DateTime fields</div><div class="bookfrontmatter">Days from Today</div><div class="bookfrontmatter">fiscal year</div><div class="bookfrontmatter">FORMAT function</div><div class="bookfrontmatter">MonthID column</div><div class="bookfrontmatter">optimizing dates</div><div class="bookfrontmatter">period comparison calculations</div><div class="bookfrontmatter">point-in-time value</div><div class="bookfrontmatter">quick measures</div><div class="bookfrontmatter">rolling average</div><div class="bookfrontmatter">sorting by columns</div><div class="bookfrontmatter">time</div><div class="bookfrontmatter">time intelligence</div><div class="bookfrontmatter">weekday name</div><div class="bookfrontmatter">weekly buckets</div><div class="bookfrontmatter">working days</div><div class="bookfrontmatter">Year to Date</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Datatypes</div><div class="bookfrontmatter">calculations on REAL numbers</div><div class="bookfrontmatter">categories</div><div class="bookfrontmatter">date-based</div><div class="bookfrontmatter">in DAX</div><div class="bookfrontmatter">decimal and fixed decimal number</div><div class="bookfrontmatter">time</div><div class="bookfrontmatter">whole number</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Date tables</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">DAX Studio</div><div class="bookfrontmatter">application</div><div class="bookfrontmatter">calculated columns</div><div class="bookfrontmatter">calculated measures</div><div class="bookfrontmatter">Best Ten Products</div><div class="bookfrontmatter">Calculate Revenue as Column</div><div class="bookfrontmatter">CALCULATETABLE function</div><div class="bookfrontmatter">‘Dates’ and ‘Daily Summary’ tables</div><div class="bookfrontmatter">DAX query testing</div><div class="bookfrontmatter">FILTER function</div><div class="bookfrontmatter">InnerGroup table expression</div><div class="bookfrontmatter">iterators</div><div class="bookfrontmatter">NATURALINNERJOIN function</div><div class="bookfrontmatter">SELECTCOLUMNS function</div><div class="bookfrontmatter">server timing output</div><div class="bookfrontmatter">SUMMARIZECOLUMNS function</div><div class="bookfrontmatter">table and line chart</div><div class="bookfrontmatter">table/matrix visual</div><div class="bookfrontmatter">TOPN function</div><div class="bookfrontmatter">client tool</div><div class="bookfrontmatter">column indexes</div><div class="bookfrontmatter">connection dialog</div><div class="bookfrontmatter">COUNTROWS function</div><div class="bookfrontmatter">data models</div><div class="bookfrontmatter">date table</div><div class="bookfrontmatter">DEFINE MEASURE statement</div><div class="bookfrontmatter">double grouping</div><div class="bookfrontmatter">AVERAGEX iterator function</div><div class="bookfrontmatter">CopyOfSummaryTable variable</div><div class="bookfrontmatter">COUNTROWSX iterator function</div><div class="bookfrontmatter">CURRENTGROUP() function</div><div class="bookfrontmatter">InnerGroup variable</div><div class="bookfrontmatter">MAXX function</div><div class="bookfrontmatter">ProductByDateRanking variable</div><div class="bookfrontmatter">RANKX iterator</div><div class="bookfrontmatter">RETURN Statement</div><div class="bookfrontmatter">SUMMARIZECOLUMNS functions</div><div class="bookfrontmatter">summary calculated table</div><div class="bookfrontmatter">TopTenDaysPerProduct variable</div><div class="bookfrontmatter">EVALUATE keyword</div><div class="bookfrontmatter">Format Query (F6)</div><div class="bookfrontmatter">nested variables</div><div class="bookfrontmatter">numbers table</div><div class="bookfrontmatter">optimizing sales</div><div class="bookfrontmatter">Power BI Desktop</div><div class="bookfrontmatter">sales table</div><div class="bookfrontmatter">SELECTCOLUMNS function</div><div class="bookfrontmatter">store data</div><div class="bookfrontmatter">US Census Bureau</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Debugging</div><div class="bookfrontmatter">calculated measures</div><div class="bookfrontmatter">client tools</div><div class="bookfrontmatter">column approach</div><div class="bookfrontmatter">DAX</div><div class="bookfrontmatter">variables</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Decimal numbers datatype</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Dimension.Date</div><div class="bookfrontmatter">hierarchy in</div><div class="bookfrontmatter">relationship, fact sale table and</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">E</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Explicit filtering</div><div class="bookfrontmatter">ALLEXCEPT function</div><div class="bookfrontmatter">ALL function</div><div class="bookfrontmatter">ALLSELECTED function</div><div class="bookfrontmatter">Columns and EARLIER function</div><div class="bookfrontmatter">‘Fact Sale’ table</div><div class="bookfrontmatter">filter function</div><div class="bookfrontmatter">filters and calculated tables</div><div class="bookfrontmatter">measurement</div><div class="bookfrontmatter">overriding filters</div><div class="bookfrontmatter">percentage of total</div><div class="bookfrontmatter">period comparison</div><div class="bookfrontmatter">running totals</div><div class="bookfrontmatter">ALLSELECTED</div><div class="bookfrontmatter">calculated measures</div><div class="bookfrontmatter">rank</div><div class="bookfrontmatter">resetting</div><div class="bookfrontmatter">table visual</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Explicit measures</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">F</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Filter context</div><div class="bookfrontmatter">calculated column</div><div class="bookfrontmatter">calculated measure</div><div class="bookfrontmatter">column filters</div><div class="bookfrontmatter">container</div><div class="bookfrontmatter">defined</div><div class="bookfrontmatter">effect of</div><div class="bookfrontmatter">explicit</div><div class="bookfrontmatter">hardcode</div><div class="bookfrontmatter">iterators</div><div class="bookfrontmatter">overriden output</div><div class="bookfrontmatter">row context</div><div class="bookfrontmatter">simpler dataset</div><div class="bookfrontmatter">transition</div><div class="bookfrontmatter">T-SQL</div><div class="bookfrontmatter">calculated measure</div><div class="bookfrontmatter">for basic DAX Query</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">FILTER function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Formula engine (FE)</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">G</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">GENERATE function</div><div class="bookfrontmatter">behavior of</div><div class="bookfrontmatter">filter</div><div class="bookfrontmatter">numbers table</div><div class="bookfrontmatter">ADDCOLUMNS function</div><div class="bookfrontmatter">dataset</div><div class="bookfrontmatter">GENERATESERIES</div><div class="bookfrontmatter">output</div><div class="bookfrontmatter">occupancies, hotel room</div><div class="bookfrontmatter"><span class="indexentryseelabel">See</span>Hotel room occupancies</div><div class="bookfrontmatter">query</div><div class="bookfrontmatter">removal, unwanted columns</div><div class="bookfrontmatter">sales table</div><div class="bookfrontmatter">dataset</div><div class="bookfrontmatter">find last purchases</div><div class="bookfrontmatter">NATURALLEFTOUTERJOIN</div><div class="bookfrontmatter">output</div><div class="bookfrontmatter">RETURN statement</div><div class="bookfrontmatter">SelfJoin variable</div><div class="bookfrontmatter">T-SQL equivalent</div><div class="bookfrontmatter">SELECTCOLUMNS function</div><div class="bookfrontmatter">syntax</div><div class="bookfrontmatter">T-SQL equivalent</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">GROUPBY function</div><div class="bookfrontmatter">CALCULATETABLE</div><div class="bookfrontmatter">CURRENTGROUP() function</div><div class="bookfrontmatter">double aggregation</div><div class="bookfrontmatter">filter</div><div class="bookfrontmatter">SUMX function</div><div class="bookfrontmatter">syntax</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">H</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Hierarchies</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Hotel room occupancies</div><div class="bookfrontmatter">CALENDAR function</div><div class="bookfrontmatter">dataset</div><div class="bookfrontmatter">FILTER function</div><div class="bookfrontmatter">occupancy table</div><div class="bookfrontmatter">output</div><div class="bookfrontmatter">Ribbon Chart</div><div class="bookfrontmatter">T-SQL equivalent</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">I</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Implicit filtering</div><div class="bookfrontmatter">advantages</div><div class="bookfrontmatter">Count of Sales</div><div class="bookfrontmatter">cross-filtering property</div><div class="bookfrontmatter">DAX engine</div><div class="bookfrontmatter">‘Dimension Date’ table</div><div class="bookfrontmatter">‘Dimension Stock Item’ table</div><div class="bookfrontmatter">dimension tables</div><div class="bookfrontmatter">‘Fact Sale’ table</div><div class="bookfrontmatter">intergenerational tables</div><div class="bookfrontmatter">Power BI</div><div class="bookfrontmatter">query context</div><div class="bookfrontmatter">WideWorldImportersDW dataset</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Implicit measures</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">IntelliSense</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">ISSUBTOTAL function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Iterators</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">J, K</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Joining tables</div><div class="bookfrontmatter">CROSSJOIN</div><div class="bookfrontmatter">GENERATE</div><div class="bookfrontmatter"><span class="indexentryseelabel">See</span>GENERATE function</div><div class="bookfrontmatter">LOOKUPVALUE</div><div class="bookfrontmatter">NATURALINNERJOIN function</div><div class="bookfrontmatter">NATURALLEFTOUTERJOIN function</div><div class="bookfrontmatter">UNION function</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">L, M</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Logical operators</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">LOOKUPVALUE function</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">N</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">NATURALINNERJOIN function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">NATURALLEFTOUTERJOIN function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Nested variables</div><div class="bookfrontmatter">calculated measure</div><div class="bookfrontmatter">complex</div><div class="bookfrontmatter">defined</div><div class="bookfrontmatter">multiple levels</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Numbers table</div><div class="bookfrontmatter">ADDCOLUMNS function</div><div class="bookfrontmatter">dataset</div><div class="bookfrontmatter">GENERATESERIES</div><div class="bookfrontmatter">output</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">O</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Operators</div><div class="bookfrontmatter">arithmetic</div><div class="bookfrontmatter">comparison</div><div class="bookfrontmatter">concatenation</div><div class="bookfrontmatter">logical</div><div class="bookfrontmatter">precedence</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Optimization</div><div class="bookfrontmatter">dimension tables</div><div class="bookfrontmatter">fact tables</div><div class="bookfrontmatter">filtering</div><div class="bookfrontmatter">precalculating data</div><div class="bookfrontmatter">removing unused data</div><div class="bookfrontmatter">
                SE
                <em class="emphasistypeitalic">vs.</em>
                FE
              </div><div class="bookfrontmatter">simplifying table structure</div><div class="bookfrontmatter">splitting up unique columns</div><div class="bookfrontmatter">SSMS Profiler</div><div class="bookfrontmatter">summary tables</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">P</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Pigs-Ear relationship</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Power BI Desktop</div><div class="bookfrontmatter">Data View</div><div class="bookfrontmatter">relationships</div><div class="bookfrontmatter">Relationship View</div><div class="bookfrontmatter">Report View</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">Q</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Quick Measures</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">R</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">RANDBETWEEN function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">REAL numbers</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Relationships</div><div class="bookfrontmatter">active</div><div class="bookfrontmatter">defined</div><div class="bookfrontmatter">filter tables</div><div class="bookfrontmatter">for filtering</div><div class="bookfrontmatter">join tables without</div><div class="bookfrontmatter">one column per table</div><div class="bookfrontmatter">one-to-many relationships</div><div class="bookfrontmatter">= operator</div><div class="bookfrontmatter">Pigs-Ear</div><div class="bookfrontmatter">rules</div><div class="bookfrontmatter">table on the one side of</div><div class="bookfrontmatter">types of</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">RETURN keyword</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">ROLLUP function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Row context</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">S</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Sales table</div><div class="bookfrontmatter">dataset</div><div class="bookfrontmatter">NATURALLEFTOUTERJOIN</div><div class="bookfrontmatter">output</div><div class="bookfrontmatter">purchases</div><div class="bookfrontmatter">RETURN statement</div><div class="bookfrontmatter">SelfJoin variable</div><div class="bookfrontmatter">T-SQL equivalent</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">SELECTCOLUMNS function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">SQL Server Management Studio (SSMS)</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Storage engine (SE)</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">SUMMARIZE function</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">Summary table</div><div class="bookfrontmatter">create</div><div class="bookfrontmatter">GROUPBY function</div><div class="bookfrontmatter">CALCULATETABLE</div><div class="bookfrontmatter">CURRENTGROUP() function</div><div class="bookfrontmatter">double aggregation</div><div class="bookfrontmatter">filter</div><div class="bookfrontmatter">SUMX function</div><div class="bookfrontmatter">syntax</div><div class="bookfrontmatter">time in milliseconds</div><div class="bookfrontmatter">SUMMARIZECOLUMNS function</div><div class="bookfrontmatter">SUMMARIZE function</div><div class="bookfrontmatter">alternative relationships</div><div class="bookfrontmatter">calculated table</div><div class="bookfrontmatter">filter</div><div class="bookfrontmatter">ISSUBTOTAL function</div><div class="bookfrontmatter">output</div><div class="bookfrontmatter">relationship</div><div class="bookfrontmatter">ROLLUP function</div><div class="bookfrontmatter">sample output</div><div class="bookfrontmatter">Sub Category column</div><div class="bookfrontmatter">syntax</div><div class="bookfrontmatter">T-SQL-equivalent statement</div><div class="bookfrontmatter">uses of</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">SUMX function</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">T</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Time datatype</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">U</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">UNION function</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">V</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Variables</div><div class="bookfrontmatter">basic structure</div><div class="bookfrontmatter">calculated columns</div><div class="bookfrontmatter">calculated measure</div><div class="bookfrontmatter">calculated tables</div><div class="bookfrontmatter">debugging</div><div class="bookfrontmatter">defined</div><div class="bookfrontmatter">equivalent T-SQL to match DAX</div><div class="bookfrontmatter">error code</div><div class="bookfrontmatter">multiple DAX variables</div><div class="bookfrontmatter">nested</div><div class="bookfrontmatter"><span class="indexentryseelabel">See</span>Nested variables</div><div class="bookfrontmatter">other types of calculations</div><div class="bookfrontmatter">RETURN keyword</div><div class="bookfrontmatter">structure</div><div class="bookfrontmatter">VAR keyword</div><div class="bookfrontmatter">with text</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">W</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">Whole Number datatype</div></div><div class="bookfrontmatter"><div class="bookfrontmatter">WideWorldImportersDW dataset</div></div></div><div class="bookfrontmatter"><div class="bookfrontmatter"><h3 class="heading">X, Y, Z</h3></div><div class="bookfrontmatter"><div class="bookfrontmatter">X functions</div><div class="bookfrontmatter"><span class="indexentryseelabel">See</span>(Iterators)</div></div></div></div></div></div>
</div>
</div>


</body></html>